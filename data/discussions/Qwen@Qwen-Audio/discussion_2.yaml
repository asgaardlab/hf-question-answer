!!python/object:huggingface_hub.community.DiscussionWithDetails
author: zfarrell13
conflicting_files: null
created_at: 2023-12-01 14:40:04+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/504f0592e3e0c3a7fce7c5d2d68e17c8.svg
      fullname: Zach Farrell
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: zfarrell13
      type: user
    createdAt: '2023-12-01T14:40:04.000Z'
    data:
      edited: false
      editors:
      - zfarrell13
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.7850974798202515
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/504f0592e3e0c3a7fce7c5d2d68e17c8.svg
          fullname: Zach Farrell
          isHf: false
          isPro: false
          name: zfarrell13
          type: user
        html: "<p>I wrote a script to make an inference on an audio file, and it took\
          \ 30 minutes to get a response:</p>\n<p>script:</p>\n<p>`<br>import time<br>from\
          \ transformers import AutoModelForCausalLM, AutoTokenizer</p>\n<p>Initialize\
          \ model<br>tokenizer = AutoTokenizer.from_pretrained(\"Qwen/Qwen-Audio-Chat\"\
          , trust_remote_code=True)<br>model = AutoModelForCausalLM.from_pretrained(\"\
          Qwen/Qwen-Audio-Chat\", device_map=\"cpu\", trust_remote_code=True).eval()</p>\n\
          <p>Set up audio file<br>audio_file = \"file.mp3\"</p>\n<p>Define helper\
          \ validation function<br>def validate_response(text):<br>if ',' not in text:<br>print(\"\
          Error - response did not contain comma delimited list\")<br>return False<br>return\
          \ True</p>\n<p>Time full execution<br>start = time.time()</p>\n<p>Attempt\
          \ audio analysis<br>try:<br>query = tokenizer.from_list_format([<br>{'audio':\
          \ audio_file},<br>{'text': 'Describe this audio with 5 comma-separated adjectives'},<br>])<br>response,\
          \ history = model.chat(tokenizer, query=query, history=None)</p>\n<h1 id=\"\
          print-full-response-and-validate\">Print full response and validate</h1>\n\
          <p>print(response)<br>valid = validate_response(response)<br>except Exception\
          \ as e:<br>print(f\"Error: {e}\")<br>valid = False</p>\n<p>end = time.time()<br>elapsed\
          \ = end - start</p>\n<p>Print total time<br>print(f\"Elapsed time: {elapsed}\
          \ seconds\")</p>\n<p>Check if the response was valid<br>if not valid:<br>print(\"\
          Issues with audio analysis\")`</p>\n<p>result:</p>\n<p>`python caption_audio.py<br>audio_start_id:\
          \ 155164, audio_end_id: 155165, audio_pad_id: 151851.<br>Warning: import\
          \ flash_attn rotary fail, please install FlashAttention rotary to get higher\
          \ efficiency <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\"\
          >https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary</a><br>Warning:\
          \ import flash_attn rms_norm fail, please install FlashAttention layer_norm\
          \ to get higher efficiency <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\"\
          >https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm</a><br>Warning:\
          \ import flash_attn fail, please install FlashAttention to get higher efficiency\
          \ <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention\"\
          >https://github.com/Dao-AILab/flash-attention</a><br>Loading checkpoint\
          \ shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588| 9/9 [00:00&lt;00:00, 17.97it/s]<br>&lt;|im_start|&gt;system<br>You\
          \ are a helpful assistant.&lt;|im_end|&gt;<br>&lt;|im_start|&gt;user<br>Audio\
          \ 1:file.mp3<br>Describe this audio with 5 comma-separated adjectives&lt;|im_end|&gt;<br>&lt;|im_start|&gt;assistant</p>\n\
          <p>Funky, groovy, energetic, hip-hop, dance<br>Elapsed time: 1812.089405298233\
          \ seconds`</p>\n<p>Also inconsistent results running the same script a subsequent\
          \ time:</p>\n<p>second result:</p>\n<p>`python caption_audio.py<br>audio_start_id:\
          \ 155164, audio_end_id: 155165, audio_pad_id: 151851.<br>Warning: import\
          \ flash_attn rotary fail, please install FlashAttention rotary to get higher\
          \ efficiency <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\"\
          >https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary</a><br>Warning:\
          \ import flash_attn rms_norm fail, please install FlashAttention layer_norm\
          \ to get higher efficiency <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\"\
          >https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm</a><br>Warning:\
          \ import flash_attn fail, please install FlashAttention to get higher efficiency\
          \ <a rel=\"nofollow\" href=\"https://github.com/Dao-AILab/flash-attention\"\
          >https://github.com/Dao-AILab/flash-attention</a><br>Loading checkpoint\
          \ shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588| 9/9 [00:00&lt;00:00, 9.99it/s]<br>&lt;|im_start|&gt;system<br>You\
          \ are a helpful assistant.&lt;|im_end|&gt;<br>&lt;|im_start|&gt;user<br>Audio\
          \ 1:file.mp3<br>Describe this audio with 5 comma-separated adjectives&lt;|im_end|&gt;<br>&lt;|im_start|&gt;assistant</p>\n\
          <p>This is a funky, groovy, upbeat, electronic, electro, electronic beats,\
          \ electronic music, electronic dance, electronic instrumental, electronic\
          \ background, electronic soundtrack, electronic soundtrack, electro hip\
          \ hop, electro hip hop beats, electro hip hop instrumental, electro rap,\
          \ electro rap beats, electro rap instrumental, electronic music for tv,\
          \ electronic music for radio, electronic music for advertising, electronic\
          \ music for games, electronic music for movies, electronic music for youtube,\
          \ electronic music for corporate use, electronic music for commercial use,\
          \ electronic music for business, electronic music for presentations, electronic\
          \ music for websites, electronic music for apps, electronic music for software,\
          \ electronic music for advertising, electronic music for marketing, electronic\
          \ music for product presentation, electronic music for corporate presentations,\
          \ electronic music for business videos, electronic music for product videos,\
          \ electronic music for commercials, electronic music for radio, electronic\
          \ music for tv, electronic music for films, electronic music for viral marketing,\
          \ electronic music for web advertisements, electronic music for youtube\
          \ videos, electronic music for social media, electronic music for apps,\
          \ electronic music for mobile, electronic music for corporate, electronic\
          \ music for background, electronic music for fashion, electronic music for\
          \ lifestyle, electronic music for beauty, electronic music for food, electronic\
          \ music for travel, electronic music for health, electronic music for fitness,\
          \ electronic music for meditation, electronic music for relaxation, electronic\
          \ music for studying, electronic music for working, electronic music for\
          \ sleeping, electronic music for dancing, electronic music for fun, electronic\
          \ music for playing, electronic music for singing, electronic music for\
          \ podcast, electronic music for video games, electronic music for background\
          \ music, electronic music for club, electronic music for rapping, electronic\
          \ music for beat-making, electronic music for producing, electronic music\
          \ for composing, electronic music for singing, electronic music for playing,\
          \ electronic music for dancing, electronic music for fun, electronic music\
          \ for playing, electronic music for singing, electronic music for producing,\
          \ electronic music for composing, electronic music for radio, electronic\
          \ music for tv, electronic music for films, electronic music for viral marketing,\
          \ electronic music for web advertisements, electronic music for youtube\
          \ videos, electronic music for social media, electronic music for apps,\
          \ electronic music for mobile, electronic music for corporate, electronic\
          \ music for background, electronic music for fashion, electronic music for\
          \ lifestyle, electronic music for beauty, electronic music for food, electronic\
          \ music for travel, electronic music for health, electronic music for fitness,\
          \ electronic music for meditation, electronic music for relaxation, electronic\
          \ music for studying, electronic music for working, electronic music for\
          \ sleeping, electronic music for<br>Elapsed time: 60488.493457078934 seconds`</p>\n\
          <p>any tips to make this run more efficiently?</p>\n"
        raw: "I wrote a script to make an inference on an audio file, and it took\
          \ 30 minutes to get a response:\r\n\r\nscript:\r\n\r\n`\r\nimport time\r\
          \nfrom transformers import AutoModelForCausalLM, AutoTokenizer\r\n\r\nInitialize\
          \ model\r\ntokenizer = AutoTokenizer.from_pretrained(\"Qwen/Qwen-Audio-Chat\"\
          , trust_remote_code=True)\r\nmodel = AutoModelForCausalLM.from_pretrained(\"\
          Qwen/Qwen-Audio-Chat\", device_map=\"cpu\", trust_remote_code=True).eval()\r\
          \n\r\nSet up audio file\r\naudio_file = \"file.mp3\"\r\n\r\nDefine helper\
          \ validation function\r\ndef validate_response(text):\r\nif ',' not in text:\r\
          \nprint(\"Error - response did not contain comma delimited list\")\r\nreturn\
          \ False\r\nreturn True\r\n\r\nTime full execution\r\nstart = time.time()\r\
          \n\r\nAttempt audio analysis\r\ntry:\r\nquery = tokenizer.from_list_format([\r\
          \n{'audio': audio_file},\r\n{'text': 'Describe this audio with 5 comma-separated\
          \ adjectives'},\r\n])\r\nresponse, history = model.chat(tokenizer, query=query,\
          \ history=None)\r\n\r\n# Print full response and validate\r\nprint(response)\r\
          \nvalid = validate_response(response)\r\nexcept Exception as e:\r\nprint(f\"\
          Error: {e}\")\r\nvalid = False\r\n\r\nend = time.time()\r\nelapsed = end\
          \ - start\r\n\r\nPrint total time\r\nprint(f\"Elapsed time: {elapsed} seconds\"\
          )\r\n\r\nCheck if the response was valid\r\nif not valid:\r\nprint(\"Issues\
          \ with audio analysis\")`\r\n\r\nresult:\r\n\r\n`python caption_audio.py\r\
          \naudio_start_id: 155164, audio_end_id: 155165, audio_pad_id: 151851.\r\n\
          Warning: import flash_attn rotary fail, please install FlashAttention rotary\
          \ to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\r\
          \nWarning: import flash_attn rms_norm fail, please install FlashAttention\
          \ layer_norm to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\r\
          \nWarning: import flash_attn fail, please install FlashAttention to get\
          \ higher efficiency https://github.com/Dao-AILab/flash-attention\r\nLoading\
          \ checkpoint shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 9/9 [00:00<00:00, 17.97it/s]\r\n<|im_start|>system\r\
          \nYou are a helpful assistant.<|im_end|>\r\n<|im_start|>user\r\nAudio 1:file.mp3\r\
          \nDescribe this audio with 5 comma-separated adjectives<|im_end|>\r\n<|im_start|>assistant\r\
          \n\r\nFunky, groovy, energetic, hip-hop, dance\r\nElapsed time: 1812.089405298233\
          \ seconds`\r\n\r\nAlso inconsistent results running the same script a subsequent\
          \ time:\r\n\r\nsecond result:\r\n\r\n`python caption_audio.py\r\naudio_start_id:\
          \ 155164, audio_end_id: 155165, audio_pad_id: 151851.\r\nWarning: import\
          \ flash_attn rotary fail, please install FlashAttention rotary to get higher\
          \ efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\r\
          \nWarning: import flash_attn rms_norm fail, please install FlashAttention\
          \ layer_norm to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\r\
          \nWarning: import flash_attn fail, please install FlashAttention to get\
          \ higher efficiency https://github.com/Dao-AILab/flash-attention\r\nLoading\
          \ checkpoint shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 9/9 [00:00<00:00, 9.99it/s]\r\n<|im_start|>system\r\
          \nYou are a helpful assistant.<|im_end|>\r\n<|im_start|>user\r\nAudio 1:file.mp3\r\
          \nDescribe this audio with 5 comma-separated adjectives<|im_end|>\r\n<|im_start|>assistant\r\
          \n\r\nThis is a funky, groovy, upbeat, electronic, electro, electronic beats,\
          \ electronic music, electronic dance, electronic instrumental, electronic\
          \ background, electronic soundtrack, electronic soundtrack, electro hip\
          \ hop, electro hip hop beats, electro hip hop instrumental, electro rap,\
          \ electro rap beats, electro rap instrumental, electronic music for tv,\
          \ electronic music for radio, electronic music for advertising, electronic\
          \ music for games, electronic music for movies, electronic music for youtube,\
          \ electronic music for corporate use, electronic music for commercial use,\
          \ electronic music for business, electronic music for presentations, electronic\
          \ music for websites, electronic music for apps, electronic music for software,\
          \ electronic music for advertising, electronic music for marketing, electronic\
          \ music for product presentation, electronic music for corporate presentations,\
          \ electronic music for business videos, electronic music for product videos,\
          \ electronic music for commercials, electronic music for radio, electronic\
          \ music for tv, electronic music for films, electronic music for viral marketing,\
          \ electronic music for web advertisements, electronic music for youtube\
          \ videos, electronic music for social media, electronic music for apps,\
          \ electronic music for mobile, electronic music for corporate, electronic\
          \ music for background, electronic music for fashion, electronic music for\
          \ lifestyle, electronic music for beauty, electronic music for food, electronic\
          \ music for travel, electronic music for health, electronic music for fitness,\
          \ electronic music for meditation, electronic music for relaxation, electronic\
          \ music for studying, electronic music for working, electronic music for\
          \ sleeping, electronic music for dancing, electronic music for fun, electronic\
          \ music for playing, electronic music for singing, electronic music for\
          \ podcast, electronic music for video games, electronic music for background\
          \ music, electronic music for club, electronic music for rapping, electronic\
          \ music for beat-making, electronic music for producing, electronic music\
          \ for composing, electronic music for singing, electronic music for playing,\
          \ electronic music for dancing, electronic music for fun, electronic music\
          \ for playing, electronic music for singing, electronic music for producing,\
          \ electronic music for composing, electronic music for radio, electronic\
          \ music for tv, electronic music for films, electronic music for viral marketing,\
          \ electronic music for web advertisements, electronic music for youtube\
          \ videos, electronic music for social media, electronic music for apps,\
          \ electronic music for mobile, electronic music for corporate, electronic\
          \ music for background, electronic music for fashion, electronic music for\
          \ lifestyle, electronic music for beauty, electronic music for food, electronic\
          \ music for travel, electronic music for health, electronic music for fitness,\
          \ electronic music for meditation, electronic music for relaxation, electronic\
          \ music for studying, electronic music for working, electronic music for\
          \ sleeping, electronic music for\r\nElapsed time: 60488.493457078934 seconds`\r\
          \n\r\nany tips to make this run more efficiently?"
        updatedAt: '2023-12-01T14:40:04.471Z'
      numEdits: 0
      reactions: []
    id: 6569f0444527e9d1ffcb07bb
    type: comment
  author: zfarrell13
  content: "I wrote a script to make an inference on an audio file, and it took 30\
    \ minutes to get a response:\r\n\r\nscript:\r\n\r\n`\r\nimport time\r\nfrom transformers\
    \ import AutoModelForCausalLM, AutoTokenizer\r\n\r\nInitialize model\r\ntokenizer\
    \ = AutoTokenizer.from_pretrained(\"Qwen/Qwen-Audio-Chat\", trust_remote_code=True)\r\
    \nmodel = AutoModelForCausalLM.from_pretrained(\"Qwen/Qwen-Audio-Chat\", device_map=\"\
    cpu\", trust_remote_code=True).eval()\r\n\r\nSet up audio file\r\naudio_file =\
    \ \"file.mp3\"\r\n\r\nDefine helper validation function\r\ndef validate_response(text):\r\
    \nif ',' not in text:\r\nprint(\"Error - response did not contain comma delimited\
    \ list\")\r\nreturn False\r\nreturn True\r\n\r\nTime full execution\r\nstart =\
    \ time.time()\r\n\r\nAttempt audio analysis\r\ntry:\r\nquery = tokenizer.from_list_format([\r\
    \n{'audio': audio_file},\r\n{'text': 'Describe this audio with 5 comma-separated\
    \ adjectives'},\r\n])\r\nresponse, history = model.chat(tokenizer, query=query,\
    \ history=None)\r\n\r\n# Print full response and validate\r\nprint(response)\r\
    \nvalid = validate_response(response)\r\nexcept Exception as e:\r\nprint(f\"Error:\
    \ {e}\")\r\nvalid = False\r\n\r\nend = time.time()\r\nelapsed = end - start\r\n\
    \r\nPrint total time\r\nprint(f\"Elapsed time: {elapsed} seconds\")\r\n\r\nCheck\
    \ if the response was valid\r\nif not valid:\r\nprint(\"Issues with audio analysis\"\
    )`\r\n\r\nresult:\r\n\r\n`python caption_audio.py\r\naudio_start_id: 155164, audio_end_id:\
    \ 155165, audio_pad_id: 151851.\r\nWarning: import flash_attn rotary fail, please\
    \ install FlashAttention rotary to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\r\
    \nWarning: import flash_attn rms_norm fail, please install FlashAttention layer_norm\
    \ to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\r\
    \nWarning: import flash_attn fail, please install FlashAttention to get higher\
    \ efficiency https://github.com/Dao-AILab/flash-attention\r\nLoading checkpoint\
    \ shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588| 9/9 [00:00<00:00, 17.97it/s]\r\n<|im_start|>system\r\nYou\
    \ are a helpful assistant.<|im_end|>\r\n<|im_start|>user\r\nAudio 1:file.mp3\r\
    \nDescribe this audio with 5 comma-separated adjectives<|im_end|>\r\n<|im_start|>assistant\r\
    \n\r\nFunky, groovy, energetic, hip-hop, dance\r\nElapsed time: 1812.089405298233\
    \ seconds`\r\n\r\nAlso inconsistent results running the same script a subsequent\
    \ time:\r\n\r\nsecond result:\r\n\r\n`python caption_audio.py\r\naudio_start_id:\
    \ 155164, audio_end_id: 155165, audio_pad_id: 151851.\r\nWarning: import flash_attn\
    \ rotary fail, please install FlashAttention rotary to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/rotary\r\
    \nWarning: import flash_attn rms_norm fail, please install FlashAttention layer_norm\
    \ to get higher efficiency https://github.com/Dao-AILab/flash-attention/tree/main/csrc/layer_norm\r\
    \nWarning: import flash_attn fail, please install FlashAttention to get higher\
    \ efficiency https://github.com/Dao-AILab/flash-attention\r\nLoading checkpoint\
    \ shards: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588| 9/9 [00:00<00:00, 9.99it/s]\r\n<|im_start|>system\r\nYou are\
    \ a helpful assistant.<|im_end|>\r\n<|im_start|>user\r\nAudio 1:file.mp3\r\nDescribe\
    \ this audio with 5 comma-separated adjectives<|im_end|>\r\n<|im_start|>assistant\r\
    \n\r\nThis is a funky, groovy, upbeat, electronic, electro, electronic beats,\
    \ electronic music, electronic dance, electronic instrumental, electronic background,\
    \ electronic soundtrack, electronic soundtrack, electro hip hop, electro hip hop\
    \ beats, electro hip hop instrumental, electro rap, electro rap beats, electro\
    \ rap instrumental, electronic music for tv, electronic music for radio, electronic\
    \ music for advertising, electronic music for games, electronic music for movies,\
    \ electronic music for youtube, electronic music for corporate use, electronic\
    \ music for commercial use, electronic music for business, electronic music for\
    \ presentations, electronic music for websites, electronic music for apps, electronic\
    \ music for software, electronic music for advertising, electronic music for marketing,\
    \ electronic music for product presentation, electronic music for corporate presentations,\
    \ electronic music for business videos, electronic music for product videos, electronic\
    \ music for commercials, electronic music for radio, electronic music for tv,\
    \ electronic music for films, electronic music for viral marketing, electronic\
    \ music for web advertisements, electronic music for youtube videos, electronic\
    \ music for social media, electronic music for apps, electronic music for mobile,\
    \ electronic music for corporate, electronic music for background, electronic\
    \ music for fashion, electronic music for lifestyle, electronic music for beauty,\
    \ electronic music for food, electronic music for travel, electronic music for\
    \ health, electronic music for fitness, electronic music for meditation, electronic\
    \ music for relaxation, electronic music for studying, electronic music for working,\
    \ electronic music for sleeping, electronic music for dancing, electronic music\
    \ for fun, electronic music for playing, electronic music for singing, electronic\
    \ music for podcast, electronic music for video games, electronic music for background\
    \ music, electronic music for club, electronic music for rapping, electronic music\
    \ for beat-making, electronic music for producing, electronic music for composing,\
    \ electronic music for singing, electronic music for playing, electronic music\
    \ for dancing, electronic music for fun, electronic music for playing, electronic\
    \ music for singing, electronic music for producing, electronic music for composing,\
    \ electronic music for radio, electronic music for tv, electronic music for films,\
    \ electronic music for viral marketing, electronic music for web advertisements,\
    \ electronic music for youtube videos, electronic music for social media, electronic\
    \ music for apps, electronic music for mobile, electronic music for corporate,\
    \ electronic music for background, electronic music for fashion, electronic music\
    \ for lifestyle, electronic music for beauty, electronic music for food, electronic\
    \ music for travel, electronic music for health, electronic music for fitness,\
    \ electronic music for meditation, electronic music for relaxation, electronic\
    \ music for studying, electronic music for working, electronic music for sleeping,\
    \ electronic music for\r\nElapsed time: 60488.493457078934 seconds`\r\n\r\nany\
    \ tips to make this run more efficiently?"
  created_at: 2023-12-01 14:40:04+00:00
  edited: false
  hidden: false
  id: 6569f0444527e9d1ffcb07bb
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 2
repo_id: Qwen/Qwen-Audio
repo_type: model
status: open
target_branch: null
title: Mac m1 runs painfully slow
