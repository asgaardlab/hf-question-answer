!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Zubi401
conflicting_files: null
created_at: 2023-12-11 16:28:28+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/067aac8784320d4e8e875379dc4cc209.svg
      fullname: Sal xoubi
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Zubi401
      type: user
    createdAt: '2023-12-11T16:28:28.000Z'
    data:
      edited: false
      editors:
      - Zubi401
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.5789551138877869
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/067aac8784320d4e8e875379dc4cc209.svg
          fullname: Sal xoubi
          isHf: false
          isPro: false
          name: Zubi401
          type: user
        html: "<p>I'm trying to use ip adapters with sdxl_turbo (which seem to both\
          \ have a sdxl 1.0 checkpoint as their base). I'm doing the following: </p>\n\
          <pre><code>pipe = DiffusionPipeline.from_pretrained(\"stabilityai/sdxl-turbo\"\
          , torch_dtype=torch.float16) \npipe.vae = AutoencoderTiny.from_pretrained(\"\
          madebyollin/taesdxl\", torch_dtype=torch.float16)\n\nadapter_id = \"ip-adapter-plus-face_sdxl_vit-h.bin\"\
          \npipe.load_ip_adapter(\"h94/IP-Adapter\", subfolder=\"sdxl_models\", weight_name=adapter_id)\n\
          </code></pre>\n<p>this gives me the following error: </p>\n<pre><code>KeyError\
          \                                  Traceback (most recent call last)\nCell\
          \ In[14], line 2\n      1 adapter_id = \"ip-adapter-plus-face_sdxl_vit-h.bin\"\
          \n----&gt; 2 pipe.load_ip_adapter(\"h94/IP-Adapter\", subfolder=\"sdxl_models\"\
          , weight_name=adapter_id)\n\nFile ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/ip_adapter.py:152,\
          \ in IPAdapterMixin.load_ip_adapter(self, pretrained_model_name_or_path_or_dict,\
          \ subfolder, weight_name, **kwargs)\n    149     self.feature_extractor\
          \ = CLIPImageProcessor()\n    151 # load ip-adapter into unet\n--&gt; 152\
          \ self.unet._load_ip_adapter_weights(state_dict)\n\nFile ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/unet.py:711,\
          \ in UNet2DConditionLoadersMixin._load_ip_adapter_weights(self, state_dict)\n\
          \    708 self.set_attn_processor(attn_procs)\n    710 # create image projection\
          \ layers.\n--&gt; 711 clip_embeddings_dim = state_dict[\"image_proj\"][\"\
          proj.weight\"].shape[-1]\n    712 cross_attention_dim = state_dict[\"image_proj\"\
          ][\"proj.weight\"].shape[0] // 4\n    714 image_projection = ImageProjection(\n\
          \    715     cross_attention_dim=cross_attention_dim, image_embed_dim=clip_embeddings_dim,\
          \ num_image_text_embeds=4\n    716 )\n\nKeyError: 'proj.weight'\n</code></pre>\n\
          <p>I've also tried setting the image encoder to the one mentioned in the\
          \ IP-Adapters repo, but it still gives the same error. Any idea how to fix?\
          \ Or is SDXL_turbo not supported yet?</p>\n<p>e.g. </p>\n<pre><code>#I've\
          \ also tried the non-large version but still get the same result...\npipe.image_encoder\
          \ = CLIPVisionModelWithProjection.from_pretrained(\"laion/CLIP-ViT-bigG-14-laion2B-39B-b160k\"\
          , ignore_mismatched_sizes=True)\n</code></pre>\n"
        raw: "I'm trying to use ip adapters with sdxl_turbo (which seem to both have\
          \ a sdxl 1.0 checkpoint as their base). I'm doing the following: \r\n\r\n\
          ```\r\npipe = DiffusionPipeline.from_pretrained(\"stabilityai/sdxl-turbo\"\
          , torch_dtype=torch.float16) \r\npipe.vae = AutoencoderTiny.from_pretrained(\"\
          madebyollin/taesdxl\", torch_dtype=torch.float16)\r\n\r\nadapter_id = \"\
          ip-adapter-plus-face_sdxl_vit-h.bin\"\r\npipe.load_ip_adapter(\"h94/IP-Adapter\"\
          , subfolder=\"sdxl_models\", weight_name=adapter_id)\r\n```\r\n\r\nthis\
          \ gives me the following error: \r\n\r\n```\r\nKeyError                \
          \                  Traceback (most recent call last)\r\nCell In[14], line\
          \ 2\r\n      1 adapter_id = \"ip-adapter-plus-face_sdxl_vit-h.bin\"\r\n\
          ----> 2 pipe.load_ip_adapter(\"h94/IP-Adapter\", subfolder=\"sdxl_models\"\
          , weight_name=adapter_id)\r\n\r\nFile ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/ip_adapter.py:152,\
          \ in IPAdapterMixin.load_ip_adapter(self, pretrained_model_name_or_path_or_dict,\
          \ subfolder, weight_name, **kwargs)\r\n    149     self.feature_extractor\
          \ = CLIPImageProcessor()\r\n    151 # load ip-adapter into unet\r\n--> 152\
          \ self.unet._load_ip_adapter_weights(state_dict)\r\n\r\nFile ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/unet.py:711,\
          \ in UNet2DConditionLoadersMixin._load_ip_adapter_weights(self, state_dict)\r\
          \n    708 self.set_attn_processor(attn_procs)\r\n    710 # create image\
          \ projection layers.\r\n--> 711 clip_embeddings_dim = state_dict[\"image_proj\"\
          ][\"proj.weight\"].shape[-1]\r\n    712 cross_attention_dim = state_dict[\"\
          image_proj\"][\"proj.weight\"].shape[0] // 4\r\n    714 image_projection\
          \ = ImageProjection(\r\n    715     cross_attention_dim=cross_attention_dim,\
          \ image_embed_dim=clip_embeddings_dim, num_image_text_embeds=4\r\n    716\
          \ )\r\n\r\nKeyError: 'proj.weight'\r\n\r\n```\r\n\r\nI've also tried setting\
          \ the image encoder to the one mentioned in the IP-Adapters repo, but it\
          \ still gives the same error. Any idea how to fix? Or is SDXL_turbo not\
          \ supported yet?\r\n\r\ne.g. \r\n\r\n```\r\n#I've also tried the non-large\
          \ version but still get the same result...\r\npipe.image_encoder = CLIPVisionModelWithProjection.from_pretrained(\"\
          laion/CLIP-ViT-bigG-14-laion2B-39B-b160k\", ignore_mismatched_sizes=True)\r\
          \n```"
        updatedAt: '2023-12-11T16:28:28.564Z'
      numEdits: 0
      reactions: []
    id: 657738acc991ca09567784a3
    type: comment
  author: Zubi401
  content: "I'm trying to use ip adapters with sdxl_turbo (which seem to both have\
    \ a sdxl 1.0 checkpoint as their base). I'm doing the following: \r\n\r\n```\r\
    \npipe = DiffusionPipeline.from_pretrained(\"stabilityai/sdxl-turbo\", torch_dtype=torch.float16)\
    \ \r\npipe.vae = AutoencoderTiny.from_pretrained(\"madebyollin/taesdxl\", torch_dtype=torch.float16)\r\
    \n\r\nadapter_id = \"ip-adapter-plus-face_sdxl_vit-h.bin\"\r\npipe.load_ip_adapter(\"\
    h94/IP-Adapter\", subfolder=\"sdxl_models\", weight_name=adapter_id)\r\n```\r\n\
    \r\nthis gives me the following error: \r\n\r\n```\r\nKeyError               \
    \                   Traceback (most recent call last)\r\nCell In[14], line 2\r\
    \n      1 adapter_id = \"ip-adapter-plus-face_sdxl_vit-h.bin\"\r\n----> 2 pipe.load_ip_adapter(\"\
    h94/IP-Adapter\", subfolder=\"sdxl_models\", weight_name=adapter_id)\r\n\r\nFile\
    \ ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/ip_adapter.py:152,\
    \ in IPAdapterMixin.load_ip_adapter(self, pretrained_model_name_or_path_or_dict,\
    \ subfolder, weight_name, **kwargs)\r\n    149     self.feature_extractor = CLIPImageProcessor()\r\
    \n    151 # load ip-adapter into unet\r\n--> 152 self.unet._load_ip_adapter_weights(state_dict)\r\
    \n\r\nFile ~/miniconda3/envs/sd_diff/lib/python3.10/site-packages/diffusers/loaders/unet.py:711,\
    \ in UNet2DConditionLoadersMixin._load_ip_adapter_weights(self, state_dict)\r\n\
    \    708 self.set_attn_processor(attn_procs)\r\n    710 # create image projection\
    \ layers.\r\n--> 711 clip_embeddings_dim = state_dict[\"image_proj\"][\"proj.weight\"\
    ].shape[-1]\r\n    712 cross_attention_dim = state_dict[\"image_proj\"][\"proj.weight\"\
    ].shape[0] // 4\r\n    714 image_projection = ImageProjection(\r\n    715    \
    \ cross_attention_dim=cross_attention_dim, image_embed_dim=clip_embeddings_dim,\
    \ num_image_text_embeds=4\r\n    716 )\r\n\r\nKeyError: 'proj.weight'\r\n\r\n\
    ```\r\n\r\nI've also tried setting the image encoder to the one mentioned in the\
    \ IP-Adapters repo, but it still gives the same error. Any idea how to fix? Or\
    \ is SDXL_turbo not supported yet?\r\n\r\ne.g. \r\n\r\n```\r\n#I've also tried\
    \ the non-large version but still get the same result...\r\npipe.image_encoder\
    \ = CLIPVisionModelWithProjection.from_pretrained(\"laion/CLIP-ViT-bigG-14-laion2B-39B-b160k\"\
    , ignore_mismatched_sizes=True)\r\n```"
  created_at: 2023-12-11 16:28:28+00:00
  edited: false
  hidden: false
  id: 657738acc991ca09567784a3
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/643cb43e6eeb746f5ad81c26/_DUtzHpNtpTeDw7u0oYyX.png?w=200&h=200&f=face
      fullname: Jaret Burkett
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ostris
      type: user
    createdAt: '2023-12-22T22:35:08.000Z'
    data:
      edited: false
      editors:
      - ostris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8643621802330017
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/643cb43e6eeb746f5ad81c26/_DUtzHpNtpTeDw7u0oYyX.png?w=200&h=200&f=face
          fullname: Jaret Burkett
          isHf: false
          isPro: false
          name: ostris
          type: user
        html: '<p>Use the CLIP from the <code>models</code> folder. It is VIT-H. <a
          href="https://huggingface.co/h94/IP-Adapter/tree/main/models/image_encoder">https://huggingface.co/h94/IP-Adapter/tree/main/models/image_encoder</a>
          . It should work with all the vit-h sdxl ones. You need to do the same on
          comfy as well. </p>

          '
        raw: 'Use the CLIP from the `models` folder. It is VIT-H. https://huggingface.co/h94/IP-Adapter/tree/main/models/image_encoder
          . It should work with all the vit-h sdxl ones. You need to do the same on
          comfy as well. '
        updatedAt: '2023-12-22T22:35:08.236Z'
      numEdits: 0
      reactions: []
    id: 65860f1cce38d143c4ecc639
    type: comment
  author: ostris
  content: 'Use the CLIP from the `models` folder. It is VIT-H. https://huggingface.co/h94/IP-Adapter/tree/main/models/image_encoder
    . It should work with all the vit-h sdxl ones. You need to do the same on comfy
    as well. '
  created_at: 2023-12-22 22:35:08+00:00
  edited: false
  hidden: false
  id: 65860f1cce38d143c4ecc639
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 21
repo_id: h94/IP-Adapter
repo_type: model
status: open
target_branch: null
title: Using IP-Adapters sdxl with sdxl-turbo? Not working?
