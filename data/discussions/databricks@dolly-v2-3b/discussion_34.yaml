!!python/object:huggingface_hub.community.DiscussionWithDetails
author: deepthoughts
conflicting_files: null
created_at: 2023-07-03 13:23:08+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/f6d371ce1aa070f1d7672e01cc5e1d9a.svg
      fullname: Petar Angelov
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: deepthoughts
      type: user
    createdAt: '2023-07-03T14:23:08.000Z'
    data:
      edited: false
      editors:
      - deepthoughts
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.5583210587501526
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/f6d371ce1aa070f1d7672e01cc5e1d9a.svg
          fullname: Petar Angelov
          isHf: false
          isPro: false
          name: deepthoughts
          type: user
        html: "<p>I am executing the following command to train a model and I am getting\
          \ the following error which does not make sense because I have nearly 60GB\
          \ free ram. The require RAM that fails to be allocated is only 4gb and I\
          \ can see my RAM usage and it's definitely way lower than what's available.</p>\n\
          <p>The error is in the cpu_adam.py file:</p>\n<p>Command:</p>\n<p><code>deepspeed\
          \ --num_gpus=1 --module training.trainer --deepspeed config/v100_config.json\
          \ --local-output-dir testOutputDir --per-device-train-batch-size 2 --input-model\
          \ EleutherAI/pythia-2.8b --logging-steps 10 --save-steps 200 --save-total-limit\
          \ 20 --eval-steps 50 --warmup-steps 50^C-test-size 200 --lr 5e-6 --epochs\
          \ 2</code></p>\n<p>Error</p>\n<pre><code>...\nTime to load utils op: 0.16718578338623047\
          \ seconds\nParameter Offload: Total persistent parameters: 1070080 in 258\
          \ params\n..\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
          , line 1649, in train\n    ignore_keys_for_eval=ignore_keys_for_eval,\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
          , line 1760, in _inner_training_loop\n    self.model, self.optimizer, self.lr_scheduler\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
          , line 1178, in prepare\n    result = self._prepare_deepspeed(*args)\n \
          \ File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
          , line 1505, in _prepare_deepspeed\n    engine, optimizer, _, lr_scheduler\
          \ = deepspeed.initialize(**kwargs)\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/__init__.py\"\
          , line 135, in initialize\n    config_params=config_params)\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 340, in __init__\n    self._configure_optimizer(optimizer, model_parameters)\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 1298, in _configure_optimizer\n    self.optimizer = self._configure_zero_optimizer(basic_optimizer)\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 1626, in _configure_zero_optimizer\n    communication_data_type=self.communication_data_type)\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 312, in __init__\n    self._setup_for_real_optimizer()\n  File \"\
          /home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 371, in _setup_for_real_optimizer\n    self.initialize_optimizer_states()\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 938, in initialize_optimizer_states\n    self._optimizer_step(i)\n\
          \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 858, in _optimizer_step\n    self.optimizer.step()\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/torch/optim/optimizer.py\"\
          , line 140, in wrapper\n    out = func(*args, **kwargs)\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/torch/autograd/grad_mode.py\"\
          , line 27, in decorate_context\n    return func(*args, **kwargs)\n  File\
          \ \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/ops/adam/cpu_adam.py\"\
          , line 178, in step\n    device=device)\nRuntimeError: [enforce fail at\
          \ alloc_cpu.cpp:75] err == 0. DefaultCPUAllocator: can't allocate memory:\
          \ you tried to allocate 4012482560 bytes. Error code 12 (Cannot allocate\
          \ memory)```\n</code></pre>\n"
        raw: "I am executing the following command to train a model and I am getting\
          \ the following error which does not make sense because I have nearly 60GB\
          \ free ram. The require RAM that fails to be allocated is only 4gb and I\
          \ can see my RAM usage and it's definitely way lower than what's available.\r\
          \n\r\n\r\nThe error is in the cpu_adam.py file:\r\n\r\nCommand:\r\n\r\n\
          ```deepspeed --num_gpus=1 --module training.trainer --deepspeed config/v100_config.json\
          \ --local-output-dir testOutputDir --per-device-train-batch-size 2 --input-model\
          \ EleutherAI/pythia-2.8b --logging-steps 10 --save-steps 200 --save-total-limit\
          \ 20 --eval-steps 50 --warmup-steps 50^C-test-size 200 --lr 5e-6 --epochs\
          \ 2```\r\n\r\nError\r\n\r\n```\r\n...\r\nTime to load utils op: 0.16718578338623047\
          \ seconds\r\nParameter Offload: Total persistent parameters: 1070080 in\
          \ 258 params\r\n..\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
          , line 1649, in train\r\n    ignore_keys_for_eval=ignore_keys_for_eval,\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
          , line 1760, in _inner_training_loop\r\n    self.model, self.optimizer,\
          \ self.lr_scheduler\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
          , line 1178, in prepare\r\n    result = self._prepare_deepspeed(*args)\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
          , line 1505, in _prepare_deepspeed\r\n    engine, optimizer, _, lr_scheduler\
          \ = deepspeed.initialize(**kwargs)\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/__init__.py\"\
          , line 135, in initialize\r\n    config_params=config_params)\r\n  File\
          \ \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 340, in __init__\r\n    self._configure_optimizer(optimizer, model_parameters)\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 1298, in _configure_optimizer\r\n    self.optimizer = self._configure_zero_optimizer(basic_optimizer)\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
          , line 1626, in _configure_zero_optimizer\r\n    communication_data_type=self.communication_data_type)\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 312, in __init__\r\n    self._setup_for_real_optimizer()\r\n  File\
          \ \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 371, in _setup_for_real_optimizer\r\n    self.initialize_optimizer_states()\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 938, in initialize_optimizer_states\r\n    self._optimizer_step(i)\r\
          \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
          , line 858, in _optimizer_step\r\n    self.optimizer.step()\r\n  File \"\
          /home/admin/train-dolly/env/lib/python3.7/site-packages/torch/optim/optimizer.py\"\
          , line 140, in wrapper\r\n    out = func(*args, **kwargs)\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/torch/autograd/grad_mode.py\"\
          , line 27, in decorate_context\r\n    return func(*args, **kwargs)\r\n \
          \ File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/ops/adam/cpu_adam.py\"\
          , line 178, in step\r\n    device=device)\r\nRuntimeError: [enforce fail\
          \ at alloc_cpu.cpp:75] err == 0. DefaultCPUAllocator: can't allocate memory:\
          \ you tried to allocate 4012482560 bytes. Error code 12 (Cannot allocate\
          \ memory)```\r\n"
        updatedAt: '2023-07-03T14:23:08.732Z'
      numEdits: 0
      reactions: []
    id: 64a2d9cc5d82c84b0d67f069
    type: comment
  author: deepthoughts
  content: "I am executing the following command to train a model and I am getting\
    \ the following error which does not make sense because I have nearly 60GB free\
    \ ram. The require RAM that fails to be allocated is only 4gb and I can see my\
    \ RAM usage and it's definitely way lower than what's available.\r\n\r\n\r\nThe\
    \ error is in the cpu_adam.py file:\r\n\r\nCommand:\r\n\r\n```deepspeed --num_gpus=1\
    \ --module training.trainer --deepspeed config/v100_config.json --local-output-dir\
    \ testOutputDir --per-device-train-batch-size 2 --input-model EleutherAI/pythia-2.8b\
    \ --logging-steps 10 --save-steps 200 --save-total-limit 20 --eval-steps 50 --warmup-steps\
    \ 50^C-test-size 200 --lr 5e-6 --epochs 2```\r\n\r\nError\r\n\r\n```\r\n...\r\n\
    Time to load utils op: 0.16718578338623047 seconds\r\nParameter Offload: Total\
    \ persistent parameters: 1070080 in 258 params\r\n..\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
    , line 1649, in train\r\n    ignore_keys_for_eval=ignore_keys_for_eval,\r\n  File\
    \ \"/home/admin/train-dolly/env/lib/python3.7/site-packages/transformers/trainer.py\"\
    , line 1760, in _inner_training_loop\r\n    self.model, self.optimizer, self.lr_scheduler\r\
    \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
    , line 1178, in prepare\r\n    result = self._prepare_deepspeed(*args)\r\n  File\
    \ \"/home/admin/train-dolly/env/lib/python3.7/site-packages/accelerate/accelerator.py\"\
    , line 1505, in _prepare_deepspeed\r\n    engine, optimizer, _, lr_scheduler =\
    \ deepspeed.initialize(**kwargs)\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/__init__.py\"\
    , line 135, in initialize\r\n    config_params=config_params)\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
    , line 340, in __init__\r\n    self._configure_optimizer(optimizer, model_parameters)\r\
    \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
    , line 1298, in _configure_optimizer\r\n    self.optimizer = self._configure_zero_optimizer(basic_optimizer)\r\
    \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/engine.py\"\
    , line 1626, in _configure_zero_optimizer\r\n    communication_data_type=self.communication_data_type)\r\
    \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
    , line 312, in __init__\r\n    self._setup_for_real_optimizer()\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
    , line 371, in _setup_for_real_optimizer\r\n    self.initialize_optimizer_states()\r\
    \n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
    , line 938, in initialize_optimizer_states\r\n    self._optimizer_step(i)\r\n\
    \  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/runtime/zero/stage3.py\"\
    , line 858, in _optimizer_step\r\n    self.optimizer.step()\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/torch/optim/optimizer.py\"\
    , line 140, in wrapper\r\n    out = func(*args, **kwargs)\r\n  File \"/home/admin/train-dolly/env/lib/python3.7/site-packages/torch/autograd/grad_mode.py\"\
    , line 27, in decorate_context\r\n    return func(*args, **kwargs)\r\n  File \"\
    /home/admin/train-dolly/env/lib/python3.7/site-packages/deepspeed/ops/adam/cpu_adam.py\"\
    , line 178, in step\r\n    device=device)\r\nRuntimeError: [enforce fail at alloc_cpu.cpp:75]\
    \ err == 0. DefaultCPUAllocator: can't allocate memory: you tried to allocate\
    \ 4012482560 bytes. Error code 12 (Cannot allocate memory)```\r\n"
  created_at: 2023-07-03 13:23:08+00:00
  edited: false
  hidden: false
  id: 64a2d9cc5d82c84b0d67f069
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/63050fbfce6b12280b1e2976/2lJphRSgdt9B_5YAQ1SIs.jpeg?w=200&h=200&f=face
      fullname: Sean Owen
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: srowen
      type: user
    createdAt: '2023-07-03T15:08:59.000Z'
    data:
      edited: false
      editors:
      - srowen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9906346797943115
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/63050fbfce6b12280b1e2976/2lJphRSgdt9B_5YAQ1SIs.jpeg?w=200&h=200&f=face
          fullname: Sean Owen
          isHf: false
          isPro: false
          name: srowen
          type: user
        html: '<p>Looks like you''re using CPU offload but just don''t have enough
          RAM. Consider how much RAM the model and weights need just to load, and
          per worker. 60GB probably isn''t enough. But you really want GPUs here anyway,
          isn''t worth it in CPU.</p>

          '
        raw: Looks like you're using CPU offload but just don't have enough RAM. Consider
          how much RAM the model and weights need just to load, and per worker. 60GB
          probably isn't enough. But you really want GPUs here anyway, isn't worth
          it in CPU.
        updatedAt: '2023-07-03T15:08:59.081Z'
      numEdits: 0
      reactions: []
    id: 64a2e48bd05c79e4f554b22a
    type: comment
  author: srowen
  content: Looks like you're using CPU offload but just don't have enough RAM. Consider
    how much RAM the model and weights need just to load, and per worker. 60GB probably
    isn't enough. But you really want GPUs here anyway, isn't worth it in CPU.
  created_at: 2023-07-03 14:08:59+00:00
  edited: false
  hidden: false
  id: 64a2e48bd05c79e4f554b22a
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/63050fbfce6b12280b1e2976/2lJphRSgdt9B_5YAQ1SIs.jpeg?w=200&h=200&f=face
      fullname: Sean Owen
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: srowen
      type: user
    createdAt: '2023-07-15T16:03:17.000Z'
    data:
      status: closed
    id: 64b2c3455e1230a79f9282bc
    type: status-change
  author: srowen
  created_at: 2023-07-15 15:03:17+00:00
  id: 64b2c3455e1230a79f9282bc
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 34
repo_id: databricks/dolly-v2-3b
repo_type: model
status: closed
target_branch: null
title: '60GB of RAM but getting RuntimeError: [enforce fail at alloc_cpu.cpp:75] err
  == 0. DefaultCPUAllocator: can''t allocate memory'
