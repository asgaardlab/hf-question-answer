!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Weiguo
conflicting_files: null
created_at: 2023-08-04 00:59:25+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
      fullname: Weiguo Liao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Weiguo
      type: user
    createdAt: '2023-08-04T01:59:25.000Z'
    data:
      edited: false
      editors:
      - Weiguo
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.9996402859687805
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
          fullname: Weiguo Liao
          isHf: false
          isPro: false
          name: Weiguo
          type: user
        html: "<p>\u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\u5427</p>\n"
        raw: "\u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\u5427"
        updatedAt: '2023-08-04T01:59:25.205Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F91D"
        users:
        - RabbitCheese
      - count: 1
        reaction: "\U0001F44D"
        users:
        - itkingtao
    id: 64cc5b7da257a3212c163191
    type: comment
  author: Weiguo
  content: "\u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\u5427"
  created_at: 2023-08-04 00:59:25+00:00
  edited: false
  hidden: false
  id: 64cc5b7da257a3212c163191
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/d363c346fb4f857a12596700ac1e5634.svg
      fullname: Kaisheng He
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: Hekaisheng
      type: user
    createdAt: '2023-08-04T03:36:31.000Z'
    data:
      edited: false
      editors:
      - Hekaisheng
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8089509010314941
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/d363c346fb4f857a12596700ac1e5634.svg
          fullname: Kaisheng He
          isHf: false
          isPro: false
          name: Hekaisheng
          type: user
        html: '<p>Try xinference(<a rel="nofollow" href="https://github.com/xorbitsai/inference">https://github.com/xorbitsai/inference</a>),
          it has supported qwen and generate in stream.</p>

          '
        raw: Try xinference(https://github.com/xorbitsai/inference), it has supported
          qwen and generate in stream.
        updatedAt: '2023-08-04T03:36:31.039Z'
      numEdits: 0
      reactions: []
    id: 64cc723fe60d2cddfad7e436
    type: comment
  author: Hekaisheng
  content: Try xinference(https://github.com/xorbitsai/inference), it has supported
    qwen and generate in stream.
  created_at: 2023-08-04 02:36:31+00:00
  edited: false
  hidden: false
  id: 64cc723fe60d2cddfad7e436
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
      fullname: Huajian Mao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: huajianmao
      type: user
    createdAt: '2023-08-04T04:07:54.000Z'
    data:
      edited: false
      editors:
      - huajianmao
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.37745505571365356
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
          fullname: Huajian Mao
          isHf: false
          isPro: false
          name: huajianmao
          type: user
        html: "<pre><code class=\"language-diff\"><span class=\"hljs-comment\">diff\
          \ --git a/modeling_qwen.py b/modeling_qwen.py</span>\n<span class=\"hljs-comment\"\
          >index cc58746..a0361d9 100644</span>\n<span class=\"hljs-comment\">---\
          \ a/modeling_qwen.py</span>\n<span class=\"hljs-comment\">+++ b/modeling_qwen.py</span>\n\
          <span class=\"hljs-meta\">@@ -883,6 +883,7 @@</span> class QWenLMHeadModel(QWenPreTrainedModel):\n\
          \         history: Optional[HistoryType],\n         system: str = \"You\
          \ are a helpful assistant.\",\n         append_history: bool = True,\n<span\
          \ class=\"hljs-addition\">+        stream: Optional[bool] = False,</span>\n\
          \     ) -&gt; Tuple[str, HistoryType]:\n \n         if history is None:\n\
          <span class=\"hljs-meta\">@@ -902,25 +903,39 @@</span> class QWenLMHeadModel(QWenPreTrainedModel):\n\
          \         )\n         input_ids = torch.tensor([context_tokens]).to(self.device)\n\
          \ \n<span class=\"hljs-deletion\">-        outputs = self.generate(</span>\n\
          <span class=\"hljs-deletion\">-            input_ids,</span>\n<span class=\"\
          hljs-deletion\">-            stop_words_ids=stop_words_ids,</span>\n<span\
          \ class=\"hljs-deletion\">-            return_dict_in_generate=False,</span>\n\
          <span class=\"hljs-deletion\">-        )</span>\n<span class=\"hljs-addition\"\
          >+        if stream:</span>\n<span class=\"hljs-addition\">+           \
          \ from transformers_stream_generator.main import NewGenerationMixin, StreamGenerationConfig</span>\n\
          <span class=\"hljs-addition\">+            self.__class__.generate = NewGenerationMixin.generate</span>\n\
          <span class=\"hljs-addition\">+            self.__class__.sample_stream\
          \ = NewGenerationMixin.sample_stream</span>\n<span class=\"hljs-addition\"\
          >+            stream_config = StreamGenerationConfig(**self.generation_config.to_dict(),\
          \ do_stream=True)</span>\n \n<span class=\"hljs-deletion\">-        response\
          \ = decode_tokens(</span>\n<span class=\"hljs-deletion\">-            outputs[0],</span>\n\
          <span class=\"hljs-deletion\">-            tokenizer,</span>\n<span class=\"\
          hljs-deletion\">-            raw_text_len=len(raw_text),</span>\n<span class=\"\
          hljs-deletion\">-            context_length=len(context_tokens),</span>\n\
          <span class=\"hljs-deletion\">-            chat_format=self.generation_config.chat_format,</span>\n\
          <span class=\"hljs-deletion\">-            verbose=False,</span>\n<span\
          \ class=\"hljs-deletion\">-        )</span>\n<span class=\"hljs-addition\"\
          >+            def stream_generator():</span>\n<span class=\"hljs-addition\"\
          >+                outputs = []</span>\n<span class=\"hljs-addition\">+ \
          \               for token in self.generate(input_ids, stop_words_ids=stop_words_ids,\
          \ return_dict_in_generate=False, generation_config=stream_config):</span>\n\
          <span class=\"hljs-addition\">+                    outputs.append(token.item())</span>\n\
          <span class=\"hljs-addition\">+                    yield tokenizer.decode(outputs,\
          \ skip_special_tokens=True)</span>\n<span class=\"hljs-addition\">+</span>\n\
          <span class=\"hljs-addition\">+            return stream_generator()</span>\n\
          <span class=\"hljs-addition\">+        else:</span>\n<span class=\"hljs-addition\"\
          >+            outputs = self.generate(</span>\n<span class=\"hljs-addition\"\
          >+                input_ids,</span>\n<span class=\"hljs-addition\">+   \
          \             stop_words_ids=stop_words_ids,</span>\n<span class=\"hljs-addition\"\
          >+                return_dict_in_generate=False,</span>\n<span class=\"\
          hljs-addition\">+            )</span>\n<span class=\"hljs-addition\">+</span>\n\
          <span class=\"hljs-addition\">+            response = decode_tokens(</span>\n\
          <span class=\"hljs-addition\">+                outputs[0],</span>\n<span\
          \ class=\"hljs-addition\">+                tokenizer,</span>\n<span class=\"\
          hljs-addition\">+                raw_text_len=len(raw_text),</span>\n<span\
          \ class=\"hljs-addition\">+                context_length=len(context_tokens),</span>\n\
          <span class=\"hljs-addition\">+                chat_format=self.generation_config.chat_format,</span>\n\
          <span class=\"hljs-addition\">+                verbose=False,</span>\n<span\
          \ class=\"hljs-addition\">+            )</span>\n \n<span class=\"hljs-deletion\"\
          >-        if append_history:</span>\n<span class=\"hljs-deletion\">-   \
          \         history.append((query, response))</span>\n<span class=\"hljs-addition\"\
          >+            if append_history:</span>\n<span class=\"hljs-addition\">+\
          \                history.append((query, response))</span>\n \n<span class=\"\
          hljs-deletion\">-        return response, history</span>\n<span class=\"\
          hljs-addition\">+            return response, history</span>\n \n     def\
          \ generate(\n         self,\n</code></pre>\n"
        raw: "``` diff\ndiff --git a/modeling_qwen.py b/modeling_qwen.py\nindex cc58746..a0361d9\
          \ 100644\n--- a/modeling_qwen.py\n+++ b/modeling_qwen.py\n@@ -883,6 +883,7\
          \ @@ class QWenLMHeadModel(QWenPreTrainedModel):\n         history: Optional[HistoryType],\n\
          \         system: str = \"You are a helpful assistant.\",\n         append_history:\
          \ bool = True,\n+        stream: Optional[bool] = False,\n     ) -> Tuple[str,\
          \ HistoryType]:\n \n         if history is None:\n@@ -902,25 +903,39 @@\
          \ class QWenLMHeadModel(QWenPreTrainedModel):\n         )\n         input_ids\
          \ = torch.tensor([context_tokens]).to(self.device)\n \n-        outputs\
          \ = self.generate(\n-            input_ids,\n-            stop_words_ids=stop_words_ids,\n\
          -            return_dict_in_generate=False,\n-        )\n+        if stream:\n\
          +            from transformers_stream_generator.main import NewGenerationMixin,\
          \ StreamGenerationConfig\n+            self.__class__.generate = NewGenerationMixin.generate\n\
          +            self.__class__.sample_stream = NewGenerationMixin.sample_stream\n\
          +            stream_config = StreamGenerationConfig(**self.generation_config.to_dict(),\
          \ do_stream=True)\n \n-        response = decode_tokens(\n-            outputs[0],\n\
          -            tokenizer,\n-            raw_text_len=len(raw_text),\n-   \
          \         context_length=len(context_tokens),\n-            chat_format=self.generation_config.chat_format,\n\
          -            verbose=False,\n-        )\n+            def stream_generator():\n\
          +                outputs = []\n+                for token in self.generate(input_ids,\
          \ stop_words_ids=stop_words_ids, return_dict_in_generate=False, generation_config=stream_config):\n\
          +                    outputs.append(token.item())\n+                   \
          \ yield tokenizer.decode(outputs, skip_special_tokens=True)\n+\n+      \
          \      return stream_generator()\n+        else:\n+            outputs =\
          \ self.generate(\n+                input_ids,\n+                stop_words_ids=stop_words_ids,\n\
          +                return_dict_in_generate=False,\n+            )\n+\n+  \
          \          response = decode_tokens(\n+                outputs[0],\n+  \
          \              tokenizer,\n+                raw_text_len=len(raw_text),\n\
          +                context_length=len(context_tokens),\n+                chat_format=self.generation_config.chat_format,\n\
          +                verbose=False,\n+            )\n \n-        if append_history:\n\
          -            history.append((query, response))\n+            if append_history:\n\
          +                history.append((query, response))\n \n-        return response,\
          \ history\n+            return response, history\n \n     def generate(\n\
          \         self,\n```"
        updatedAt: '2023-08-04T04:07:54.158Z'
      numEdits: 0
      reactions:
      - count: 3
        reaction: "\U0001F44D"
        users:
        - tonic886
        - leong7
        - huajianmao
    id: 64cc799a7a4f23635746ffed
    type: comment
  author: huajianmao
  content: "``` diff\ndiff --git a/modeling_qwen.py b/modeling_qwen.py\nindex cc58746..a0361d9\
    \ 100644\n--- a/modeling_qwen.py\n+++ b/modeling_qwen.py\n@@ -883,6 +883,7 @@\
    \ class QWenLMHeadModel(QWenPreTrainedModel):\n         history: Optional[HistoryType],\n\
    \         system: str = \"You are a helpful assistant.\",\n         append_history:\
    \ bool = True,\n+        stream: Optional[bool] = False,\n     ) -> Tuple[str,\
    \ HistoryType]:\n \n         if history is None:\n@@ -902,25 +903,39 @@ class\
    \ QWenLMHeadModel(QWenPreTrainedModel):\n         )\n         input_ids = torch.tensor([context_tokens]).to(self.device)\n\
    \ \n-        outputs = self.generate(\n-            input_ids,\n-            stop_words_ids=stop_words_ids,\n\
    -            return_dict_in_generate=False,\n-        )\n+        if stream:\n\
    +            from transformers_stream_generator.main import NewGenerationMixin,\
    \ StreamGenerationConfig\n+            self.__class__.generate = NewGenerationMixin.generate\n\
    +            self.__class__.sample_stream = NewGenerationMixin.sample_stream\n\
    +            stream_config = StreamGenerationConfig(**self.generation_config.to_dict(),\
    \ do_stream=True)\n \n-        response = decode_tokens(\n-            outputs[0],\n\
    -            tokenizer,\n-            raw_text_len=len(raw_text),\n-         \
    \   context_length=len(context_tokens),\n-            chat_format=self.generation_config.chat_format,\n\
    -            verbose=False,\n-        )\n+            def stream_generator():\n\
    +                outputs = []\n+                for token in self.generate(input_ids,\
    \ stop_words_ids=stop_words_ids, return_dict_in_generate=False, generation_config=stream_config):\n\
    +                    outputs.append(token.item())\n+                    yield\
    \ tokenizer.decode(outputs, skip_special_tokens=True)\n+\n+            return\
    \ stream_generator()\n+        else:\n+            outputs = self.generate(\n\
    +                input_ids,\n+                stop_words_ids=stop_words_ids,\n\
    +                return_dict_in_generate=False,\n+            )\n+\n+        \
    \    response = decode_tokens(\n+                outputs[0],\n+              \
    \  tokenizer,\n+                raw_text_len=len(raw_text),\n+               \
    \ context_length=len(context_tokens),\n+                chat_format=self.generation_config.chat_format,\n\
    +                verbose=False,\n+            )\n \n-        if append_history:\n\
    -            history.append((query, response))\n+            if append_history:\n\
    +                history.append((query, response))\n \n-        return response,\
    \ history\n+            return response, history\n \n     def generate(\n    \
    \     self,\n```"
  created_at: 2023-08-04 03:07:54+00:00
  edited: false
  hidden: false
  id: 64cc799a7a4f23635746ffed
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
      fullname: Weiguo Liao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Weiguo
      type: user
    createdAt: '2023-08-04T04:56:36.000Z'
    data:
      edited: false
      editors:
      - Weiguo
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.9963746070861816
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
          fullname: Weiguo Liao
          isHf: false
          isPro: false
          name: Weiguo
          type: user
        html: "<p>\u8C22\u8C22</p>\n"
        raw: "\u8C22\u8C22"
        updatedAt: '2023-08-04T04:56:36.686Z'
      numEdits: 0
      reactions: []
    id: 64cc8504eed22517ae12c75c
    type: comment
  author: Weiguo
  content: "\u8C22\u8C22"
  created_at: 2023-08-04 03:56:36+00:00
  edited: false
  hidden: false
  id: 64cc8504eed22517ae12c75c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
      fullname: Weiguo Liao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Weiguo
      type: user
    createdAt: '2023-08-04T05:32:00.000Z'
    data:
      edited: false
      editors:
      - Weiguo
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.9981041550636292
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
          fullname: Weiguo Liao
          isHf: false
          isPro: false
          name: Weiguo
          type: user
        html: "<p>\u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB</p>\n"
        raw: "\u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB"
        updatedAt: '2023-08-04T05:32:00.794Z'
      numEdits: 0
      reactions: []
    id: 64cc8d502e592905f917fefd
    type: comment
  author: Weiguo
  content: "\u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB"
  created_at: 2023-08-04 04:32:00+00:00
  edited: false
  hidden: false
  id: 64cc8d502e592905f917fefd
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
      fullname: Huajian Mao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: huajianmao
      type: user
    createdAt: '2023-08-04T06:37:53.000Z'
    data:
      edited: false
      editors:
      - huajianmao
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.8119603991508484
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
          fullname: Huajian Mao
          isHf: false
          isPro: false
          name: huajianmao
          type: user
        html: "<blockquote>\n<p>\u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB</p>\n\
          </blockquote>\n<p>\u4E0D\u77E5\u9053\u5B98\u65B9\u4F1A\u600E\u4E48\u6539\
          \uFF0C\u4E0D\u4E00\u5B9A\u5408\u8FD9\u4E2A\u7248\u672C\u7684\u3002\u81EA\
          \u5DF1\u4E34\u65F6\u6027\u7528\u7684\u8BDD\uFF0C\u53EF\u4EE5\u6539<code>modeling_qwen.py</code>.</p>\n\
          <p>\u53E6\u5916\uFF0C<a href=\"https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979\"\
          >\u8FD9\u91CC</a>\u597D\u50CF\u6709\u4E2Abug\uFF0C<br>\u8FD9\u4E2A<code>if</code>\u6709\
          \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4<code>self._rotary_pos_emb_cache</code>\u4E3A\
          <code>None</code>.<br>\u6211\u76F4\u63A5\u66B4\u529B\u7684\u628Aif \u53BB\
          \u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\u8DD1 \U0001F60A</p>\n"
        raw: "> \u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB\n\n\u4E0D\u77E5\u9053\
          \u5B98\u65B9\u4F1A\u600E\u4E48\u6539\uFF0C\u4E0D\u4E00\u5B9A\u5408\u8FD9\
          \u4E2A\u7248\u672C\u7684\u3002\u81EA\u5DF1\u4E34\u65F6\u6027\u7528\u7684\
          \u8BDD\uFF0C\u53EF\u4EE5\u6539`modeling_qwen.py`.\n\n\u53E6\u5916\uFF0C\
          [\u8FD9\u91CC](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979)\u597D\
          \u50CF\u6709\u4E2Abug\uFF0C\n\u8FD9\u4E2A`if`\u6709\u65F6\u5019\u53EF\u80FD\
          \u4F1A\u5BFC\u81F4`self._rotary_pos_emb_cache`\u4E3A`None`.\n\u6211\u76F4\
          \u63A5\u66B4\u529B\u7684\u628Aif \u53BB\u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\
          \u8DD1 \U0001F60A"
        updatedAt: '2023-08-04T06:37:53.592Z'
      numEdits: 0
      reactions: []
    id: 64cc9cc1f0bf3b3b9db63629
    type: comment
  author: huajianmao
  content: "> \u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB\n\n\u4E0D\u77E5\u9053\
    \u5B98\u65B9\u4F1A\u600E\u4E48\u6539\uFF0C\u4E0D\u4E00\u5B9A\u5408\u8FD9\u4E2A\
    \u7248\u672C\u7684\u3002\u81EA\u5DF1\u4E34\u65F6\u6027\u7528\u7684\u8BDD\uFF0C\
    \u53EF\u4EE5\u6539`modeling_qwen.py`.\n\n\u53E6\u5916\uFF0C[\u8FD9\u91CC](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979)\u597D\
    \u50CF\u6709\u4E2Abug\uFF0C\n\u8FD9\u4E2A`if`\u6709\u65F6\u5019\u53EF\u80FD\u4F1A\
    \u5BFC\u81F4`self._rotary_pos_emb_cache`\u4E3A`None`.\n\u6211\u76F4\u63A5\u66B4\
    \u529B\u7684\u628Aif \u53BB\u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\u8DD1 \U0001F60A"
  created_at: 2023-08-04 05:37:53+00:00
  edited: false
  hidden: false
  id: 64cc9cc1f0bf3b3b9db63629
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
      fullname: Weiguo Liao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Weiguo
      type: user
    createdAt: '2023-08-04T09:12:39.000Z'
    data:
      edited: true
      editors:
      - Weiguo
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.6734284162521362
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/49eaab4e23945f6645cf69f78ce475e1.svg
          fullname: Weiguo Liao
          isHf: false
          isPro: false
          name: Weiguo
          type: user
        html: "<blockquote>\n<blockquote>\n<p>\u597D\u50CF\u6CA1\u6709\u5408\u5E76\
          \u8FDB\u53BB</p>\n</blockquote>\n<p>\u4E0D\u77E5\u9053\u5B98\u65B9\u4F1A\
          \u600E\u4E48\u6539\uFF0C\u4E0D\u4E00\u5B9A\u5408\u8FD9\u4E2A\u7248\u672C\
          \u7684\u3002\u81EA\u5DF1\u4E34\u65F6\u6027\u7528\u7684\u8BDD\uFF0C\u53EF\
          \u4EE5\u6539<code>modeling_qwen.py</code>.</p>\n<p>\u53E6\u5916\uFF0C<a\
          \ href=\"https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979\"\
          >\u8FD9\u91CC</a>\u597D\u50CF\u6709\u4E2Abug\uFF0C<br>\u8FD9\u4E2A<code>if</code>\u6709\
          \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4<code>self._rotary_pos_emb_cache</code>\u4E3A\
          <code>None</code>.<br>\u6211\u76F4\u63A5\u66B4\u529B\u7684\u628Aif \u53BB\
          \u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\u8DD1 \U0001F60A</p>\n</blockquote>\n\
          <p>\u8FD9\u4E2Astream chat\u4F1A\u51FA\u73B0\u4E00\u4E9B\u5947\u602A\u7684\
          \u8F93\u51FA</p>\n<p><a rel=\"nofollow\" href=\"https://cdn-uploads.huggingface.co/production/uploads/6340d124b78ed99eab034e85/M0oQ_xpkXNEnaiV56fKvg.png\"\
          ><img alt=\"\u622A\u56FE 2023-08-04 17-11-11.png\" src=\"https://cdn-uploads.huggingface.co/production/uploads/6340d124b78ed99eab034e85/M0oQ_xpkXNEnaiV56fKvg.png\"\
          ></a></p>\n<p>\u6211\u628A\u8F93\u51FA\u957F\u5EA6\u8C03\u6574\u4E86\u4E00\
          \u4E0B</p>\n<p>model.generation_config.max_context_size=2048<br>model.generation_config.max_generate_size=1024<br>model.generation_config.max_new_tokens=1024</p>\n"
        raw: "> > \u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB\n> \n> \u4E0D\u77E5\
          \u9053\u5B98\u65B9\u4F1A\u600E\u4E48\u6539\uFF0C\u4E0D\u4E00\u5B9A\u5408\
          \u8FD9\u4E2A\u7248\u672C\u7684\u3002\u81EA\u5DF1\u4E34\u65F6\u6027\u7528\
          \u7684\u8BDD\uFF0C\u53EF\u4EE5\u6539`modeling_qwen.py`.\n> \n> \u53E6\u5916\
          \uFF0C[\u8FD9\u91CC](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979)\u597D\
          \u50CF\u6709\u4E2Abug\uFF0C\n> \u8FD9\u4E2A`if`\u6709\u65F6\u5019\u53EF\u80FD\
          \u4F1A\u5BFC\u81F4`self._rotary_pos_emb_cache`\u4E3A`None`.\n> \u6211\u76F4\
          \u63A5\u66B4\u529B\u7684\u628Aif \u53BB\u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\
          \u8DD1 \U0001F60A\n\n\u8FD9\u4E2Astream chat\u4F1A\u51FA\u73B0\u4E00\u4E9B\
          \u5947\u602A\u7684\u8F93\u51FA\n\n\n![\u622A\u56FE 2023-08-04 17-11-11.png](https://cdn-uploads.huggingface.co/production/uploads/6340d124b78ed99eab034e85/M0oQ_xpkXNEnaiV56fKvg.png)\n\
          \n\u6211\u628A\u8F93\u51FA\u957F\u5EA6\u8C03\u6574\u4E86\u4E00\u4E0B\n\n\
          model.generation_config.max_context_size=2048\nmodel.generation_config.max_generate_size=1024\n\
          model.generation_config.max_new_tokens=1024\n"
        updatedAt: '2023-08-04T09:14:25.989Z'
      numEdits: 1
      reactions: []
    id: 64ccc10778fad0f5b6aeb0e0
    type: comment
  author: Weiguo
  content: "> > \u597D\u50CF\u6CA1\u6709\u5408\u5E76\u8FDB\u53BB\n> \n> \u4E0D\u77E5\
    \u9053\u5B98\u65B9\u4F1A\u600E\u4E48\u6539\uFF0C\u4E0D\u4E00\u5B9A\u5408\u8FD9\
    \u4E2A\u7248\u672C\u7684\u3002\u81EA\u5DF1\u4E34\u65F6\u6027\u7528\u7684\u8BDD\
    \uFF0C\u53EF\u4EE5\u6539`modeling_qwen.py`.\n> \n> \u53E6\u5916\uFF0C[\u8FD9\u91CC\
    ](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/62bf1c62d1c8979d99345b5279f0b3cb7c6d529a/modeling_qwen.py#L979)\u597D\
    \u50CF\u6709\u4E2Abug\uFF0C\n> \u8FD9\u4E2A`if`\u6709\u65F6\u5019\u53EF\u80FD\u4F1A\
    \u5BFC\u81F4`self._rotary_pos_emb_cache`\u4E3A`None`.\n> \u6211\u76F4\u63A5\u66B4\
    \u529B\u7684\u628Aif \u53BB\u6389\uFF0C\u597D\u50CF\u4E5F\u80FD\u8DD1 \U0001F60A\
    \n\n\u8FD9\u4E2Astream chat\u4F1A\u51FA\u73B0\u4E00\u4E9B\u5947\u602A\u7684\u8F93\
    \u51FA\n\n\n![\u622A\u56FE 2023-08-04 17-11-11.png](https://cdn-uploads.huggingface.co/production/uploads/6340d124b78ed99eab034e85/M0oQ_xpkXNEnaiV56fKvg.png)\n\
    \n\u6211\u628A\u8F93\u51FA\u957F\u5EA6\u8C03\u6574\u4E86\u4E00\u4E0B\n\nmodel.generation_config.max_context_size=2048\n\
    model.generation_config.max_generate_size=1024\nmodel.generation_config.max_new_tokens=1024\n"
  created_at: 2023-08-04 08:12:39+00:00
  edited: true
  hidden: false
  id: 64ccc10778fad0f5b6aeb0e0
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
      fullname: Huajian Mao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: huajianmao
      type: user
    createdAt: '2023-08-04T10:20:46.000Z'
    data:
      edited: false
      editors:
      - huajianmao
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.9950584173202515
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
          fullname: Huajian Mao
          isHf: false
          isPro: false
          name: huajianmao
          type: user
        html: "<p>\u7B49\u5B98\u65B9\u5427</p>\n"
        raw: "\u7B49\u5B98\u65B9\u5427"
        updatedAt: '2023-08-04T10:20:46.880Z'
      numEdits: 0
      reactions: []
    id: 64ccd0fe0bf3949c69368705
    type: comment
  author: huajianmao
  content: "\u7B49\u5B98\u65B9\u5427"
  created_at: 2023-08-04 09:20:46+00:00
  edited: false
  hidden: false
  id: 64ccd0fe0bf3949c69368705
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1644682834896-620760a26e3b7210c2ff1943.jpeg?w=200&h=200&f=face
      fullname: Junyang Lin
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: JustinLin610
      type: user
    createdAt: '2023-08-05T03:02:00.000Z'
    data:
      edited: false
      editors:
      - JustinLin610
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.2829354405403137
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1644682834896-620760a26e3b7210c2ff1943.jpeg?w=200&h=200&f=face
          fullname: Junyang Lin
          isHf: false
          isPro: false
          name: JustinLin610
          type: user
        html: "<p>\u5DF2\u7ECF\u66F4\u65B0\u4E86streaming\u8F93\u51FA\uFF0C\u793A\u4F8B\
          \u5728cli_demo.py</p>\n"
        raw: "\u5DF2\u7ECF\u66F4\u65B0\u4E86streaming\u8F93\u51FA\uFF0C\u793A\u4F8B\
          \u5728cli_demo.py"
        updatedAt: '2023-08-05T03:02:00.154Z'
      numEdits: 0
      reactions: []
    id: 64cdbba8484264a3b3a7d225
    type: comment
  author: JustinLin610
  content: "\u5DF2\u7ECF\u66F4\u65B0\u4E86streaming\u8F93\u51FA\uFF0C\u793A\u4F8B\u5728\
    cli_demo.py"
  created_at: 2023-08-05 02:02:00+00:00
  edited: false
  hidden: false
  id: 64cdbba8484264a3b3a7d225
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
      fullname: Huajian Mao
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: huajianmao
      type: user
    createdAt: '2023-08-05T07:41:26.000Z'
    data:
      edited: false
      editors:
      - huajianmao
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.4361477792263031
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/47dc6ef352db5324227d6cc85bfc026c.svg
          fullname: Huajian Mao
          isHf: false
          isPro: false
          name: huajianmao
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;JustinLin610&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/JustinLin610\"\
          >@<span class=\"underline\">JustinLin610</span></a></span>\n\n\t</span></span>\
          \  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\u5C0F\u95EE\u9898\
          \uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\u679C\u7B2C\u4E00\
          \u6761message\u662F<code>Hi</code>\uFF0C\u6709\u5F88\u5927\u6982\u7387\u4F1A\
          \u62A5\u9519\u3002<br><a href=\"https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093\"\
          >\u8FD9\u91CC\u7684<code>update_rotary_pos_emb_cache</code></a>\u6709\u65F6\
          \u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3ANone?</p>\n\
          <p><a rel=\"nofollow\" href=\"https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png\"\
          ><img alt=\"image.png\" src=\"https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png\"\
          ></a></p>\n"
        raw: "@JustinLin610  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\u5C0F\
          \u95EE\u9898\uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\u679C\
          \u7B2C\u4E00\u6761message\u662F`Hi`\uFF0C\u6709\u5F88\u5927\u6982\u7387\u4F1A\
          \u62A5\u9519\u3002\n[\u8FD9\u91CC\u7684`update_rotary_pos_emb_cache`](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093)\u6709\
          \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3A\
          None?\n\n![image.png](https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png)\n"
        updatedAt: '2023-08-05T07:41:26.359Z'
      numEdits: 0
      reactions: []
    id: 64cdfd26d2a781d3f0d54b3d
    type: comment
  author: huajianmao
  content: "@JustinLin610  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\u5C0F\
    \u95EE\u9898\uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\u679C\u7B2C\
    \u4E00\u6761message\u662F`Hi`\uFF0C\u6709\u5F88\u5927\u6982\u7387\u4F1A\u62A5\u9519\
    \u3002\n[\u8FD9\u91CC\u7684`update_rotary_pos_emb_cache`](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093)\u6709\
    \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3ANone?\n\
    \n![image.png](https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png)\n"
  created_at: 2023-08-05 06:41:26+00:00
  edited: false
  hidden: false
  id: 64cdfd26d2a781d3f0d54b3d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/7548b9e13e00ad1c080c32c05173fca4.svg
      fullname: walker
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: itkingtao
      type: user
    createdAt: '2023-08-06T14:49:44.000Z'
    data:
      edited: false
      editors:
      - itkingtao
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.7419478893280029
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/7548b9e13e00ad1c080c32c05173fca4.svg
          fullname: walker
          isHf: false
          isPro: false
          name: itkingtao
          type: user
        html: "<blockquote>\n<p>\u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\
          \u5427</p>\n</blockquote>\n<p>\u6211\u627E\u5230\u4E86\u8FD9\u4E2A\u5DE5\
          \u7A0B\u662F\u53EF\u4EE5\u76F4\u63A5\u8DD1stream\u7684<br><a rel=\"nofollow\"\
          \ href=\"https://github.com/xusenlinzy/api-for-open-llm/blob/master/docs/SCRIPT.md#qwen-7b-chat\"\
          >https://github.com/xusenlinzy/api-for-open-llm/blob/master/docs/SCRIPT.md#qwen-7b-chat</a></p>\n"
        raw: "> \u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\u5427\n\n\u6211\
          \u627E\u5230\u4E86\u8FD9\u4E2A\u5DE5\u7A0B\u662F\u53EF\u4EE5\u76F4\u63A5\
          \u8DD1stream\u7684\nhttps://github.com/xusenlinzy/api-for-open-llm/blob/master/docs/SCRIPT.md#qwen-7b-chat"
        updatedAt: '2023-08-06T14:49:44.279Z'
      numEdits: 0
      reactions: []
    id: 64cfb308bf39f9c8beb3c3a9
    type: comment
  author: itkingtao
  content: "> \u8FD9\u4E2A\u5E94\u8BE5\u662F\u57FA\u672C\u9700\u6C42\u5427\n\n\u6211\
    \u627E\u5230\u4E86\u8FD9\u4E2A\u5DE5\u7A0B\u662F\u53EF\u4EE5\u76F4\u63A5\u8DD1\
    stream\u7684\nhttps://github.com/xusenlinzy/api-for-open-llm/blob/master/docs/SCRIPT.md#qwen-7b-chat"
  created_at: 2023-08-06 13:49:44+00:00
  edited: false
  hidden: false
  id: 64cfb308bf39f9c8beb3c3a9
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1644682834896-620760a26e3b7210c2ff1943.jpeg?w=200&h=200&f=face
      fullname: Junyang Lin
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: JustinLin610
      type: user
    createdAt: '2023-08-08T17:05:34.000Z'
    data:
      edited: false
      editors:
      - JustinLin610
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.5732095241546631
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1644682834896-620760a26e3b7210c2ff1943.jpeg?w=200&h=200&f=face
          fullname: Junyang Lin
          isHf: false
          isPro: false
          name: JustinLin610
          type: user
        html: "<blockquote>\n<p><span data-props=\"{&quot;user&quot;:&quot;JustinLin610&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/JustinLin610\"\
          >@<span class=\"underline\">JustinLin610</span></a></span>\n\n\t</span></span>\
          \  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\u5C0F\u95EE\u9898\
          \uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\u679C\u7B2C\u4E00\
          \u6761message\u662F<code>Hi</code>\uFF0C\u6709\u5F88\u5927\u6982\u7387\u4F1A\
          \u62A5\u9519\u3002<br><a href=\"https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093\"\
          >\u8FD9\u91CC\u7684<code>update_rotary_pos_emb_cache</code></a>\u6709\u65F6\
          \u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3ANone?</p>\n\
          <p><a rel=\"nofollow\" href=\"https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png\"\
          ><img alt=\"image.png\" src=\"https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png\"\
          ></a></p>\n</blockquote>\n<p>\u76EE\u524D\u5DF2\u7ECF\u66F4\u65B0\u4E86\u5199\
          \u6CD5\uFF0C\u73B0\u5728\u7528\u7684\u662F\u65B0\u7684\u5206\u5F00\u5199\
          \u7684chat_stream\u7684</p>\n"
        raw: "> @JustinLin610  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\
          \u5C0F\u95EE\u9898\uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\
          \u679C\u7B2C\u4E00\u6761message\u662F`Hi`\uFF0C\u6709\u5F88\u5927\u6982\u7387\
          \u4F1A\u62A5\u9519\u3002\n> [\u8FD9\u91CC\u7684`update_rotary_pos_emb_cache`](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093)\u6709\
          \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3A\
          None?\n> \n> ![image.png](https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png)\n\
          \n\u76EE\u524D\u5DF2\u7ECF\u66F4\u65B0\u4E86\u5199\u6CD5\uFF0C\u73B0\u5728\
          \u7528\u7684\u662F\u65B0\u7684\u5206\u5F00\u5199\u7684chat_stream\u7684"
        updatedAt: '2023-08-08T17:05:34.217Z'
      numEdits: 0
      reactions: []
    id: 64d275de68438a91f3235f67
    type: comment
  author: JustinLin610
  content: "> @JustinLin610  streaming\u63A5\u53E3\u662F\u4E0D\u662F\u6709\u70B9\u5C0F\
    \u95EE\u9898\uFF0C\u7B2C\u4E00\u6B21chat\u7684\u65F6\u5019\uFF0C\u5982\u679C\u7B2C\
    \u4E00\u6761message\u662F`Hi`\uFF0C\u6709\u5F88\u5927\u6982\u7387\u4F1A\u62A5\u9519\
    \u3002\n> [\u8FD9\u91CC\u7684`update_rotary_pos_emb_cache`](https://huggingface.co/Qwen/Qwen-7B-Chat/blob/main/modeling_qwen.py#L1093)\u6709\
    \u65F6\u5019\u53EF\u80FD\u4F1A\u5BFC\u81F4self._rotary_pos_emb_cache\u4E3ANone?\n\
    > \n> ![image.png](https://cdn-uploads.huggingface.co/production/uploads/63fb2b500aab060792f5514c/OEmgEYvEZUoacIQ8PQraI.png)\n\
    \n\u76EE\u524D\u5DF2\u7ECF\u66F4\u65B0\u4E86\u5199\u6CD5\uFF0C\u73B0\u5728\u7528\
    \u7684\u662F\u65B0\u7684\u5206\u5F00\u5199\u7684chat_stream\u7684"
  created_at: 2023-08-08 16:05:34+00:00
  edited: false
  hidden: false
  id: 64d275de68438a91f3235f67
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1644682834896-620760a26e3b7210c2ff1943.jpeg?w=200&h=200&f=face
      fullname: Junyang Lin
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: JustinLin610
      type: user
    createdAt: '2023-08-09T08:51:55.000Z'
    data:
      status: closed
    id: 64d353abf41bdb1e2f6056c7
    type: status-change
  author: JustinLin610
  created_at: 2023-08-09 07:51:55+00:00
  id: 64d353abf41bdb1e2f6056c7
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 6
repo_id: Qwen/Qwen-7B-Chat
repo_type: model
status: closed
target_branch: null
title: "\u6709\u6CA1\u6709\u4EBA\u5199\u4E00\u4E2Astream_chat\uFF0C\u73B0\u5728\u7684\
  \u4F53\u9A8C\u6709\u70B9\u5DEE"
