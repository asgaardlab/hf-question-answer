!!python/object:huggingface_hub.community.DiscussionWithDetails
author: mbluetail
conflicting_files: null
created_at: 2022-08-30 12:58:00+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/397a318b159c0fdb15ca9bc848552d75.svg
      fullname: Maria Bruevich
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: mbluetail
      type: user
    createdAt: '2022-08-30T13:58:00.000Z'
    data:
      edited: false
      editors:
      - mbluetail
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/397a318b159c0fdb15ca9bc848552d75.svg
          fullname: Maria Bruevich
          isHf: false
          isPro: false
          name: mbluetail
          type: user
        html: "<p>I have a google's visual transformer model which  I have trained\
          \ in Tensorflow 2 and saved as an h5 file.</p>\n<pre><code># Base model\
          \ pre-trained on ImageNet-21k with the 224x224 image resolution\nbase_model\
          \ = TFViTModel.from_pretrained('google/vit-base-patch16-224-in21k')\n# Freeze\
          \ base model\nbase_model.trainable = False\n# Create new model\ninputs =\
          \ keras.Input(shape = (3, 224, 224))\nx = data_augmentation_vit(inputs)\n\
          \nvit = base_model.vit(inputs)[0]\nvit = keras.layers.GlobalAveragePooling1D()(vit)\n\
          vit = tf.keras.layers.Dense(256, activation='relu')(vit)\nvit = tf. keras.layers.Dropout(0.15)(vit)\n\
          outputs = tf.keras.layers.Dense(1, activation='sigmoid', name='outputs')(vit)\n\
          \nmodel_vit = tf.keras.Model(inputs, outputs)\nprint(model_vit.summary())\n\
          \nModel: \"model_1\"\n_________________________________________________________________\n\
          \ Layer (type)                Output Shape              Param #   \n=================================================================\n\
          \ input_2 (InputLayer)        [(None, 3, 224, 224)]     0         \n   \
          \                                                              \n vit (TFViTMainLayer)\
          \        TFBaseModelOutputWithPoo  86389248  \n                        \
          \     ling(last_hidden_state=(            \n                           \
          \  None, 197, 768),                    \n                              pooler_output=(None,\
          \ 76            \n                             8),                     \
          \            \n                              hidden_states=None, att   \
          \         \n                             entions=None)                 \
          \      \n                                                              \
          \   \n global_average_pooling1d (G  (None, 768)              0         \n\
          \ lobalAveragePooling1D)                                          \n   \
          \                                                              \n dense_2\
          \ (Dense)             (None, 256)               196864    \n           \
          \                                                      \n dropout_37 (Dropout)\
          \        (None, 256)               0         \n                        \
          \                                         \n outputs (Dense)           \
          \  (None, 1)                 257       \n                              \
          \                                   \n=================================================================\n\
          </code></pre>\n<p>So when I use the following code and run my app in Streamlit,\
          \ it gives me this ValueError.</p>\n<pre><code>ValueError: Unknown layer:\
          \ Custom&gt;TFViTMainLayer. Please ensure this object is passed to the `custom_objects`\
          \ argument. See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object\
          \ for details.\n\nTraceback:\n\nFile \"C:\\Users\\maria\\anaconda3\\envs\\\
          tfenv\\lib\\site-packages\\streamlit\\scriptrunner\\script_runner.py\",\
          \ line 557, in _run_script\n    exec(code, module.__dict__)\nFile \"app_extended.py\"\
          , line 248, in &lt;module&gt;\n    model_loader = tf.keras.models.load_model(path_to_model)\n\
          File \"C:\\Users\\maria\\anaconda3\\envs\\tfenv\\lib\\site-packages\\keras\\\
          utils\\traceback_utils.py\", line 67, in error_handler\n    raise e.with_traceback(filtered_tb)\
          \ from None\nFile \"C:\\Users\\maria\\anaconda3\\envs\\tfenv\\lib\\site-packages\\\
          keras\\utils\\generic_utils.py\", line 562, in class_and_config_for_serialized_keras_object\n\
          \    raise ValueError(\n</code></pre>\n<p>my code</p>\n<pre><code>\nif model_name\
          \ == 'Vision Transformer(ViT)':\n        ## Initialize tensorflow model\n\
          \    path_to_model = \"C:/Users/maria/Jupiter_Notebooks/Dataset_Thermal_Project/Camera_videos/Saved_models/model_vit.h5\"\
          \n    model_loader = tf.keras.models.load_model(path_to_model)\n    model_vit\
          \ = tf.keras.models.Model(model_loader.inputs, model_loader.outputs)\n\n\
          \   .....\n</code></pre>\n<p>Not sure how to register the custom object\
          \ in my example after looking at this link, \"<a rel=\"nofollow\" href=\"\
          https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object%20for%20details&quot;\"\
          >https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object%20for%20details\"\
          </a>.</p>\n<p>Need some help with this please?</p>\n"
        raw: "I have a google's visual transformer model which  I have trained in\
          \ Tensorflow 2 and saved as an h5 file.\r\n\r\n\r\n```\r\n# Base model pre-trained\
          \ on ImageNet-21k with the 224x224 image resolution\r\nbase_model = TFViTModel.from_pretrained('google/vit-base-patch16-224-in21k')\r\
          \n# Freeze base model\r\nbase_model.trainable = False\r\n# Create new model\r\
          \ninputs = keras.Input(shape = (3, 224, 224))\r\nx = data_augmentation_vit(inputs)\r\
          \n\r\nvit = base_model.vit(inputs)[0]\r\nvit = keras.layers.GlobalAveragePooling1D()(vit)\r\
          \nvit = tf.keras.layers.Dense(256, activation='relu')(vit)\r\nvit = tf.\
          \ keras.layers.Dropout(0.15)(vit)\r\noutputs = tf.keras.layers.Dense(1,\
          \ activation='sigmoid', name='outputs')(vit)\r\n\r\nmodel_vit = tf.keras.Model(inputs,\
          \ outputs)\r\nprint(model_vit.summary())\r\n\r\nModel: \"model_1\"\r\n_________________________________________________________________\r\
          \n Layer (type)                Output Shape              Param #   \r\n\
          =================================================================\r\n input_2\
          \ (InputLayer)        [(None, 3, 224, 224)]     0         \r\n         \
          \                                                        \r\n vit (TFViTMainLayer)\
          \        TFBaseModelOutputWithPoo  86389248  \r\n                      \
          \       ling(last_hidden_state=(            \r\n                       \
          \      None, 197, 768),                    \r\n                        \
          \      pooler_output=(None, 76            \r\n                         \
          \    8),                                 \r\n                          \
          \    hidden_states=None, att            \r\n                           \
          \  entions=None)                       \r\n                            \
          \                                     \r\n global_average_pooling1d (G \
          \ (None, 768)              0         \r\n lobalAveragePooling1D)       \
          \                                   \r\n                               \
          \                                  \r\n dense_2 (Dense)             (None,\
          \ 256)               196864    \r\n                                    \
          \                             \r\n dropout_37 (Dropout)        (None, 256)\
          \               0         \r\n                                         \
          \                        \r\n outputs (Dense)             (None, 1)    \
          \             257       \r\n                                           \
          \                      \r\n=================================================================\r\
          \n```\r\nSo when I use the following code and run my app in Streamlit, it\
          \ gives me this ValueError.\r\n\r\n\r\n```\r\nValueError: Unknown layer:\
          \ Custom>TFViTMainLayer. Please ensure this object is passed to the `custom_objects`\
          \ argument. See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object\
          \ for details.\r\n\r\nTraceback:\r\n\r\nFile \"C:\\Users\\maria\\anaconda3\\\
          envs\\tfenv\\lib\\site-packages\\streamlit\\scriptrunner\\script_runner.py\"\
          , line 557, in _run_script\r\n    exec(code, module.__dict__)\r\nFile \"\
          app_extended.py\", line 248, in <module>\r\n    model_loader = tf.keras.models.load_model(path_to_model)\r\
          \nFile \"C:\\Users\\maria\\anaconda3\\envs\\tfenv\\lib\\site-packages\\\
          keras\\utils\\traceback_utils.py\", line 67, in error_handler\r\n    raise\
          \ e.with_traceback(filtered_tb) from None\r\nFile \"C:\\Users\\maria\\anaconda3\\\
          envs\\tfenv\\lib\\site-packages\\keras\\utils\\generic_utils.py\", line\
          \ 562, in class_and_config_for_serialized_keras_object\r\n    raise ValueError(\r\
          \n```\r\nmy code\r\n\r\n```\r\n\r\nif model_name == 'Vision Transformer(ViT)':\r\
          \n        ## Initialize tensorflow model\r\n    path_to_model = \"C:/Users/maria/Jupiter_Notebooks/Dataset_Thermal_Project/Camera_videos/Saved_models/model_vit.h5\"\
          \r\n    model_loader = tf.keras.models.load_model(path_to_model)\r\n   \
          \ model_vit = tf.keras.models.Model(model_loader.inputs, model_loader.outputs)\r\
          \n\r\n   .....\r\n```\r\nNot sure how to register the custom object in my\
          \ example after looking at this link, \"https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object%20for%20details\"\
          .\r\n\r\nNeed some help with this please?"
        updatedAt: '2022-08-30T13:58:00.208Z'
      numEdits: 0
      reactions: []
    id: 630e176864f1f8d0c76d926e
    type: comment
  author: mbluetail
  content: "I have a google's visual transformer model which  I have trained in Tensorflow\
    \ 2 and saved as an h5 file.\r\n\r\n\r\n```\r\n# Base model pre-trained on ImageNet-21k\
    \ with the 224x224 image resolution\r\nbase_model = TFViTModel.from_pretrained('google/vit-base-patch16-224-in21k')\r\
    \n# Freeze base model\r\nbase_model.trainable = False\r\n# Create new model\r\n\
    inputs = keras.Input(shape = (3, 224, 224))\r\nx = data_augmentation_vit(inputs)\r\
    \n\r\nvit = base_model.vit(inputs)[0]\r\nvit = keras.layers.GlobalAveragePooling1D()(vit)\r\
    \nvit = tf.keras.layers.Dense(256, activation='relu')(vit)\r\nvit = tf. keras.layers.Dropout(0.15)(vit)\r\
    \noutputs = tf.keras.layers.Dense(1, activation='sigmoid', name='outputs')(vit)\r\
    \n\r\nmodel_vit = tf.keras.Model(inputs, outputs)\r\nprint(model_vit.summary())\r\
    \n\r\nModel: \"model_1\"\r\n_________________________________________________________________\r\
    \n Layer (type)                Output Shape              Param #   \r\n=================================================================\r\
    \n input_2 (InputLayer)        [(None, 3, 224, 224)]     0         \r\n      \
    \                                                           \r\n vit (TFViTMainLayer)\
    \        TFBaseModelOutputWithPoo  86389248  \r\n                            \
    \ ling(last_hidden_state=(            \r\n                             None, 197,\
    \ 768),                    \r\n                              pooler_output=(None,\
    \ 76            \r\n                             8),                         \
    \        \r\n                              hidden_states=None, att           \
    \ \r\n                             entions=None)                       \r\n  \
    \                                                               \r\n global_average_pooling1d\
    \ (G  (None, 768)              0         \r\n lobalAveragePooling1D)         \
    \                                 \r\n                                       \
    \                          \r\n dense_2 (Dense)             (None, 256)      \
    \         196864    \r\n                                                     \
    \            \r\n dropout_37 (Dropout)        (None, 256)               0    \
    \     \r\n                                                                 \r\n\
    \ outputs (Dense)             (None, 1)                 257       \r\n       \
    \                                                          \r\n=================================================================\r\
    \n```\r\nSo when I use the following code and run my app in Streamlit, it gives\
    \ me this ValueError.\r\n\r\n\r\n```\r\nValueError: Unknown layer: Custom>TFViTMainLayer.\
    \ Please ensure this object is passed to the `custom_objects` argument. See https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object\
    \ for details.\r\n\r\nTraceback:\r\n\r\nFile \"C:\\Users\\maria\\anaconda3\\envs\\\
    tfenv\\lib\\site-packages\\streamlit\\scriptrunner\\script_runner.py\", line 557,\
    \ in _run_script\r\n    exec(code, module.__dict__)\r\nFile \"app_extended.py\"\
    , line 248, in <module>\r\n    model_loader = tf.keras.models.load_model(path_to_model)\r\
    \nFile \"C:\\Users\\maria\\anaconda3\\envs\\tfenv\\lib\\site-packages\\keras\\\
    utils\\traceback_utils.py\", line 67, in error_handler\r\n    raise e.with_traceback(filtered_tb)\
    \ from None\r\nFile \"C:\\Users\\maria\\anaconda3\\envs\\tfenv\\lib\\site-packages\\\
    keras\\utils\\generic_utils.py\", line 562, in class_and_config_for_serialized_keras_object\r\
    \n    raise ValueError(\r\n```\r\nmy code\r\n\r\n```\r\n\r\nif model_name == 'Vision\
    \ Transformer(ViT)':\r\n        ## Initialize tensorflow model\r\n    path_to_model\
    \ = \"C:/Users/maria/Jupiter_Notebooks/Dataset_Thermal_Project/Camera_videos/Saved_models/model_vit.h5\"\
    \r\n    model_loader = tf.keras.models.load_model(path_to_model)\r\n    model_vit\
    \ = tf.keras.models.Model(model_loader.inputs, model_loader.outputs)\r\n\r\n \
    \  .....\r\n```\r\nNot sure how to register the custom object in my example after\
    \ looking at this link, \"https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object%20for%20details\"\
    .\r\n\r\nNeed some help with this please?"
  created_at: 2022-08-30 12:58:00+00:00
  edited: false
  hidden: false
  id: 630e176864f1f8d0c76d926e
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 2
repo_id: google/vit-base-patch16-224-in21k
repo_type: model
status: open
target_branch: null
title: How to register custom object for the TFViTMainLayer in this model?
