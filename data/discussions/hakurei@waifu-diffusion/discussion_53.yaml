!!python/object:huggingface_hub.community.DiscussionWithDetails
author: williamhCode
conflicting_files: null
created_at: 2022-11-20 10:07:06+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/28c404d476466e994f909a017a877fa3.svg
      fullname: William Hou
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: williamhCode
      type: user
    createdAt: '2022-11-20T10:07:06.000Z'
    data:
      edited: false
      editors:
      - williamhCode
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/28c404d476466e994f909a017a877fa3.svg
          fullname: William Hou
          isHf: false
          isPro: false
          name: williamhCode
          type: user
        html: "<pre><code class=\"language-python\"><span class=\"hljs-keyword\">import</span>\
          \ torch\n<span class=\"hljs-keyword\">from</span> diffusers <span class=\"\
          hljs-keyword\">import</span> StableDiffusionPipeline\n\npipe = StableDiffusionPipeline.from_pretrained(<span\
          \ class=\"hljs-string\">'hakurei/waifu-diffusion'</span>, torch_dtype=torch.float32)\n\
          pipe = pipe.to(<span class=\"hljs-string\">'mps'</span>)\n\npipe.enable_attention_slicing()\n\
          \nprompt = <span class=\"hljs-string\">\"test\"</span>\n\n_ = pipe(prompt,\
          \ num_inference_steps=<span class=\"hljs-number\">1</span>)\n\nimage = pipe(prompt,\
          \ guidance_scale=<span class=\"hljs-number\">6</span>).images[<span class=\"\
          hljs-number\">0</span>]\n    \nimage.save(<span class=\"hljs-string\">\"\
          test.png\"</span>)\n</code></pre>\n<p>This throws the error</p>\n<pre><code>...\n\
          line 11, in &lt;module&gt;\n    _ = pipe(prompt, num_inference_steps=1)\n\
          \  File \"/opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/torch/autograd/grad_mode.py\"\
          , line 27, in decorate_context\n    return func(*args, **kwargs)\n  File\
          \ \"/opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py\"\
          , line 362, in __call__\n    timesteps_tensor = self.scheduler.timesteps.to(self.device)\n\
          TypeError: Cannot convert a MPS Tensor to float64 dtype as the MPS framework\
          \ doesn't support float64. Please use float32 instead.\n</code></pre>\n\
          <p>It works if I use <code>runwayml/stable-diffusion-v1-5</code> instead\
          \ of waifu diffusion.<br>This issue might be related, <a rel=\"nofollow\"\
          \ href=\"https://github.com/pytorch/pytorch/issues/78168\">https://github.com/pytorch/pytorch/issues/78168</a>,\
          \ but it has been fixed. This issue only happens when I use waifu-diffusion,\
          \ not stable-diffusion</p>\n"
        raw: "```python\r\nimport torch\r\nfrom diffusers import StableDiffusionPipeline\r\
          \n\r\npipe = StableDiffusionPipeline.from_pretrained('hakurei/waifu-diffusion',\
          \ torch_dtype=torch.float32)\r\npipe = pipe.to('mps')\r\n\r\npipe.enable_attention_slicing()\r\
          \n\r\nprompt = \"test\"\r\n\r\n_ = pipe(prompt, num_inference_steps=1)\r\
          \n\r\nimage = pipe(prompt, guidance_scale=6).images[0]\r\n    \r\nimage.save(\"\
          test.png\")\r\n```\r\nThis throws the error\r\n```\r\n...\r\nline 11, in\
          \ <module>\r\n    _ = pipe(prompt, num_inference_steps=1)\r\n  File \"/opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/torch/autograd/grad_mode.py\"\
          , line 27, in decorate_context\r\n    return func(*args, **kwargs)\r\n \
          \ File \"/opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py\"\
          , line 362, in __call__\r\n    timesteps_tensor = self.scheduler.timesteps.to(self.device)\r\
          \nTypeError: Cannot convert a MPS Tensor to float64 dtype as the MPS framework\
          \ doesn't support float64. Please use float32 instead.\r\n```\r\nIt works\
          \ if I use `runwayml/stable-diffusion-v1-5` instead of waifu diffusion.\r\
          \nThis issue might be related, https://github.com/pytorch/pytorch/issues/78168,\
          \ but it has been fixed. This issue only happens when I use waifu-diffusion,\
          \ not stable-diffusion\r\n"
        updatedAt: '2022-11-20T10:07:06.666Z'
      numEdits: 0
      reactions: []
    id: 6379fc4a7ce76c3b83466f9a
    type: comment
  author: williamhCode
  content: "```python\r\nimport torch\r\nfrom diffusers import StableDiffusionPipeline\r\
    \n\r\npipe = StableDiffusionPipeline.from_pretrained('hakurei/waifu-diffusion',\
    \ torch_dtype=torch.float32)\r\npipe = pipe.to('mps')\r\n\r\npipe.enable_attention_slicing()\r\
    \n\r\nprompt = \"test\"\r\n\r\n_ = pipe(prompt, num_inference_steps=1)\r\n\r\n\
    image = pipe(prompt, guidance_scale=6).images[0]\r\n    \r\nimage.save(\"test.png\"\
    )\r\n```\r\nThis throws the error\r\n```\r\n...\r\nline 11, in <module>\r\n  \
    \  _ = pipe(prompt, num_inference_steps=1)\r\n  File \"/opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/torch/autograd/grad_mode.py\"\
    , line 27, in decorate_context\r\n    return func(*args, **kwargs)\r\n  File \"\
    /opt/homebrew/Caskroom/miniforge/base/envs/waifu/lib/python3.10/site-packages/diffusers/pipelines/stable_diffusion/pipeline_stable_diffusion.py\"\
    , line 362, in __call__\r\n    timesteps_tensor = self.scheduler.timesteps.to(self.device)\r\
    \nTypeError: Cannot convert a MPS Tensor to float64 dtype as the MPS framework\
    \ doesn't support float64. Please use float32 instead.\r\n```\r\nIt works if I\
    \ use `runwayml/stable-diffusion-v1-5` instead of waifu diffusion.\r\nThis issue\
    \ might be related, https://github.com/pytorch/pytorch/issues/78168, but it has\
    \ been fixed. This issue only happens when I use waifu-diffusion, not stable-diffusion\r\
    \n"
  created_at: 2022-11-20 10:07:06+00:00
  edited: false
  hidden: false
  id: 6379fc4a7ce76c3b83466f9a
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 53
repo_id: hakurei/waifu-diffusion
repo_type: model
status: open
target_branch: null
title: Error on macbook with pipe.to('mps')
