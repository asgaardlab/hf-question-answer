!!python/object:huggingface_hub.community.DiscussionWithDetails
author: linkanjarad
conflicting_files: null
created_at: 2022-12-17 12:35:12+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/62563c7c25cfd82dbb086f33/a3ATolZTIAkwORg8R_oSS.png?w=200&h=200&f=face
      fullname: Link An Jarad
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: linkanjarad
      type: user
    createdAt: '2022-12-17T12:35:12.000Z'
    data:
      edited: false
      editors:
      - linkanjarad
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/62563c7c25cfd82dbb086f33/a3ATolZTIAkwORg8R_oSS.png?w=200&h=200&f=face
          fullname: Link An Jarad
          isHf: false
          isPro: false
          name: linkanjarad
          type: user
        html: "<p>Running the code:</p>\n<pre><code class=\"language-python\">model\
          \ = OPTForCausalLM.from_pretrained(<span class=\"hljs-string\">\"facebook/opt-350m\"\
          </span>, device_map=<span class=\"hljs-string\">'auto'</span>, load_in_8bit=<span\
          \ class=\"hljs-literal\">True</span>).to(device)\n</code></pre>\n<p>produces\
          \ the following error:</p>\n<pre><code class=\"language-python\">NameError\
          \                                 Traceback (most recent call last)\n&lt;ipython-<span\
          \ class=\"hljs-built_in\">input</span>-<span class=\"hljs-number\">7</span>-2a869e732be4&gt;\
          \ <span class=\"hljs-keyword\">in</span> &lt;module&gt;\n      <span class=\"\
          hljs-number\">3</span> device = <span class=\"hljs-string\">\"cuda\"</span>\n\
          \      <span class=\"hljs-number\">4</span> \n----&gt; <span class=\"hljs-number\"\
          >5</span> model = OPTForCausalLM.from_pretrained(<span class=\"hljs-string\"\
          >\"facebook/opt-350m\"</span>, device_map=<span class=\"hljs-string\">'auto'</span>,\
          \ load_in_8bit=<span class=\"hljs-literal\">True</span>).to(device)\n  \
          \    <span class=\"hljs-number\">6</span> tokenizer = GPT2Tokenizer.from_pretrained(<span\
          \ class=\"hljs-string\">\"facebook/opt-350m\"</span>)\n\n/usr/local/lib/python3<span\
          \ class=\"hljs-number\">.8</span>/dist-packages/transformers/modeling_utils.py\
          \ <span class=\"hljs-keyword\">in</span> from_pretrained(cls, pretrained_model_name_or_path,\
          \ *model_args, **kwargs)\n   <span class=\"hljs-number\">2271</span>   \
          \          init_contexts = [deepspeed.zero.Init(config_dict_or_path=deepspeed_config())]\
          \ + init_contexts\n   <span class=\"hljs-number\">2272</span>         <span\
          \ class=\"hljs-keyword\">elif</span> load_in_8bit <span class=\"hljs-keyword\"\
          >or</span> low_cpu_mem_usage:\n-&gt; <span class=\"hljs-number\">2273</span>\
          \             init_contexts.append(init_empty_weights())\n   <span class=\"\
          hljs-number\">2274</span> \n   <span class=\"hljs-number\">2275</span> \
          \        <span class=\"hljs-keyword\">with</span> ContextManagers(init_contexts):\n\
          \nNameError: name <span class=\"hljs-string\">'init_empty_weights'</span>\
          \ <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span>\
          \ defined\n</code></pre>\n<p>I have both <code>bitsandbytes</code> and <code>accelerate</code>\
          \ installed.</p>\n"
        raw: "Running the code:\r\n\r\n```python\r\nmodel = OPTForCausalLM.from_pretrained(\"\
          facebook/opt-350m\", device_map='auto', load_in_8bit=True).to(device)\r\n\
          ```\r\n\r\nproduces the following error:\r\n\r\n```python\r\nNameError \
          \                                Traceback (most recent call last)\r\n<ipython-input-7-2a869e732be4>\
          \ in <module>\r\n      3 device = \"cuda\"\r\n      4 \r\n----> 5 model\
          \ = OPTForCausalLM.from_pretrained(\"facebook/opt-350m\", device_map='auto',\
          \ load_in_8bit=True).to(device)\r\n      6 tokenizer = GPT2Tokenizer.from_pretrained(\"\
          facebook/opt-350m\")\r\n\r\n/usr/local/lib/python3.8/dist-packages/transformers/modeling_utils.py\
          \ in from_pretrained(cls, pretrained_model_name_or_path, *model_args, **kwargs)\r\
          \n   2271             init_contexts = [deepspeed.zero.Init(config_dict_or_path=deepspeed_config())]\
          \ + init_contexts\r\n   2272         elif load_in_8bit or low_cpu_mem_usage:\r\
          \n-> 2273             init_contexts.append(init_empty_weights())\r\n   2274\
          \ \r\n   2275         with ContextManagers(init_contexts):\r\n\r\nNameError:\
          \ name 'init_empty_weights' is not defined\r\n```\r\n\r\nI have both `bitsandbytes`\
          \ and `accelerate` installed."
        updatedAt: '2022-12-17T12:35:12.639Z'
      numEdits: 0
      reactions: []
    id: 639db780727066701115f255
    type: comment
  author: linkanjarad
  content: "Running the code:\r\n\r\n```python\r\nmodel = OPTForCausalLM.from_pretrained(\"\
    facebook/opt-350m\", device_map='auto', load_in_8bit=True).to(device)\r\n```\r\
    \n\r\nproduces the following error:\r\n\r\n```python\r\nNameError            \
    \                     Traceback (most recent call last)\r\n<ipython-input-7-2a869e732be4>\
    \ in <module>\r\n      3 device = \"cuda\"\r\n      4 \r\n----> 5 model = OPTForCausalLM.from_pretrained(\"\
    facebook/opt-350m\", device_map='auto', load_in_8bit=True).to(device)\r\n    \
    \  6 tokenizer = GPT2Tokenizer.from_pretrained(\"facebook/opt-350m\")\r\n\r\n\
    /usr/local/lib/python3.8/dist-packages/transformers/modeling_utils.py in from_pretrained(cls,\
    \ pretrained_model_name_or_path, *model_args, **kwargs)\r\n   2271           \
    \  init_contexts = [deepspeed.zero.Init(config_dict_or_path=deepspeed_config())]\
    \ + init_contexts\r\n   2272         elif load_in_8bit or low_cpu_mem_usage:\r\
    \n-> 2273             init_contexts.append(init_empty_weights())\r\n   2274 \r\
    \n   2275         with ContextManagers(init_contexts):\r\n\r\nNameError: name\
    \ 'init_empty_weights' is not defined\r\n```\r\n\r\nI have both `bitsandbytes`\
    \ and `accelerate` installed."
  created_at: 2022-12-17 12:35:12+00:00
  edited: false
  hidden: false
  id: 639db780727066701115f255
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1618450692745-5e3aec01f55e2b62848a5217.jpeg?w=200&h=200&f=face
      fullname: Lysandre
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: false
      name: lysandre
      type: user
    createdAt: '2022-12-19T10:44:21.000Z'
    data:
      edited: false
      editors:
      - lysandre
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1618450692745-5e3aec01f55e2b62848a5217.jpeg?w=200&h=200&f=face
          fullname: Lysandre
          isHf: true
          isPro: false
          name: lysandre
          type: user
        html: "<p>Hey <span data-props=\"{&quot;user&quot;:&quot;linkanjarad&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/linkanjarad\"\
          >@<span class=\"underline\">linkanjarad</span></a></span>\n\n\t</span></span>,\
          \ what is your version of <code>accelerate</code>? cc <span data-props=\"\
          {&quot;user&quot;:&quot;ybelkada&quot;}\" data-target=\"UserMention\" class=\"\
          SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"inline-block\"><span\
          \ class=\"contents\"><a href=\"/ybelkada\">@<span class=\"underline\">ybelkada</span></a></span>\n\
          \n\t</span></span></p>\n"
        raw: Hey @linkanjarad, what is your version of `accelerate`? cc @ybelkada
        updatedAt: '2022-12-19T10:44:21.294Z'
      numEdits: 0
      reactions: []
    id: 63a04085e648d42537498d3c
    type: comment
  author: lysandre
  content: Hey @linkanjarad, what is your version of `accelerate`? cc @ybelkada
  created_at: 2022-12-19 10:44:21+00:00
  edited: false
  hidden: false
  id: 63a04085e648d42537498d3c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
      fullname: Younes Belkada
      isHf: true
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ybelkada
      type: user
    createdAt: '2022-12-19T10:45:54.000Z'
    data:
      edited: false
      editors:
      - ybelkada
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
          fullname: Younes Belkada
          isHf: true
          isPro: false
          name: ybelkada
          type: user
        html: "<p>Hey <span data-props=\"{&quot;user&quot;:&quot;linkanjarad&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/linkanjarad\"\
          >@<span class=\"underline\">linkanjarad</span></a></span>\n\n\t</span></span><br>Thanks\
          \ for the issue!<br>Could you please make sure you are using the latest\
          \ version of <code>accelerate</code> and <code>transformers</code>? <code>pip\
          \ install --upgrade accelerate</code> &amp; <code>pip install --upgrade\
          \ transformers</code></p>\n"
        raw: "Hey @linkanjarad \nThanks for the issue!\nCould you please make sure\
          \ you are using the latest version of `accelerate` and `transformers`? `pip\
          \ install --upgrade accelerate` & `pip install --upgrade transformers`"
        updatedAt: '2022-12-19T10:45:54.159Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\u2764\uFE0F"
        users:
        - linkanjarad
    id: 63a040e26b087d7413be4d29
    type: comment
  author: ybelkada
  content: "Hey @linkanjarad \nThanks for the issue!\nCould you please make sure you\
    \ are using the latest version of `accelerate` and `transformers`? `pip install\
    \ --upgrade accelerate` & `pip install --upgrade transformers`"
  created_at: 2022-12-19 10:45:54+00:00
  edited: false
  hidden: false
  id: 63a040e26b087d7413be4d29
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
      fullname: Younes Belkada
      isHf: true
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ybelkada
      type: user
    createdAt: '2022-12-19T12:35:03.000Z'
    data:
      edited: false
      editors:
      - ybelkada
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
          fullname: Younes Belkada
          isHf: true
          isPro: false
          name: ybelkada
          type: user
        html: '<p>And also it''s not recommended to call <code>.to(device)</code>
          when you load a 8bit model - you will most likely get an error. So just
          calling:</p>

          <pre><code>model = OPTForCausalLM.from_pretrained("facebook/opt-350m", device_map=''auto'',
          load_in_8bit=True)

          </code></pre>

          <p>is enough</p>

          '
        raw: 'And also it''s not recommended to call `.to(device)` when you load a
          8bit model - you will most likely get an error. So just calling:

          ```

          model = OPTForCausalLM.from_pretrained("facebook/opt-350m", device_map=''auto'',
          load_in_8bit=True)

          ```

          is enough'
        updatedAt: '2022-12-19T12:35:03.336Z'
      numEdits: 0
      reactions: []
    id: 63a05a776b087d7413c1d29e
    type: comment
  author: ybelkada
  content: 'And also it''s not recommended to call `.to(device)` when you load a 8bit
    model - you will most likely get an error. So just calling:

    ```

    model = OPTForCausalLM.from_pretrained("facebook/opt-350m", device_map=''auto'',
    load_in_8bit=True)

    ```

    is enough'
  created_at: 2022-12-19 12:35:03+00:00
  edited: false
  hidden: false
  id: 63a05a776b087d7413c1d29e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/62563c7c25cfd82dbb086f33/a3ATolZTIAkwORg8R_oSS.png?w=200&h=200&f=face
      fullname: Link An Jarad
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: linkanjarad
      type: user
    createdAt: '2022-12-19T12:58:17.000Z'
    data:
      edited: false
      editors:
      - linkanjarad
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/62563c7c25cfd82dbb086f33/a3ATolZTIAkwORg8R_oSS.png?w=200&h=200&f=face
          fullname: Link An Jarad
          isHf: false
          isPro: false
          name: linkanjarad
          type: user
        html: "<blockquote>\n<p>Hey <span data-props=\"{&quot;user&quot;:&quot;linkanjarad&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/linkanjarad\"\
          >@<span class=\"underline\">linkanjarad</span></a></span>\n\n\t</span></span><br>Thanks\
          \ for the issue!<br>Could you please make sure you are using the latest\
          \ version of <code>accelerate</code> and <code>transformers</code>? <code>pip\
          \ install --upgrade accelerate</code> &amp; <code>pip install --upgrade\
          \ transformers</code></p>\n</blockquote>\n<p><span data-props=\"{&quot;user&quot;:&quot;ybelkada&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/ybelkada\"\
          >@<span class=\"underline\">ybelkada</span></a></span>\n\n\t</span></span>\
          \ Hi, thanks for pointing out my redundancy on the usage of both <code>device_map='auto'</code>\
          \ and <code>.to(device)</code>, will keep that in mind. I tried using the\
          \ latest version of <code>accelerate</code> and <code>transformers</code>\
          \ and now it works! Thanks! Apologies for not trying the most obvious solution\
          \ \U0001F605</p>\n"
        raw: "> Hey @linkanjarad \n> Thanks for the issue!\n> Could you please make\
          \ sure you are using the latest version of `accelerate` and `transformers`?\
          \ `pip install --upgrade accelerate` & `pip install --upgrade transformers`\n\
          \n@ybelkada Hi, thanks for pointing out my redundancy on the usage of both\
          \ `device_map='auto'` and `.to(device)`, will keep that in mind. I tried\
          \ using the latest version of `accelerate` and `transformers` and now it\
          \ works! Thanks! Apologies for not trying the most obvious solution \U0001F605"
        updatedAt: '2022-12-19T12:58:17.386Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\u2764\uFE0F"
        users:
        - ybelkada
      - count: 1
        reaction: "\U0001F91D"
        users:
        - ybelkada
    id: 63a05fe96b087d7413c27bc6
    type: comment
  author: linkanjarad
  content: "> Hey @linkanjarad \n> Thanks for the issue!\n> Could you please make\
    \ sure you are using the latest version of `accelerate` and `transformers`? `pip\
    \ install --upgrade accelerate` & `pip install --upgrade transformers`\n\n@ybelkada\
    \ Hi, thanks for pointing out my redundancy on the usage of both `device_map='auto'`\
    \ and `.to(device)`, will keep that in mind. I tried using the latest version\
    \ of `accelerate` and `transformers` and now it works! Thanks! Apologies for not\
    \ trying the most obvious solution \U0001F605"
  created_at: 2022-12-19 12:58:17+00:00
  edited: false
  hidden: false
  id: 63a05fe96b087d7413c27bc6
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
      fullname: Younes Belkada
      isHf: true
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ybelkada
      type: user
    createdAt: '2022-12-19T13:27:58.000Z'
    data:
      edited: true
      editors:
      - ybelkada
      hidden: false
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1648631057413-noauth.png?w=200&h=200&f=face
          fullname: Younes Belkada
          isHf: true
          isPro: false
          name: ybelkada
          type: user
        html: '<p>Great! Let us know if you face into any issue in the future</p>

          '
        raw: Great! Let us know if you face into any issue in the future
        updatedAt: '2022-12-19T13:28:06.804Z'
      numEdits: 1
      reactions: []
    id: 63a066def3334a6553d98241
    type: comment
  author: ybelkada
  content: Great! Let us know if you face into any issue in the future
  created_at: 2022-12-19 13:27:58+00:00
  edited: true
  hidden: false
  id: 63a066def3334a6553d98241
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 23
repo_id: facebook/opt-350m
repo_type: model
status: open
target_branch: null
title: 'NameError: name ''init_empty_weights'' is not defined when using load_in_8bit=True'
