!!python/object:huggingface_hub.community.DiscussionWithDetails
author: ag0
conflicting_files: []
created_at: 2023-08-04 11:04:16+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/0f8dd578dfc9ee41db586bdc7df4cafb.svg
      fullname: ag0
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ag0
      type: user
    createdAt: '2023-08-04T12:04:16.000Z'
    data:
      edited: false
      editors:
      - ag0
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.45251917839050293
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/0f8dd578dfc9ee41db586bdc7df4cafb.svg
          fullname: ag0
          isHf: false
          isPro: false
          name: ag0
          type: user
        html: "<p>Currently the output dtype of <code>rmsnorm_func</code> is not the\
          \ same as the input dtype, I'm not sure if this is the intended behaviour\
          \ but this looks like a bug.</p>\n<p>How to reproduce:</p>\n<pre><code>import\
          \ torch\n\nhidden_size = 8\n\nhidden_states = torch.rand((4, hidden_size),\
          \ dtype=torch.float16)\nweight = torch.ones(hidden_size, dtype=torch.float32)\n\
          variance_epsilon = torch.tensor(1e-6)\n\ndef rmsnorm_func(hidden_states,\
          \ weight, variance_epsilon):\n    input_dtype = hidden_states.dtype\n  \
          \  hidden_states = hidden_states.to(torch.float32)\n    variance = hidden_states.pow(2).mean(-1,\
          \ keepdim=True)\n    hidden_states = hidden_states * torch.rsqrt(variance\
          \ + variance_epsilon)\n    return weight * hidden_states.to(input_dtype)\n\
          \nprint('input', hidden_states.dtype)\nprint('output', rmsnorm_func(hidden_states,\
          \ weight, variance_epsilon).dtype)\n</code></pre>\n<p>Result:</p>\n<pre><code>input\
          \ torch.float16\noutput torch.float32\n</code></pre>\n<p>With this PR: </p>\n\
          <pre><code>input torch.float16\noutput torch.float16\n</code></pre>\n"
        raw: "Currently the output dtype of `rmsnorm_func` is not the same as the\
          \ input dtype, I'm not sure if this is the intended behaviour but this looks\
          \ like a bug.\n\nHow to reproduce:\n```\nimport torch\n\nhidden_size = 8\n\
          \nhidden_states = torch.rand((4, hidden_size), dtype=torch.float16)\nweight\
          \ = torch.ones(hidden_size, dtype=torch.float32)\nvariance_epsilon = torch.tensor(1e-6)\n\
          \ndef rmsnorm_func(hidden_states, weight, variance_epsilon):\n    input_dtype\
          \ = hidden_states.dtype\n    hidden_states = hidden_states.to(torch.float32)\n\
          \    variance = hidden_states.pow(2).mean(-1, keepdim=True)\n    hidden_states\
          \ = hidden_states * torch.rsqrt(variance + variance_epsilon)\n    return\
          \ weight * hidden_states.to(input_dtype)\n\nprint('input', hidden_states.dtype)\n\
          print('output', rmsnorm_func(hidden_states, weight, variance_epsilon).dtype)\n\
          ```\n\nResult:\n```\ninput torch.float16\noutput torch.float32\n```\n\n\
          With this PR: \n```\ninput torch.float16\noutput torch.float16\n```"
        updatedAt: '2023-08-04T12:04:16.062Z'
      numEdits: 0
      reactions: []
    id: 64cce94054348e678d723907
    type: comment
  author: ag0
  content: "Currently the output dtype of `rmsnorm_func` is not the same as the input\
    \ dtype, I'm not sure if this is the intended behaviour but this looks like a\
    \ bug.\n\nHow to reproduce:\n```\nimport torch\n\nhidden_size = 8\n\nhidden_states\
    \ = torch.rand((4, hidden_size), dtype=torch.float16)\nweight = torch.ones(hidden_size,\
    \ dtype=torch.float32)\nvariance_epsilon = torch.tensor(1e-6)\n\ndef rmsnorm_func(hidden_states,\
    \ weight, variance_epsilon):\n    input_dtype = hidden_states.dtype\n    hidden_states\
    \ = hidden_states.to(torch.float32)\n    variance = hidden_states.pow(2).mean(-1,\
    \ keepdim=True)\n    hidden_states = hidden_states * torch.rsqrt(variance + variance_epsilon)\n\
    \    return weight * hidden_states.to(input_dtype)\n\nprint('input', hidden_states.dtype)\n\
    print('output', rmsnorm_func(hidden_states, weight, variance_epsilon).dtype)\n\
    ```\n\nResult:\n```\ninput torch.float16\noutput torch.float32\n```\n\nWith this\
    \ PR: \n```\ninput torch.float16\noutput torch.float16\n```"
  created_at: 2023-08-04 11:04:16+00:00
  edited: false
  hidden: false
  id: 64cce94054348e678d723907
  type: comment
- !!python/object:huggingface_hub.community.DiscussionCommit
  _event:
    author:
      avatarUrl: /avatars/0f8dd578dfc9ee41db586bdc7df4cafb.svg
      fullname: ag0
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: ag0
      type: user
    createdAt: '2023-08-04T12:04:16.000Z'
    data:
      oid: f2e665eb9ee6eae4abd08d7cb44fdf6422ee0c84
      parents:
      - 4ec6edc8319166177b58747681c16740a6c6ac65
      subject: Correct the output dtype of rmsnorm_func
    id: 64cce9400000000000000000
    type: commit
  author: ag0
  created_at: 2023-08-04 11:04:16+00:00
  id: 64cce9400000000000000000
  oid: f2e665eb9ee6eae4abd08d7cb44fdf6422ee0c84
  summary: Correct the output dtype of rmsnorm_func
  type: commit
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/277ff242cf15b380b80bdabfc0cfa030.svg
      fullname: Ce Zhang
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: zhangce
      type: user
    createdAt: '2023-08-04T14:48:00.000Z'
    data:
      edited: false
      editors:
      - zhangce
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8937920331954956
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/277ff242cf15b380b80bdabfc0cfa030.svg
          fullname: Ce Zhang
          isHf: false
          isPro: false
          name: zhangce
          type: user
        html: "<p>Thanks <span data-props=\"{&quot;user&quot;:&quot;ag0&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/ag0\">@<span class=\"\
          underline\">ag0</span></a></span>\n\n\t</span></span> !! <span data-props=\"\
          {&quot;user&quot;:&quot;juewang&quot;}\" data-target=\"UserMention\" class=\"\
          SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"inline-block\"><span\
          \ class=\"contents\"><a href=\"/juewang\">@<span class=\"underline\">juewang</span></a></span>\n\
          \n\t</span></span> can you look into this one?</p>\n<p>Ce</p>\n"
        raw: 'Thanks @ag0 !! @juewang can you look into this one?


          Ce'
        updatedAt: '2023-08-04T14:48:00.056Z'
      numEdits: 0
      reactions: []
    id: 64cd0fa0855f210d63db8681
    type: comment
  author: zhangce
  content: 'Thanks @ag0 !! @juewang can you look into this one?


    Ce'
  created_at: 2023-08-04 13:48:00+00:00
  edited: false
  hidden: false
  id: 64cd0fa0855f210d63db8681
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1669380535028-61dce5c2af6d5e733e0fb08b.jpeg?w=200&h=200&f=face
      fullname: Jue Wang
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: juewang
      type: user
    createdAt: '2023-08-05T08:32:40.000Z'
    data:
      edited: false
      editors:
      - juewang
      hidden: false
      identifiedLanguage:
        language: zh
        probability: 0.43048617243766785
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1669380535028-61dce5c2af6d5e733e0fb08b.jpeg?w=200&h=200&f=face
          fullname: Jue Wang
          isHf: false
          isPro: false
          name: juewang
          type: user
        html: '<p>LGTM</p>

          '
        raw: LGTM
        updatedAt: '2023-08-05T08:32:40.633Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64ce0928749587dbe0ecc1ef
    id: 64ce0928749587dbe0ecc1ec
    type: comment
  author: juewang
  content: LGTM
  created_at: 2023-08-05 07:32:40+00:00
  edited: false
  hidden: false
  id: 64ce0928749587dbe0ecc1ec
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1669380535028-61dce5c2af6d5e733e0fb08b.jpeg?w=200&h=200&f=face
      fullname: Jue Wang
      isHf: false
      isOrgMember: true
      isOwner: false
      isPro: false
      name: juewang
      type: user
    createdAt: '2023-08-05T08:32:40.000Z'
    data:
      status: merged
    id: 64ce0928749587dbe0ecc1ef
    type: status-change
  author: juewang
  created_at: 2023-08-05 07:32:40+00:00
  id: 64ce0928749587dbe0ecc1ef
  new_status: merged
  type: status-change
is_pull_request: true
merge_commit_oid: aef6d8946ae1015bdb65c478a2dd73b58daaef47
num: 13
repo_id: togethercomputer/LLaMA-2-7B-32K
repo_type: model
status: merged
target_branch: refs/heads/main
title: Correct the output dtype of rmsnorm_func
