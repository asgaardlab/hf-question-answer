!!python/object:huggingface_hub.community.DiscussionWithDetails
author: diablo98
conflicting_files: null
created_at: 2023-10-15 16:30:35+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
      fullname: Aymen Bouzid
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: diablo98
      type: user
    createdAt: '2023-10-15T17:30:35.000Z'
    data:
      edited: false
      editors:
      - diablo98
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9488107562065125
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
          fullname: Aymen Bouzid
          isHf: false
          isPro: false
          name: diablo98
          type: user
        html: "<p>First, I'd like to thank you for your work. The quantized phi 1.5\
          \ model is the only LLM that I dared to run on my 10 years old laptop with\
          \ an i3, 4gb ddr3 and an HDD. Using the candle ML framework, it runs at\
          \ an impressive  \u22486 token/s and only eat around 1&nbsp;GB of RAM. It's\
          \ beyond impressive.</p>\n<p>While the phi 1.5 model is impressive for its\
          \ size, it was still lacking. After searching and experimenting with some\
          \ finetunings of the model, I found this one : <a href=\"https://huggingface.co/teknium/Puffin-Phi-v2/tree/main\"\
          >https://huggingface.co/teknium/Puffin-Phi-v2/tree/main</a>, and it was\
          \ quite frankly astonishing. Sadly, the model seems to be in the PyTorch\
          \ format and unquantized.  Can you please share the code to convert phi\
          \ 1.5 to the GGUF format? I tried the convert.py file available on llama.cpp\
          \ but no luck.</p>\n<p>I don't know if the model can be quantized using\
          \ the free tier of Google colab, but at such small size I think it hopefully\
          \ will. Alternatively and while I honestly hope it's possible to achieve\
          \ it by myself, you could, if it's not much to ask, do the conversion and\
          \ quantization and share them on hugging face.  Thanks in advance.</p>\n"
        raw: "First, I'd like to thank you for your work. The quantized phi 1.5 model\
          \ is the only LLM that I dared to run on my 10 years old laptop with an\
          \ i3, 4gb ddr3 and an HDD. Using the candle ML framework, it runs at an\
          \ impressive  \u22486 token/s and only eat around 1\_GB of RAM. It's beyond\
          \ impressive.\r\n\r\nWhile the phi 1.5 model is impressive for its size,\
          \ it was still lacking. After searching and experimenting with some finetunings\
          \ of the model, I found this one : https://huggingface.co/teknium/Puffin-Phi-v2/tree/main,\
          \ and it was quite frankly astonishing. Sadly, the model seems to be in\
          \ the PyTorch format and unquantized.  Can you please share the code to\
          \ convert phi 1.5 to the GGUF format? I tried the convert.py file available\
          \ on llama.cpp but no luck.\r\n\r\nI don't know if the model can be quantized\
          \ using the free tier of Google colab, but at such small size I think it\
          \ hopefully will. Alternatively and while I honestly hope it's possible\
          \ to achieve it by myself, you could, if it's not much to ask, do the conversion\
          \ and quantization and share them on hugging face.  Thanks in advance.\r\
          \n\r\n"
        updatedAt: '2023-10-15T17:30:35.498Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - lmz
    id: 652c21bba2d97e682b53618e
    type: comment
  author: diablo98
  content: "First, I'd like to thank you for your work. The quantized phi 1.5 model\
    \ is the only LLM that I dared to run on my 10 years old laptop with an i3, 4gb\
    \ ddr3 and an HDD. Using the candle ML framework, it runs at an impressive  \u2248\
    6 token/s and only eat around 1\_GB of RAM. It's beyond impressive.\r\n\r\nWhile\
    \ the phi 1.5 model is impressive for its size, it was still lacking. After searching\
    \ and experimenting with some finetunings of the model, I found this one : https://huggingface.co/teknium/Puffin-Phi-v2/tree/main,\
    \ and it was quite frankly astonishing. Sadly, the model seems to be in the PyTorch\
    \ format and unquantized.  Can you please share the code to convert phi 1.5 to\
    \ the GGUF format? I tried the convert.py file available on llama.cpp but no luck.\r\
    \n\r\nI don't know if the model can be quantized using the free tier of Google\
    \ colab, but at such small size I think it hopefully will. Alternatively and while\
    \ I honestly hope it's possible to achieve it by myself, you could, if it's not\
    \ much to ask, do the conversion and quantization and share them on hugging face.\
    \  Thanks in advance.\r\n\r\n"
  created_at: 2023-10-15 16:30:35+00:00
  edited: false
  hidden: false
  id: 652c21bba2d97e682b53618e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
      fullname: Laurent Mazare
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: lmz
      type: user
    createdAt: '2023-10-15T20:20:30.000Z'
    data:
      edited: false
      editors:
      - lmz
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.548143744468689
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
          fullname: Laurent Mazare
          isHf: false
          isPro: false
          name: lmz
          type: user
        html: '<p>You can first convert the pytorch checkpoint to a safetensor file
          using the following python script.</p>

          <pre><code class="language-python"><span class="hljs-keyword">from</span>
          safetensors.torch <span class="hljs-keyword">import</span> save_file

          <span class="hljs-keyword">import</span> torch

          tensors = torch.load(<span class="hljs-string">"pytorch_model.bin"</span>)

          save_file(tensors, <span class="hljs-string">"pytorch_model.safetensors"</span>)

          </code></pre>

          <p>And then quantize the resulting safetensor files via candle <code>tensor-tools</code>
          utility.</p>

          <pre><code class="language-bash">cargo run --release --example tensor-tools
          -- quantize pytorch_model.safetensors --out-file model-q4k.gguf --quantization
          q4k

          </code></pre>

          <p>Note that the resulting <code>gguf</code> file will only work with candle
          and not with llama.cpp.</p>

          '
        raw: 'You can first convert the pytorch checkpoint to a safetensor file using
          the following python script.

          ```python

          from safetensors.torch import save_file

          import torch

          tensors = torch.load("pytorch_model.bin")

          save_file(tensors, "pytorch_model.safetensors")

          ```

          And then quantize the resulting safetensor files via candle `tensor-tools`
          utility.

          ```bash

          cargo run --release --example tensor-tools -- quantize pytorch_model.safetensors
          --out-file model-q4k.gguf --quantization q4k

          ```

          Note that the resulting `gguf` file will only work with candle and not with
          llama.cpp.'
        updatedAt: '2023-10-15T20:20:30.026Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\u2764\uFE0F"
        users:
        - diablo98
    id: 652c498e1ef9983c6d358a23
    type: comment
  author: lmz
  content: 'You can first convert the pytorch checkpoint to a safetensor file using
    the following python script.

    ```python

    from safetensors.torch import save_file

    import torch

    tensors = torch.load("pytorch_model.bin")

    save_file(tensors, "pytorch_model.safetensors")

    ```

    And then quantize the resulting safetensor files via candle `tensor-tools` utility.

    ```bash

    cargo run --release --example tensor-tools -- quantize pytorch_model.safetensors
    --out-file model-q4k.gguf --quantization q4k

    ```

    Note that the resulting `gguf` file will only work with candle and not with llama.cpp.'
  created_at: 2023-10-15 19:20:30+00:00
  edited: false
  hidden: false
  id: 652c498e1ef9983c6d358a23
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
      fullname: Aymen Bouzid
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: diablo98
      type: user
    createdAt: '2023-10-16T12:58:48.000Z'
    data:
      edited: true
      editors:
      - diablo98
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8196491599082947
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
          fullname: Aymen Bouzid
          isHf: false
          isPro: false
          name: diablo98
          type: user
        html: '<p>Thanks for your help. Sadly, after following the steps, when I run
          the model via candle I get Error: shape mismatch for weight, got [50304,
          2048], expected [51200, 2048]<br>Here are the resulting files : <a href="https://huggingface.co/diabolo96/candle-quantized-Puffin-Phi-v2/tree/main">https://huggingface.co/diabolo96/candle-quantized-Puffin-Phi-v2/tree/main</a></p>

          '
        raw: 'Thanks for your help. Sadly, after following the steps, when I run the
          model via candle I get Error: shape mismatch for weight, got [50304, 2048],
          expected [51200, 2048]

          Here are the resulting files : https://huggingface.co/diabolo96/candle-quantized-Puffin-Phi-v2/tree/main'
        updatedAt: '2023-10-16T13:07:44.083Z'
      numEdits: 1
      reactions: []
    id: 652d33886a41c1d38e256ec1
    type: comment
  author: diablo98
  content: 'Thanks for your help. Sadly, after following the steps, when I run the
    model via candle I get Error: shape mismatch for weight, got [50304, 2048], expected
    [51200, 2048]

    Here are the resulting files : https://huggingface.co/diabolo96/candle-quantized-Puffin-Phi-v2/tree/main'
  created_at: 2023-10-16 11:58:48+00:00
  edited: true
  hidden: false
  id: 652d33886a41c1d38e256ec1
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
      fullname: Laurent Mazare
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: lmz
      type: user
    createdAt: '2023-10-16T13:01:20.000Z'
    data:
      edited: false
      editors:
      - lmz
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9429214596748352
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
          fullname: Laurent Mazare
          isHf: false
          isPro: false
          name: lmz
          type: user
        html: '<p>Looks like the tokenizers are supposed to be different from the
          phi ones? One has 50304 tokens in the vocabulary and the other 51200. Currently
          we use the <code>tokenizer.json</code> file from the main repo but maybe
          you want to tweak this to use a different tokenizer file? Let me know if
          you need some help for this.</p>

          '
        raw: Looks like the tokenizers are supposed to be different from the phi ones?
          One has 50304 tokens in the vocabulary and the other 51200. Currently we
          use the `tokenizer.json` file from the main repo but maybe you want to tweak
          this to use a different tokenizer file? Let me know if you need some help
          for this.
        updatedAt: '2023-10-16T13:01:20.273Z'
      numEdits: 0
      reactions: []
    id: 652d342003fdab13ae7a98d1
    type: comment
  author: lmz
  content: Looks like the tokenizers are supposed to be different from the phi ones?
    One has 50304 tokens in the vocabulary and the other 51200. Currently we use the
    `tokenizer.json` file from the main repo but maybe you want to tweak this to use
    a different tokenizer file? Let me know if you need some help for this.
  created_at: 2023-10-16 12:01:20+00:00
  edited: false
  hidden: false
  id: 652d342003fdab13ae7a98d1
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
      fullname: Aymen Bouzid
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: diablo98
      type: user
    createdAt: '2023-10-16T18:33:50.000Z'
    data:
      edited: false
      editors:
      - diablo98
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8905107378959656
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
          fullname: Aymen Bouzid
          isHf: false
          isPro: false
          name: diablo98
          type: user
        html: '<p>I looked at the config.json of the two repos, and it seems that
          it''s Microsoft phi 1.5 that has a vocab size of 51200 while the Puffin-Phi-v2
          fine-tune has only 50304.<br>Frankly, I know nothing about rust and even
          less ML, but I downloaded the tokenize.json file from the <a href="https://huggingface.co/teknium/Puffin-Phi-v2">https://huggingface.co/teknium/Puffin-Phi-v2</a>
          repo and after looking at the code in /content/candle/candle-examples/examples/phi
          and asking bing I changed line number 241 from<br>    let tokenizer_filename
          = repo.get("tokenizer.json")?;<br>to :<br>    let tokenizer_filename = std::path::PathBuf::from("path/to/Puffin-Phi-v2
          tokenizer.json");<br>Mirroring the line under it :<br>  let filename = match
          args.weight_file {<br>        Some(weight_file) =&gt; std::path::PathBuf::from(weight_file)</p>

          <p>I get this :<br>   Error: unknown magic 0x73726576</p>

          <p>This is the limit of what I can do, and I honestly don''t know if what
          I am doing is completely wrong, so I apologize in advance if it''s nonsense.</p>

          '
        raw: "I looked at the config.json of the two repos, and it seems that it's\
          \ Microsoft phi 1.5 that has a vocab size of 51200 while the Puffin-Phi-v2\
          \ fine-tune has only 50304. \nFrankly, I know nothing about rust and even\
          \ less ML, but I downloaded the tokenize.json file from the https://huggingface.co/teknium/Puffin-Phi-v2\
          \ repo and after looking at the code in /content/candle/candle-examples/examples/phi\
          \ and asking bing I changed line number 241 from\n    let tokenizer_filename\
          \ = repo.get(\"tokenizer.json\")?;\nto :\n    let tokenizer_filename = std::path::PathBuf::from(\"\
          path/to/Puffin-Phi-v2 tokenizer.json\");\nMirroring the line under it :\n\
          \  let filename = match args.weight_file {\n        Some(weight_file) =>\
          \ std::path::PathBuf::from(weight_file)\n\nI get this :\n   Error: unknown\
          \ magic 0x73726576\n\nThis is the limit of what I can do, and I honestly\
          \ don't know if what I am doing is completely wrong, so I apologize in advance\
          \ if it's nonsense."
        updatedAt: '2023-10-16T18:33:50.963Z'
      numEdits: 0
      reactions: []
    id: 652d820e6360a042ea811c1d
    type: comment
  author: diablo98
  content: "I looked at the config.json of the two repos, and it seems that it's Microsoft\
    \ phi 1.5 that has a vocab size of 51200 while the Puffin-Phi-v2 fine-tune has\
    \ only 50304. \nFrankly, I know nothing about rust and even less ML, but I downloaded\
    \ the tokenize.json file from the https://huggingface.co/teknium/Puffin-Phi-v2\
    \ repo and after looking at the code in /content/candle/candle-examples/examples/phi\
    \ and asking bing I changed line number 241 from\n    let tokenizer_filename =\
    \ repo.get(\"tokenizer.json\")?;\nto :\n    let tokenizer_filename = std::path::PathBuf::from(\"\
    path/to/Puffin-Phi-v2 tokenizer.json\");\nMirroring the line under it :\n  let\
    \ filename = match args.weight_file {\n        Some(weight_file) => std::path::PathBuf::from(weight_file)\n\
    \nI get this :\n   Error: unknown magic 0x73726576\n\nThis is the limit of what\
    \ I can do, and I honestly don't know if what I am doing is completely wrong,\
    \ so I apologize in advance if it's nonsense."
  created_at: 2023-10-16 17:33:50+00:00
  edited: false
  hidden: false
  id: 652d820e6360a042ea811c1d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
      fullname: Laurent Mazare
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: lmz
      type: user
    createdAt: '2023-10-16T20:01:01.000Z'
    data:
      edited: true
      editors:
      - lmz
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.930473804473877
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/eaf7f30a334d23c1c561a4512f55c9b3.svg
          fullname: Laurent Mazare
          isHf: false
          isPro: false
          name: lmz
          type: user
        html: "<p>Ah sorry about that, this turns out to require slighly more changes.\
          \ I've actually made them and merged them in the main branch so it should\
          \ now be easy to run this model. E.g. from the github tip of the candle\
          \ repo you can run the following</p>\n<pre><code>$ cargo run --example phi\
          \ --release  -- \\\n    --prompt \"USER: What would you do on a sunny day\
          \ in Paris?\\nASSISTANT:\" \\\n    --sample-len 200 --model puffin-phi-v2\
          \ --quantized \nUSER: What would you do on a sunny day in Paris?\nASSISTANT:\
          \ On a sunny day in Paris, you could visit the Mus\xE9e du Louvre to admire\
          \ the famous\npainting \"Mona Lisa\" by Leonardo da Vinci. You might also\
          \ want to stroll along the Champs-\xC9lys\xE9es\nand enjoy the beautiful\
          \ architecture of the buildings around you. Don't forget to stop by a caf\xE9\
          \nfor a cup of coffee and to soak up the sun!\"\n</code></pre>\n<p>Let me\
          \ know if you run into any issues or see any model that you would want to\
          \ see supported - also don't hesitate to look at the <a rel=\"nofollow\"\
          \ href=\"https://github.com/huggingface/candle/pull/1110/files\">PR</a>\
          \ if you want to be able to make such changes.</p>\n"
        raw: "Ah sorry about that, this turns out to require slighly more changes.\
          \ I've actually made them and merged them in the main branch so it should\
          \ now be easy to run this model. E.g. from the github tip of the candle\
          \ repo you can run the following\n```\n$ cargo run --example phi --release\
          \  -- \\\n    --prompt \"USER: What would you do on a sunny day in Paris?\\\
          nASSISTANT:\" \\\n    --sample-len 200 --model puffin-phi-v2 --quantized\
          \ \nUSER: What would you do on a sunny day in Paris?\nASSISTANT: On a sunny\
          \ day in Paris, you could visit the Mus\xE9e du Louvre to admire the famous\n\
          painting \"Mona Lisa\" by Leonardo da Vinci. You might also want to stroll\
          \ along the Champs-\xC9lys\xE9es\nand enjoy the beautiful architecture of\
          \ the buildings around you. Don't forget to stop by a caf\xE9\nfor a cup\
          \ of coffee and to soak up the sun!\"\n```\nLet me know if you run into\
          \ any issues or see any model that you would want to see supported - also\
          \ don't hesitate to look at the [PR](https://github.com/huggingface/candle/pull/1110/files)\
          \ if you want to be able to make such changes."
        updatedAt: '2023-10-16T20:20:41.019Z'
      numEdits: 1
      reactions:
      - count: 1
        reaction: "\u2764\uFE0F"
        users:
        - diablo98
    id: 652d967dcc4609d6438cc6ca
    type: comment
  author: lmz
  content: "Ah sorry about that, this turns out to require slighly more changes. I've\
    \ actually made them and merged them in the main branch so it should now be easy\
    \ to run this model. E.g. from the github tip of the candle repo you can run the\
    \ following\n```\n$ cargo run --example phi --release  -- \\\n    --prompt \"\
    USER: What would you do on a sunny day in Paris?\\nASSISTANT:\" \\\n    --sample-len\
    \ 200 --model puffin-phi-v2 --quantized \nUSER: What would you do on a sunny day\
    \ in Paris?\nASSISTANT: On a sunny day in Paris, you could visit the Mus\xE9e\
    \ du Louvre to admire the famous\npainting \"Mona Lisa\" by Leonardo da Vinci.\
    \ You might also want to stroll along the Champs-\xC9lys\xE9es\nand enjoy the\
    \ beautiful architecture of the buildings around you. Don't forget to stop by\
    \ a caf\xE9\nfor a cup of coffee and to soak up the sun!\"\n```\nLet me know if\
    \ you run into any issues or see any model that you would want to see supported\
    \ - also don't hesitate to look at the [PR](https://github.com/huggingface/candle/pull/1110/files)\
    \ if you want to be able to make such changes."
  created_at: 2023-10-16 19:01:01+00:00
  edited: true
  hidden: false
  id: 652d967dcc4609d6438cc6ca
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
      fullname: Aymen Bouzid
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: diablo98
      type: user
    createdAt: '2023-10-22T13:10:02.000Z'
    data:
      edited: true
      editors:
      - diablo98
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9697223901748657
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
          fullname: Aymen Bouzid
          isHf: false
          isPro: false
          name: diablo98
          type: user
        html: '<p>First,I would like to apologize  for the late response, my internet
          was cut off.</p>

          <p>I am deeply grateful that you took some of your time to adapt the Candle
          framework to be able to use the model. The PR is very valuable. If i understand
          correctly I need to add the config.json inside the mixformer.rs file. If
          I find another interesting model I definitely will try.</p>

          '
        raw: 'First,I would like to apologize  for the late response, my internet
          was cut off.


          I am deeply grateful that you took some of your time to adapt the Candle
          framework to be able to use the model. The PR is very valuable. If i understand
          correctly I need to add the config.json inside the mixformer.rs file. If
          I find another interesting model I definitely will try.


          '
        updatedAt: '2023-10-22T13:21:02.840Z'
      numEdits: 1
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - lmz
    id: 65351f2a7139c5dd8d992087
    type: comment
  author: diablo98
  content: 'First,I would like to apologize  for the late response, my internet was
    cut off.


    I am deeply grateful that you took some of your time to adapt the Candle framework
    to be able to use the model. The PR is very valuable. If i understand correctly
    I need to add the config.json inside the mixformer.rs file. If I find another
    interesting model I definitely will try.


    '
  created_at: 2023-10-22 12:10:02+00:00
  edited: true
  hidden: false
  id: 65351f2a7139c5dd8d992087
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: /avatars/f787e1dad37bad570121b7c4ab40e981.svg
      fullname: Aymen Bouzid
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: diablo98
      type: user
    createdAt: '2023-10-26T03:23:14.000Z'
    data:
      status: closed
    id: 6539dba243d9189cdce61959
    type: status-change
  author: diablo98
  created_at: 2023-10-26 02:23:14+00:00
  id: 6539dba243d9189cdce61959
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 2
repo_id: lmz/candle-quantized-phi
repo_type: model
status: closed
target_branch: null
title: Can you please share the code to convert phi 1.5 to the GGUF format?
