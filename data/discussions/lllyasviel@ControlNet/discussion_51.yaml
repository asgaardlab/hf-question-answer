!!python/object:huggingface_hub.community.DiscussionWithDetails
author: snatchysquid
conflicting_files: null
created_at: 2023-10-18 16:57:34+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/d33c80d6b804ba8ba90c786a5e01af80.svg
      fullname: Doron Daniel
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: snatchysquid
      type: user
    createdAt: '2023-10-18T17:57:34.000Z'
    data:
      edited: true
      editors:
      - snatchysquid
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9161949157714844
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/d33c80d6b804ba8ba90c786a5e01af80.svg
          fullname: Doron Daniel
          isHf: false
          isPro: false
          name: snatchysquid
          type: user
        html: "<p>In section 3.4, the ControlNet <a rel=\"nofollow\" href=\"https://arxiv.org/pdf/2302.05543.pdf\"\
          >paper</a> talks about CFG-RW, quoting:</p>\n<blockquote>\n<p>In challenging\
          \ cases, e.g., when no prompts are given, adding it to both \u03F5uc and\
          \ \u03F5c will completely remove CFG guidance (Figure 5b);<br>using only\
          \ \u03F5c will make the guidance very strong (Figure 5c).<br>Our solution\
          \ is to first add the conditioning image to \u03F5_c and then multiply a\
          \ weight wi to each connection between Stable Diffusion and ControlNet according\
          \ to the resolution of each block wi = 64/hi, where hi is the size of i\
          \ th block, e.g., h1 = 8, h2 = 16, ..., h13 = 64</p>\n</blockquote>\n<p>I\
          \ don't quite understand what this means and where is this implemented in\
          \ the code in the github <a rel=\"nofollow\" href=\"https://github.com/lllyasviel/ControlNet\"\
          >repository</a>. My questions, therefore, are as follows:</p>\n<ol>\n<li>Do\
          \ I understand correctly that what we do is train the model without any\
          \ weighting, and then for the \u03F5_uc we use unconditional SD without\
          \ ControlNet, and for \u03F5_c we use ControlNet but before adding the skip\
          \ connection, we multiply the output by wi (meaning SD_Layer_i_final_output\
          \ = SD_Layer_i_output + (w_i*ControlNet_Layer_i_output) )?</li>\n<li>If\
          \ so, what is the logic and motivation for doing that? It doesn't sound\
          \ trivial that this would be want we want to do.</li>\n<li>Finally, I'd\
          \ like to know where is this implemented in the code?</li>\n</ol>\n"
        raw: "In section 3.4, the ControlNet [paper](https://arxiv.org/pdf/2302.05543.pdf)\
          \ talks about CFG-RW, quoting:\n\n> In challenging cases, e.g., when no\
          \ prompts are given, adding it to both \u03F5uc and \u03F5c will completely\
          \ remove CFG guidance (Figure 5b);\n> using only \u03F5c will make the guidance\
          \ very strong (Figure 5c).\n> Our solution is to first add the conditioning\
          \ image to \u03F5_c and then multiply a weight wi to each connection between\
          \ Stable Diffusion and ControlNet according to the resolution of each block\
          \ wi = 64/hi, where hi is the size of i th block, e.g., h1 = 8, h2 = 16,\
          \ ..., h13 = 64\n\nI don't quite understand what this means and where is\
          \ this implemented in the code in the github [repository](https://github.com/lllyasviel/ControlNet).\
          \ My questions, therefore, are as follows:\n\n1.  Do I understand correctly\
          \ that what we do is train the model without any weighting, and then for\
          \ the \u03F5_uc we use unconditional SD without ControlNet, and for \u03F5\
          _c we use ControlNet but before adding the skip connection, we multiply\
          \ the output by wi (meaning SD_Layer_i_final_output = SD_Layer_i_output\
          \ + (w_i*ControlNet_Layer_i_output) )?\n2. If so, what is the logic and\
          \ motivation for doing that? It doesn't sound trivial that this would be\
          \ want we want to do.\n3.  Finally, I'd like to know where is this implemented\
          \ in the code?\n"
        updatedAt: '2023-10-18T17:59:37.693Z'
      numEdits: 1
      reactions: []
    id: 65301c8edd9b27760ad797d5
    type: comment
  author: snatchysquid
  content: "In section 3.4, the ControlNet [paper](https://arxiv.org/pdf/2302.05543.pdf)\
    \ talks about CFG-RW, quoting:\n\n> In challenging cases, e.g., when no prompts\
    \ are given, adding it to both \u03F5uc and \u03F5c will completely remove CFG\
    \ guidance (Figure 5b);\n> using only \u03F5c will make the guidance very strong\
    \ (Figure 5c).\n> Our solution is to first add the conditioning image to \u03F5\
    _c and then multiply a weight wi to each connection between Stable Diffusion and\
    \ ControlNet according to the resolution of each block wi = 64/hi, where hi is\
    \ the size of i th block, e.g., h1 = 8, h2 = 16, ..., h13 = 64\n\nI don't quite\
    \ understand what this means and where is this implemented in the code in the\
    \ github [repository](https://github.com/lllyasviel/ControlNet). My questions,\
    \ therefore, are as follows:\n\n1.  Do I understand correctly that what we do\
    \ is train the model without any weighting, and then for the \u03F5_uc we use\
    \ unconditional SD without ControlNet, and for \u03F5_c we use ControlNet but\
    \ before adding the skip connection, we multiply the output by wi (meaning SD_Layer_i_final_output\
    \ = SD_Layer_i_output + (w_i*ControlNet_Layer_i_output) )?\n2. If so, what is\
    \ the logic and motivation for doing that? It doesn't sound trivial that this\
    \ would be want we want to do.\n3.  Finally, I'd like to know where is this implemented\
    \ in the code?\n"
  created_at: 2023-10-18 16:57:34+00:00
  edited: true
  hidden: false
  id: 65301c8edd9b27760ad797d5
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 51
repo_id: lllyasviel/ControlNet
repo_type: model
status: open
target_branch: null
title: Classifier-free guidance resolution weighting
