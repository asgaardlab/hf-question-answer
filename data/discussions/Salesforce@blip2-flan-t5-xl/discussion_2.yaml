!!python/object:huggingface_hub.community.DiscussionWithDetails
author: LDY
conflicting_files: null
created_at: 2023-10-14 11:59:53+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/6c08c6c18b63412438daa2ee89ddbba8.svg
      fullname: LDY
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: LDY
      type: user
    createdAt: '2023-10-14T12:59:53.000Z'
    data:
      edited: false
      editors:
      - LDY
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6429769396781921
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/6c08c6c18b63412438daa2ee89ddbba8.svg
          fullname: LDY
          isHf: false
          isPro: false
          name: LDY
          type: user
        html: "<p>I find RuntimeError when I use the official code on inference: </p>\n\
          <pre><code class=\"language-shell\">Expected all tensors to be on the same\
          \ device, but found at least two devices, cuda:7 and cuda:2!\n</code></pre>\n\
          <p>Test code:</p>\n<pre><code class=\"language-python\">model_path = <span\
          \ class=\"hljs-string\">\".cache/huggingface/hub/models--Salesforce--blip2-flan-t5-xl/snapshots/cc2bb7bce2f7d4d1c37753c7e9c05a443a226614/\"\
          </span>\nprocessor = Blip2Processor.from_pretrained(model_path)\nmodel =\
          \ Blip2ForConditionalGeneration.from_pretrained(model_path, device_map=<span\
          \ class=\"hljs-string\">\"auto\"</span>)\n\nimg_url = <span class=\"hljs-string\"\
          >'https://storage.googleapis.com/sfr-vision-language-research/BLIP/demo.jpg'</span>\
          \ \nraw_image = Image.<span class=\"hljs-built_in\">open</span>(requests.get(img_url,\
          \ stream=<span class=\"hljs-literal\">True</span>).raw).convert(<span class=\"\
          hljs-string\">'RGB'</span>)\n\nquestion = <span class=\"hljs-string\">\"\
          how many dogs are in the picture?\"</span>\ninputs = processor(raw_image,\
          \ question, return_tensors=<span class=\"hljs-string\">\"pt\"</span>).to(<span\
          \ class=\"hljs-string\">\"cuda\"</span>)\n\n<span class=\"hljs-built_in\"\
          >print</span>(<span class=\"hljs-string\">\"model: \"</span>,model.hf_device_map)\n\
          \nout = model.generate(**inputs)\n<span class=\"hljs-built_in\">print</span>(processor.decode(out[<span\
          \ class=\"hljs-number\">0</span>], skip_special_tokens=<span class=\"hljs-literal\"\
          >True</span>))\n</code></pre>\n<p>System Info:</p>\n<ul>\n<li>OS: 18.04.2\
          \ LTS</li>\n<li>One mechine with 8x tesla p100-pcie-16gb</li>\n</ul>\n<p>How\
          \ can I fix this bug?</p>\n"
        raw: "I find RuntimeError when I use the official code on inference: \r\n\
          ```shell\r\nExpected all tensors to be on the same device, but found at\
          \ least two devices, cuda:7 and cuda:2!\r\n```\r\n\r\nTest code:\r\n```python\r\
          \nmodel_path = \".cache/huggingface/hub/models--Salesforce--blip2-flan-t5-xl/snapshots/cc2bb7bce2f7d4d1c37753c7e9c05a443a226614/\"\
          \r\nprocessor = Blip2Processor.from_pretrained(model_path)\r\nmodel = Blip2ForConditionalGeneration.from_pretrained(model_path,\
          \ device_map=\"auto\")\r\n\r\nimg_url = 'https://storage.googleapis.com/sfr-vision-language-research/BLIP/demo.jpg'\
          \ \r\nraw_image = Image.open(requests.get(img_url, stream=True).raw).convert('RGB')\r\
          \n\r\nquestion = \"how many dogs are in the picture?\"\r\ninputs = processor(raw_image,\
          \ question, return_tensors=\"pt\").to(\"cuda\")\r\n\r\nprint(\"model: \"\
          ,model.hf_device_map)\r\n\r\nout = model.generate(**inputs)\r\nprint(processor.decode(out[0],\
          \ skip_special_tokens=True))\r\n```\r\n\r\nSystem Info:\r\n - OS: 18.04.2\
          \ LTS\r\n - One mechine with 8x tesla p100-pcie-16gb\r\n\r\nHow can I fix\
          \ this bug?"
        updatedAt: '2023-10-14T12:59:53.466Z'
      numEdits: 0
      reactions: []
    id: 652a90c9c3cba555d53bd239
    type: comment
  author: LDY
  content: "I find RuntimeError when I use the official code on inference: \r\n```shell\r\
    \nExpected all tensors to be on the same device, but found at least two devices,\
    \ cuda:7 and cuda:2!\r\n```\r\n\r\nTest code:\r\n```python\r\nmodel_path = \"\
    .cache/huggingface/hub/models--Salesforce--blip2-flan-t5-xl/snapshots/cc2bb7bce2f7d4d1c37753c7e9c05a443a226614/\"\
    \r\nprocessor = Blip2Processor.from_pretrained(model_path)\r\nmodel = Blip2ForConditionalGeneration.from_pretrained(model_path,\
    \ device_map=\"auto\")\r\n\r\nimg_url = 'https://storage.googleapis.com/sfr-vision-language-research/BLIP/demo.jpg'\
    \ \r\nraw_image = Image.open(requests.get(img_url, stream=True).raw).convert('RGB')\r\
    \n\r\nquestion = \"how many dogs are in the picture?\"\r\ninputs = processor(raw_image,\
    \ question, return_tensors=\"pt\").to(\"cuda\")\r\n\r\nprint(\"model: \",model.hf_device_map)\r\
    \n\r\nout = model.generate(**inputs)\r\nprint(processor.decode(out[0], skip_special_tokens=True))\r\
    \n```\r\n\r\nSystem Info:\r\n - OS: 18.04.2 LTS\r\n - One mechine with 8x tesla\
    \ p100-pcie-16gb\r\n\r\nHow can I fix this bug?"
  created_at: 2023-10-14 11:59:53+00:00
  edited: false
  hidden: false
  id: 652a90c9c3cba555d53bd239
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 2
repo_id: Salesforce/blip2-flan-t5-xl
repo_type: model
status: open
target_branch: null
title: 'Inference Error: Expected all tensors to be on the same device, but found
  at least two devices, cuda:7 and cuda:2!'
