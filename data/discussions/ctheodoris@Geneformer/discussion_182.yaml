!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Pingiotto
conflicting_files: null
created_at: 2023-08-07 09:41:16+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
      fullname: Matthew Pace
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Pingiotto
      type: user
    createdAt: '2023-08-07T10:41:16.000Z'
    data:
      edited: false
      editors:
      - Pingiotto
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.5803565382957458
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
          fullname: Matthew Pace
          isHf: false
          isPro: false
          name: Pingiotto
          type: user
        html: "<p>Hi Dr Theodoris, thank you for your fantastic work. I am trying\
          \ to reproduce your in silico perturbation results by deleting GATA4 from\
          \ the human_dcm_hcm_nf dataset using the fine-tuned CellClassifier_cardiomyopathies\
          \ model you have recently uploaded.</p>\n<p>But I am getting the following\
          \ error:<br><code>  File \"in_silico_perturber.py\", line 413, in quant_cos_sims\
          \     attention_mask = gen_attention_mask(original_minibatch, original_max_len)\
          \ UnboundLocalError: local variable 'original_max_len' referenced before\
          \ assignment</code></p>\n<p>This is because the following condition isnt\
          \ being met, therefore original_max_len isnt being defined:<br><code>if\
          \ (len(original_minibatch_length_set) &gt; 1) or (max(original_minibatch_length_set)\
          \ &gt; new_max_len):</code></p>\n<p>I checked the values of the relevant\
          \ variables just before the conditional:<br>len(original_minibatch_length_set)\
          \ = 1<br>max(original_minibatch_length_set) = 2048<br>new_max_len = 2048</p>\n\
          <p>And this is how I am calling the InSilicoPerturber class:</p>\n<pre><code>isp\
          \ = InSilicoPerturber(perturb_type=\"delete\",\n                       \
          \ perturb_rank_shift=None,\n                        genes_to_perturb=[\"\
          ENSG00000136574\"],\n                        combos=0,\n               \
          \         anchor_gene=None,\n                        model_type=\"CellClassifier\"\
          ,\n                        num_classes=3,\n                        emb_mode=\"\
          cell\",\n                        cell_emb_style=\"mean_pool\",\n       \
          \                 filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
          ,\"Cardiomyocyte3\"]},\n                        cell_states_to_model={'state_key':\
          \ 'disease', \n                                              'start_state':\
          \ 'dcm', \n                                              'goal_state': 'nf',\
          \ \n                                              'alt_states': ['hcm']},\n\
          \                        max_ncells=2000,\n                        emb_layer=0,\n\
          \                        forward_batch_size=70,\n                      \
          \  nproc=16)\nisp.perturb_data(\"./CellClassifier_cardiomyopathies/\",\n\
          \                 \"./human_dcm_hcm_nf.dataset\",\n                 \"./perturb_out/\"\
          ,\n                 \"inter_\")\n\nispstats = InSilicoPerturberStats(mode=\"\
          goal_state_shift\",\n                                  genes_perturbed=\"\
          all\",\n                                  combos=0,\n                  \
          \                anchor_gene=None,\n                                  cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\n</code></pre>\n<p>Any idea as\
          \ to why this is happening?</p>\n"
        raw: "Hi Dr Theodoris, thank you for your fantastic work. I am trying to reproduce\
          \ your in silico perturbation results by deleting GATA4 from the human_dcm_hcm_nf\
          \ dataset using the fine-tuned CellClassifier_cardiomyopathies model you\
          \ have recently uploaded.\r\n\r\nBut I am getting the following error:\r\
          \n`  File \"in_silico_perturber.py\", line 413, in quant_cos_sims\r\n  \
          \  attention_mask = gen_attention_mask(original_minibatch, original_max_len)\r\
          \nUnboundLocalError: local variable 'original_max_len' referenced before\
          \ assignment`\r\n\r\nThis is because the following condition isnt being\
          \ met, therefore original_max_len isnt being defined:\r\n`if (len(original_minibatch_length_set)\
          \ > 1) or (max(original_minibatch_length_set) > new_max_len):`\r\n\r\nI\
          \ checked the values of the relevant variables just before the conditional:\r\
          \nlen(original_minibatch_length_set) = 1\r\nmax(original_minibatch_length_set)\
          \ = 2048\r\nnew_max_len = 2048\r\n\r\nAnd this is how I am calling the InSilicoPerturber\
          \ class:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"delete\",\r\
          \n                        perturb_rank_shift=None,\r\n                 \
          \       genes_to_perturb=[\"ENSG00000136574\"],\r\n                    \
          \    combos=0,\r\n                        anchor_gene=None,\r\n        \
          \                model_type=\"CellClassifier\",\r\n                    \
          \    num_classes=3,\r\n                        emb_mode=\"cell\",\r\n  \
          \                      cell_emb_style=\"mean_pool\",\r\n               \
          \         filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
          ,\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={'state_key':\
          \ 'disease', \r\n                                              'start_state':\
          \ 'dcm', \r\n                                              'goal_state':\
          \ 'nf', \r\n                                              'alt_states':\
          \ ['hcm']},\r\n                        max_ncells=2000,\r\n            \
          \            emb_layer=0,\r\n                        forward_batch_size=70,\r\
          \n                        nproc=16)\r\nisp.perturb_data(\"./CellClassifier_cardiomyopathies/\"\
          ,\r\n                 \"./human_dcm_hcm_nf.dataset\",\r\n              \
          \   \"./perturb_out/\",\r\n                 \"inter_\")\r\n\r\nispstats\
          \ = InSilicoPerturberStats(mode=\"goal_state_shift\",\r\n              \
          \                    genes_perturbed=\"all\",\r\n                      \
          \            combos=0,\r\n                                  anchor_gene=None,\r\
          \n                                  cell_states_to_model={\"disease\":([\"\
          dcm\"],[\"nf\"],[\"hcm\"])})\r\n```\r\n\r\nAny idea as to why this is happening?"
        updatedAt: '2023-08-07T10:41:16.860Z'
      numEdits: 0
      reactions: []
    id: 64d0ca4c8749302d816be845
    type: comment
  author: Pingiotto
  content: "Hi Dr Theodoris, thank you for your fantastic work. I am trying to reproduce\
    \ your in silico perturbation results by deleting GATA4 from the human_dcm_hcm_nf\
    \ dataset using the fine-tuned CellClassifier_cardiomyopathies model you have\
    \ recently uploaded.\r\n\r\nBut I am getting the following error:\r\n`  File \"\
    in_silico_perturber.py\", line 413, in quant_cos_sims\r\n    attention_mask =\
    \ gen_attention_mask(original_minibatch, original_max_len)\r\nUnboundLocalError:\
    \ local variable 'original_max_len' referenced before assignment`\r\n\r\nThis\
    \ is because the following condition isnt being met, therefore original_max_len\
    \ isnt being defined:\r\n`if (len(original_minibatch_length_set) > 1) or (max(original_minibatch_length_set)\
    \ > new_max_len):`\r\n\r\nI checked the values of the relevant variables just\
    \ before the conditional:\r\nlen(original_minibatch_length_set) = 1\r\nmax(original_minibatch_length_set)\
    \ = 2048\r\nnew_max_len = 2048\r\n\r\nAnd this is how I am calling the InSilicoPerturber\
    \ class:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"delete\",\r\n  \
    \                      perturb_rank_shift=None,\r\n                        genes_to_perturb=[\"\
    ENSG00000136574\"],\r\n                        combos=0,\r\n                 \
    \       anchor_gene=None,\r\n                        model_type=\"CellClassifier\"\
    ,\r\n                        num_classes=3,\r\n                        emb_mode=\"\
    cell\",\r\n                        cell_emb_style=\"mean_pool\",\r\n         \
    \               filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
    ,\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={'state_key':\
    \ 'disease', \r\n                                              'start_state':\
    \ 'dcm', \r\n                                              'goal_state': 'nf',\
    \ \r\n                                              'alt_states': ['hcm']},\r\n\
    \                        max_ncells=2000,\r\n                        emb_layer=0,\r\
    \n                        forward_batch_size=70,\r\n                        nproc=16)\r\
    \nisp.perturb_data(\"./CellClassifier_cardiomyopathies/\",\r\n               \
    \  \"./human_dcm_hcm_nf.dataset\",\r\n                 \"./perturb_out/\",\r\n\
    \                 \"inter_\")\r\n\r\nispstats = InSilicoPerturberStats(mode=\"\
    goal_state_shift\",\r\n                                  genes_perturbed=\"all\"\
    ,\r\n                                  combos=0,\r\n                         \
    \         anchor_gene=None,\r\n                                  cell_states_to_model={\"\
    disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\r\n```\r\n\r\nAny idea as to why this\
    \ is happening?"
  created_at: 2023-08-07 09:41:16+00:00
  edited: false
  hidden: false
  id: 64d0ca4c8749302d816be845
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/bba642fd0a83520934d4fd028d256526.svg
      fullname: David Wen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: davidjwen
      type: user
    createdAt: '2023-08-07T17:18:59.000Z'
    data:
      edited: false
      editors:
      - davidjwen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9724609851837158
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/bba642fd0a83520934d4fd028d256526.svg
          fullname: David Wen
          isHf: false
          isPro: false
          name: davidjwen
          type: user
        html: "<p>Hi there \u2013 thanks for your interest in Geneformer! We've recently\
          \ made a lot of changes in the code and that error slipped through. We've\
          \ just fixed it, and thanks for clear explanation!</p>\n"
        raw: "Hi there \u2013 thanks for your interest in Geneformer! We've recently\
          \ made a lot of changes in the code and that error slipped through. We've\
          \ just fixed it, and thanks for clear explanation!"
        updatedAt: '2023-08-07T17:18:59.791Z'
      numEdits: 0
      reactions: []
    id: 64d127834e3372f9ebca7883
    type: comment
  author: davidjwen
  content: "Hi there \u2013 thanks for your interest in Geneformer! We've recently\
    \ made a lot of changes in the code and that error slipped through. We've just\
    \ fixed it, and thanks for clear explanation!"
  created_at: 2023-08-07 16:18:59+00:00
  edited: false
  hidden: false
  id: 64d127834e3372f9ebca7883
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-07T17:20:10.000Z'
    data:
      status: closed
    id: 64d127ca7a7305c58960ee93
    type: status-change
  author: ctheodoris
  created_at: 2023-08-07 16:20:10+00:00
  id: 64d127ca7a7305c58960ee93
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
      fullname: Matthew Pace
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Pingiotto
      type: user
    createdAt: '2023-08-08T09:14:31.000Z'
    data:
      edited: false
      editors:
      - Pingiotto
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.7051509022712708
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
          fullname: Matthew Pace
          isHf: false
          isPro: false
          name: Pingiotto
          type: user
        html: "<p>Hi David, thanks for looking into this. Your new script seems to\
          \ have fixed it, but it is now getting stuck on in_silico_perturber_stats.<br><code>gene_list</code>\
          \ seems to be composed of tuples and integers, which cannot be sorted. Any\
          \ idea what is causing this?</p>\n<pre><code>Traceback (most recent call\
          \ last):\n  File \"/home/ubuntu/Geneformer/examples/in_silico_perturbation.py\"\
          , line 39, in &lt;module&gt;\n    ispstats.get_stats(\"./perturb_out/\"\
          ,\n  File \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
          , line 678, in get_stats\n    gene_list = get_gene_list(dict_list, \"cell\"\
          )\n  File \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
          , line 83, in get_gene_list\n    gene_list.sort()\nTypeError: '&lt;' not\
          \ supported between instances of 'tuple' and 'int'\n</code></pre>\n"
        raw: "Hi David, thanks for looking into this. Your new script seems to have\
          \ fixed it, but it is now getting stuck on in_silico_perturber_stats.\n\
          `gene_list` seems to be composed of tuples and integers, which cannot be\
          \ sorted. Any idea what is causing this?\n\n```\nTraceback (most recent\
          \ call last):\n  File \"/home/ubuntu/Geneformer/examples/in_silico_perturbation.py\"\
          , line 39, in <module>\n    ispstats.get_stats(\"./perturb_out/\",\n  File\
          \ \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
          , line 678, in get_stats\n    gene_list = get_gene_list(dict_list, \"cell\"\
          )\n  File \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
          , line 83, in get_gene_list\n    gene_list.sort()\nTypeError: '<' not supported\
          \ between instances of 'tuple' and 'int'\n```"
        updatedAt: '2023-08-08T09:14:31.536Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64d20777c787a044b75dbf00
    id: 64d20777c787a044b75dbeff
    type: comment
  author: Pingiotto
  content: "Hi David, thanks for looking into this. Your new script seems to have\
    \ fixed it, but it is now getting stuck on in_silico_perturber_stats.\n`gene_list`\
    \ seems to be composed of tuples and integers, which cannot be sorted. Any idea\
    \ what is causing this?\n\n```\nTraceback (most recent call last):\n  File \"\
    /home/ubuntu/Geneformer/examples/in_silico_perturbation.py\", line 39, in <module>\n\
    \    ispstats.get_stats(\"./perturb_out/\",\n  File \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
    , line 678, in get_stats\n    gene_list = get_gene_list(dict_list, \"cell\")\n\
    \  File \"/home/ubuntu/miniconda3/lib/python3.10/site-packages/geneformer/in_silico_perturber_stats.py\"\
    , line 83, in get_gene_list\n    gene_list.sort()\nTypeError: '<' not supported\
    \ between instances of 'tuple' and 'int'\n```"
  created_at: 2023-08-08 08:14:31+00:00
  edited: false
  hidden: false
  id: 64d20777c787a044b75dbeff
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
      fullname: Matthew Pace
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Pingiotto
      type: user
    createdAt: '2023-08-08T09:14:31.000Z'
    data:
      status: open
    id: 64d20777c787a044b75dbf00
    type: status-change
  author: Pingiotto
  created_at: 2023-08-08 08:14:31+00:00
  id: 64d20777c787a044b75dbf00
  new_status: open
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T10:14:47.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9298693537712097
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your question! Since this is a separate question from
          the initial one here, please open a new discussion with a title descriptive
          of this question. This will be helpful for others who may have the same
          question later. Please also include the details of the options you are using
          to run the stats so we can reproduce the error and help troubleshoot. Thank
          you!</p>

          '
        raw: Thank you for your question! Since this is a separate question from the
          initial one here, please open a new discussion with a title descriptive
          of this question. This will be helpful for others who may have the same
          question later. Please also include the details of the options you are using
          to run the stats so we can reproduce the error and help troubleshoot. Thank
          you!
        updatedAt: '2023-08-08T10:14:47.038Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64d2159707abea8697b1a795
    id: 64d2159707abea8697b1a794
    type: comment
  author: ctheodoris
  content: Thank you for your question! Since this is a separate question from the
    initial one here, please open a new discussion with a title descriptive of this
    question. This will be helpful for others who may have the same question later.
    Please also include the details of the options you are using to run the stats
    so we can reproduce the error and help troubleshoot. Thank you!
  created_at: 2023-08-08 09:14:47+00:00
  edited: false
  hidden: false
  id: 64d2159707abea8697b1a794
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T10:14:47.000Z'
    data:
      status: closed
    id: 64d2159707abea8697b1a795
    type: status-change
  author: ctheodoris
  created_at: 2023-08-08 09:14:47+00:00
  id: 64d2159707abea8697b1a795
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 182
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: 'in_silico_perturber error: ''original_max_len'' referenced before assignment'
