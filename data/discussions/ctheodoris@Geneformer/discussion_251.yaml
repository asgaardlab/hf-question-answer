!!python/object:huggingface_hub.community.DiscussionWithDetails
author: kchen360
conflicting_files: null
created_at: 2023-09-22 23:24:04+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/947ad2da1f7a9a2466ab90e75e86ab07.svg
      fullname: Kai Chen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: kchen360
      type: user
    createdAt: '2023-09-23T00:24:04.000Z'
    data:
      edited: false
      editors:
      - kchen360
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.16288939118385315
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/947ad2da1f7a9a2466ab90e75e86ab07.svg
          fullname: Kai Chen
          isHf: false
          isPro: false
          name: kchen360
          type: user
        html: "<p>Hi,</p>\n<p>I tried to reproduce in silico perturbation results\
          \ as one provided from examples:</p>\n<pre><code>isp = InSilicoPerturber(perturb_type=\"\
          delete\",\n                        perturb_rank_shift=None,\n          \
          \              genes_to_perturb=[\"ENSG00000136574\"],\n               \
          \         combos=0,\n                        anchor_gene=None,\n       \
          \                 model_type=\"CellClassifier\",\n                     \
          \   num_classes=3,\n                        emb_mode=\"cell\",\n       \
          \                 cell_emb_style=\"mean_pool\",\n                      \
          \  filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\",\"\
          Cardiomyocyte3\"]},\n                        cell_states_to_model={'state_key':\
          \ 'disease', \n                                              'start_state':\
          \ 'dcm', \n                                              'goal_state': 'nf',\
          \ \n                                              'alt_states': ['hcm']},\n\
          \                        max_ncells=2000,\n                        emb_layer=0,\n\
          \                        forward_batch_size=70,\n                      \
          \  nproc=1)\nisp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224/\"\
          ,\n                 \"/home/ubuntu/Geneformer/data/\",\n               \
          \  \"./perturb_out/\",\n                 \"inter_\")\n\nispstats = InSilicoPerturberStats(mode=\"\
          goal_state_shift\",\n                                  genes_perturbed=\"\
          all\",\n                                  combos=0,\n                  \
          \                anchor_gene=None,\n                                  cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\n</code></pre>\n<p>Where the\
          \ input data directory contains example human dcm hcm disease classification\
          \ dataset include: <code>dataset.arrow, dataset_info.json, state.json</code>.\
          \ Yet the error occurs:</p>\n<pre><code>Filter: 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588| 579159/579159 [05:07&lt;00:00, 1881.22 examples/s]\nFilter:\
          \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000\
          \ [00:01&lt;00:00, 1201.53 examples/s]\nFilter: 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01&lt;00:00, 1183.41\
          \ examples/s]\nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588| 2000/2000 [00:01&lt;00:00, 1196.40 examples/s]\nFilter: 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588| 144962/144962 [02:01&lt;00:00, 1196.26 examples/s]\n\
          Filter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30301/30301\
          \ [00:29&lt;00:00, 1027.08 examples/s]\nMap: 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000\
          \ [00:07&lt;00:00, 253.53 examples/s]\nMap: 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000\
          \ [00:02&lt;00:00, 726.47 examples/s]\n/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:450:\
          \ UserWarning: To copy construct from a tensor, it is recommended to use\
          \ sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True),\
          \ rather than torch.tensor(sourceTensor).\n  original_minibatch_lengths\
          \ = torch.tensor(original_minibatch[\"length\"], device=\"cuda\")\n/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:451:\
          \ UserWarning: To copy construct from a tensor, it is recommended to use\
          \ sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True),\
          \ rather than torch.tensor(sourceTensor).\n  minibatch_lengths = torch.tensor(perturbation_minibatch[\"\
          length\"], device=\"cuda\")\nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 70/70 [00:00&lt;00:00, 746.04 examples/s]\nMap: 100%|\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588| 70/70 [00:00&lt;00:00, 750.51 examples/s]\nEmbeddings\
          \ are not the same dimensions. original_emb is torch.Size([70, 2046, 256]).\
          \ minibatch_emb is torch.Size([70, 2047, 256]).\nTraceback (most recent\
          \ call last):\n  File \"/home/ubuntu/Geneformer/in_silico_perturbation.py\"\
          , line 24, in &lt;module&gt;\n    isp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224\"\
          ,\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 981, in perturb_data\n    self.in_silico_perturb(model,\n  File \"\
          /home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 1059,\
          \ in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\n  File\
          \ \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 459,\
          \ in quant_cos_sims\n    cos_sims_vs_alt_dict[state] += cos_sim_shift(original_minibatch_emb,\n\
          \  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line\
          \ 495, in cos_sim_shift\n    raise\nRuntimeError: No active exception to\
          \ reraise\n</code></pre>\n<p>Is it because something is needed to be tuned\
          \ before running example code? Any tip will be helpful. Thank you. </p>\n"
        raw: "Hi,\r\n\r\nI tried to reproduce in silico perturbation results as one\
          \ provided from examples:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"\
          delete\",\r\n                        perturb_rank_shift=None,\r\n      \
          \                  genes_to_perturb=[\"ENSG00000136574\"],\r\n         \
          \               combos=0,\r\n                        anchor_gene=None,\r\
          \n                        model_type=\"CellClassifier\",\r\n           \
          \             num_classes=3,\r\n                        emb_mode=\"cell\"\
          ,\r\n                        cell_emb_style=\"mean_pool\",\r\n         \
          \               filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
          ,\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={'state_key':\
          \ 'disease', \r\n                                              'start_state':\
          \ 'dcm', \r\n                                              'goal_state':\
          \ 'nf', \r\n                                              'alt_states':\
          \ ['hcm']},\r\n                        max_ncells=2000,\r\n            \
          \            emb_layer=0,\r\n                        forward_batch_size=70,\r\
          \n                        nproc=1)\r\nisp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224/\"\
          ,\r\n                 \"/home/ubuntu/Geneformer/data/\",\r\n           \
          \      \"./perturb_out/\",\r\n                 \"inter_\")\r\n\r\nispstats\
          \ = InSilicoPerturberStats(mode=\"goal_state_shift\",\r\n              \
          \                    genes_perturbed=\"all\",\r\n                      \
          \            combos=0,\r\n                                  anchor_gene=None,\r\
          \n                                  cell_states_to_model={\"disease\":([\"\
          dcm\"],[\"nf\"],[\"hcm\"])})\r\n```\r\n\r\nWhere the input data directory\
          \ contains example human dcm hcm disease classification dataset include:\
          \ `dataset.arrow, dataset_info.json, state.json`. Yet the error occurs:\r\
          \n \r\n```\r\nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 579159/579159\
          \ [05:07<00:00, 1881.22 examples/s]\r\nFilter: 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01<00:00, 1201.53 examples/s]\r\
          \nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 2000/2000 [00:01<00:00, 1183.41 examples/s]\r\nFilter: 100%|\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01<00:00,\
          \ 1196.40 examples/s]\r\nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 144962/144962 [02:01<00:00, 1196.26 examples/s]\r\nFilter: 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30301/30301 [00:29<00:00, 1027.08\
          \ examples/s]\r\nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:07<00:00, 253.53 examples/s]\r\
          \nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588| 2000/2000 [00:02<00:00, 726.47 examples/s]\r\n\
          /home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:450: UserWarning:\
          \ To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach()\
          \ or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).\r\
          \n  original_minibatch_lengths = torch.tensor(original_minibatch[\"length\"\
          ], device=\"cuda\")\r\n/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:451:\
          \ UserWarning: To copy construct from a tensor, it is recommended to use\
          \ sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True),\
          \ rather than torch.tensor(sourceTensor).\r\n  minibatch_lengths = torch.tensor(perturbation_minibatch[\"\
          length\"], device=\"cuda\")\r\nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 70/70 [00:00<00:00, 746.04 examples/s]\r\nMap: 100%|\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588| 70/70 [00:00<00:00, 750.51 examples/s]\r\nEmbeddings\
          \ are not the same dimensions. original_emb is torch.Size([70, 2046, 256]).\
          \ minibatch_emb is torch.Size([70, 2047, 256]).\r\nTraceback (most recent\
          \ call last):\r\n  File \"/home/ubuntu/Geneformer/in_silico_perturbation.py\"\
          , line 24, in <module>\r\n    isp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224\"\
          ,\r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 981, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File\
          \ \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 1059,\
          \ in in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\r\n\
          \  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line\
          \ 459, in quant_cos_sims\r\n    cos_sims_vs_alt_dict[state] += cos_sim_shift(original_minibatch_emb,\r\
          \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\",\
          \ line 495, in cos_sim_shift\r\n    raise\r\nRuntimeError: No active exception\
          \ to reraise\r\n```\r\n\r\nIs it because something is needed to be tuned\
          \ before running example code? Any tip will be helpful. Thank you. "
        updatedAt: '2023-09-23T00:24:04.090Z'
      numEdits: 0
      reactions: []
    id: 650e302499fe56caa8ea2b26
    type: comment
  author: kchen360
  content: "Hi,\r\n\r\nI tried to reproduce in silico perturbation results as one\
    \ provided from examples:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"\
    delete\",\r\n                        perturb_rank_shift=None,\r\n            \
    \            genes_to_perturb=[\"ENSG00000136574\"],\r\n                     \
    \   combos=0,\r\n                        anchor_gene=None,\r\n               \
    \         model_type=\"CellClassifier\",\r\n                        num_classes=3,\r\
    \n                        emb_mode=\"cell\",\r\n                        cell_emb_style=\"\
    mean_pool\",\r\n                        filter_data={\"cell_type\":[\"Cardiomyocyte1\"\
    ,\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={'state_key':\
    \ 'disease', \r\n                                              'start_state':\
    \ 'dcm', \r\n                                              'goal_state': 'nf',\
    \ \r\n                                              'alt_states': ['hcm']},\r\n\
    \                        max_ncells=2000,\r\n                        emb_layer=0,\r\
    \n                        forward_batch_size=70,\r\n                        nproc=1)\r\
    \nisp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224/\"\
    ,\r\n                 \"/home/ubuntu/Geneformer/data/\",\r\n                 \"\
    ./perturb_out/\",\r\n                 \"inter_\")\r\n\r\nispstats = InSilicoPerturberStats(mode=\"\
    goal_state_shift\",\r\n                                  genes_perturbed=\"all\"\
    ,\r\n                                  combos=0,\r\n                         \
    \         anchor_gene=None,\r\n                                  cell_states_to_model={\"\
    disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\r\n```\r\n\r\nWhere the input data\
    \ directory contains example human dcm hcm disease classification dataset include:\
    \ `dataset.arrow, dataset_info.json, state.json`. Yet the error occurs:\r\n \r\
    \n```\r\nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588| 579159/579159 [05:07<00:00, 1881.22 examples/s]\r\n\
    Filter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01<00:00, 1201.53 examples/s]\r\
    \nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01<00:00, 1183.41 examples/s]\r\
    \nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:01<00:00, 1196.40 examples/s]\r\
    \nFilter: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588| 144962/144962 [02:01<00:00, 1196.26 examples/s]\r\nFilter:\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588| 30301/30301 [00:29<00:00, 1027.08 examples/s]\r\nMap:\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2000/2000 [00:07<00:00,\
    \ 253.53 examples/s]\r\nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588| 2000/2000 [00:02<00:00, 726.47 examples/s]\r\n/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:450:\
    \ UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach()\
    \ or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).\r\
    \n  original_minibatch_lengths = torch.tensor(original_minibatch[\"length\"],\
    \ device=\"cuda\")\r\n/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py:451:\
    \ UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach()\
    \ or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).\r\
    \n  minibatch_lengths = torch.tensor(perturbation_minibatch[\"length\"], device=\"\
    cuda\")\r\nMap: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588| 70/70 [00:00<00:00, 746.04 examples/s]\r\nMap: 100%|\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 70/70\
    \ [00:00<00:00, 750.51 examples/s]\r\nEmbeddings are not the same dimensions.\
    \ original_emb is torch.Size([70, 2046, 256]). minibatch_emb is torch.Size([70,\
    \ 2047, 256]).\r\nTraceback (most recent call last):\r\n  File \"/home/ubuntu/Geneformer/in_silico_perturbation.py\"\
    , line 24, in <module>\r\n    isp.perturb_data(\"./fine_tuned_models/geneformer-6L-30M_CellClassifier_cardiomyopathies_220224\"\
    ,\r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line\
    \ 981, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
    , line 1059, in in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\r\
    \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 459,\
    \ in quant_cos_sims\r\n    cos_sims_vs_alt_dict[state] += cos_sim_shift(original_minibatch_emb,\r\
    \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 495,\
    \ in cos_sim_shift\r\n    raise\r\nRuntimeError: No active exception to reraise\r\
    \n```\r\n\r\nIs it because something is needed to be tuned before running example\
    \ code? Any tip will be helpful. Thank you. "
  created_at: 2023-09-22 23:24:04+00:00
  edited: false
  hidden: false
  id: 650e302499fe56caa8ea2b26
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/0a4422c08eab1b32dd30922fc0fb7666.svg
      fullname: Journey
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Jonyyqn
      type: user
    createdAt: '2023-10-17T08:45:21.000Z'
    data:
      edited: false
      editors:
      - Jonyyqn
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9756972193717957
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/0a4422c08eab1b32dd30922fc0fb7666.svg
          fullname: Journey
          isHf: false
          isPro: false
          name: Jonyyqn
          type: user
        html: '<p>I also encountered the same error. Can anyone help solve it?</p>

          '
        raw: I also encountered the same error. Can anyone help solve it?
        updatedAt: '2023-10-17T08:45:21.012Z'
      numEdits: 0
      reactions: []
    id: 652e49a165a4619fb5e2cdbf
    type: comment
  author: Jonyyqn
  content: I also encountered the same error. Can anyone help solve it?
  created_at: 2023-10-17 07:45:21+00:00
  edited: false
  hidden: false
  id: 652e49a165a4619fb5e2cdbf
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T09:00:42.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9056812524795532
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer and for your patience!
          We pushed an update that should resolve this issue. If you continue to face
          errors after pulling the updated code, please let us know by either reopening
          this discussion if it''s the same error or opening a new discussion if it''s
          a new error. Thank you!</p>

          '
        raw: Thank you for your interest in Geneformer and for your patience! We pushed
          an update that should resolve this issue. If you continue to face errors
          after pulling the updated code, please let us know by either reopening this
          discussion if it's the same error or opening a new discussion if it's a
          new error. Thank you!
        updatedAt: '2023-12-15T09:00:42.892Z'
      numEdits: 0
      reactions: []
      relatedEventId: 657c15ba8c3aee70547d6c86
    id: 657c15ba8c3aee70547d6c84
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer and for your patience! We pushed
    an update that should resolve this issue. If you continue to face errors after
    pulling the updated code, please let us know by either reopening this discussion
    if it's the same error or opening a new discussion if it's a new error. Thank
    you!
  created_at: 2023-12-15 09:00:42+00:00
  edited: false
  hidden: false
  id: 657c15ba8c3aee70547d6c84
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T09:00:42.000Z'
    data:
      status: closed
    id: 657c15ba8c3aee70547d6c86
    type: status-change
  author: ctheodoris
  created_at: 2023-12-15 09:00:42+00:00
  id: 657c15ba8c3aee70547d6c86
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 251
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: '[In silico perturbation] RuntimeError: No active exception to reraise'
