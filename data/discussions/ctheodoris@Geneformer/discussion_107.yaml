!!python/object:huggingface_hub.community.DiscussionWithDetails
author: simplern
conflicting_files: null
created_at: 2023-07-11 01:36:01+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2794662f172cce4c49c3e198cdb0fb93.svg
      fullname: huang
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: simplern
      type: user
    createdAt: '2023-07-11T02:36:01.000Z'
    data:
      edited: false
      editors:
      - simplern
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8983500003814697
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2794662f172cce4c49c3e198cdb0fb93.svg
          fullname: huang
          isHf: false
          isPro: false
          name: simplern
          type: user
        html: '<p>Hello Geneformer developers and users.<br>I am new to Geneformer
          and transformer.<br> I got a cell classification model by fine-tuning Geneformer,
          how can I deploy the model to make cell label predictions on new datasets,
          for example on previously unused test sets, could you provide a code example?</p>

          '
        raw: "Hello Geneformer developers and users.\r\nI am new to Geneformer and\
          \ transformer.\r\n I got a cell classification model by fine-tuning Geneformer,\
          \ how can I deploy the model to make cell label predictions on new datasets,\
          \ for example on previously unused test sets, could you provide a code example?"
        updatedAt: '2023-07-11T02:36:01.548Z'
      numEdits: 0
      reactions: []
    id: 64acc01109d1b58891e189bd
    type: comment
  author: simplern
  content: "Hello Geneformer developers and users.\r\nI am new to Geneformer and transformer.\r\
    \n I got a cell classification model by fine-tuning Geneformer, how can I deploy\
    \ the model to make cell label predictions on new datasets, for example on previously\
    \ unused test sets, could you provide a code example?"
  created_at: 2023-07-11 01:36:01+00:00
  edited: false
  hidden: false
  id: 64acc01109d1b58891e189bd
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-11T04:42:39.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9068225622177124
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer! One way to use the model
          to make predictions on new datasets is by the trainer.predict method, which
          is demonstrated in the cell classification example notebook (please refer
          to the last 5 lines of the notebook). Another way is to load the model and
          obtain the predictions from the model outputs. Please see the "classifier_predict"
          function defined in the gene classification example notebook.</p>

          '
        raw: Thank you for your interest in Geneformer! One way to use the model to
          make predictions on new datasets is by the trainer.predict method, which
          is demonstrated in the cell classification example notebook (please refer
          to the last 5 lines of the notebook). Another way is to load the model and
          obtain the predictions from the model outputs. Please see the "classifier_predict"
          function defined in the gene classification example notebook.
        updatedAt: '2023-07-11T04:42:39.340Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64acddbfb7d86b40fd718290
    id: 64acddbfb7d86b40fd71828d
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer! One way to use the model to
    make predictions on new datasets is by the trainer.predict method, which is demonstrated
    in the cell classification example notebook (please refer to the last 5 lines
    of the notebook). Another way is to load the model and obtain the predictions
    from the model outputs. Please see the "classifier_predict" function defined in
    the gene classification example notebook.
  created_at: 2023-07-11 03:42:39+00:00
  edited: false
  hidden: false
  id: 64acddbfb7d86b40fd71828d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-11T04:42:39.000Z'
    data:
      status: closed
    id: 64acddbfb7d86b40fd718290
    type: status-change
  author: ctheodoris
  created_at: 2023-07-11 03:42:39+00:00
  id: 64acddbfb7d86b40fd718290
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-11T09:27:56.000Z'
    data:
      edited: true
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.5508977770805359
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;ctheodoris&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/ctheodoris\">@<span class=\"\
          underline\">ctheodoris</span></a></span>\n\n\t</span></span><br>I use the\
          \ fine-tuned model to predict a new dataset by Trainer.<br>When the length\
          \ is inconsistent, the prediction will report an error, do you have any\
          \ suggestions, the code is as follows:</p>\n<pre><code>train_dataset=load_from_disk(\"\
          /scRNA/Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/\"\
          )\ntrain_dataset = train_dataset.shuffle(seed=42).select(i for i in range(100))\n\
          set(train_dataset['disease'])# {'dcm', 'hcm', 'nf'}\ntest_dataset = train_dataset.remove_columns(['individual',\
          \ 'age', 'sex',  'lvef','cell_type','disease'])\n\nmodel=BertForSequenceClassification.from_pretrained(\"\
          /scRNA/Geneformer/checkpoint/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/\"\
          , ).to(\"cpu\")\ntrainer = Trainer(model=model)\npredictions = trainer.predict(test_dataset)\n\
          pre = predictions.predictions\n</code></pre>\n<p>Error is:<br>ValueError:\
          \ expected sequence of length 794 at dim 1 (got 432)</p>\n<p>Input dataset\
          \ to dataframe like:</p>\n<p><a rel=\"nofollow\" href=\"https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/CS0xtwDabnqonJDK-61qI.png\"\
          ><img alt=\"image.png\" src=\"https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/CS0xtwDabnqonJDK-61qI.png\"\
          ></a></p>\n"
        raw: '@ctheodoris

          I use the fine-tuned model to predict a new dataset by Trainer.

          When the length is inconsistent, the prediction will report an error, do
          you have any suggestions, the code is as follows:

          ```

          train_dataset=load_from_disk("/scRNA/Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/")

          train_dataset = train_dataset.shuffle(seed=42).select(i for i in range(100))

          set(train_dataset[''disease''])# {''dcm'', ''hcm'', ''nf''}

          test_dataset = train_dataset.remove_columns([''individual'', ''age'', ''sex'',  ''lvef'',''cell_type'',''disease''])


          model=BertForSequenceClassification.from_pretrained("/scRNA/Geneformer/checkpoint/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/",
          ).to("cpu")

          trainer = Trainer(model=model)

          predictions = trainer.predict(test_dataset)

          pre = predictions.predictions

          ```

          Error is:

          ValueError: expected sequence of length 794 at dim 1 (got 432)


          Input dataset to dataframe like:


          ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/CS0xtwDabnqonJDK-61qI.png)



          '
        updatedAt: '2023-07-11T09:30:32.460Z'
      numEdits: 6
      reactions: []
    id: 64ad209c2d29d3bdcd4aff0c
    type: comment
  author: Renqing
  content: '@ctheodoris

    I use the fine-tuned model to predict a new dataset by Trainer.

    When the length is inconsistent, the prediction will report an error, do you have
    any suggestions, the code is as follows:

    ```

    train_dataset=load_from_disk("/scRNA/Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/")

    train_dataset = train_dataset.shuffle(seed=42).select(i for i in range(100))

    set(train_dataset[''disease''])# {''dcm'', ''hcm'', ''nf''}

    test_dataset = train_dataset.remove_columns([''individual'', ''age'', ''sex'',  ''lvef'',''cell_type'',''disease''])


    model=BertForSequenceClassification.from_pretrained("/scRNA/Geneformer/checkpoint/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/",
    ).to("cpu")

    trainer = Trainer(model=model)

    predictions = trainer.predict(test_dataset)

    pre = predictions.predictions

    ```

    Error is:

    ValueError: expected sequence of length 794 at dim 1 (got 432)


    Input dataset to dataframe like:


    ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/CS0xtwDabnqonJDK-61qI.png)



    '
  created_at: 2023-07-11 08:27:56+00:00
  edited: true
  hidden: false
  id: 64ad209c2d29d3bdcd4aff0c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-11T12:05:47.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9267192482948303
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your question. Batches of tensors need to be padded
          to be the same length. </p>

          '
        raw: 'Thank you for your question. Batches of tensors need to be padded to
          be the same length. '
        updatedAt: '2023-07-11T12:05:47.416Z'
      numEdits: 0
      reactions: []
    id: 64ad459bb7d86b40fd7e921e
    type: comment
  author: ctheodoris
  content: 'Thank you for your question. Batches of tensors need to be padded to be
    the same length. '
  created_at: 2023-07-11 11:05:47+00:00
  edited: false
  hidden: false
  id: 64ad459bb7d86b40fd7e921e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-13T01:18:50.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6035503149032593
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>Thank you for  responding,  just like <code>preprocess_classifier_batch</code>
          function defined in the gene classification example notebook?</p>

          '
        raw: Thank you for  responding,  just like `preprocess_classifier_batch` function
          defined in the gene classification example notebook?
        updatedAt: '2023-07-13T01:18:50.155Z'
      numEdits: 0
      reactions: []
    id: 64af50fa0d79759ee64c2f8a
    type: comment
  author: Renqing
  content: Thank you for  responding,  just like `preprocess_classifier_batch` function
    defined in the gene classification example notebook?
  created_at: 2023-07-13 00:18:50+00:00
  edited: false
  hidden: false
  id: 64af50fa0d79759ee64c2f8a
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-13T01:22:32.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9959872961044312
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Yes, that''s right!</p>

          '
        raw: Yes, that's right!
        updatedAt: '2023-07-13T01:22:32.508Z'
      numEdits: 0
      reactions: []
    id: 64af51d8c313684399b1b7c2
    type: comment
  author: ctheodoris
  content: Yes, that's right!
  created_at: 2023-07-13 00:22:32+00:00
  edited: false
  hidden: false
  id: 64af51d8c313684399b1b7c2
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-13T01:23:20.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8000723719596863
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>Thanks.</p>

          '
        raw: Thanks.
        updatedAt: '2023-07-13T01:23:20.842Z'
      numEdits: 0
      reactions: []
    id: 64af5208d2373ae50c04f530
    type: comment
  author: Renqing
  content: Thanks.
  created_at: 2023-07-13 00:23:20+00:00
  edited: false
  hidden: false
  id: 64af5208d2373ae50c04f530
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 107
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: How to use fine-tuned models to predict new datasets
