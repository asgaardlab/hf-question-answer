!!python/object:huggingface_hub.community.DiscussionWithDetails
author: swang12
conflicting_files: null
created_at: 2023-09-08 06:19:07+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/dfad9b282f034de3ccdaf7ab2b999559.svg
      fullname: Su Wang
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: swang12
      type: user
    createdAt: '2023-09-08T07:19:07.000Z'
    data:
      edited: false
      editors:
      - swang12
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.4023975729942322
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/dfad9b282f034de3ccdaf7ab2b999559.svg
          fullname: Su Wang
          isHf: false
          isPro: false
          name: swang12
          type: user
        html: "<p>Hi, I'm running InSilicoPerturber for a single gene:</p>\n<p>for\
          \ gene in tqdm(genes_to_perturb):<br>    output_directory = f'{work_directory}{gene}/'<br>\
          \    os.mkdir(output_directory)</p>\n<pre><code>gene_id = df.at[gene, 'Ensembl_ID']\n\
          \nshutil.copytree(f'{root_directory}tokenized_.dataset', f'{output_directory}tokenized_copy.dataset')\n\
          \nisp = InSilicoPerturber(perturb_type='delete', \n                    \
          \    perturb_rank_shift=None, \n                        genes_to_perturb=[gene_id],\
          \ \n                        combos=0, \n                        anchor_gene=None,\
          \ \n                        model_type='Pretrained', \n                \
          \        num_classes=0, \n                        emb_mode='cell_and_gene',\
          \ \n                        cell_emb_style='mean_pool', \n             \
          \           cell_states_to_model=None, \n                        max_ncells=2000,\
          \ \n                        emb_layer=-1, \n                        forward_batch_size=32,\
          \ \n                        nproc=16\n                        )\n\nisp.perturb_data(model_directory='Geneformer/',\
          \ \n                 input_data_file=f'{output_directory}tokenized_copy.dataset',\
          \ \n                 output_directory=output_directory, \n             \
          \    output_prefix='perturbed'\n                 )\n\nispstats = InSilicoPerturberStats(mode='mixture_model',\
          \ \n                                  combos=0, \n                     \
          \             anchor_gene=None, \n                                  cell_states_to_model=None\n\
          \                                  )\n\nispstats.get_stats(input_data_directory=output_directory,\n\
          \                   null_dist_data_directory=None,\n                   output_directory=output_directory,\n\
          \                   output_prefix='stats'\n                   )\n</code></pre>\n\
          <p>I tried both python3.8.10 and python3.10.12. For any gene, I got similar\
          \ errors:</p>\n<p>Traceback (most recent call last):<br>  File \"/raid/swang12/Transformer31012/perturb_one.py\"\
          , line 80, in <br>    isp.perturb_data(model_directory='Geneformer/',<br>\
          \  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 981, in perturb_data<br>    self.in_silico_perturb(model,<br>  File\
          \ \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1059, in in_silico_perturb<br>    cos_sims_data = quant_cos_sims(model,<br>\
          \  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 445, in quant_cos_sims<br>    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]<br>  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 1501, in _call_impl<br>    return forward_call(*args, **kwargs)<br>\
          \  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 87, in forward<br>    return F.cosine_similarity(x1, x2, self.dim,\
          \ self.eps)<br>RuntimeError: The size of tensor a (2047) must match the\
          \ size of tensor b (2046) at non-singleton dimension 1</p>\n<p>Could you\
          \ help me with this? Thank you very much!</p>\n<p>Sincerely,<br>Su</p>\n"
        raw: "Hi, I'm running InSilicoPerturber for a single gene:\r\n\r\nfor gene\
          \ in tqdm(genes_to_perturb):\r\n    output_directory = f'{work_directory}{gene}/'\r\
          \n    os.mkdir(output_directory)\r\n\r\n    gene_id = df.at[gene, 'Ensembl_ID']\r\
          \n\r\n    shutil.copytree(f'{root_directory}tokenized_.dataset', f'{output_directory}tokenized_copy.dataset')\r\
          \n\r\n    isp = InSilicoPerturber(perturb_type='delete', \r\n          \
          \                  perturb_rank_shift=None, \r\n                       \
          \     genes_to_perturb=[gene_id], \r\n                            combos=0,\
          \ \r\n                            anchor_gene=None, \r\n               \
          \             model_type='Pretrained', \r\n                            num_classes=0,\
          \ \r\n                            emb_mode='cell_and_gene', \r\n       \
          \                     cell_emb_style='mean_pool', \r\n                 \
          \           cell_states_to_model=None, \r\n                            max_ncells=2000,\
          \ \r\n                            emb_layer=-1, \r\n                   \
          \         forward_batch_size=32, \r\n                            nproc=16\r\
          \n                            )\r\n\r\n    isp.perturb_data(model_directory='Geneformer/',\
          \ \r\n                     input_data_file=f'{output_directory}tokenized_copy.dataset',\
          \ \r\n                     output_directory=output_directory, \r\n     \
          \                output_prefix='perturbed'\r\n                     )\r\n\
          \r\n    ispstats = InSilicoPerturberStats(mode='mixture_model', \r\n   \
          \                                   combos=0, \r\n                     \
          \                 anchor_gene=None, \r\n                               \
          \       cell_states_to_model=None\r\n                                  \
          \    )\r\n\r\n    ispstats.get_stats(input_data_directory=output_directory,\r\
          \n                       null_dist_data_directory=None,\r\n            \
          \           output_directory=output_directory,\r\n                     \
          \  output_prefix='stats'\r\n                       )\r\n\r\nI tried both\
          \ python3.8.10 and python3.10.12. For any gene, I got similar errors:\r\n\
          \r\nTraceback (most recent call last):\r\n  File \"/raid/swang12/Transformer31012/perturb_one.py\"\
          , line 80, in <module>\r\n    isp.perturb_data(model_directory='Geneformer/',\
          \ \r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 981, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File\
          \ \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1059, in in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\
          \ \r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 445, in quant_cos_sims\r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]\r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 1501, in _call_impl\r\n    return forward_call(*args, **kwargs)\r\
          \n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 87, in forward\r\n    return F.cosine_similarity(x1, x2, self.dim,\
          \ self.eps)\r\nRuntimeError: The size of tensor a (2047) must match the\
          \ size of tensor b (2046) at non-singleton dimension 1\r\n\r\nCould you\
          \ help me with this? Thank you very much!\r\n\r\nSincerely,\r\nSu"
        updatedAt: '2023-09-08T07:19:07.036Z'
      numEdits: 0
      reactions: []
    id: 64facaebe0dc35986b8b6f01
    type: comment
  author: swang12
  content: "Hi, I'm running InSilicoPerturber for a single gene:\r\n\r\nfor gene in\
    \ tqdm(genes_to_perturb):\r\n    output_directory = f'{work_directory}{gene}/'\r\
    \n    os.mkdir(output_directory)\r\n\r\n    gene_id = df.at[gene, 'Ensembl_ID']\r\
    \n\r\n    shutil.copytree(f'{root_directory}tokenized_.dataset', f'{output_directory}tokenized_copy.dataset')\r\
    \n\r\n    isp = InSilicoPerturber(perturb_type='delete', \r\n                \
    \            perturb_rank_shift=None, \r\n                            genes_to_perturb=[gene_id],\
    \ \r\n                            combos=0, \r\n                            anchor_gene=None,\
    \ \r\n                            model_type='Pretrained', \r\n              \
    \              num_classes=0, \r\n                            emb_mode='cell_and_gene',\
    \ \r\n                            cell_emb_style='mean_pool', \r\n           \
    \                 cell_states_to_model=None, \r\n                            max_ncells=2000,\
    \ \r\n                            emb_layer=-1, \r\n                         \
    \   forward_batch_size=32, \r\n                            nproc=16\r\n      \
    \                      )\r\n\r\n    isp.perturb_data(model_directory='Geneformer/',\
    \ \r\n                     input_data_file=f'{output_directory}tokenized_copy.dataset',\
    \ \r\n                     output_directory=output_directory, \r\n           \
    \          output_prefix='perturbed'\r\n                     )\r\n\r\n    ispstats\
    \ = InSilicoPerturberStats(mode='mixture_model', \r\n                        \
    \              combos=0, \r\n                                      anchor_gene=None,\
    \ \r\n                                      cell_states_to_model=None\r\n    \
    \                                  )\r\n\r\n    ispstats.get_stats(input_data_directory=output_directory,\r\
    \n                       null_dist_data_directory=None,\r\n                  \
    \     output_directory=output_directory,\r\n                       output_prefix='stats'\r\
    \n                       )\r\n\r\nI tried both python3.8.10 and python3.10.12.\
    \ For any gene, I got similar errors:\r\n\r\nTraceback (most recent call last):\r\
    \n  File \"/raid/swang12/Transformer31012/perturb_one.py\", line 80, in <module>\r\
    \n    isp.perturb_data(model_directory='Geneformer/', \r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 981, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File \"\
    /home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 1059, in in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\
    \ \r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 445, in quant_cos_sims\r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
    cpu\")]\r\n  File \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
    , line 1501, in _call_impl\r\n    return forward_call(*args, **kwargs)\r\n  File\
    \ \"/home/swang12/anaconda3/envs/myenv/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
    , line 87, in forward\r\n    return F.cosine_similarity(x1, x2, self.dim, self.eps)\r\
    \nRuntimeError: The size of tensor a (2047) must match the size of tensor b (2046)\
    \ at non-singleton dimension 1\r\n\r\nCould you help me with this? Thank you very\
    \ much!\r\n\r\nSincerely,\r\nSu"
  created_at: 2023-09-08 06:19:07+00:00
  edited: false
  hidden: false
  id: 64facaebe0dc35986b8b6f01
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/87affbf02e38d7088fb2b90ea634836f.svg
      fullname: Tara
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: MinieRosie
      type: user
    createdAt: '2023-09-08T14:41:49.000Z'
    data:
      edited: false
      editors:
      - MinieRosie
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9962062239646912
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/87affbf02e38d7088fb2b90ea634836f.svg
          fullname: Tara
          isHf: false
          isPro: false
          name: MinieRosie
          type: user
        html: '<p>I''m also having this same issue, refer to discussion <a href="/ctheodoris/Geneformer/discussions/85">#85</a>.
          </p>

          '
        raw: 'I''m also having this same issue, refer to discussion #85. '
        updatedAt: '2023-09-08T14:41:49.141Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F91D"
        users:
        - swang12
    id: 64fb32addc46569735664b00
    type: comment
  author: MinieRosie
  content: 'I''m also having this same issue, refer to discussion #85. '
  created_at: 2023-09-08 13:41:49+00:00
  edited: false
  hidden: false
  id: 64fb32addc46569735664b00
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
      fullname: Julie Nguyen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: junguyen
      type: user
    createdAt: '2023-09-26T13:10:48.000Z'
    data:
      edited: false
      editors:
      - junguyen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.3825297951698303
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
          fullname: Julie Nguyen
          isHf: false
          isPro: false
          name: junguyen
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;swang12&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/swang12\">@<span class=\"\
          underline\">swang12</span></a></span>\n\n\t</span></span> <span data-props=\"\
          {&quot;user&quot;:&quot;MinieRosie&quot;}\" data-target=\"UserMention\"\
          \ class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"inline-block\"\
          ><span class=\"contents\"><a href=\"/MinieRosie\">@<span class=\"underline\"\
          >MinieRosie</span></a></span>\n\n\t</span></span> I found that this error\
          \ only occurs at certain cell indices. While I haven't solved this error,\
          \ I did find a work around that allows the function to process through more\
          \ cells instead of throwing an error at the beginning. You can specify <code>cell_inds_to_perturb={'start':0,\
          \ 'end':2}</code> and <code>forward_batch_size=2</code>, for example. Then\
          \ loop the command to output a pickle file for every 2 cells. I personally\
          \ had to loop the command in bash to prevent OOM errors. See example below.\
          \ Hope this helps!</p>\n<pre><code>#!/usr/bin/env bash\n# in_silico_perturbation_loop.sh\n\
          \ni=0\nj=2\nk=1\n\nfor a in {1..193}\ndo\n  python3 in_silico_perturbation_loop.py\
          \ -i $i -j $j -k $k;\n  i=$(($i+2))\n  j=$(($j+2))\n  k=$(($k+1))\n  rm\
          \ /data/genecorpus_filtered_hep/cache*\n  echo $i $j $k\ndone\n\npython3\
          \ in_silico_perturbation_stats.py\n</code></pre>\n<pre><code>#!/usr/bin/env\
          \ python3\n# in_silico_perturbation_loop.py\n\n# Import libraries\nfrom\
          \ geneformer import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\
          from datasets import load_from_disk\nimport os\nimport gc\nimport torch\n\
          import argparse\n\ndef main():\n    args = get_cli_args()\n    i = args.i\n\
          \    j = args.j\n    k = args.k\n\n    # 1. Set parameters for perturbation\
          \ function\n    gc.collect()\n    torch.cuda.empty_cache()\n\n    isp =\
          \ InSilicoPerturber(perturb_type=\"delete\",\n                         \
          \   perturb_rank_shift=None,\n                            genes_to_perturb=[\"\
          ENSG00000118520\"],\n                            combos=0,\n           \
          \                 anchor_gene=None,\n                            model_type=\"\
          Pretrained\",\n                            num_classes=0,\n            \
          \                emb_mode=\"cell\",\n                            cell_emb_style=\"\
          mean_pool\",\n                            filter_data=None,\n          \
          \                  cell_states_to_model=None,\n                        \
          \    max_ncells=None,\n                            cell_inds_to_perturb={\"\
          start\":i,\n                                                  \"end\":j},\n\
          \                            emb_layer=-1,\n                           \
          \ forward_batch_size=2,\n                            nproc=2,\n        \
          \                    token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\n\n    # 2. Perturb data\n    isp.perturb_data(\"/home/ubuntu/Geneformer/\"\
          ,\n                     \"/data/genecorpus_filtered_hep/\",\n          \
          \           \"/data/genecorpus_filtered_hep/delete_cell/\",\n          \
          \           f\"cell_ARG1_{k}\")\n\ndef get_cli_args():\n    parser = argparse.ArgumentParser()\n\
          \n    parser.add_argument('-i', dest='i',\n                        type=int,\
          \ help=\"Starting cell index\",\n                        required=True)\n\
          \    parser.add_argument('-j', dest='j',\n                        type=int,\
          \ help=\"Ending cell index\",\n                        required=True)\n\
          \    parser.add_argument('-k', dest='k',\n                        type=int,\
          \ help=\"Pickle file suffix\",\n                        required=True)\n\
          \n    return parser.parse_args()\n\nif __name__ == '__main__':\n    main()\n\
          </code></pre>\n<pre><code>#!/usr/bin/env python3\n# in_silico_perturbation_stats.py\n\
          \nfrom geneformer import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\
          import argparse\n\n# 1. Set parameters for perturbation statistics\nispstats\
          \ = InSilicoPerturberStats(mode=\"aggregate_data\",\n                  \
          \                genes_perturbed=[\"ENSG00000118520\"],\n              \
          \                    combos=0,\n                                  anchor_gene=None,\n\
          \                                  cell_states_to_model=None,\n        \
          \                          token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\n\n# 2. Get perturbation stats\nispstats.get_stats(\"/data/genecorpus_filtered_hep/delete_cell/\"\
          ,\n                   None,\n                   \"/data/genecorpus_filtered_hep/delete_cell/\"\
          ,\n                   \"delete_cell_ARG1\")\n</code></pre>\n"
        raw: "@swang12 @MinieRosie I found that this error only occurs at certain\
          \ cell indices. While I haven't solved this error, I did find a work around\
          \ that allows the function to process through more cells instead of throwing\
          \ an error at the beginning. You can specify `cell_inds_to_perturb={'start':0,\
          \ 'end':2}` and `forward_batch_size=2`, for example. Then loop the command\
          \ to output a pickle file for every 2 cells. I personally had to loop the\
          \ command in bash to prevent OOM errors. See example below. Hope this helps!\n\
          \n```\n#!/usr/bin/env bash\n# in_silico_perturbation_loop.sh\n\ni=0\nj=2\n\
          k=1\n\nfor a in {1..193}\ndo\n  python3 in_silico_perturbation_loop.py -i\
          \ $i -j $j -k $k;\n  i=$(($i+2))\n  j=$(($j+2))\n  k=$(($k+1))\n  rm /data/genecorpus_filtered_hep/cache*\n\
          \  echo $i $j $k\ndone\n\npython3 in_silico_perturbation_stats.py\n```\n\
          \n```\n#!/usr/bin/env python3\n# in_silico_perturbation_loop.py\n\n# Import\
          \ libraries\nfrom geneformer import InSilicoPerturber\nfrom geneformer import\
          \ InSilicoPerturberStats\nfrom datasets import load_from_disk\nimport os\n\
          import gc\nimport torch\nimport argparse\n\ndef main():\n    args = get_cli_args()\n\
          \    i = args.i\n    j = args.j\n    k = args.k\n\n    # 1. Set parameters\
          \ for perturbation function\n    gc.collect()\n    torch.cuda.empty_cache()\n\
          \n    isp = InSilicoPerturber(perturb_type=\"delete\",\n               \
          \             perturb_rank_shift=None,\n                            genes_to_perturb=[\"\
          ENSG00000118520\"],\n                            combos=0,\n           \
          \                 anchor_gene=None,\n                            model_type=\"\
          Pretrained\",\n                            num_classes=0,\n            \
          \                emb_mode=\"cell\",\n                            cell_emb_style=\"\
          mean_pool\",\n                            filter_data=None,\n          \
          \                  cell_states_to_model=None,\n                        \
          \    max_ncells=None,\n                            cell_inds_to_perturb={\"\
          start\":i,\n                                                  \"end\":j},\n\
          \                            emb_layer=-1,\n                           \
          \ forward_batch_size=2,\n                            nproc=2,\n        \
          \                    token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\n\n    # 2. Perturb data\n    isp.perturb_data(\"/home/ubuntu/Geneformer/\"\
          ,\n                     \"/data/genecorpus_filtered_hep/\",\n          \
          \           \"/data/genecorpus_filtered_hep/delete_cell/\",\n          \
          \           f\"cell_ARG1_{k}\")\n\ndef get_cli_args():\n    parser = argparse.ArgumentParser()\n\
          \n    parser.add_argument('-i', dest='i',\n                        type=int,\
          \ help=\"Starting cell index\",\n                        required=True)\n\
          \    parser.add_argument('-j', dest='j',\n                        type=int,\
          \ help=\"Ending cell index\",\n                        required=True)\n\
          \    parser.add_argument('-k', dest='k',\n                        type=int,\
          \ help=\"Pickle file suffix\",\n                        required=True)\n\
          \n    return parser.parse_args()\n\nif __name__ == '__main__':\n    main()\n\
          ```\n\n```\n#!/usr/bin/env python3\n# in_silico_perturbation_stats.py\n\n\
          from geneformer import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\
          import argparse\n\n# 1. Set parameters for perturbation statistics\nispstats\
          \ = InSilicoPerturberStats(mode=\"aggregate_data\",\n                  \
          \                genes_perturbed=[\"ENSG00000118520\"],\n              \
          \                    combos=0,\n                                  anchor_gene=None,\n\
          \                                  cell_states_to_model=None,\n        \
          \                          token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\n\n# 2. Get perturbation stats\nispstats.get_stats(\"/data/genecorpus_filtered_hep/delete_cell/\"\
          ,\n                   None,\n                   \"/data/genecorpus_filtered_hep/delete_cell/\"\
          ,\n                   \"delete_cell_ARG1\")\n```\n"
        updatedAt: '2023-09-26T13:10:48.942Z'
      numEdits: 0
      reactions: []
    id: 6512d85813aa0728130dac63
    type: comment
  author: junguyen
  content: "@swang12 @MinieRosie I found that this error only occurs at certain cell\
    \ indices. While I haven't solved this error, I did find a work around that allows\
    \ the function to process through more cells instead of throwing an error at the\
    \ beginning. You can specify `cell_inds_to_perturb={'start':0, 'end':2}` and `forward_batch_size=2`,\
    \ for example. Then loop the command to output a pickle file for every 2 cells.\
    \ I personally had to loop the command in bash to prevent OOM errors. See example\
    \ below. Hope this helps!\n\n```\n#!/usr/bin/env bash\n# in_silico_perturbation_loop.sh\n\
    \ni=0\nj=2\nk=1\n\nfor a in {1..193}\ndo\n  python3 in_silico_perturbation_loop.py\
    \ -i $i -j $j -k $k;\n  i=$(($i+2))\n  j=$(($j+2))\n  k=$(($k+1))\n  rm /data/genecorpus_filtered_hep/cache*\n\
    \  echo $i $j $k\ndone\n\npython3 in_silico_perturbation_stats.py\n```\n\n```\n\
    #!/usr/bin/env python3\n# in_silico_perturbation_loop.py\n\n# Import libraries\n\
    from geneformer import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\
    from datasets import load_from_disk\nimport os\nimport gc\nimport torch\nimport\
    \ argparse\n\ndef main():\n    args = get_cli_args()\n    i = args.i\n    j =\
    \ args.j\n    k = args.k\n\n    # 1. Set parameters for perturbation function\n\
    \    gc.collect()\n    torch.cuda.empty_cache()\n\n    isp = InSilicoPerturber(perturb_type=\"\
    delete\",\n                            perturb_rank_shift=None,\n            \
    \                genes_to_perturb=[\"ENSG00000118520\"],\n                   \
    \         combos=0,\n                            anchor_gene=None,\n         \
    \                   model_type=\"Pretrained\",\n                            num_classes=0,\n\
    \                            emb_mode=\"cell\",\n                            cell_emb_style=\"\
    mean_pool\",\n                            filter_data=None,\n                \
    \            cell_states_to_model=None,\n                            max_ncells=None,\n\
    \                            cell_inds_to_perturb={\"start\":i,\n            \
    \                                      \"end\":j},\n                         \
    \   emb_layer=-1,\n                            forward_batch_size=2,\n       \
    \                     nproc=2,\n                            token_dictionary_file\
    \ = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\")\n\n    # 2. Perturb\
    \ data\n    isp.perturb_data(\"/home/ubuntu/Geneformer/\",\n                 \
    \    \"/data/genecorpus_filtered_hep/\",\n                     \"/data/genecorpus_filtered_hep/delete_cell/\"\
    ,\n                     f\"cell_ARG1_{k}\")\n\ndef get_cli_args():\n    parser\
    \ = argparse.ArgumentParser()\n\n    parser.add_argument('-i', dest='i',\n   \
    \                     type=int, help=\"Starting cell index\",\n              \
    \          required=True)\n    parser.add_argument('-j', dest='j',\n         \
    \               type=int, help=\"Ending cell index\",\n                      \
    \  required=True)\n    parser.add_argument('-k', dest='k',\n                 \
    \       type=int, help=\"Pickle file suffix\",\n                        required=True)\n\
    \n    return parser.parse_args()\n\nif __name__ == '__main__':\n    main()\n```\n\
    \n```\n#!/usr/bin/env python3\n# in_silico_perturbation_stats.py\n\nfrom geneformer\
    \ import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\nimport\
    \ argparse\n\n# 1. Set parameters for perturbation statistics\nispstats = InSilicoPerturberStats(mode=\"\
    aggregate_data\",\n                                  genes_perturbed=[\"ENSG00000118520\"\
    ],\n                                  combos=0,\n                            \
    \      anchor_gene=None,\n                                  cell_states_to_model=None,\n\
    \                                  token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
    )\n\n# 2. Get perturbation stats\nispstats.get_stats(\"/data/genecorpus_filtered_hep/delete_cell/\"\
    ,\n                   None,\n                   \"/data/genecorpus_filtered_hep/delete_cell/\"\
    ,\n                   \"delete_cell_ARG1\")\n```\n"
  created_at: 2023-09-26 12:10:48+00:00
  edited: false
  hidden: false
  id: 6512d85813aa0728130dac63
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T08:59:32.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9056812524795532
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer and for your patience!
          We pushed an update that should resolve this issue. If you continue to face
          errors after pulling the updated code, please let us know by either reopening
          this discussion if it''s the same error or opening a new discussion if it''s
          a new error. Thank you!</p>

          '
        raw: Thank you for your interest in Geneformer and for your patience! We pushed
          an update that should resolve this issue. If you continue to face errors
          after pulling the updated code, please let us know by either reopening this
          discussion if it's the same error or opening a new discussion if it's a
          new error. Thank you!
        updatedAt: '2023-12-15T08:59:32.911Z'
      numEdits: 0
      reactions: []
      relatedEventId: 657c15747e11375c6f341c82
    id: 657c15747e11375c6f341c80
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer and for your patience! We pushed
    an update that should resolve this issue. If you continue to face errors after
    pulling the updated code, please let us know by either reopening this discussion
    if it's the same error or opening a new discussion if it's a new error. Thank
    you!
  created_at: 2023-12-15 08:59:32+00:00
  edited: false
  hidden: false
  id: 657c15747e11375c6f341c80
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T08:59:32.000Z'
    data:
      status: closed
    id: 657c15747e11375c6f341c82
    type: status-change
  author: ctheodoris
  created_at: 2023-12-15 08:59:32+00:00
  id: 657c15747e11375c6f341c82
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 243
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Single gene perturbation error
