!!python/object:huggingface_hub.community.DiscussionWithDetails
author: swang12
conflicting_files: null
created_at: 2023-08-08 06:03:55+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/dfad9b282f034de3ccdaf7ab2b999559.svg
      fullname: Su Wang
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: swang12
      type: user
    createdAt: '2023-08-08T07:03:55.000Z'
    data:
      edited: false
      editors:
      - swang12
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6944356560707092
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/dfad9b282f034de3ccdaf7ab2b999559.svg
          fullname: Su Wang
          isHf: false
          isPro: false
          name: swang12
          type: user
        html: '<p>Hi, I''m working on gene perturbation using the pre-trained Geneformer
          model and I was wondering if you could help me with the interpretation and
          plotting of the results of InSilicoPerturberStats.get_stats. </p>

          <p>I finished running InSilicoPerturber(emb_mode=''cell'').perturb_data
          on 1,000 disease cells and 1,000 healthy cells with 19,117 genes and conducted
          InSilicoPerturberStats.get_stats. </p>

          <p>Then I performed InSilicoPerturber(emb_mode=''cell_and_gene'').perturb_data
          separately on the same data. </p>

          <p>The parameters I used are as below:</p>

          <p>isp = InSilicoPerturber(perturb_type=''delete'',<br>                        perturb_rank_shift=None,<br>                        genes_to_perturb=''all'',<br>                        combos=0,<br>                        anchor_gene=None,<br>                        model_type=''Pretrained'',<br>                        num_classes=0,<br>                        emb_mode=''cell_and_gene'',<br>                        cell_emb_style=''mean_pool'',<br>                        cell_states_to_model={''state_key'':
          ''group'', ''start_state'': ''opc_gaba'', ''goal_state'': ''other'', ''alt_states'':
          []},<br>                        max_ncells=2000,<br>                        emb_layer=-1,<br>                        forward_batch_size=32,<br>                        nproc=16<br>                        )</p>

          <p>isp.perturb_data(model_directory=''Geneformer/'',<br>                 input_data_file=''tokenized_.dataset'',<br>                 output_directory=''./'',<br>                 output_prefix=''perturbed''<br>                 )</p>

          <p>ispstats = InSilicoPerturberStats(mode=''goal_state_shift'',<br>                                  combos=0,<br>                                  anchor_gene=None,<br>                                  cell_states_to_model={''state_key'':
          ''group'', ''start_state'': ''opc_gaba'', ''goal_state'': ''other'', ''alt_states'':
          []}<br>                                  )</p>

          <p>ispstats.get_stats(input_data_directory=''./'',<br>                   null_dist_data_directory=None,<br>                   output_directory=''./'',<br>                   output_prefix=''stats_emb_mode_gene''<br>                   )</p>

          <p>I found the two output stats.csv files have identical values regardless
          of emb_mode. They have 14,497 genes on rows and 9 columns: "", "Gene", "Gene_name",
          "Ensembl_ID", "Shift_to_goal_end", "Goal_end_vs_random_pval", "Goal_end_FDR",
          "N_Detections",  and "Sig". </p>

          <p>I was wondering if "Shift_to_goal_end" represents the cosine similarity
          shift in the paper. And I''m not very clear on how I should interpret the
          main columns. </p>

          <p>I thought the first two columns "" and "Gene" are just gene indices in
          my dataset and Geneformer model, respectively, and have nothing to do with
          gene ranking values. "N_Detections" should be the number of cells in which
          the gene was detected, and "Sig" denotes whether the deletion of this gene
          shifted the cell state from start_state to goal_state. Please correct me
          if I''m wrong.</p>

          <p>I was wondering if you could briefly explain "Shift_to_goal_end", "Goal_end_vs_random_pval",
          and "Goal_end_FDR" for the interpretation of the results. How should I use
          "Shift_to_goal_end" for plotting the cosine similarity as in the paper,
          or gene/cell embedding plots? Thank you very much for your time and help!</p>

          <p>Sincerely,<br>Su Wang</p>

          '
        raw: "Hi, I'm working on gene perturbation using the pre-trained Geneformer\
          \ model and I was wondering if you could help me with the interpretation\
          \ and plotting of the results of InSilicoPerturberStats.get_stats. \r\n\r\
          \nI finished running InSilicoPerturber(emb_mode='cell').perturb_data on\
          \ 1,000 disease cells and 1,000 healthy cells with 19,117 genes and conducted\
          \ InSilicoPerturberStats.get_stats. \r\n\r\nThen I performed InSilicoPerturber(emb_mode='cell_and_gene').perturb_data\
          \ separately on the same data. \r\n\r\nThe parameters I used are as below:\r\
          \n\r\nisp = InSilicoPerturber(perturb_type='delete', \r\n              \
          \          perturb_rank_shift=None, \r\n                        genes_to_perturb='all',\
          \ \r\n                        combos=0, \r\n                        anchor_gene=None,\
          \ \r\n                        model_type='Pretrained', \r\n            \
          \            num_classes=0, \r\n                        emb_mode='cell_and_gene',\
          \ \r\n                        cell_emb_style='mean_pool', \r\n         \
          \               cell_states_to_model={'state_key': 'group', 'start_state':\
          \ 'opc_gaba', 'goal_state': 'other', 'alt_states': []}, \r\n           \
          \             max_ncells=2000, \r\n                        emb_layer=-1,\
          \ \r\n                        forward_batch_size=32, \r\n              \
          \          nproc=16\r\n                        )\r\n\r\nisp.perturb_data(model_directory='Geneformer/',\
          \ \r\n                 input_data_file='tokenized_.dataset', \r\n      \
          \           output_directory='./', \r\n                 output_prefix='perturbed'\r\
          \n                 )\r\n\r\nispstats = InSilicoPerturberStats(mode='goal_state_shift',\
          \ \r\n                                  combos=0, \r\n                 \
          \                 anchor_gene=None, \r\n                               \
          \   cell_states_to_model={'state_key': 'group', 'start_state': 'opc_gaba',\
          \ 'goal_state': 'other', 'alt_states': []}\r\n                         \
          \         )\r\n\r\nispstats.get_stats(input_data_directory='./',\r\n   \
          \                null_dist_data_directory=None,\r\n                   output_directory='./',\r\
          \n                   output_prefix='stats_emb_mode_gene'\r\n           \
          \        )\r\n\r\nI found the two output stats.csv files have identical\
          \ values regardless of emb_mode. They have 14,497 genes on rows and 9 columns:\
          \ \"\", \"Gene\", \"Gene_name\", \"Ensembl_ID\", \"Shift_to_goal_end\",\
          \ \"Goal_end_vs_random_pval\", \"Goal_end_FDR\", \"N_Detections\",  and\
          \ \"Sig\". \r\n\r\nI was wondering if \"Shift_to_goal_end\" represents the\
          \ cosine similarity shift in the paper. And I'm not very clear on how I\
          \ should interpret the main columns. \r\n\r\nI thought the first two columns\
          \ \"\" and \"Gene\" are just gene indices in my dataset and Geneformer model,\
          \ respectively, and have nothing to do with gene ranking values. \"N_Detections\"\
          \ should be the number of cells in which the gene was detected, and \"Sig\"\
          \ denotes whether the deletion of this gene shifted the cell state from\
          \ start_state to goal_state. Please correct me if I'm wrong.\r\n\r\nI was\
          \ wondering if you could briefly explain \"Shift_to_goal_end\", \"Goal_end_vs_random_pval\"\
          , and \"Goal_end_FDR\" for the interpretation of the results. How should\
          \ I use \"Shift_to_goal_end\" for plotting the cosine similarity as in the\
          \ paper, or gene/cell embedding plots? Thank you very much for your time\
          \ and help!\r\n\r\nSincerely,\r\nSu Wang"
        updatedAt: '2023-08-08T07:03:55.740Z'
      numEdits: 0
      reactions: []
    id: 64d1e8db86e19d5db1c3c26c
    type: comment
  author: swang12
  content: "Hi, I'm working on gene perturbation using the pre-trained Geneformer\
    \ model and I was wondering if you could help me with the interpretation and plotting\
    \ of the results of InSilicoPerturberStats.get_stats. \r\n\r\nI finished running\
    \ InSilicoPerturber(emb_mode='cell').perturb_data on 1,000 disease cells and 1,000\
    \ healthy cells with 19,117 genes and conducted InSilicoPerturberStats.get_stats.\
    \ \r\n\r\nThen I performed InSilicoPerturber(emb_mode='cell_and_gene').perturb_data\
    \ separately on the same data. \r\n\r\nThe parameters I used are as below:\r\n\
    \r\nisp = InSilicoPerturber(perturb_type='delete', \r\n                      \
    \  perturb_rank_shift=None, \r\n                        genes_to_perturb='all',\
    \ \r\n                        combos=0, \r\n                        anchor_gene=None,\
    \ \r\n                        model_type='Pretrained', \r\n                  \
    \      num_classes=0, \r\n                        emb_mode='cell_and_gene', \r\
    \n                        cell_emb_style='mean_pool', \r\n                   \
    \     cell_states_to_model={'state_key': 'group', 'start_state': 'opc_gaba', 'goal_state':\
    \ 'other', 'alt_states': []}, \r\n                        max_ncells=2000, \r\n\
    \                        emb_layer=-1, \r\n                        forward_batch_size=32,\
    \ \r\n                        nproc=16\r\n                        )\r\n\r\nisp.perturb_data(model_directory='Geneformer/',\
    \ \r\n                 input_data_file='tokenized_.dataset', \r\n            \
    \     output_directory='./', \r\n                 output_prefix='perturbed'\r\n\
    \                 )\r\n\r\nispstats = InSilicoPerturberStats(mode='goal_state_shift',\
    \ \r\n                                  combos=0, \r\n                       \
    \           anchor_gene=None, \r\n                                  cell_states_to_model={'state_key':\
    \ 'group', 'start_state': 'opc_gaba', 'goal_state': 'other', 'alt_states': []}\r\
    \n                                  )\r\n\r\nispstats.get_stats(input_data_directory='./',\r\
    \n                   null_dist_data_directory=None,\r\n                   output_directory='./',\r\
    \n                   output_prefix='stats_emb_mode_gene'\r\n                 \
    \  )\r\n\r\nI found the two output stats.csv files have identical values regardless\
    \ of emb_mode. They have 14,497 genes on rows and 9 columns: \"\", \"Gene\", \"\
    Gene_name\", \"Ensembl_ID\", \"Shift_to_goal_end\", \"Goal_end_vs_random_pval\"\
    , \"Goal_end_FDR\", \"N_Detections\",  and \"Sig\". \r\n\r\nI was wondering if\
    \ \"Shift_to_goal_end\" represents the cosine similarity shift in the paper. And\
    \ I'm not very clear on how I should interpret the main columns. \r\n\r\nI thought\
    \ the first two columns \"\" and \"Gene\" are just gene indices in my dataset\
    \ and Geneformer model, respectively, and have nothing to do with gene ranking\
    \ values. \"N_Detections\" should be the number of cells in which the gene was\
    \ detected, and \"Sig\" denotes whether the deletion of this gene shifted the\
    \ cell state from start_state to goal_state. Please correct me if I'm wrong.\r\
    \n\r\nI was wondering if you could briefly explain \"Shift_to_goal_end\", \"Goal_end_vs_random_pval\"\
    , and \"Goal_end_FDR\" for the interpretation of the results. How should I use\
    \ \"Shift_to_goal_end\" for plotting the cosine similarity as in the paper, or\
    \ gene/cell embedding plots? Thank you very much for your time and help!\r\n\r\
    \nSincerely,\r\nSu Wang"
  created_at: 2023-08-08 06:03:55+00:00
  edited: false
  hidden: false
  id: 64d1e8db86e19d5db1c3c26c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T10:06:13.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9029508829116821
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: "<p>Thank you for your interest in Geneformer!</p>\n<ul>\n<li><p>please\
          \ check help(InSilicoPerturberStats) for documentation on the output column\
          \ meaning</p>\n</li>\n<li><p>the gene embedding shifts are not calculated\
          \ in the goal state shift mode since this is measuring cosine shift between\
          \ cell embedding positions. To output gene embedding cosine shifts in response\
          \ to a given perturbation, change the cell_states_to_model to be None and\
          \ the emb_mode to be \u201Ccell_and_gene\u201D. </p>\n</li>\n<li><p>check\
          \ the example for extracting and plotting cell embeddings for how to plot\
          \ the cell embeddings</p>\n</li>\n<li><p>of note, plotting the perturbed\
          \ embeddings on a UMAP is not relevant because the perturbed embeddings\
          \ only represent the first step in the perturbation (by deleting or overexpressing\
          \ a given gene) and not the downstream consequences, so they will be necessarily\
          \ close to the initial position. However, the cosine shift directionality\
          \ is the important feature that determines whether the position has moved\
          \ in the desired direction towards the goal cell state.</p>\n</li>\n<li><p>to\
          \ plot the cosine shifts, you can use the column for the cosine shifts in\
          \ the output csv as the input for your plotting tool of choice, for example\
          \ kde plots from seaborn. </p>\n</li>\n<li><p>If you have a particular plot\
          \ you are interested in that is not answered by the above, please be more\
          \ specific about the Fig # in the manuscript.</p>\n</li>\n<li><p>You may\
          \ have already done this, but before using the pretrained model to check\
          \ cosine shifts between normal and diseased, I would first confirm that\
          \ the pretrained model sufficiently separates the classes, for example by\
          \ extracting cell embeddings and plotting them to visualize. If it does\
          \ not separate them sufficiently, I would recommend fine-tuning the model\
          \ to separate them first. You can use the example for hyperparameter optimization\
          \ for disease classification to do this. We highly recommend hyperparameter\
          \ optimization for all downstream tasks. When using the fine-tuned model,\
          \ since the final prediction is relevant to the goal of the analysis, you\
          \ can change the emb_layer to be 0.</p>\n</li>\n<li><p>Finally, I wanted\
          \ to note that the statistics are sensitive to the number of observations\
          \ (as all statistics are) so you may consider modeling more cells than 1000\
          \ if you have enough of your sample to increase your power. You can use\
          \ the newly added feature of cell_inds_to_perturb to help parallelize the\
          \ analysis across multiple GPUs if you have the resources and would like\
          \ to speed up the analysis.</p>\n</li>\n</ul>\n"
        raw: "Thank you for your interest in Geneformer!\n\n- please check help(InSilicoPerturberStats)\
          \ for documentation on the output column meaning\n\n- the gene embedding\
          \ shifts are not calculated in the goal state shift mode since this is measuring\
          \ cosine shift between cell embedding positions. To output gene embedding\
          \ cosine shifts in response to a given perturbation, change the cell_states_to_model\
          \ to be None and the emb_mode to be \u201Ccell_and_gene\u201D. \n\n- check\
          \ the example for extracting and plotting cell embeddings for how to plot\
          \ the cell embeddings\n\n- of note, plotting the perturbed embeddings on\
          \ a UMAP is not relevant because the perturbed embeddings only represent\
          \ the first step in the perturbation (by deleting or overexpressing a given\
          \ gene) and not the downstream consequences, so they will be necessarily\
          \ close to the initial position. However, the cosine shift directionality\
          \ is the important feature that determines whether the position has moved\
          \ in the desired direction towards the goal cell state.\n\n- to plot the\
          \ cosine shifts, you can use the column for the cosine shifts in the output\
          \ csv as the input for your plotting tool of choice, for example kde plots\
          \ from seaborn. \n\n- If you have a particular plot you are interested in\
          \ that is not answered by the above, please be more specific about the Fig\
          \ # in the manuscript.\n\n- You may have already done this, but before using\
          \ the pretrained model to check cosine shifts between normal and diseased,\
          \ I would first confirm that the pretrained model sufficiently separates\
          \ the classes, for example by extracting cell embeddings and plotting them\
          \ to visualize. If it does not separate them sufficiently, I would recommend\
          \ fine-tuning the model to separate them first. You can use the example\
          \ for hyperparameter optimization for disease classification to do this.\
          \ We highly recommend hyperparameter optimization for all downstream tasks.\
          \ When using the fine-tuned model, since the final prediction is relevant\
          \ to the goal of the analysis, you can change the emb_layer to be 0.\n\n\
          - Finally, I wanted to note that the statistics are sensitive to the number\
          \ of observations (as all statistics are) so you may consider modeling more\
          \ cells than 1000 if you have enough of your sample to increase your power.\
          \ You can use the newly added feature of cell_inds_to_perturb to help parallelize\
          \ the analysis across multiple GPUs if you have the resources and would\
          \ like to speed up the analysis."
        updatedAt: '2023-08-08T10:06:13.409Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64d213952607da25ef501c84
    id: 64d213952607da25ef501c81
    type: comment
  author: ctheodoris
  content: "Thank you for your interest in Geneformer!\n\n- please check help(InSilicoPerturberStats)\
    \ for documentation on the output column meaning\n\n- the gene embedding shifts\
    \ are not calculated in the goal state shift mode since this is measuring cosine\
    \ shift between cell embedding positions. To output gene embedding cosine shifts\
    \ in response to a given perturbation, change the cell_states_to_model to be None\
    \ and the emb_mode to be \u201Ccell_and_gene\u201D. \n\n- check the example for\
    \ extracting and plotting cell embeddings for how to plot the cell embeddings\n\
    \n- of note, plotting the perturbed embeddings on a UMAP is not relevant because\
    \ the perturbed embeddings only represent the first step in the perturbation (by\
    \ deleting or overexpressing a given gene) and not the downstream consequences,\
    \ so they will be necessarily close to the initial position. However, the cosine\
    \ shift directionality is the important feature that determines whether the position\
    \ has moved in the desired direction towards the goal cell state.\n\n- to plot\
    \ the cosine shifts, you can use the column for the cosine shifts in the output\
    \ csv as the input for your plotting tool of choice, for example kde plots from\
    \ seaborn. \n\n- If you have a particular plot you are interested in that is not\
    \ answered by the above, please be more specific about the Fig # in the manuscript.\n\
    \n- You may have already done this, but before using the pretrained model to check\
    \ cosine shifts between normal and diseased, I would first confirm that the pretrained\
    \ model sufficiently separates the classes, for example by extracting cell embeddings\
    \ and plotting them to visualize. If it does not separate them sufficiently, I\
    \ would recommend fine-tuning the model to separate them first. You can use the\
    \ example for hyperparameter optimization for disease classification to do this.\
    \ We highly recommend hyperparameter optimization for all downstream tasks. When\
    \ using the fine-tuned model, since the final prediction is relevant to the goal\
    \ of the analysis, you can change the emb_layer to be 0.\n\n- Finally, I wanted\
    \ to note that the statistics are sensitive to the number of observations (as\
    \ all statistics are) so you may consider modeling more cells than 1000 if you\
    \ have enough of your sample to increase your power. You can use the newly added\
    \ feature of cell_inds_to_perturb to help parallelize the analysis across multiple\
    \ GPUs if you have the resources and would like to speed up the analysis."
  created_at: 2023-08-08 09:06:13+00:00
  edited: false
  hidden: false
  id: 64d213952607da25ef501c81
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T10:06:13.000Z'
    data:
      status: closed
    id: 64d213952607da25ef501c84
    type: status-change
  author: ctheodoris
  created_at: 2023-08-08 09:06:13+00:00
  id: 64d213952607da25ef501c84
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 194
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Interpretation and plotting of the results of InSilicoPerturberStats.get_stats
