!!python/object:huggingface_hub.community.DiscussionWithDetails
author: v2vJyl
conflicting_files: null
created_at: 2023-08-08 10:42:27+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/e6039d587cc50b932edef7eabafc0585.svg
      fullname: jyl
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: v2vJyl
      type: user
    createdAt: '2023-08-08T11:42:27.000Z'
    data:
      edited: false
      editors:
      - v2vJyl
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.7572769522666931
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/e6039d587cc50b932edef7eabafc0585.svg
          fullname: jyl
          isHf: false
          isPro: false
          name: v2vJyl
          type: user
        html: "<p>Thanks for your great work. I encountered some difficulties when\
          \ replicating the in_silico_perturbation results. By the limitation of GPU\
          \ memory, I set the max_ncells = 2000 or 5000. The model is the outmost\
          \ model in the installed Geneformer folder and the dataset is the example\
          \ human_dcm_hcm. The other codes keep the same as the original in_silico_perturbation.ipynb\
          \ file as below. </p>\n<pre><code>from geneformer import InSilicoPerturber\n\
          from geneformer import InSilicoPerturberStats\n\n\n# in silico perturbation\
          \ in deletion mode to determine genes whose \n# deletion in the dilated\
          \ cardiomyopathy (dcm) state significantly shifts\n# the embedding towards\
          \ non-failing (nf) state\nisp = InSilicoPerturber(perturb_type=\"delete\"\
          ,\n                        perturb_rank_shift=None,\n                  \
          \      genes_to_perturb=\"all\",\n                        combos=0,\n  \
          \                      anchor_gene=None,\n                        model_type=\"\
          CellClassifier\",\n                        num_classes=3,\n            \
          \            emb_mode=\"cell\",\n                        cell_emb_style=\"\
          mean_pool\",\n                        filter_data={\"cell_type\":[\"Cardiomyocyte1\"\
          ,\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\n                        cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])},\n                        max_ncells=5000,\n\
          \                        emb_layer=0,\n                        forward_batch_size=400,\n\
          \                        nproc=16)\n\n# outputs intermediate files from\
          \ in silico perturbation\nisp.perturb_data(\"/install_path/Geneformer/\"\
          ,\n                 \"/install_path/Geneformer/examples/datasets/human_dcm_hcm/\"\
          ,\n                 \"/install_path/Geneformer/examples/output/\",\n   \
          \              \"human_dcm_hcm\")\n# I make some dirs as above to store\
          \ the dataset and output files\n\nispstats = InSilicoPerturberStats(mode=\"\
          goal_state_shift\",\n                                  genes_perturbed=\"\
          all\",\n                                  combos=0,\n                  \
          \                anchor_gene=None,\n                                  cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\n\n# extracts data from intermediate\
          \ files and processes stats to output in final .csv\nispstats.get_stats(\"\
          /install_path/Geneformer/examples/output/\",\n                   None,\n\
          \                   \"/install_path/Geneformer/examples/output/\",\n   \
          \                \"human_dcm_hcm\")\n</code></pre>\n<p>However, I found\
          \ the results differ a lot from those in table12, the sheet \"DCM_del_tx\"\
          , typically by the low absolute value of shift_to_goal_end and shift_to_alt_end.\
          \ </p>\n<p>For example, I got <code>\"ADGRL3\tENSG00000150471\t6.18E-05\t\
          -6.88E-06\"</code> with 883 detections from a max_5000_cells file, but the\
          \ one in sheet DCM_del_tx is <code>\"ENSG00000150471\tADGRL3\t0.010678123\t\
          -0.026562714\"</code> with 1880 detections, showing a 1000 times lower shift\
          \ in my results. Could you tell me what would be the possible causes? Thank\
          \ you!</p>\n"
        raw: "Thanks for your great work. I encountered some difficulties when replicating\
          \ the in_silico_perturbation results. By the limitation of GPU memory, I\
          \ set the max_ncells = 2000 or 5000. The model is the outmost model in the\
          \ installed Geneformer folder and the dataset is the example human_dcm_hcm.\
          \ The other codes keep the same as the original in_silico_perturbation.ipynb\
          \ file as below. \r\n\r\n```\r\nfrom geneformer import InSilicoPerturber\r\
          \nfrom geneformer import InSilicoPerturberStats\r\n\r\n\r\n# in silico perturbation\
          \ in deletion mode to determine genes whose \r\n# deletion in the dilated\
          \ cardiomyopathy (dcm) state significantly shifts\r\n# the embedding towards\
          \ non-failing (nf) state\r\nisp = InSilicoPerturber(perturb_type=\"delete\"\
          ,\r\n                        perturb_rank_shift=None,\r\n              \
          \          genes_to_perturb=\"all\",\r\n                        combos=0,\r\
          \n                        anchor_gene=None,\r\n                        model_type=\"\
          CellClassifier\",\r\n                        num_classes=3,\r\n        \
          \                emb_mode=\"cell\",\r\n                        cell_emb_style=\"\
          mean_pool\",\r\n                        filter_data={\"cell_type\":[\"Cardiomyocyte1\"\
          ,\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])},\r\n                        max_ncells=5000,\r\
          \n                        emb_layer=0,\r\n                        forward_batch_size=400,\r\
          \n                        nproc=16)\r\n\r\n# outputs intermediate files\
          \ from in silico perturbation\r\nisp.perturb_data(\"/install_path/Geneformer/\"\
          ,\r\n                 \"/install_path/Geneformer/examples/datasets/human_dcm_hcm/\"\
          ,\r\n                 \"/install_path/Geneformer/examples/output/\",\r\n\
          \                 \"human_dcm_hcm\")\r\n# I make some dirs as above to store\
          \ the dataset and output files\r\n\r\nispstats = InSilicoPerturberStats(mode=\"\
          goal_state_shift\",\r\n                                  genes_perturbed=\"\
          all\",\r\n                                  combos=0,\r\n              \
          \                    anchor_gene=None,\r\n                             \
          \     cell_states_to_model={\"disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\r\
          \n\r\n# extracts data from intermediate files and processes stats to output\
          \ in final .csv\r\nispstats.get_stats(\"/install_path/Geneformer/examples/output/\"\
          ,\r\n                   None,\r\n                   \"/install_path/Geneformer/examples/output/\"\
          ,\r\n                   \"human_dcm_hcm\")\r\n```\r\n\r\nHowever, I found\
          \ the results differ a lot from those in table12, the sheet \"DCM_del_tx\"\
          , typically by the low absolute value of shift_to_goal_end and shift_to_alt_end.\
          \ \r\n\r\nFor example, I got ```\"ADGRL3\tENSG00000150471\t6.18E-05\t-6.88E-06\"\
          ``` with 883 detections from a max_5000_cells file, but the one in sheet\
          \ DCM_del_tx is ```\"ENSG00000150471\tADGRL3\t0.010678123\t-0.026562714\"\
          ``` with 1880 detections, showing a 1000 times lower shift in my results.\
          \ Could you tell me what would be the possible causes? Thank you!\r\n\r\n"
        updatedAt: '2023-08-08T11:42:27.334Z'
      numEdits: 0
      reactions: []
    id: 64d22a23f0109d559f9d7607
    type: comment
  author: v2vJyl
  content: "Thanks for your great work. I encountered some difficulties when replicating\
    \ the in_silico_perturbation results. By the limitation of GPU memory, I set the\
    \ max_ncells = 2000 or 5000. The model is the outmost model in the installed Geneformer\
    \ folder and the dataset is the example human_dcm_hcm. The other codes keep the\
    \ same as the original in_silico_perturbation.ipynb file as below. \r\n\r\n```\r\
    \nfrom geneformer import InSilicoPerturber\r\nfrom geneformer import InSilicoPerturberStats\r\
    \n\r\n\r\n# in silico perturbation in deletion mode to determine genes whose \r\
    \n# deletion in the dilated cardiomyopathy (dcm) state significantly shifts\r\n\
    # the embedding towards non-failing (nf) state\r\nisp = InSilicoPerturber(perturb_type=\"\
    delete\",\r\n                        perturb_rank_shift=None,\r\n            \
    \            genes_to_perturb=\"all\",\r\n                        combos=0,\r\n\
    \                        anchor_gene=None,\r\n                        model_type=\"\
    CellClassifier\",\r\n                        num_classes=3,\r\n              \
    \          emb_mode=\"cell\",\r\n                        cell_emb_style=\"mean_pool\"\
    ,\r\n                        filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"\
    Cardiomyocyte2\",\"Cardiomyocyte3\"]},\r\n                        cell_states_to_model={\"\
    disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])},\r\n                        max_ncells=5000,\r\
    \n                        emb_layer=0,\r\n                        forward_batch_size=400,\r\
    \n                        nproc=16)\r\n\r\n# outputs intermediate files from in\
    \ silico perturbation\r\nisp.perturb_data(\"/install_path/Geneformer/\",\r\n \
    \                \"/install_path/Geneformer/examples/datasets/human_dcm_hcm/\"\
    ,\r\n                 \"/install_path/Geneformer/examples/output/\",\r\n     \
    \            \"human_dcm_hcm\")\r\n# I make some dirs as above to store the dataset\
    \ and output files\r\n\r\nispstats = InSilicoPerturberStats(mode=\"goal_state_shift\"\
    ,\r\n                                  genes_perturbed=\"all\",\r\n          \
    \                        combos=0,\r\n                                  anchor_gene=None,\r\
    \n                                  cell_states_to_model={\"disease\":([\"dcm\"\
    ],[\"nf\"],[\"hcm\"])})\r\n\r\n# extracts data from intermediate files and processes\
    \ stats to output in final .csv\r\nispstats.get_stats(\"/install_path/Geneformer/examples/output/\"\
    ,\r\n                   None,\r\n                   \"/install_path/Geneformer/examples/output/\"\
    ,\r\n                   \"human_dcm_hcm\")\r\n```\r\n\r\nHowever, I found the\
    \ results differ a lot from those in table12, the sheet \"DCM_del_tx\", typically\
    \ by the low absolute value of shift_to_goal_end and shift_to_alt_end. \r\n\r\n\
    For example, I got ```\"ADGRL3\tENSG00000150471\t6.18E-05\t-6.88E-06\"``` with\
    \ 883 detections from a max_5000_cells file, but the one in sheet DCM_del_tx is\
    \ ```\"ENSG00000150471\tADGRL3\t0.010678123\t-0.026562714\"``` with 1880 detections,\
    \ showing a 1000 times lower shift in my results. Could you tell me what would\
    \ be the possible causes? Thank you!\r\n\r\n"
  created_at: 2023-08-08 10:42:27+00:00
  edited: false
  hidden: false
  id: 64d22a23f0109d559f9d7607
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T14:32:28.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9222539067268372
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer! My understanding from
          your comment is that you are using the pretrained model for the analysis.
          As discussed in the manuscript, we first fine-tuned the model to distinguish
          the cardiomyopathy states before performing the in silico perturbation.
          By loading the pretrained model as a CellClassifier, you are introducing
          a head layer with random untrained weights from which you are modeling the
          embeddings with emb_layer = 0. We have released the fine-tuned model for
          cardiomyopathy in this repository so you should use that model instead.
          For max_ncells, you should set this to None so that all cells are used to
          calculate the start and goal embedding positions. Then, you can use cell_inds_to_perturb
          to subset to a smaller number of cells for the perturbations. You can increase
          it from 5000 to approach the number of detections reported in Table 12.</p>

          '
        raw: Thank you for your interest in Geneformer! My understanding from your
          comment is that you are using the pretrained model for the analysis. As
          discussed in the manuscript, we first fine-tuned the model to distinguish
          the cardiomyopathy states before performing the in silico perturbation.
          By loading the pretrained model as a CellClassifier, you are introducing
          a head layer with random untrained weights from which you are modeling the
          embeddings with emb_layer = 0. We have released the fine-tuned model for
          cardiomyopathy in this repository so you should use that model instead.
          For max_ncells, you should set this to None so that all cells are used to
          calculate the start and goal embedding positions. Then, you can use cell_inds_to_perturb
          to subset to a smaller number of cells for the perturbations. You can increase
          it from 5000 to approach the number of detections reported in Table 12.
        updatedAt: '2023-08-08T14:32:28.522Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64d251fc2234c6d3336d79b7
    id: 64d251fc2234c6d3336d79b5
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer! My understanding from your comment
    is that you are using the pretrained model for the analysis. As discussed in the
    manuscript, we first fine-tuned the model to distinguish the cardiomyopathy states
    before performing the in silico perturbation. By loading the pretrained model
    as a CellClassifier, you are introducing a head layer with random untrained weights
    from which you are modeling the embeddings with emb_layer = 0. We have released
    the fine-tuned model for cardiomyopathy in this repository so you should use that
    model instead. For max_ncells, you should set this to None so that all cells are
    used to calculate the start and goal embedding positions. Then, you can use cell_inds_to_perturb
    to subset to a smaller number of cells for the perturbations. You can increase
    it from 5000 to approach the number of detections reported in Table 12.
  created_at: 2023-08-08 13:32:28+00:00
  edited: false
  hidden: false
  id: 64d251fc2234c6d3336d79b5
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-08T14:32:28.000Z'
    data:
      status: closed
    id: 64d251fc2234c6d3336d79b7
    type: status-change
  author: ctheodoris
  created_at: 2023-08-08 13:32:28+00:00
  id: 64d251fc2234c6d3336d79b7
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
      fullname: Matthew Pace
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Pingiotto
      type: user
    createdAt: '2023-08-10T14:26:04.000Z'
    data:
      edited: false
      editors:
      - Pingiotto
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9125949740409851
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
          fullname: Matthew Pace
          isHf: false
          isPro: false
          name: Pingiotto
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;v2vJyl&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/v2vJyl\">@<span class=\"\
          underline\">v2vJyl</span></a></span>\n\n\t</span></span>  Have you managed\
          \ to replicate the results? I'm trying to do so myself and having some trouble.</p>\n\
          <p><span data-props=\"{&quot;user&quot;:&quot;ctheodoris&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/ctheodoris\">@<span class=\"\
          underline\">ctheodoris</span></a></span>\n\n\t</span></span> Thank you for\
          \ your help in troubleshooting. <code>cell_inds_to_perturb</code> is described\
          \ as \"useful for splitting large datasets across separate GPUs\". So it\
          \ allows us to run multiple analyses in parallel, which will then be collated\
          \ by InSilicoPerturberStats()?</p>\n"
        raw: "@v2vJyl  Have you managed to replicate the results? I'm trying to do\
          \ so myself and having some trouble.\n\n@ctheodoris Thank you for your help\
          \ in troubleshooting. `cell_inds_to_perturb` is described as \"useful for\
          \ splitting large datasets across separate GPUs\". So it allows us to run\
          \ multiple analyses in parallel, which will then be collated by InSilicoPerturberStats()?\n\
          \            \n"
        updatedAt: '2023-08-10T14:26:04.408Z'
      numEdits: 0
      reactions: []
    id: 64d4f37cbadf1110f76c74f3
    type: comment
  author: Pingiotto
  content: "@v2vJyl  Have you managed to replicate the results? I'm trying to do so\
    \ myself and having some trouble.\n\n@ctheodoris Thank you for your help in troubleshooting.\
    \ `cell_inds_to_perturb` is described as \"useful for splitting large datasets\
    \ across separate GPUs\". So it allows us to run multiple analyses in parallel,\
    \ which will then be collated by InSilicoPerturberStats()?\n            \n"
  created_at: 2023-08-10 13:26:04+00:00
  edited: false
  hidden: false
  id: 64d4f37cbadf1110f76c74f3
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 196
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Questions on replicating the human_dcm_hcm in silico perturbation results
