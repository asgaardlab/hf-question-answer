!!python/object:huggingface_hub.community.DiscussionWithDetails
author: hansen7
conflicting_files: null
created_at: 2023-10-04 20:29:14+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
      fullname: Hanchen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: hansen7
      type: user
    createdAt: '2023-10-04T21:29:14.000Z'
    data:
      edited: false
      editors:
      - hansen7
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6707268953323364
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
          fullname: Hanchen
          isHf: false
          isPro: false
          name: hansen7
          type: user
        html: '<p>Regarding a piece of previous <a href="https://huggingface.co/ctheodoris/Geneformer/discussions/252#651cb84b2a77c48f29c9b8dc">discussion</a>.</p>

          <p>During my trying: 1. tokenizing external .h5ad data; then 2. extract
          cell embeddings from pre-trained models, I have to replace the following
          <a href="https://huggingface.co/ctheodoris/Geneformer/blob/4302f4835eda5320b13de85092c97f2c6679b36e/geneformer/tokenizer.py#L213">line</a>
          with</p>

          <pre><code># X_view = adata[idx, coding_miRNA_loc].X

          adata = adata.to_memory()

          X_view = adata[:, coding_miRNA_loc][idx, :].X

          </code></pre>

          <p>Probably due to the fact that I installed the AnnData of 0.9.2, a more
          recent version.</p>

          '
        raw: "Regarding a piece of previous [discussion](https://huggingface.co/ctheodoris/Geneformer/discussions/252#651cb84b2a77c48f29c9b8dc).\r\
          \n\r\nDuring my trying: 1. tokenizing external .h5ad data; then 2. extract\
          \ cell embeddings from pre-trained models, I have to replace the following\
          \ [line](https://huggingface.co/ctheodoris/Geneformer/blob/4302f4835eda5320b13de85092c97f2c6679b36e/geneformer/tokenizer.py#L213)\
          \ with\r\n```\r\n# X_view = adata[idx, coding_miRNA_loc].X\r\nadata = adata.to_memory()\r\
          \nX_view = adata[:, coding_miRNA_loc][idx, :].X\r\n```\r\nProbably due to\
          \ the fact that I installed the AnnData of 0.9.2, a more recent version."
        updatedAt: '2023-10-04T21:29:14.692Z'
      numEdits: 0
      reactions: []
    id: 651dd92a46228626a3802340
    type: comment
  author: hansen7
  content: "Regarding a piece of previous [discussion](https://huggingface.co/ctheodoris/Geneformer/discussions/252#651cb84b2a77c48f29c9b8dc).\r\
    \n\r\nDuring my trying: 1. tokenizing external .h5ad data; then 2. extract cell\
    \ embeddings from pre-trained models, I have to replace the following [line](https://huggingface.co/ctheodoris/Geneformer/blob/4302f4835eda5320b13de85092c97f2c6679b36e/geneformer/tokenizer.py#L213)\
    \ with\r\n```\r\n# X_view = adata[idx, coding_miRNA_loc].X\r\nadata = adata.to_memory()\r\
    \nX_view = adata[:, coding_miRNA_loc][idx, :].X\r\n```\r\nProbably due to the\
    \ fact that I installed the AnnData of 0.9.2, a more recent version."
  created_at: 2023-10-04 20:29:14+00:00
  edited: false
  hidden: false
  id: 651dd92a46228626a3802340
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2cb6d8179d266f747cca706e7d3767a9.svg
      fullname: Marie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: mm2123
      type: user
    createdAt: '2023-11-10T11:44:24.000Z'
    data:
      edited: true
      editors:
      - mm2123
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8796972632408142
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2cb6d8179d266f747cca706e7d3767a9.svg
          fullname: Marie
          isHf: false
          isPro: false
          name: mm2123
          type: user
        html: '<p>Ran into the same issue and the same fix work, thank you so much!
          </p>

          '
        raw: 'Ran into the same issue and the same fix work, thank you so much! '
        updatedAt: '2023-11-10T11:44:52.575Z'
      numEdits: 1
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - hansen7
    id: 654e1798b0288caeae9c6e64
    type: comment
  author: mm2123
  content: 'Ran into the same issue and the same fix work, thank you so much! '
  created_at: 2023-11-10 11:44:24+00:00
  edited: true
  hidden: false
  id: 654e1798b0288caeae9c6e64
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-11-11T01:31:41.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9212897419929504
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for the update! Adding .to_memory() loads the whole adata
          to memory, but the purpose of the X_view method is to process the file chunks
          at a time similarly to how the .loom method we initially implemented is
          done. It would be ideal to determine if there is a different method to resolve
          the error without loading the whole dataset into memory, which can be a
          problem for very large datasets. </p>

          '
        raw: 'Thank you for the update! Adding .to_memory() loads the whole adata
          to memory, but the purpose of the X_view method is to process the file chunks
          at a time similarly to how the .loom method we initially implemented is
          done. It would be ideal to determine if there is a different method to resolve
          the error without loading the whole dataset into memory, which can be a
          problem for very large datasets. '
        updatedAt: '2023-11-11T01:31:41.208Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - hansen7
    id: 654ed97d4c6f4e3300ec2497
    type: comment
  author: ctheodoris
  content: 'Thank you for the update! Adding .to_memory() loads the whole adata to
    memory, but the purpose of the X_view method is to process the file chunks at
    a time similarly to how the .loom method we initially implemented is done. It
    would be ideal to determine if there is a different method to resolve the error
    without loading the whole dataset into memory, which can be a problem for very
    large datasets. '
  created_at: 2023-11-11 01:31:41+00:00
  edited: false
  hidden: false
  id: 654ed97d4c6f4e3300ec2497
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
      fullname: Hanchen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: hansen7
      type: user
    createdAt: '2023-11-11T01:39:01.000Z'
    data:
      edited: false
      editors:
      - hansen7
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9680614471435547
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
          fullname: Hanchen
          isHf: false
          isPro: false
          name: hansen7
          type: user
        html: '<p>Thanks for the clarification, I will take a look at it over the
          weekends.</p>

          '
        raw: Thanks for the clarification, I will take a look at it over the weekends.
        updatedAt: '2023-11-11T01:39:01.650Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - ctheodoris
    id: 654edb358ffcf56fcb722ddf
    type: comment
  author: hansen7
  content: Thanks for the clarification, I will take a look at it over the weekends.
  created_at: 2023-11-11 01:39:01+00:00
  edited: false
  hidden: false
  id: 654edb358ffcf56fcb722ddf
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
      fullname: Hanchen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: hansen7
      type: user
    createdAt: '2023-11-13T09:02:34.000Z'
    data:
      edited: true
      editors:
      - hansen7
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8482906818389893
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
          fullname: Hanchen
          isHf: false
          isPro: false
          name: hansen7
          type: user
        html: '<p>Oh I just realize it is in a loop of chunk processing: the <code>adata</code>
          here at most has <code>chunk_size</code> cells, which is preset as 512.
          So nothing should be worried :)<br><a rel="nofollow" href="https://cdn-uploads.huggingface.co/production/uploads/648200707046ce7300848aa6/YS4zFNwnJlhBFzazalhhe.png"><img
          alt="image.png" src="https://cdn-uploads.huggingface.co/production/uploads/648200707046ce7300848aa6/YS4zFNwnJlhBFzazalhhe.png"></a></p>

          '
        raw: "Oh I just realize it is in a loop of chunk processing: the `adata` here\
          \ at most has `chunk_size` cells, which is preset as 512. So nothing should\
          \ be worried :) \n![image.png](https://cdn-uploads.huggingface.co/production/uploads/648200707046ce7300848aa6/YS4zFNwnJlhBFzazalhhe.png)\n"
        updatedAt: '2023-11-13T09:02:57.373Z'
      numEdits: 1
      reactions: []
    id: 6551e62a8cc59d5b49692ade
    type: comment
  author: hansen7
  content: "Oh I just realize it is in a loop of chunk processing: the `adata` here\
    \ at most has `chunk_size` cells, which is preset as 512. So nothing should be\
    \ worried :) \n![image.png](https://cdn-uploads.huggingface.co/production/uploads/648200707046ce7300848aa6/YS4zFNwnJlhBFzazalhhe.png)\n"
  created_at: 2023-11-13 09:02:34+00:00
  edited: true
  hidden: false
  id: 6551e62a8cc59d5b49692ade
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-11-13T14:51:21.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9568354487419128
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for following up! The variable adata is defined outside
          of that loop, but the loop as you said defines a chunk size which is what
          defines a narrower view of the data, X_view, for the following operations
          to be done with. If we load adata into memory rather than X_view, the whole
          adata will be loaded into memory, which would be an issue for large datasets.
          It would be wonderful to find another way to resolve the error without loading
          the whole dataset into memory though. Thank you again so much for looking
          into this!</p>

          '
        raw: Thank you for following up! The variable adata is defined outside of
          that loop, but the loop as you said defines a chunk size which is what defines
          a narrower view of the data, X_view, for the following operations to be
          done with. If we load adata into memory rather than X_view, the whole adata
          will be loaded into memory, which would be an issue for large datasets.
          It would be wonderful to find another way to resolve the error without loading
          the whole dataset into memory though. Thank you again so much for looking
          into this!
        updatedAt: '2023-11-13T14:51:21.954Z'
      numEdits: 0
      reactions: []
    id: 655237e9f71a0f5860cf0456
    type: comment
  author: ctheodoris
  content: Thank you for following up! The variable adata is defined outside of that
    loop, but the loop as you said defines a chunk size which is what defines a narrower
    view of the data, X_view, for the following operations to be done with. If we
    load adata into memory rather than X_view, the whole adata will be loaded into
    memory, which would be an issue for large datasets. It would be wonderful to find
    another way to resolve the error without loading the whole dataset into memory
    though. Thank you again so much for looking into this!
  created_at: 2023-11-13 14:51:21+00:00
  edited: false
  hidden: false
  id: 655237e9f71a0f5860cf0456
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
      fullname: Hanchen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: hansen7
      type: user
    createdAt: '2023-11-14T07:06:03.000Z'
    data:
      edited: true
      editors:
      - hansen7
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9079872369766235
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/95cff7686299947d02ede1bd5c1ed8eb.svg
          fullname: Hanchen
          isHf: false
          isPro: false
          name: hansen7
          type: user
        html: '<p>True, I''ve re-run with the original implementation (<code>X_view
          = adata[idx, coding_miRNA_loc].X</code>), and previous issue has gone. Also
          I''ve done a few benchmarking, if your MEM is large than the adata size,
          adding <code>adata=adata.to_memory()</code> before the for-loop gives 5-10x
          speedup. 13mins -&gt; 2~3 mins for an adata of 1e6 genome-wide cells.</p>

          '
        raw: True, I've re-run with the original implementation (`X_view = adata[idx,
          coding_miRNA_loc].X`), and previous issue has gone. Also I've done a few
          benchmarking, if your MEM is large than the adata size, adding `adata=adata.to_memory()`
          before the for-loop gives 5-10x speedup. 13mins -> 2~3 mins for an adata
          of 1e6 genome-wide cells.
        updatedAt: '2023-11-14T07:08:09.818Z'
      numEdits: 1
      reactions: []
    id: 65531c5bab7c20ac6fed7bd8
    type: comment
  author: hansen7
  content: True, I've re-run with the original implementation (`X_view = adata[idx,
    coding_miRNA_loc].X`), and previous issue has gone. Also I've done a few benchmarking,
    if your MEM is large than the adata size, adding `adata=adata.to_memory()` before
    the for-loop gives 5-10x speedup. 13mins -> 2~3 mins for an adata of 1e6 genome-wide
    cells.
  created_at: 2023-11-14 07:06:03+00:00
  edited: true
  hidden: false
  id: 65531c5bab7c20ac6fed7bd8
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-11-21T06:22:44.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9060720205307007
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Glad to hear the prior error is resolved. I added the option for
          modifying the chunk_size used by the anndata tokenizer to allow for speedups
          with larger chunk_size when memory is not a limitation. Thank you for your
          suggestion!</p>

          '
        raw: Glad to hear the prior error is resolved. I added the option for modifying
          the chunk_size used by the anndata tokenizer to allow for speedups with
          larger chunk_size when memory is not a limitation. Thank you for your suggestion!
        updatedAt: '2023-11-21T06:22:44.727Z'
      numEdits: 0
      reactions: []
      relatedEventId: 655c4cb42f050bbb02d1a195
    id: 655c4cb42f050bbb02d1a192
    type: comment
  author: ctheodoris
  content: Glad to hear the prior error is resolved. I added the option for modifying
    the chunk_size used by the anndata tokenizer to allow for speedups with larger
    chunk_size when memory is not a limitation. Thank you for your suggestion!
  created_at: 2023-11-21 06:22:44+00:00
  edited: false
  hidden: false
  id: 655c4cb42f050bbb02d1a192
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-11-21T06:22:44.000Z'
    data:
      status: closed
    id: 655c4cb42f050bbb02d1a195
    type: status-change
  author: ctheodoris
  created_at: 2023-11-21 06:22:44+00:00
  id: 655c4cb42f050bbb02d1a195
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 255
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Slicing in Anndata in tokenizer.py
