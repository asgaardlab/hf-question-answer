!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Renqing
conflicting_files: null
created_at: 2023-06-25 08:23:07+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-25T09:23:07.000Z'
    data:
      edited: true
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.48262351751327515
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: "<p>Hello, When i run the in silicon perturbation code encountered the\
          \ following errors\uFF1A<br><code>The code is</code>:<br>from geneformer\
          \ import InSilicoPerturber<br>from geneformer import InSilicoPerturberStats</p>\n\
          <p>isp = InSilicoPerturber(perturb_type=\"delete\",<br>                \
          \      perturb_rank_shift=None,<br>                      genes_to_perturb=\"\
          all\",<br>                      combos=0,<br>                      anchor_gene=None,<br>\
          \                      model_type=\"Pretrained\",<br>                  \
          \    num_classes=3,<br>                      emb_mode=\"cell\",<br>    \
          \                  cell_emb_style=\"mean_pool\",<br>                   \
          \   filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\",\"\
          Cardiomyocyte3\"]},<br>                      cell_states_to_model={\"disease\"\
          :([\"dcm\"],[\"nf\"],[\"hcm\"])},<br>                      max_ncells=2000,<br>\
          \                      emb_layer=0,<br>                      forward_batch_size=4,<br>\
          \                      nproc=16,<br>                      save_raw_data=True)<br>isp.perturb_data(\"\
          /path_to_pretrained/Geneformer/\",             \"/path_to/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/\"\
          ,<br>\"/path_to/cell_classification/disease_classification/\",<br>     \
          \          \"test\")</p>\n<p><code>The error is</code>:<br>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:232,\
          \ in quant_cos_sims(model, perturbation_batch, forward_batch_size, layer_to_quant,\
          \ original_emb, indices_to_perturb, cell_states_to_model, state_embs_dict)<br>\
          \    230 else:<br>    231     for state in possible_states:<br>--&gt; 232\
          \         cos_sims_vs_alt_dict[state] += cos_sim_shift(original_emb, minibatch_emb,\
          \ state_embs_dict[state])<br>    233 del outputs<br>    234 del minibatch_emb</p>\n\
          <p>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,\
          \ in cos_sim_shift(original_emb, minibatch_emb, alt_emb)<br>    249 original_emb\
          \ = torch.mean(original_emb,dim=0,keepdim=True)[None, :]<br>    250 alt_emb\
          \ = alt_emb[None, None, :]<br>--&gt; 251 origin_v_end = cos(original_emb,alt_emb)<br>\
          \    252 perturb_v_end = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)<br>\
          \    253 return [(perturb_v_end-origin_v_end).to(\"cpu\")]</p>\n<p>File\
          \ ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,\
          \ in Module._call_impl(self, *input, **kwargs)<br>   1098 # If we don't\
          \ have any hooks, we want to skip the rest of the logic in<br>   1099 #\
          \ this function, and just call forward.<br>   1100 if not (self._backward_hooks\
          \ or self._forward_hooks or self._forward_pre_hooks or _global_backward_hooks<br>\
          \   1101         or _global_forward_hooks or _global_forward_pre_hooks):<br>-&gt;\
          \ 1102     return forward_call(*input, **kwargs)<br>   1103 # Do not call\
          \ functions when jit is used<br>   1104 full_backward_hooks, non_full_backward_hooks\
          \ = [], []</p>\n<p>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,\
          \ in CosineSimilarity.forward(self, x1, x2)<br>     76 def forward(self,\
          \ x1: Tensor, x2: Tensor) -&gt; Tensor:<br>---&gt; 77     return F.cosine_similarity(x1,\
          \ x2, self.dim, self.eps)</p>\n<p>RuntimeError: cosine_similarity requires\
          \ both inputs to have the same number of dimensions, but x1 has 3 and x2\
          \ has 5</p>\n"
        raw: "Hello, When i run the in silicon perturbation code encountered the following\
          \ errors\uFF1A\n`The code is`:\nfrom geneformer import InSilicoPerturber\n\
          from geneformer import InSilicoPerturberStats\n\nisp = InSilicoPerturber(perturb_type=\"\
          delete\",\n                      perturb_rank_shift=None,\n            \
          \          genes_to_perturb=\"all\",\n                      combos=0,\n\
          \                      anchor_gene=None,\n                      model_type=\"\
          Pretrained\",\n                      num_classes=3,\n                  \
          \    emb_mode=\"cell\",\n                      cell_emb_style=\"mean_pool\"\
          ,\n                      filter_data={\"cell_type\":[\"Cardiomyocyte1\"\
          ,\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\n                      cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])},\n                      max_ncells=2000,\n\
          \                      emb_layer=0,\n                      forward_batch_size=4,\n\
          \                      nproc=16,\n                      save_raw_data=True)\n\
          isp.perturb_data(\"/path_to_pretrained/Geneformer/\",             \"/path_to/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/\"\
          ,\n\"/path_to/cell_classification/disease_classification/\",\n         \
          \      \"test\")\n\n`The error is`:\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:232,\
          \ in quant_cos_sims(model, perturbation_batch, forward_batch_size, layer_to_quant,\
          \ original_emb, indices_to_perturb, cell_states_to_model, state_embs_dict)\n\
          \    230 else:\n    231     for state in possible_states:\n--> 232     \
          \    cos_sims_vs_alt_dict[state] += cos_sim_shift(original_emb, minibatch_emb,\
          \ state_embs_dict[state])\n    233 del outputs\n    234 del minibatch_emb\n\
          \nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,\
          \ in cos_sim_shift(original_emb, minibatch_emb, alt_emb)\n    249 original_emb\
          \ = torch.mean(original_emb,dim=0,keepdim=True)[None, :]\n    250 alt_emb\
          \ = alt_emb[None, None, :]\n--> 251 origin_v_end = cos(original_emb,alt_emb)\n\
          \    252 perturb_v_end = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)\n\
          \    253 return [(perturb_v_end-origin_v_end).to(\"cpu\")]\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,\
          \ in Module._call_impl(self, *input, **kwargs)\n   1098 # If we don't have\
          \ any hooks, we want to skip the rest of the logic in\n   1099 # this function,\
          \ and just call forward.\n   1100 if not (self._backward_hooks or self._forward_hooks\
          \ or self._forward_pre_hooks or _global_backward_hooks\n   1101        \
          \ or _global_forward_hooks or _global_forward_pre_hooks):\n-> 1102     return\
          \ forward_call(*input, **kwargs)\n   1103 # Do not call functions when jit\
          \ is used\n   1104 full_backward_hooks, non_full_backward_hooks = [], []\n\
          \nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,\
          \ in CosineSimilarity.forward(self, x1, x2)\n     76 def forward(self, x1:\
          \ Tensor, x2: Tensor) -> Tensor:\n---> 77     return F.cosine_similarity(x1,\
          \ x2, self.dim, self.eps)\n\nRuntimeError: cosine_similarity requires both\
          \ inputs to have the same number of dimensions, but x1 has 3 and x2 has\
          \ 5\n"
        updatedAt: '2023-06-25T09:24:17.292Z'
      numEdits: 2
      reactions: []
    id: 6498077b641fe57dcd5d4457
    type: comment
  author: Renqing
  content: "Hello, When i run the in silicon perturbation code encountered the following\
    \ errors\uFF1A\n`The code is`:\nfrom geneformer import InSilicoPerturber\nfrom\
    \ geneformer import InSilicoPerturberStats\n\nisp = InSilicoPerturber(perturb_type=\"\
    delete\",\n                      perturb_rank_shift=None,\n                  \
    \    genes_to_perturb=\"all\",\n                      combos=0,\n            \
    \          anchor_gene=None,\n                      model_type=\"Pretrained\"\
    ,\n                      num_classes=3,\n                      emb_mode=\"cell\"\
    ,\n                      cell_emb_style=\"mean_pool\",\n                     \
    \ filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\",\"Cardiomyocyte3\"\
    ]},\n                      cell_states_to_model={\"disease\":([\"dcm\"],[\"nf\"\
    ],[\"hcm\"])},\n                      max_ncells=2000,\n                     \
    \ emb_layer=0,\n                      forward_batch_size=4,\n                \
    \      nproc=16,\n                      save_raw_data=True)\nisp.perturb_data(\"\
    /path_to_pretrained/Geneformer/\",             \"/path_to/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/\"\
    ,\n\"/path_to/cell_classification/disease_classification/\",\n               \"\
    test\")\n\n`The error is`:\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:232,\
    \ in quant_cos_sims(model, perturbation_batch, forward_batch_size, layer_to_quant,\
    \ original_emb, indices_to_perturb, cell_states_to_model, state_embs_dict)\n \
    \   230 else:\n    231     for state in possible_states:\n--> 232         cos_sims_vs_alt_dict[state]\
    \ += cos_sim_shift(original_emb, minibatch_emb, state_embs_dict[state])\n    233\
    \ del outputs\n    234 del minibatch_emb\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,\
    \ in cos_sim_shift(original_emb, minibatch_emb, alt_emb)\n    249 original_emb\
    \ = torch.mean(original_emb,dim=0,keepdim=True)[None, :]\n    250 alt_emb = alt_emb[None,\
    \ None, :]\n--> 251 origin_v_end = cos(original_emb,alt_emb)\n    252 perturb_v_end\
    \ = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)\n    253 return\
    \ [(perturb_v_end-origin_v_end).to(\"cpu\")]\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,\
    \ in Module._call_impl(self, *input, **kwargs)\n   1098 # If we don't have any\
    \ hooks, we want to skip the rest of the logic in\n   1099 # this function, and\
    \ just call forward.\n   1100 if not (self._backward_hooks or self._forward_hooks\
    \ or self._forward_pre_hooks or _global_backward_hooks\n   1101         or _global_forward_hooks\
    \ or _global_forward_pre_hooks):\n-> 1102     return forward_call(*input, **kwargs)\n\
    \   1103 # Do not call functions when jit is used\n   1104 full_backward_hooks,\
    \ non_full_backward_hooks = [], []\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,\
    \ in CosineSimilarity.forward(self, x1, x2)\n     76 def forward(self, x1: Tensor,\
    \ x2: Tensor) -> Tensor:\n---> 77     return F.cosine_similarity(x1, x2, self.dim,\
    \ self.eps)\n\nRuntimeError: cosine_similarity requires both inputs to have the\
    \ same number of dimensions, but x1 has 3 and x2 has 5\n"
  created_at: 2023-06-25 08:23:07+00:00
  edited: true
  hidden: false
  id: 6498077b641fe57dcd5d4457
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-25T09:50:59.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6717546582221985
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>I pull the repository on Jun 19.</p>

          '
        raw: I pull the repository on Jun 19.
        updatedAt: '2023-06-25T09:50:59.520Z'
      numEdits: 0
      reactions: []
    id: 64980e03cf74a0fce0f53f7e
    type: comment
  author: Renqing
  content: I pull the repository on Jun 19.
  created_at: 2023-06-25 08:50:59+00:00
  edited: false
  hidden: false
  id: 64980e03cf74a0fce0f53f7e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-25T19:41:05.000Z'
    data:
      edited: true
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9332601428031921
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer and for your question.
          I am not encountering this error when I run it with your options. Could
          you please pull the current version and retry? </p>

          <p>Also, I wanted to note that when using in silico perturbation to test
          for perturbations that shift cells between two very similar states, it will
          likely be more effective if you first fine-tune the model to distinguish
          between the states so that they are better separated within the embedding
          space before testing what perturbation shifts between them. Specifically,
          the end-stage failing heart states are similar between the dilated and hypertrophic
          cardiomyopathy samples in Chaffin et al. Nature 2022, so it will likely
          be more effective to first fine-tune the model to distinguish them before
          running the in silico perturbation/treatment analysis. Fine-tuning the model
          is less necessary when testing the shift between two states that are already
          very separable by the pretrained model (e.g. fibroblasts vs. cardiomyocytes).
          However, fine-tuning with relevant data may still be helpful to orient the
          model''s weights towards the specific downstream objective.</p>

          '
        raw: "Thank you for your interest in Geneformer and for your question. I am\
          \ not encountering this error when I run it with your options. Could you\
          \ please pull the current version and retry? \n\nAlso, I wanted to note\
          \ that when using in silico perturbation to test for perturbations that\
          \ shift cells between two very similar states, it will likely be more effective\
          \ if you first fine-tune the model to distinguish between the states so\
          \ that they are better separated within the embedding space before testing\
          \ what perturbation shifts between them. Specifically, the end-stage failing\
          \ heart states are similar between the dilated and hypertrophic cardiomyopathy\
          \ samples in Chaffin et al. Nature 2022, so it will likely be more effective\
          \ to first fine-tune the model to distinguish them before running the in\
          \ silico perturbation/treatment analysis. Fine-tuning the model is less\
          \ necessary when testing the shift between two states that are already very\
          \ separable by the pretrained model (e.g. fibroblasts vs. cardiomyocytes).\
          \ However, fine-tuning with relevant data may still be helpful to orient\
          \ the model's weights towards the specific downstream objective."
        updatedAt: '2023-06-25T19:41:17.758Z'
      numEdits: 1
      reactions: []
      relatedEventId: 64989851cf74a0fce0ffb97a
    id: 64989851cf74a0fce0ffb979
    type: comment
  author: ctheodoris
  content: "Thank you for your interest in Geneformer and for your question. I am\
    \ not encountering this error when I run it with your options. Could you please\
    \ pull the current version and retry? \n\nAlso, I wanted to note that when using\
    \ in silico perturbation to test for perturbations that shift cells between two\
    \ very similar states, it will likely be more effective if you first fine-tune\
    \ the model to distinguish between the states so that they are better separated\
    \ within the embedding space before testing what perturbation shifts between them.\
    \ Specifically, the end-stage failing heart states are similar between the dilated\
    \ and hypertrophic cardiomyopathy samples in Chaffin et al. Nature 2022, so it\
    \ will likely be more effective to first fine-tune the model to distinguish them\
    \ before running the in silico perturbation/treatment analysis. Fine-tuning the\
    \ model is less necessary when testing the shift between two states that are already\
    \ very separable by the pretrained model (e.g. fibroblasts vs. cardiomyocytes).\
    \ However, fine-tuning with relevant data may still be helpful to orient the model's\
    \ weights towards the specific downstream objective."
  created_at: 2023-06-25 18:41:05+00:00
  edited: true
  hidden: false
  id: 64989851cf74a0fce0ffb979
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-25T19:41:05.000Z'
    data:
      status: closed
    id: 64989851cf74a0fce0ffb97a
    type: status-change
  author: ctheodoris
  created_at: 2023-06-25 18:41:05+00:00
  id: 64989851cf74a0fce0ffb97a
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T01:36:45.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.545590341091156
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>Hey, I called back the repository, but the error didn''t work out.<br>`<br>File
          ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,
          in quant_cos_sims(model, perturb_type, perturbation_batch, forward_batch_size,
          layer_to_quant, original_emb, indices_to_perturb, cell_states_to_model,
          state_embs_dict)<br>    249 elif cell_states_to_model is not None:<br>    250     for
          state in possible_states:<br>--&gt; 251         cos_sims_vs_alt_dict[state]
          += cos_sim_shift(original_emb, minibatch_emb, state_embs_dict[state])<br>    252
          del outputs<br>    253 del minibatch_emb</p>

          <p>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:270,
          in cos_sim_shift(original_emb, minibatch_emb, alt_emb)<br>    268 original_emb
          = torch.mean(original_emb,dim=0,keepdim=True)[None, :]<br>    269 alt_emb
          = alt_emb[None, None, :]<br>--&gt; 270 origin_v_end = cos(original_emb,alt_emb)<br>    271
          perturb_v_end = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)<br>    272
          return [(perturb_v_end-origin_v_end).to("cpu")]</p>

          <p>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,
          in Module._call_impl(self, *input, **kwargs)<br>   1098 # If we don''t have
          any hooks, we want to skip the rest of the logic in<br>   1099 # this function,
          and just call forward.<br>   1100 if not (self._backward_hooks or self._forward_hooks
          or self._forward_pre_hooks or _global_backward_hooks<br>   1101         or
          _global_forward_hooks or _global_forward_pre_hooks):<br>-&gt; 1102     return
          forward_call(*input, **kwargs)<br>   1103 # Do not call functions when jit
          is used<br>   1104 full_backward_hooks, non_full_backward_hooks = [], []</p>

          <p>File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,
          in CosineSimilarity.forward(self, x1, x2)<br>     76 def forward(self, x1:
          Tensor, x2: Tensor) -&gt; Tensor:<br>---&gt; 77     return F.cosine_similarity(x1,
          x2, self.dim, self.eps)</p>

          <p>RuntimeError: cosine_similarity requires both inputs to have the same
          number of dimensions, but x1 has 3 and x2 has 5<br>`</p>

          '
        raw: "Hey, I called back the repository, but the error didn't work out.\n\
          `\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,\
          \ in quant_cos_sims(model, perturb_type, perturbation_batch, forward_batch_size,\
          \ layer_to_quant, original_emb, indices_to_perturb, cell_states_to_model,\
          \ state_embs_dict)\n    249 elif cell_states_to_model is not None:\n   \
          \ 250     for state in possible_states:\n--> 251         cos_sims_vs_alt_dict[state]\
          \ += cos_sim_shift(original_emb, minibatch_emb, state_embs_dict[state])\n\
          \    252 del outputs\n    253 del minibatch_emb\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:270,\
          \ in cos_sim_shift(original_emb, minibatch_emb, alt_emb)\n    268 original_emb\
          \ = torch.mean(original_emb,dim=0,keepdim=True)[None, :]\n    269 alt_emb\
          \ = alt_emb[None, None, :]\n--> 270 origin_v_end = cos(original_emb,alt_emb)\n\
          \    271 perturb_v_end = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)\n\
          \    272 return [(perturb_v_end-origin_v_end).to(\"cpu\")]\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,\
          \ in Module._call_impl(self, *input, **kwargs)\n   1098 # If we don't have\
          \ any hooks, we want to skip the rest of the logic in\n   1099 # this function,\
          \ and just call forward.\n   1100 if not (self._backward_hooks or self._forward_hooks\
          \ or self._forward_pre_hooks or _global_backward_hooks\n   1101        \
          \ or _global_forward_hooks or _global_forward_pre_hooks):\n-> 1102     return\
          \ forward_call(*input, **kwargs)\n   1103 # Do not call functions when jit\
          \ is used\n   1104 full_backward_hooks, non_full_backward_hooks = [], []\n\
          \nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,\
          \ in CosineSimilarity.forward(self, x1, x2)\n     76 def forward(self, x1:\
          \ Tensor, x2: Tensor) -> Tensor:\n---> 77     return F.cosine_similarity(x1,\
          \ x2, self.dim, self.eps)\n\nRuntimeError: cosine_similarity requires both\
          \ inputs to have the same number of dimensions, but x1 has 3 and x2 has\
          \ 5\n`\n"
        updatedAt: '2023-06-27T01:36:45.574Z'
      numEdits: 0
      reactions: []
    id: 649a3d2d7a119fd611f28620
    type: comment
  author: Renqing
  content: "Hey, I called back the repository, but the error didn't work out.\n`\n\
    File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:251,\
    \ in quant_cos_sims(model, perturb_type, perturbation_batch, forward_batch_size,\
    \ layer_to_quant, original_emb, indices_to_perturb, cell_states_to_model, state_embs_dict)\n\
    \    249 elif cell_states_to_model is not None:\n    250     for state in possible_states:\n\
    --> 251         cos_sims_vs_alt_dict[state] += cos_sim_shift(original_emb, minibatch_emb,\
    \ state_embs_dict[state])\n    252 del outputs\n    253 del minibatch_emb\n\n\
    File ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/geneformer/in_silico_perturber.py:270,\
    \ in cos_sim_shift(original_emb, minibatch_emb, alt_emb)\n    268 original_emb\
    \ = torch.mean(original_emb,dim=0,keepdim=True)[None, :]\n    269 alt_emb = alt_emb[None,\
    \ None, :]\n--> 270 origin_v_end = cos(original_emb,alt_emb)\n    271 perturb_v_end\
    \ = cos(torch.mean(minibatch_emb,dim=1,keepdim=True),alt_emb)\n    272 return\
    \ [(perturb_v_end-origin_v_end).to(\"cpu\")]\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/module.py:1102,\
    \ in Module._call_impl(self, *input, **kwargs)\n   1098 # If we don't have any\
    \ hooks, we want to skip the rest of the logic in\n   1099 # this function, and\
    \ just call forward.\n   1100 if not (self._backward_hooks or self._forward_hooks\
    \ or self._forward_pre_hooks or _global_backward_hooks\n   1101         or _global_forward_hooks\
    \ or _global_forward_pre_hooks):\n-> 1102     return forward_call(*input, **kwargs)\n\
    \   1103 # Do not call functions when jit is used\n   1104 full_backward_hooks,\
    \ non_full_backward_hooks = [], []\n\nFile ~/anaconda3/envs/geneformer_py38/lib/python3.8/site-packages/torch/nn/modules/distance.py:77,\
    \ in CosineSimilarity.forward(self, x1, x2)\n     76 def forward(self, x1: Tensor,\
    \ x2: Tensor) -> Tensor:\n---> 77     return F.cosine_similarity(x1, x2, self.dim,\
    \ self.eps)\n\nRuntimeError: cosine_similarity requires both inputs to have the\
    \ same number of dimensions, but x1 has 3 and x2 has 5\n`\n"
  created_at: 2023-06-27 00:36:45+00:00
  edited: false
  hidden: false
  id: 649a3d2d7a119fd611f28620
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T01:51:20.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6652688384056091
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>Load dataset logging:<br>Loading cached processed dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-fb03eeb02b1434f4_*_of_00016.arrow<br>Loading
          cached shuffled indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-a0e2d2a3c71a319a.arrow<br>Loading
          cached sorted indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-463255c0abb2b70b.arrow</p>

          '
        raw: 'Load dataset logging:

          Loading cached processed dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-fb03eeb02b1434f4_*_of_00016.arrow

          Loading cached shuffled indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-a0e2d2a3c71a319a.arrow

          Loading cached sorted indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-463255c0abb2b70b.arrow'
        updatedAt: '2023-06-27T01:51:20.403Z'
      numEdits: 0
      reactions: []
    id: 649a40981ced6847e3172202
    type: comment
  author: Renqing
  content: 'Load dataset logging:

    Loading cached processed dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-fb03eeb02b1434f4_*_of_00016.arrow

    Loading cached shuffled indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-a0e2d2a3c71a319a.arrow

    Loading cached sorted indices for dataset at /Geneformer/example_input_file/cell_classification/disease_classification/human_dcm_hcm_nf.dataset/cache-463255c0abb2b70b.arrow'
  created_at: 2023-06-27 00:51:20+00:00
  edited: false
  hidden: false
  id: 649a40981ced6847e3172202
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T01:53:39.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.43583008646965027
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p><a rel="nofollow" href="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/2wxp2Gfu2Gyn_zFbyGbkQ.png"><img
          alt="image.png" src="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/2wxp2Gfu2Gyn_zFbyGbkQ.png"></a></p>

          '
        raw: '

          ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/2wxp2Gfu2Gyn_zFbyGbkQ.png)

          '
        updatedAt: '2023-06-27T01:53:39.357Z'
      numEdits: 0
      reactions: []
    id: 649a412376357a5bfc0c60b0
    type: comment
  author: Renqing
  content: '

    ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/2wxp2Gfu2Gyn_zFbyGbkQ.png)

    '
  created_at: 2023-06-27 00:53:39+00:00
  edited: false
  hidden: false
  id: 649a412376357a5bfc0c60b0
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T02:14:14.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.441715270280838
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p><a rel="nofollow" href="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/K6RWmRZ8q4Pla31zQe_eK.png"><img
          alt="image.png" src="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/K6RWmRZ8q4Pla31zQe_eK.png"></a></p>

          '
        raw: '

          ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/K6RWmRZ8q4Pla31zQe_eK.png)


          '
        updatedAt: '2023-06-27T02:14:14.917Z'
      numEdits: 0
      reactions: []
    id: 649a45f60695bc694e2a6d58
    type: comment
  author: Renqing
  content: '

    ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/K6RWmRZ8q4Pla31zQe_eK.png)


    '
  created_at: 2023-06-27 01:14:14+00:00
  edited: false
  hidden: false
  id: 649a45f60695bc694e2a6d58
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T05:55:35.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6564810276031494
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>I fix this erro,  because of the torch 1.10.0</p>

          '
        raw: I fix this erro,  because of the torch 1.10.0
        updatedAt: '2023-06-27T05:55:35.047Z'
      numEdits: 0
      reactions: []
    id: 649a79d7575e60d3a879dd03
    type: comment
  author: Renqing
  content: I fix this erro,  because of the torch 1.10.0
  created_at: 2023-06-27 04:55:35+00:00
  edited: false
  hidden: false
  id: 649a79d7575e60d3a879dd03
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-27T08:58:06.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8834789991378784
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>By the way, In the script <code>in_silico_perturber.py</code> line
          490, as follow:</p>

          <p><a rel="nofollow" href="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/8NSJcB2Uixm6JW0qfh5i2.png"><img
          alt="image.png" src="https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/8NSJcB2Uixm6JW0qfh5i2.png"></a><br>My
          understanding is that significantly this model can only do three states
          of perturbation, right? If I want to distinguish between two states, normal
          and tumor, the current perturbation model is not possible.</p>

          '
        raw: 'By the way, In the script `in_silico_perturber.py` line 490, as follow:


          ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/8NSJcB2Uixm6JW0qfh5i2.png)

          My understanding is that significantly this model can only do three states
          of perturbation, right? If I want to distinguish between two states, normal
          and tumor, the current perturbation model is not possible.



          '
        updatedAt: '2023-06-27T08:58:06.272Z'
      numEdits: 0
      reactions: []
    id: 649aa49eef592b26c3d4986f
    type: comment
  author: Renqing
  content: 'By the way, In the script `in_silico_perturber.py` line 490, as follow:


    ![image.png](https://cdn-uploads.huggingface.co/production/uploads/640fc3c5f2d7c41a1ea077df/8NSJcB2Uixm6JW0qfh5i2.png)

    My understanding is that significantly this model can only do three states of
    perturbation, right? If I want to distinguish between two states, normal and tumor,
    the current perturbation model is not possible.



    '
  created_at: 2023-06-27 07:58:06+00:00
  edited: false
  hidden: false
  id: 649aa49eef592b26c3d4986f
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-27T19:26:48.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9452301263809204
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your question. The code you highlighted just checks
          if the values within the three lists are unique. For modeling 2 states,
          you can just provide an empty list as the third element (i.e. []). I added
          this to the documentation to be extra clear and updated the stats script
          to account for that option. </p>

          <p>Also, it would be great if you could start a new discussion if there
          are questions that are unrelated to the initial question in a discussion.
          It would also be great to be descriptive in the discussion title to indicate
          what the question is specifically about in each discussion. That would be
          very helpful for others if they are looking for the answer to the same question.
          Thank you for your collaboration on that!</p>

          '
        raw: "Thank you for your question. The code you highlighted just checks if\
          \ the values within the three lists are unique. For modeling 2 states, you\
          \ can just provide an empty list as the third element (i.e. []). I added\
          \ this to the documentation to be extra clear and updated the stats script\
          \ to account for that option. \n\nAlso, it would be great if you could start\
          \ a new discussion if there are questions that are unrelated to the initial\
          \ question in a discussion. It would also be great to be descriptive in\
          \ the discussion title to indicate what the question is specifically about\
          \ in each discussion. That would be very helpful for others if they are\
          \ looking for the answer to the same question. Thank you for your collaboration\
          \ on that!"
        updatedAt: '2023-06-27T19:26:48.645Z'
      numEdits: 0
      reactions: []
    id: 649b37f88540f1501feac48d
    type: comment
  author: ctheodoris
  content: "Thank you for your question. The code you highlighted just checks if the\
    \ values within the three lists are unique. For modeling 2 states, you can just\
    \ provide an empty list as the third element (i.e. []). I added this to the documentation\
    \ to be extra clear and updated the stats script to account for that option. \n\
    \nAlso, it would be great if you could start a new discussion if there are questions\
    \ that are unrelated to the initial question in a discussion. It would also be\
    \ great to be descriptive in the discussion title to indicate what the question\
    \ is specifically about in each discussion. That would be very helpful for others\
    \ if they are looking for the answer to the same question. Thank you for your\
    \ collaboration on that!"
  created_at: 2023-06-27 18:26:48+00:00
  edited: false
  hidden: false
  id: 649b37f88540f1501feac48d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-06-28T02:14:34.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9542055130004883
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: '<p>Thank you for your responsing.</p>

          '
        raw: Thank you for your responsing.
        updatedAt: '2023-06-28T02:14:34.680Z'
      numEdits: 0
      reactions: []
    id: 649b978af0057ece9340c100
    type: comment
  author: Renqing
  content: Thank you for your responsing.
  created_at: 2023-06-28 01:14:34+00:00
  edited: false
  hidden: false
  id: 649b978af0057ece9340c100
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 63
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: About in silicon perturbation error
