!!python/object:huggingface_hub.community.DiscussionWithDetails
author: junguyen
conflicting_files: null
created_at: 2023-09-05 16:26:02+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
      fullname: Julie Nguyen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: junguyen
      type: user
    createdAt: '2023-09-05T17:26:02.000Z'
    data:
      edited: false
      editors:
      - junguyen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.28296324610710144
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
          fullname: Julie Nguyen
          isHf: false
          isPro: false
          name: junguyen
          type: user
        html: "<p>Hello,</p>\n<p>Seems I'm facing the same error described in Discussion\
          \ <a href=\"/ctheodoris/Geneformer/discussions/182\">#182</a>; however,\
          \ pulling the latest version of Geneformer did not fix this issue:</p>\n\
          <pre><code>gc.collect()\ntorch.cuda.empty_cache()\nisp = InSilicoPerturber(perturb_type=\"\
          delete\",\n                        perturb_rank_shift=None,\n          \
          \              # HNF4A: ENSG00000101076\n                        genes_to_perturb=[\"\
          ENSG00000101076\"],\n                        combos=0,\n               \
          \         anchor_gene=None,\n                        model_type=\"Pretrained\"\
          ,\n                        num_classes=0,\n                        emb_mode=\"\
          cell\",\n                        cell_emb_style=\"mean_pool\",\n       \
          \                 filter_data=None,\n                        cell_states_to_model=None,\n\
          \                        max_ncells=10,\n                        emb_layer=-1,\n\
          \                        forward_batch_size=10,\n                      \
          \  nproc=16,\n                        token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\n\n# Perturb data\nisp.perturb_data(\"/home/ubuntu/Geneformer/\",\n  \
          \               \"/data/genecorpus_filtered_hep/\",\n                 \"\
          /data/genecorpus_filtered_hep/delete_cell/\",\n                 \"delete_cell_HNF4A\"\
          )\n</code></pre>\n<pre><code>Filter (num_proc=16): 100%|\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 12775/12775 [00:13&lt;00:00, 981.99\
          \ examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3000/3000 [00:12&lt;00:00,\
          \ 231.00 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3000/3000 [00:00&lt;00:00,\
          \ 8204.96 examples/s]\nTraceback (most recent call last):              \
          \                                                                      \n\
          \  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;                   \
          \                                                              \n  File\
          \ \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 974, in perturb_data    \n    self.in_silico_perturb(model,     \
          \                                                                      \
          \          \n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1052, in in_silico_pertu\nrb                                    \
          \                                                                      \
          \          \n    cos_sims_data = quant_cos_sims(model,                 \
          \                                                            \n  File \"\
          /opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 411, in quant_cos_sims  \n    attention_mask = gen_attention_mask(original_minibatch,\
          \ original_max_len)                                         \nUnboundLocalError:\
          \ local variable 'original_max_len' referenced before assignment       \
          \                              \n</code></pre>\n<p>When I change <code>max_ncells=30</code>\
          \ and keep <code>forward_batch_size=30</code>, I receive a new error (see\
          \ below). I'm unsure of whether these 2 errors are related but I thought\
          \ I'd post both anyways. I've had previous success running the code with\
          \ these parameters on Aug 31, 2023 so it may be due to changes implemented\
          \ after that date?</p>\n<pre><code>Filter (num_proc=16): 100%|\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 12775/12775 [00:12&lt;00:00,\
          \ 986.85 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588| 30/30 [00:13&lt;00:00,  2.30 examples/s]\nMap (num_proc=16):\
          \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:00&lt;00:00, 172.79\
          \ examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 30/30 [00:00&lt;00:00, 170.27 examples/s]\nMap (num_proc=16): 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588| 30/30 [00:00&lt;00:00, 177.20 examples/s]\n\
          Traceback (most recent call last):                                     \
          \                                               \n  File \"&lt;stdin&gt;\"\
          , line 1, in &lt;module&gt;                                            \
          \                                     \n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 974, in perturb_data    \n    self.in_silico_perturb(model,     \
          \                                                                      \
          \          \n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1052, in in_silico_pertu\nrb                                    \
          \                                                                      \
          \          \n    cos_sims_data = quant_cos_sims(model,                 \
          \                                                            \n  File \"\
          /opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 444, in quant_cos_sims  \n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]                                                  \n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 1501, in _call_impl            \n    return forward_call(*args, **kwargs)\
          \                                                                      \
          \        \n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 87, in forward               \n    return F.cosine_similarity(x1,\
          \ x2, self.dim, self.eps)                                              \
          \              \nRuntimeError: The size of tensor a (2047) must match the\
          \ size of tensor b (2046) at non-singleton dimension 1         \n</code></pre>\n"
        raw: "Hello,\r\n\r\nSeems I'm facing the same error described in Discussion\
          \ #182; however, pulling the latest version of Geneformer did not fix this\
          \ issue:\r\n\r\n```\r\ngc.collect()\r\ntorch.cuda.empty_cache()\r\nisp =\
          \ InSilicoPerturber(perturb_type=\"delete\",\r\n                       \
          \ perturb_rank_shift=None,\r\n                        # HNF4A: ENSG00000101076\r\
          \n                        genes_to_perturb=[\"ENSG00000101076\"],\r\n  \
          \                      combos=0,\r\n                        anchor_gene=None,\r\
          \n                        model_type=\"Pretrained\",\r\n               \
          \         num_classes=0,\r\n                        emb_mode=\"cell\",\r\
          \n                        cell_emb_style=\"mean_pool\",\r\n            \
          \            filter_data=None,\r\n                        cell_states_to_model=None,\r\
          \n                        max_ncells=10,\r\n                        emb_layer=-1,\r\
          \n                        forward_batch_size=10,\r\n                   \
          \     nproc=16,\r\n                        token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\r\n\r\n# Perturb data\r\nisp.perturb_data(\"/home/ubuntu/Geneformer/\"\
          ,\r\n                 \"/data/genecorpus_filtered_hep/\",\r\n          \
          \       \"/data/genecorpus_filtered_hep/delete_cell/\",\r\n            \
          \     \"delete_cell_HNF4A\")\r\n```\r\n```\r\nFilter (num_proc=16): 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 12775/12775 [00:13<00:00,\
          \ 981.99 examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3000/3000\
          \ [00:12<00:00, 231.00 examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3000/3000\
          \ [00:00<00:00, 8204.96 examples/s]\r\nTraceback (most recent call last):\
          \                                                                      \
          \              \r\n  File \"<stdin>\", line 1, in <module>             \
          \                                                                    \r\n\
          \  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 974, in perturb_data    \r\n    self.in_silico_perturb(model,   \
          \                                                                      \
          \            \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1052, in in_silico_pertu\r\nrb                                  \
          \                                                                      \
          \            \r\n    cos_sims_data = quant_cos_sims(model,             \
          \                                                                \r\n  File\
          \ \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 411, in quant_cos_sims  \r\n    attention_mask = gen_attention_mask(original_minibatch,\
          \ original_max_len)                                         \r\nUnboundLocalError:\
          \ local variable 'original_max_len' referenced before assignment       \
          \                              \r\n```\r\n\r\nWhen I change `max_ncells=30`\
          \ and keep `forward_batch_size=30`, I receive a new error (see below). I'm\
          \ unsure of whether these 2 errors are related but I thought I'd post both\
          \ anyways. I've had previous success running the code with these parameters\
          \ on Aug 31, 2023 so it may be due to changes implemented after that date?\r\
          \n```\r\nFilter (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588| 12775/12775 [00:12<00:00, 986.85 examples/s]\r\nMap\
          \ (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:13<00:00,\
          \  2.30 examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588| 30/30 [00:00<00:00, 172.79 examples/s]\r\nMap (num_proc=16): 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588| 30/30 [00:00<00:00, 170.27 examples/s]\r\
          \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:00<00:00,\
          \ 177.20 examples/s]\r\nTraceback (most recent call last):             \
          \                                                                      \
          \ \r\n  File \"<stdin>\", line 1, in <module>                          \
          \                                                       \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 974, in perturb_data    \r\n    self.in_silico_perturb(model,   \
          \                                                                      \
          \            \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1052, in in_silico_pertu\r\nrb                                  \
          \                                                                      \
          \            \r\n    cos_sims_data = quant_cos_sims(model,             \
          \                                                                \r\n  File\
          \ \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 444, in quant_cos_sims  \r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]                                                  \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 1501, in _call_impl            \r\n    return forward_call(*args,\
          \ **kwargs)                                                            \
          \                  \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 87, in forward               \r\n    return F.cosine_similarity(x1,\
          \ x2, self.dim, self.eps)                                              \
          \              \r\nRuntimeError: The size of tensor a (2047) must match\
          \ the size of tensor b (2046) at non-singleton dimension 1         \r\n\
          ```"
        updatedAt: '2023-09-05T17:26:02.096Z'
      numEdits: 0
      reactions: []
    id: 64f764aa886c925e536cb91e
    type: comment
  author: junguyen
  content: "Hello,\r\n\r\nSeems I'm facing the same error described in Discussion\
    \ #182; however, pulling the latest version of Geneformer did not fix this issue:\r\
    \n\r\n```\r\ngc.collect()\r\ntorch.cuda.empty_cache()\r\nisp = InSilicoPerturber(perturb_type=\"\
    delete\",\r\n                        perturb_rank_shift=None,\r\n            \
    \            # HNF4A: ENSG00000101076\r\n                        genes_to_perturb=[\"\
    ENSG00000101076\"],\r\n                        combos=0,\r\n                 \
    \       anchor_gene=None,\r\n                        model_type=\"Pretrained\"\
    ,\r\n                        num_classes=0,\r\n                        emb_mode=\"\
    cell\",\r\n                        cell_emb_style=\"mean_pool\",\r\n         \
    \               filter_data=None,\r\n                        cell_states_to_model=None,\r\
    \n                        max_ncells=10,\r\n                        emb_layer=-1,\r\
    \n                        forward_batch_size=10,\r\n                        nproc=16,\r\
    \n                        token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
    )\r\n\r\n# Perturb data\r\nisp.perturb_data(\"/home/ubuntu/Geneformer/\",\r\n\
    \                 \"/data/genecorpus_filtered_hep/\",\r\n                 \"/data/genecorpus_filtered_hep/delete_cell/\"\
    ,\r\n                 \"delete_cell_HNF4A\")\r\n```\r\n```\r\nFilter (num_proc=16):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 12775/12775 [00:13<00:00, 981.99 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588| 3000/3000 [00:12<00:00, 231.00 examples/s]\r\nMap (num_proc=16):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 3000/3000\
    \ [00:00<00:00, 8204.96 examples/s]\r\nTraceback (most recent call last):    \
    \                                                                            \
    \    \r\n  File \"<stdin>\", line 1, in <module>                             \
    \                                                    \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 974, in perturb_data    \r\n    self.in_silico_perturb(model,         \
    \                                                                            \r\
    \n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 1052, in in_silico_pertu\r\nrb                                        \
    \                                                                            \r\
    \n    cos_sims_data = quant_cos_sims(model,                                  \
    \                                           \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 411, in quant_cos_sims  \r\n    attention_mask = gen_attention_mask(original_minibatch,\
    \ original_max_len)                                         \r\nUnboundLocalError:\
    \ local variable 'original_max_len' referenced before assignment             \
    \                        \r\n```\r\n\r\nWhen I change `max_ncells=30` and keep\
    \ `forward_batch_size=30`, I receive a new error (see below). I'm unsure of whether\
    \ these 2 errors are related but I thought I'd post both anyways. I've had previous\
    \ success running the code with these parameters on Aug 31, 2023 so it may be\
    \ due to changes implemented after that date?\r\n```\r\nFilter (num_proc=16):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 12775/12775 [00:12<00:00, 986.85 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:13<00:00,  2.30 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:00<00:00, 172.79 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:00<00:00, 170.27 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588| 30/30 [00:00<00:00, 177.20 examples/s]\r\
    \nTraceback (most recent call last):                                         \
    \                                           \r\n  File \"<stdin>\", line 1, in\
    \ <module>                                                                   \
    \              \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 974, in perturb_data    \r\n    self.in_silico_perturb(model,         \
    \                                                                            \r\
    \n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 1052, in in_silico_pertu\r\nrb                                        \
    \                                                                            \r\
    \n    cos_sims_data = quant_cos_sims(model,                                  \
    \                                           \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 444, in quant_cos_sims  \r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
    cpu\")]                                                  \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
    , line 1501, in _call_impl            \r\n    return forward_call(*args, **kwargs)\
    \                                                                            \
    \  \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
    , line 87, in forward               \r\n    return F.cosine_similarity(x1, x2,\
    \ self.dim, self.eps)                                                        \
    \    \r\nRuntimeError: The size of tensor a (2047) must match the size of tensor\
    \ b (2046) at non-singleton dimension 1         \r\n```"
  created_at: 2023-09-05 16:26:02+00:00
  edited: false
  hidden: false
  id: 64f764aa886c925e536cb91e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
      fullname: Julie Nguyen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: junguyen
      type: user
    createdAt: '2023-09-06T13:22:57.000Z'
    data:
      edited: false
      editors:
      - junguyen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9728760719299316
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
          fullname: Julie Nguyen
          isHf: false
          isPro: false
          name: junguyen
          type: user
        html: '<p>Happy to report that I am no longer receiving these errors today!</p>

          '
        raw: Happy to report that I am no longer receiving these errors today!
        updatedAt: '2023-09-06T13:22:57.316Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64f87d31c3c12b377ca70c27
    id: 64f87d31c3c12b377ca70c25
    type: comment
  author: junguyen
  content: Happy to report that I am no longer receiving these errors today!
  created_at: 2023-09-06 12:22:57+00:00
  edited: false
  hidden: false
  id: 64f87d31c3c12b377ca70c25
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
      fullname: Julie Nguyen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: junguyen
      type: user
    createdAt: '2023-09-06T13:22:57.000Z'
    data:
      status: closed
    id: 64f87d31c3c12b377ca70c27
    type: status-change
  author: junguyen
  created_at: 2023-09-06 12:22:57+00:00
  id: 64f87d31c3c12b377ca70c27
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 240
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: 'in_silico_perturber UnboundLocalError: local variable ''original_max_len''
  referenced before assignment'
