!!python/object:huggingface_hub.community.DiscussionWithDetails
author: giovp
conflicting_files: null
created_at: 2023-07-07 17:53:26+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/6481e089ab49674d438403a5098fa35a.svg
      fullname: Giovanni Palla
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: giovp
      type: user
    createdAt: '2023-07-07T18:53:26.000Z'
    data:
      edited: false
      editors:
      - giovp
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8339892029762268
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/6481e089ab49674d438403a5098fa35a.svg
          fullname: Giovanni Palla
          isHf: false
          isPro: false
          name: giovp
          type: user
        html: '<p>HI,</p>

          <p>while working on <a href="/ctheodoris/Geneformer/discussions/102">#102</a>
          I noticed that the gene count normalization with loom done here:<br><a href="https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L173">https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L173</a></p>

          <p>might result in inconsistent behaviour. </p>

          <p>Specifically, the count matrix is filtered by genes that are found in
          the gene <code>GENE_MEDIAN_FILE</code> here <a href="https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L167">https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L167</a>
          yet the counts are normalized by the total counts computed <strong>before</strong>
          filtering. Furthermore, the gene filtering is silent hence the user might
          now know of this inconsistent behavior. </p>

          <p>I think this can be quite problematic in cases where the number of filtered
          genes is high. </p>

          '
        raw: "HI,\r\n\r\nwhile working on #102 I noticed that the gene count normalization\
          \ with loom done here:\r\nhttps://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L173\r\
          \n\r\nmight result in inconsistent behaviour. \r\n\r\nSpecifically, the\
          \ count matrix is filtered by genes that are found in the gene `GENE_MEDIAN_FILE`\
          \ here https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L167\
          \ yet the counts are normalized by the total counts computed **before**\
          \ filtering. Furthermore, the gene filtering is silent hence the user might\
          \ now know of this inconsistent behavior. \r\n\r\nI think this can be quite\
          \ problematic in cases where the number of filtered genes is high. \r\n"
        updatedAt: '2023-07-07T18:53:26.948Z'
      numEdits: 0
      reactions: []
    id: 64a85f264135aae75f048807
    type: comment
  author: giovp
  content: "HI,\r\n\r\nwhile working on #102 I noticed that the gene count normalization\
    \ with loom done here:\r\nhttps://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L173\r\
    \n\r\nmight result in inconsistent behaviour. \r\n\r\nSpecifically, the count\
    \ matrix is filtered by genes that are found in the gene `GENE_MEDIAN_FILE` here\
    \ https://huggingface.co/ctheodoris/Geneformer/blob/77eb432430e05760c80cc931b0e17844fe18f391/geneformer/tokenizer.py#L167\
    \ yet the counts are normalized by the total counts computed **before** filtering.\
    \ Furthermore, the gene filtering is silent hence the user might now know of this\
    \ inconsistent behavior. \r\n\r\nI think this can be quite problematic in cases\
    \ where the number of filtered genes is high. \r\n"
  created_at: 2023-07-07 17:53:26+00:00
  edited: false
  hidden: false
  id: 64a85f264135aae75f048807
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-07T22:24:53.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9538076519966125
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer and for your pull request!
          We will review the pull request as soon as possible.</p>

          <p>Regarding your question here, it is actually quite important that the
          counts are normalized by total counts <strong>before</strong> filtering.
          The count normalization is done to account for differing sequencing depth
          that can result in variable scaling of the counts for each cell. It would
          be very problematic if the normalization by total counts was done without
          all of the genes being present as this would lead to inconsistency depending
          on the proportion of genes present in the cell that are protein-coding or
          miRNA genes.</p>

          <p>For your question about the filtering of genes, the transcriptome tokenizer
          filters for genes that are within the 25,424 protein-coding or miRNA genes
          that comprise the model vocabulary. These represent all protein-coding and
          miRNA genes present within the ~30 million cells from a broad range of human
          tissues in Genecorpus-30M. We focus on protein-coding and miRNA genes as
          these are likely to have the most relevant effects on the gene networks
          governing cell state. The 25,424 genes that comprise the model vocabulary
          are provided in the token dictionary. If users would like to add new genes
          to the token dictionary, they can certainly do so. There will not be a nonzero
          median normalization factor for these genes since they were not detected
          in any of the ~30 million cells in Genecorpus-30M. Therefore, one could
          choose to add a "neutral" normalization factor based on the provided normalization
          factors (e.g. could choose the median of these factors to represent the
          neutral state). However, it should be noted that these genes would not have
          been pretrained given their absence from the ~30 million cells in Genecorpus-30M.
          In general, the recommended usage would be to use the transcriptome tokenizer
          as provided and filter for genes within the model''s 25,424 protein-coding
          or miRNA gene vocabulary that has been used for pretraining.</p>

          <p>Thank you again for your pull request and we will review it as soon as
          possible!</p>

          '
        raw: 'Thank you for your interest in Geneformer and for your pull request!
          We will review the pull request as soon as possible.


          Regarding your question here, it is actually quite important that the counts
          are normalized by total counts **before** filtering. The count normalization
          is done to account for differing sequencing depth that can result in variable
          scaling of the counts for each cell. It would be very problematic if the
          normalization by total counts was done without all of the genes being present
          as this would lead to inconsistency depending on the proportion of genes
          present in the cell that are protein-coding or miRNA genes.


          For your question about the filtering of genes, the transcriptome tokenizer
          filters for genes that are within the 25,424 protein-coding or miRNA genes
          that comprise the model vocabulary. These represent all protein-coding and
          miRNA genes present within the ~30 million cells from a broad range of human
          tissues in Genecorpus-30M. We focus on protein-coding and miRNA genes as
          these are likely to have the most relevant effects on the gene networks
          governing cell state. The 25,424 genes that comprise the model vocabulary
          are provided in the token dictionary. If users would like to add new genes
          to the token dictionary, they can certainly do so. There will not be a nonzero
          median normalization factor for these genes since they were not detected
          in any of the ~30 million cells in Genecorpus-30M. Therefore, one could
          choose to add a "neutral" normalization factor based on the provided normalization
          factors (e.g. could choose the median of these factors to represent the
          neutral state). However, it should be noted that these genes would not have
          been pretrained given their absence from the ~30 million cells in Genecorpus-30M.
          In general, the recommended usage would be to use the transcriptome tokenizer
          as provided and filter for genes within the model''s 25,424 protein-coding
          or miRNA gene vocabulary that has been used for pretraining.


          Thank you again for your pull request and we will review it as soon as possible!'
        updatedAt: '2023-07-07T22:24:53.904Z'
      numEdits: 0
      reactions: []
      relatedEventId: 64a890b53c201fd38de83167
    id: 64a890b53c201fd38de83166
    type: comment
  author: ctheodoris
  content: 'Thank you for your interest in Geneformer and for your pull request! We
    will review the pull request as soon as possible.


    Regarding your question here, it is actually quite important that the counts are
    normalized by total counts **before** filtering. The count normalization is done
    to account for differing sequencing depth that can result in variable scaling
    of the counts for each cell. It would be very problematic if the normalization
    by total counts was done without all of the genes being present as this would
    lead to inconsistency depending on the proportion of genes present in the cell
    that are protein-coding or miRNA genes.


    For your question about the filtering of genes, the transcriptome tokenizer filters
    for genes that are within the 25,424 protein-coding or miRNA genes that comprise
    the model vocabulary. These represent all protein-coding and miRNA genes present
    within the ~30 million cells from a broad range of human tissues in Genecorpus-30M.
    We focus on protein-coding and miRNA genes as these are likely to have the most
    relevant effects on the gene networks governing cell state. The 25,424 genes that
    comprise the model vocabulary are provided in the token dictionary. If users would
    like to add new genes to the token dictionary, they can certainly do so. There
    will not be a nonzero median normalization factor for these genes since they were
    not detected in any of the ~30 million cells in Genecorpus-30M. Therefore, one
    could choose to add a "neutral" normalization factor based on the provided normalization
    factors (e.g. could choose the median of these factors to represent the neutral
    state). However, it should be noted that these genes would not have been pretrained
    given their absence from the ~30 million cells in Genecorpus-30M. In general,
    the recommended usage would be to use the transcriptome tokenizer as provided
    and filter for genes within the model''s 25,424 protein-coding or miRNA gene vocabulary
    that has been used for pretraining.


    Thank you again for your pull request and we will review it as soon as possible!'
  created_at: 2023-07-07 21:24:53+00:00
  edited: false
  hidden: false
  id: 64a890b53c201fd38de83166
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-07T22:24:53.000Z'
    data:
      status: closed
    id: 64a890b53c201fd38de83167
    type: status-change
  author: ctheodoris
  created_at: 2023-07-07 21:24:53+00:00
  id: 64a890b53c201fd38de83167
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/6481e089ab49674d438403a5098fa35a.svg
      fullname: Giovanni Palla
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: giovp
      type: user
    createdAt: '2023-07-10T14:03:30.000Z'
    data:
      edited: false
      editors:
      - giovp
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9631862640380859
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/6481e089ab49674d438403a5098fa35a.svg
          fullname: Giovanni Palla
          isHf: false
          isPro: false
          name: giovp
          type: user
        html: "<p>thanks a lot <span data-props=\"{&quot;user&quot;:&quot;ctheodoris&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/ctheodoris\"\
          >@<span class=\"underline\">ctheodoris</span></a></span>\n\n\t</span></span>\
          \ for the in depth explanation, it greatly helped me to understand the issue.\
          \ I will have to modify the PR to respect that then.</p>\n"
        raw: thanks a lot @ctheodoris for the in depth explanation, it greatly helped
          me to understand the issue. I will have to modify the PR to respect that
          then.
        updatedAt: '2023-07-10T14:03:30.215Z'
      numEdits: 0
      reactions: []
    id: 64ac0fb2ac13891808823e65
    type: comment
  author: giovp
  content: thanks a lot @ctheodoris for the in depth explanation, it greatly helped
    me to understand the issue. I will have to modify the PR to respect that then.
  created_at: 2023-07-10 13:03:30+00:00
  edited: false
  hidden: false
  id: 64ac0fb2ac13891808823e65
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 103
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: possible source of inconsistency in gene count normalization
