!!python/object:huggingface_hub.community.DiscussionWithDetails
author: junguyen
conflicting_files: null
created_at: 2023-08-07 14:12:58+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
      fullname: Julie Nguyen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: junguyen
      type: user
    createdAt: '2023-08-07T15:12:58.000Z'
    data:
      edited: false
      editors:
      - junguyen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.562526524066925
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ecd4d674b85b6b6038b47181966e7b53.svg
          fullname: Julie Nguyen
          isHf: false
          isPro: false
          name: junguyen
          type: user
        html: "<p>Thank you for making this model available!</p>\n<p>I have had previous\
          \ success running InSilicoPerturber on a subsetted Genecorpus-30M dataset\
          \ composed of ~2700 cells, using the same parameters (I am simply using\
          \ the Genecorpus-30M dataset to test how the InSilicoPerturbation functions\
          \ works). However, after changes were pushed on Aug 2, 2023 to fix the attention\
          \ mask issue, I now receive the following error:</p>\n<pre><code>isp = InSilicoPerturber(perturb_type=\"\
          delete\",\n                        perturb_rank_shift=None,\n          \
          \              genes_to_perturb=[\"ENSG00000135100\"],\n               \
          \         combos=0,\n                        anchor_gene=None,\n       \
          \                 model_type=\"Pretrained\",\n                        num_classes=0,\n\
          \                        emb_mode=\"cell\",\n                        cell_emb_style=\"\
          mean_pool\",\n                        filter_data=None,\n              \
          \          cell_states_to_model=None,\n                        max_ncells=None,\n\
          \                        emb_layer=-1,\n                        forward_batch_size=50,\n\
          \                        nproc=16,\n                        token_dictionary_file\
          \ = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\")\n\nisp.perturb_data(\"\
          /home/ubuntu/Geneformer\",\n                 \"/data/subset_genecorpus/\"\
          ,\n                 \"/data/subset_genecorpus/delete_cell/\",\n        \
          \         \"delete_cell_HNF1A\")\n</code></pre>\n<pre><code>Filter (num_proc=16):\
          \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2741/2741 [00:12&lt;00:00,\
          \ 214.74 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37 [00:12&lt;00:00,\
          \  2.92 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37 [00:00&lt;00:00,\
          \ 159.23 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37 [00:00&lt;00:00,\
          \ 166.24 examples/s]\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37 [00:00&lt;00:00,\
          \ 165.63 examples/s]\nTraceback (most recent call last):               \
          \                             \n  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;\
          \                                         \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 974, \nin perturb_data                                          \
          \                     \n    self.in_silico_perturb(model,              \
          \                               \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 1052,\n in in_silico_perturb                                    \
          \                     \n    cos_sims_data = quant_cos_sims(model,      \
          \                               \n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 444, \nin quant_cos_sims                                        \
          \                     \n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]          \n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.p\n\
          y\", line 1501, in _call_impl                                          \
          \        \n    return forward_call(*args, **kwargs)                    \
          \                  \n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance\n\
          .py\", line 87, in forward                                             \
          \        \n    return F.cosine_similarity(x1, x2, self.dim, self.eps)  \
          \                  \nRuntimeError: The size of tensor a (2047) must match\
          \ the size of tensor b (204\n6) at non-singleton dimension 1           \
          \                                    \n</code></pre>\n<p>I've referenced\
          \ Discussion <a href=\"/ctheodoris/Geneformer/discussions/85\">#85</a> to\
          \ help with this issue; however changing the batch<br>size to 200 still\
          \ raises the same error. I also have the latest version of Geneformer pulled.</p>\n\
          <p>Could I get some help with why this error is now raising? Thank you!</p>\n"
        raw: "Thank you for making this model available!\r\n\r\nI have had previous\
          \ success running InSilicoPerturber on a subsetted Genecorpus-30M dataset\
          \ composed of ~2700 cells, using the same parameters (I am simply using\
          \ the Genecorpus-30M dataset to test how the InSilicoPerturbation functions\
          \ works). However, after changes were pushed on Aug 2, 2023 to fix the attention\
          \ mask issue, I now receive the following error:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"\
          delete\",\r\n                        perturb_rank_shift=None,\r\n      \
          \                  genes_to_perturb=[\"ENSG00000135100\"],\r\n         \
          \               combos=0,\r\n                        anchor_gene=None,\r\
          \n                        model_type=\"Pretrained\",\r\n               \
          \         num_classes=0,\r\n                        emb_mode=\"cell\",\r\
          \n                        cell_emb_style=\"mean_pool\",\r\n            \
          \            filter_data=None,\r\n                        cell_states_to_model=None,\r\
          \n                        max_ncells=None,\r\n                        emb_layer=-1,\r\
          \n                        forward_batch_size=50,\r\n                   \
          \     nproc=16,\r\n                        token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
          )\r\n\r\nisp.perturb_data(\"/home/ubuntu/Geneformer\",\r\n             \
          \    \"/data/subset_genecorpus/\",\r\n                 \"/data/subset_genecorpus/delete_cell/\"\
          ,\r\n                 \"delete_cell_HNF1A\")\r\n```\r\n```\r\nFilter (num_proc=16):\
          \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2741/2741 [00:12<00:00,\
          \ 214.74 examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37\
          \ [00:12<00:00,  2.92 examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          | 37/37 [00:00<00:00, 159.23 examples/s]\r\nMap (num_proc=16): 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588| 37/37 [00:00<00:00, 166.24 examples/s]\r\nMap (num_proc=16): 100%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588| 37/37 [00:00<00:00, 165.63 examples/s]\r\nTraceback (most recent\
          \ call last):                                            \r\n  File \"<stdin>\"\
          , line 1, in <module>                                         \r\n  File\
          \ \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\", line 974,\
          \ \r\nin perturb_data                                                  \
          \             \r\n    self.in_silico_perturb(model,                    \
          \                         \r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 1052,\r\n in in_silico_perturb                                  \
          \                       \r\n    cos_sims_data = quant_cos_sims(model,  \
          \                                   \r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 444, \r\nin quant_cos_sims                                      \
          \                       \r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]          \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.p\r\
          \ny\", line 1501, in _call_impl                                        \
          \          \r\n    return forward_call(*args, **kwargs)                \
          \                      \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance\r\
          \n.py\", line 87, in forward                                           \
          \          \r\n    return F.cosine_similarity(x1, x2, self.dim, self.eps)\
          \                    \r\nRuntimeError: The size of tensor a (2047) must\
          \ match the size of tensor b (204\r\n6) at non-singleton dimension 1   \
          \                                            \r\n```\r\nI've referenced\
          \ Discussion #85 to help with this issue; however changing the batch\r\n\
          size to 200 still raises the same error. I also have the latest version\
          \ of Geneformer pulled.\r\n\r\nCould I get some help with why this error\
          \ is now raising? Thank you!"
        updatedAt: '2023-08-07T15:12:58.801Z'
      numEdits: 0
      reactions: []
    id: 64d109fa7e20ec9ea0e70064
    type: comment
  author: junguyen
  content: "Thank you for making this model available!\r\n\r\nI have had previous\
    \ success running InSilicoPerturber on a subsetted Genecorpus-30M dataset composed\
    \ of ~2700 cells, using the same parameters (I am simply using the Genecorpus-30M\
    \ dataset to test how the InSilicoPerturbation functions works). However, after\
    \ changes were pushed on Aug 2, 2023 to fix the attention mask issue, I now receive\
    \ the following error:\r\n\r\n```\r\nisp = InSilicoPerturber(perturb_type=\"delete\"\
    ,\r\n                        perturb_rank_shift=None,\r\n                    \
    \    genes_to_perturb=[\"ENSG00000135100\"],\r\n                        combos=0,\r\
    \n                        anchor_gene=None,\r\n                        model_type=\"\
    Pretrained\",\r\n                        num_classes=0,\r\n                  \
    \      emb_mode=\"cell\",\r\n                        cell_emb_style=\"mean_pool\"\
    ,\r\n                        filter_data=None,\r\n                        cell_states_to_model=None,\r\
    \n                        max_ncells=None,\r\n                        emb_layer=-1,\r\
    \n                        forward_batch_size=50,\r\n                        nproc=16,\r\
    \n                        token_dictionary_file = \"/home/ubuntu/Geneformer/geneformer/token_dictionary.pkl\"\
    )\r\n\r\nisp.perturb_data(\"/home/ubuntu/Geneformer\",\r\n                 \"\
    /data/subset_genecorpus/\",\r\n                 \"/data/subset_genecorpus/delete_cell/\"\
    ,\r\n                 \"delete_cell_HNF1A\")\r\n```\r\n```\r\nFilter (num_proc=16):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 2741/2741 [00:12<00:00, 214.74\
    \ examples/s]\r\nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 37/37 [00:12<00:00,  2.92 examples/s]\r\
    \nMap (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u2588| 37/37 [00:00<00:00, 159.23 examples/s]\r\nMap\
    \ (num_proc=16): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588| 37/37 [00:00<00:00, 166.24 examples/s]\r\nMap (num_proc=16):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588| 37/37 [00:00<00:00, 165.63 examples/s]\r\nTraceback (most recent\
    \ call last):                                            \r\n  File \"<stdin>\"\
    , line 1, in <module>                                         \r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
    , line 974, \r\nin perturb_data                                              \
    \                 \r\n    self.in_silico_perturb(model,                      \
    \                       \r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
    , line 1052,\r\n in in_silico_perturb                                        \
    \                 \r\n    cos_sims_data = quant_cos_sims(model,              \
    \                       \r\n  File \"/home/ubuntu/Geneformer/geneformer/in_silico_perturber.py\"\
    , line 444, \r\nin quant_cos_sims                                            \
    \                 \r\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
    cpu\")]          \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/module.p\r\
    \ny\", line 1501, in _call_impl                                              \
    \    \r\n    return forward_call(*args, **kwargs)                            \
    \          \r\n  File \"/opt/tensorflow/lib/python3.10/site-packages/torch/nn/modules/distance\r\
    \n.py\", line 87, in forward                                                 \
    \    \r\n    return F.cosine_similarity(x1, x2, self.dim, self.eps)          \
    \          \r\nRuntimeError: The size of tensor a (2047) must match the size of\
    \ tensor b (204\r\n6) at non-singleton dimension 1                           \
    \                    \r\n```\r\nI've referenced Discussion #85 to help with this\
    \ issue; however changing the batch\r\nsize to 200 still raises the same error.\
    \ I also have the latest version of Geneformer pulled.\r\n\r\nCould I get some\
    \ help with why this error is now raising? Thank you!"
  created_at: 2023-08-07 14:12:58+00:00
  edited: false
  hidden: false
  id: 64d109fa7e20ec9ea0e70064
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/bba642fd0a83520934d4fd028d256526.svg
      fullname: David Wen
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: davidjwen
      type: user
    createdAt: '2023-08-07T18:32:22.000Z'
    data:
      edited: false
      editors:
      - davidjwen
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9471056461334229
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/bba642fd0a83520934d4fd028d256526.svg
          fullname: David Wen
          isHf: false
          isPro: false
          name: davidjwen
          type: user
        html: '<p>Hi there, thanks for bringing this issue up! We''ve just updated
          the code to address the issue. Thanks for your interest!</p>

          '
        raw: Hi there, thanks for bringing this issue up! We've just updated the code
          to address the issue. Thanks for your interest!
        updatedAt: '2023-08-07T18:32:22.401Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F91D"
        users:
        - junguyen
    id: 64d138b62f1f9578a056e31d
    type: comment
  author: davidjwen
  content: Hi there, thanks for bringing this issue up! We've just updated the code
    to address the issue. Thanks for your interest!
  created_at: 2023-08-07 17:32:22+00:00
  edited: false
  hidden: false
  id: 64d138b62f1f9578a056e31d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-08-07T23:33:27.000Z'
    data:
      status: closed
    id: 64d17f47d1fda042b59a19e3
    type: status-change
  author: ctheodoris
  created_at: 2023-08-07 22:33:27+00:00
  id: 64d17f47d1fda042b59a19e3
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 184
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Size of tensor a does not match size of tensor b in InSilicoPerturbation
