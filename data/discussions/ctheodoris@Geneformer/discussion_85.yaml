!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Akutagawaluyifei
conflicting_files: null
created_at: 2023-07-04 04:08:08+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
      fullname: LUYIFEI
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Akutagawaluyifei
      type: user
    createdAt: '2023-07-04T05:08:08.000Z'
    data:
      edited: false
      editors:
      - Akutagawaluyifei
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.4510810077190399
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
          fullname: LUYIFEI
          isHf: false
          isPro: false
          name: Akutagawaluyifei
          type: user
        html: "<p>Thank you this amazing model!<br>When I was running in silicon perturbation\
          \ on a sampled dataset (2000 cells) of my own, I encountered an error concerning\
          \ sizes of tensors.</p>\n<p><code>RuntimeError: Sizes of tensors must match\
          \ except in dimension 0. Expected size 1 but got size 1980 for tensor number\
          \ 220 in the list.</code><br>My code shows as follows:</p>\n<pre><code>RT\
          \ = InSilicoPerturber(perturb_type=\"delete\",\n                      perturb_rank_shift=None,\n\
          \                      genes_to_perturb=\"all\",\n                     \
          \ combos=0,\n                      anchor_gene=None,\n                 \
          \     model_type=\"Pretrained\",\n                      emb_mode=\"cell_and_gene\"\
          ,\n                      cell_emb_style=\"mean_pool\",\n               \
          \       filter_data={\"Celltype_2\":[\"5\",\"3\",\"2\"]},\n            \
          \          cell_states_to_model={\"Celltype_2\":([\"5\"],[\"3\"],[\"2\"\
          ])},\n                      emb_layer=-1,\n                      forward_batch_size=10,\n\
          \                      nproc=10,\n                      save_raw_data=True)\n\
          RT.perturb_data(\"/cluster/home/yflu/Geneformer/\",\n               \"/cluster/home/yflu/Geneformer/tokenized/20230704_01.dataset\"\
          ,\n               \"/cluster/home/yflu/Geneformer/perturb/\",\n        \
          \       \"20230704_sample10_new.RT\")\n</code></pre>\n<p>The log before\
          \ this error shows:</p>\n<pre><code>\nMap (num_proc=10):   0%|         \
          \ | 0/1983 [00:00&lt;?, ? examples/s]\e[A\n\nMap (num_proc=10):   3%|\u258E\
          \         | 50/1983 [00:00&lt;00:08, 229.35 examples/s]\e[A\n\nMap (num_proc=10):\
          \  13%|\u2588\u258E        | 249/1983 [00:00&lt;00:02, 848.41 examples/s]\e\
          [A\n\nMap (num_proc=10):  27%|\u2588\u2588\u258B       | 531/1983 [00:00&lt;00:01,\
          \ 1445.16 examples/s]\e[A\n\nMap (num_proc=10):  48%|\u2588\u2588\u2588\u2588\
          \u258A     | 953/1983 [00:00&lt;00:00, 2299.78 examples/s]\e[A\n\nMap (num_proc=10):\
          \  74%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258D  | 1470/1983 [00:00&lt;00:00,\
          \ 3064.60 examples/s]\e[A\n\nMap (num_proc=10):  92%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u258F| 1834/1983 [00:00&lt;00:00, 2976.65\
          \ examples/s]\e[A\n\n                                                  \
          \                             \e[A\n\nMap (num_proc=10):   0%|         \
          \ | 0/1981 [00:00&lt;?, ? examples/s]\e[A\n\nMap (num_proc=10):   3%|\u258E\
          \         | 54/1981 [00:00&lt;00:07, 253.86 examples/s]\e[A\n\nMap (num_proc=10):\
          \  10%|\u2589         | 194/1981 [00:00&lt;00:02, 700.13 examples/s]\e[A\n\
          \nMap (num_proc=10):  30%|\u2588\u2588\u2589       | 593/1981 [00:00&lt;00:00,\
          \ 1763.90 examples/s]\e[A\n\nMap (num_proc=10):  47%|\u2588\u2588\u2588\u2588\
          \u258B     | 933/1981 [00:00&lt;00:00, 2177.79 examples/s]\e[A\n\nMap (num_proc=10):\
          \  69%|\u2588\u2588\u2588\u2588\u2588\u2588\u2589   | 1369/1981 [00:00&lt;00:00,\
          \ 2761.15 examples/s]\e[A\n\nMap (num_proc=10):  87%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u258B | 1730/1981 [00:00&lt;00:00, 2952.12 examples/s]\e\
          [A\n\nTraceback (most recent call last):\n  File \"/cluster/home/yflu/Geneformer/Perturber_10.py\"\
          , line 45, in &lt;module&gt;\n    RT.perturb_data(\"/cluster/home/yflu/Geneformer\"\
          ,\n  File \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 563, in perturb_data\n    self.in_silico_perturb(model,\n  File \"\
          /cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\", line\
          \ 661, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\n\
          \  File \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 266, in quant_cos_sims\n    cos_sims_vs_alt_dict[state] = torch.cat(cos_sims_vs_alt_dict[state])\n\
          RuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 1 but got size 1980 for tensor number 220 in the list.\n</code></pre>\n\
          <p>The code was running fine for 10+ hours before this error, and if I reduce\
          \ the sampled dataset to the size of 1% (200 cells) of the original dataset,\
          \ this error doesn't show up. </p>\n"
        raw: "Thank you this amazing model! \r\nWhen I was running in silicon perturbation\
          \ on a sampled dataset (2000 cells) of my own, I encountered an error concerning\
          \ sizes of tensors.\r\n\r\n`\r\nRuntimeError: Sizes of tensors must match\
          \ except in dimension 0. Expected size 1 but got size 1980 for tensor number\
          \ 220 in the list.\r\n`\r\nMy code shows as follows:\r\n```\r\nRT = InSilicoPerturber(perturb_type=\"\
          delete\",\r\n                      perturb_rank_shift=None,\r\n        \
          \              genes_to_perturb=\"all\",\r\n                      combos=0,\r\
          \n                      anchor_gene=None,\r\n                      model_type=\"\
          Pretrained\",\r\n                      emb_mode=\"cell_and_gene\",\r\n \
          \                     cell_emb_style=\"mean_pool\",\r\n                \
          \      filter_data={\"Celltype_2\":[\"5\",\"3\",\"2\"]},\r\n           \
          \           cell_states_to_model={\"Celltype_2\":([\"5\"],[\"3\"],[\"2\"\
          ])},\r\n                      emb_layer=-1,\r\n                      forward_batch_size=10,\r\
          \n                      nproc=10,\r\n                      save_raw_data=True)\r\
          \nRT.perturb_data(\"/cluster/home/yflu/Geneformer/\",\r\n              \
          \ \"/cluster/home/yflu/Geneformer/tokenized/20230704_01.dataset\",\r\n \
          \              \"/cluster/home/yflu/Geneformer/perturb/\",\r\n         \
          \      \"20230704_sample10_new.RT\")\r\n```\r\nThe log before this error\
          \ shows:\r\n```\r\n\r\nMap (num_proc=10):   0%|          | 0/1983 [00:00<?,\
          \ ? examples/s]\e[A\r\n\r\nMap (num_proc=10):   3%|\u258E         | 50/1983\
          \ [00:00<00:08, 229.35 examples/s]\e[A\r\n\r\nMap (num_proc=10):  13%|\u2588\
          \u258E        | 249/1983 [00:00<00:02, 848.41 examples/s]\e[A\r\n\r\nMap\
          \ (num_proc=10):  27%|\u2588\u2588\u258B       | 531/1983 [00:00<00:01,\
          \ 1445.16 examples/s]\e[A\r\n\r\nMap (num_proc=10):  48%|\u2588\u2588\u2588\
          \u2588\u258A     | 953/1983 [00:00<00:00, 2299.78 examples/s]\e[A\r\n\r\n\
          Map (num_proc=10):  74%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258D\
          \  | 1470/1983 [00:00<00:00, 3064.60 examples/s]\e[A\r\n\r\nMap (num_proc=10):\
          \  92%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258F| 1834/1983\
          \ [00:00<00:00, 2976.65 examples/s]\e[A\r\n\r\n                        \
          \                                                       \e[A\r\n\r\nMap\
          \ (num_proc=10):   0%|          | 0/1981 [00:00<?, ? examples/s]\e[A\r\n\
          \r\nMap (num_proc=10):   3%|\u258E         | 54/1981 [00:00<00:07, 253.86\
          \ examples/s]\e[A\r\n\r\nMap (num_proc=10):  10%|\u2589         | 194/1981\
          \ [00:00<00:02, 700.13 examples/s]\e[A\r\n\r\nMap (num_proc=10):  30%|\u2588\
          \u2588\u2589       | 593/1981 [00:00<00:00, 1763.90 examples/s]\e[A\r\n\r\
          \nMap (num_proc=10):  47%|\u2588\u2588\u2588\u2588\u258B     | 933/1981\
          \ [00:00<00:00, 2177.79 examples/s]\e[A\r\n\r\nMap (num_proc=10):  69%|\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2589   | 1369/1981 [00:00<00:00, 2761.15\
          \ examples/s]\e[A\r\n\r\nMap (num_proc=10):  87%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u258B | 1730/1981 [00:00<00:00, 2952.12 examples/s]\e\
          [A\r\n\r\nTraceback (most recent call last):\r\n  File \"/cluster/home/yflu/Geneformer/Perturber_10.py\"\
          , line 45, in <module>\r\n    RT.perturb_data(\"/cluster/home/yflu/Geneformer\"\
          ,\r\n  File \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 563, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File\
          \ \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\", line\
          \ 661, in in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\r\
          \n  File \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\"\
          , line 266, in quant_cos_sims\r\n    cos_sims_vs_alt_dict[state] = torch.cat(cos_sims_vs_alt_dict[state])\r\
          \nRuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 1 but got size 1980 for tensor number 220 in the list.\r\n```\r\n\
          The code was running fine for 10+ hours before this error, and if I reduce\
          \ the sampled dataset to the size of 1% (200 cells) of the original dataset,\
          \ this error doesn't show up. "
        updatedAt: '2023-07-04T05:08:08.126Z'
      numEdits: 0
      reactions: []
    id: 64a3a938565496b62986f3be
    type: comment
  author: Akutagawaluyifei
  content: "Thank you this amazing model! \r\nWhen I was running in silicon perturbation\
    \ on a sampled dataset (2000 cells) of my own, I encountered an error concerning\
    \ sizes of tensors.\r\n\r\n`\r\nRuntimeError: Sizes of tensors must match except\
    \ in dimension 0. Expected size 1 but got size 1980 for tensor number 220 in the\
    \ list.\r\n`\r\nMy code shows as follows:\r\n```\r\nRT = InSilicoPerturber(perturb_type=\"\
    delete\",\r\n                      perturb_rank_shift=None,\r\n              \
    \        genes_to_perturb=\"all\",\r\n                      combos=0,\r\n    \
    \                  anchor_gene=None,\r\n                      model_type=\"Pretrained\"\
    ,\r\n                      emb_mode=\"cell_and_gene\",\r\n                   \
    \   cell_emb_style=\"mean_pool\",\r\n                      filter_data={\"Celltype_2\"\
    :[\"5\",\"3\",\"2\"]},\r\n                      cell_states_to_model={\"Celltype_2\"\
    :([\"5\"],[\"3\"],[\"2\"])},\r\n                      emb_layer=-1,\r\n      \
    \                forward_batch_size=10,\r\n                      nproc=10,\r\n\
    \                      save_raw_data=True)\r\nRT.perturb_data(\"/cluster/home/yflu/Geneformer/\"\
    ,\r\n               \"/cluster/home/yflu/Geneformer/tokenized/20230704_01.dataset\"\
    ,\r\n               \"/cluster/home/yflu/Geneformer/perturb/\",\r\n          \
    \     \"20230704_sample10_new.RT\")\r\n```\r\nThe log before this error shows:\r\
    \n```\r\n\r\nMap (num_proc=10):   0%|          | 0/1983 [00:00<?, ? examples/s]\e\
    [A\r\n\r\nMap (num_proc=10):   3%|\u258E         | 50/1983 [00:00<00:08, 229.35\
    \ examples/s]\e[A\r\n\r\nMap (num_proc=10):  13%|\u2588\u258E        | 249/1983\
    \ [00:00<00:02, 848.41 examples/s]\e[A\r\n\r\nMap (num_proc=10):  27%|\u2588\u2588\
    \u258B       | 531/1983 [00:00<00:01, 1445.16 examples/s]\e[A\r\n\r\nMap (num_proc=10):\
    \  48%|\u2588\u2588\u2588\u2588\u258A     | 953/1983 [00:00<00:00, 2299.78 examples/s]\e\
    [A\r\n\r\nMap (num_proc=10):  74%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258D\
    \  | 1470/1983 [00:00<00:00, 3064.60 examples/s]\e[A\r\n\r\nMap (num_proc=10):\
    \  92%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u258F| 1834/1983\
    \ [00:00<00:00, 2976.65 examples/s]\e[A\r\n\r\n                              \
    \                                                 \e[A\r\n\r\nMap (num_proc=10):\
    \   0%|          | 0/1981 [00:00<?, ? examples/s]\e[A\r\n\r\nMap (num_proc=10):\
    \   3%|\u258E         | 54/1981 [00:00<00:07, 253.86 examples/s]\e[A\r\n\r\nMap\
    \ (num_proc=10):  10%|\u2589         | 194/1981 [00:00<00:02, 700.13 examples/s]\e\
    [A\r\n\r\nMap (num_proc=10):  30%|\u2588\u2588\u2589       | 593/1981 [00:00<00:00,\
    \ 1763.90 examples/s]\e[A\r\n\r\nMap (num_proc=10):  47%|\u2588\u2588\u2588\u2588\
    \u258B     | 933/1981 [00:00<00:00, 2177.79 examples/s]\e[A\r\n\r\nMap (num_proc=10):\
    \  69%|\u2588\u2588\u2588\u2588\u2588\u2588\u2589   | 1369/1981 [00:00<00:00,\
    \ 2761.15 examples/s]\e[A\r\n\r\nMap (num_proc=10):  87%|\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u2588\u258B | 1730/1981 [00:00<00:00, 2952.12 examples/s]\e\
    [A\r\n\r\nTraceback (most recent call last):\r\n  File \"/cluster/home/yflu/Geneformer/Perturber_10.py\"\
    , line 45, in <module>\r\n    RT.perturb_data(\"/cluster/home/yflu/Geneformer\"\
    ,\r\n  File \"/cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\"\
    , line 563, in perturb_data\r\n    self.in_silico_perturb(model,\r\n  File \"\
    /cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\", line 661, in\
    \ in_silico_perturb\r\n    cos_sims_data = quant_cos_sims(model,\r\n  File \"\
    /cluster/home/yflu/Geneformer/geneformer/in_silico_perturber.py\", line 266, in\
    \ quant_cos_sims\r\n    cos_sims_vs_alt_dict[state] = torch.cat(cos_sims_vs_alt_dict[state])\r\
    \nRuntimeError: Sizes of tensors must match except in dimension 0. Expected size\
    \ 1 but got size 1980 for tensor number 220 in the list.\r\n```\r\nThe code was\
    \ running fine for 10+ hours before this error, and if I reduce the sampled dataset\
    \ to the size of 1% (200 cells) of the original dataset, this error doesn't show\
    \ up. "
  created_at: 2023-07-04 04:08:08+00:00
  edited: false
  hidden: false
  id: 64a3a938565496b62986f3be
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-04T06:36:19.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9685750603675842
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer! Please confirm that you
          have pulled the current version for both the modules and example notebooks
          and that the module is running from the correct directory and not an outdated
          directory because there was a prior tensor issue that I updated the repository
          to resolve so I want to make sure it isn''t related to that. This seems
          like it''s probably different though because the expected size indicates
          1 in your error message, which may suggest that the results were trying
          to concatenate cell embeddings and gene embeddings, leading to the different
          sizes. One reason I am thinking this may be the case is because usually
          we run the mode of cell_states_to_model with "cell" as the emb_mode rather
          than "cell_and_gene" since that is more relevant to modeling cell state
          shifts. However, I am not sure why it is not showing up until you are more
          than 200 cells through your dataset. Can you investigate if there is anything
          unexpected about the cell the error occurs at? The model saves output as
          it goes in case there is an error so you should have at least some of your
          data saved. We expect batch sizes of 200-400 so if you are using batch sizes
          much smaller due to resource limitations, you may want to change the code
          to save more frequently since it will take longer to run. I would suggest
          you run the analysis with "cell" as the emb_mode as this is more relevant
          to modeling the change between cell states; this will also likely run faster
          considering your code seems to be taking a long time to run with the very
          low batch size. The model sorts the cells by size so the ones with the most
          genes detected will be run first to encounter memory limitations earlier
          rather than later. Since you already ran many of your cells, you can start
          after the last saved cell in the data that was already saved, and you may
          be able to run larger batch sizes if the size of the cells at that point
          forward are smaller. If you still encounter the error despite the above,
          please email me your dataset so I can reproduce the error and investigate
          it further.</p>

          '
        raw: Thank you for your interest in Geneformer! Please confirm that you have
          pulled the current version for both the modules and example notebooks and
          that the module is running from the correct directory and not an outdated
          directory because there was a prior tensor issue that I updated the repository
          to resolve so I want to make sure it isn't related to that. This seems like
          it's probably different though because the expected size indicates 1 in
          your error message, which may suggest that the results were trying to concatenate
          cell embeddings and gene embeddings, leading to the different sizes. One
          reason I am thinking this may be the case is because usually we run the
          mode of cell_states_to_model with "cell" as the emb_mode rather than "cell_and_gene"
          since that is more relevant to modeling cell state shifts. However, I am
          not sure why it is not showing up until you are more than 200 cells through
          your dataset. Can you investigate if there is anything unexpected about
          the cell the error occurs at? The model saves output as it goes in case
          there is an error so you should have at least some of your data saved. We
          expect batch sizes of 200-400 so if you are using batch sizes much smaller
          due to resource limitations, you may want to change the code to save more
          frequently since it will take longer to run. I would suggest you run the
          analysis with "cell" as the emb_mode as this is more relevant to modeling
          the change between cell states; this will also likely run faster considering
          your code seems to be taking a long time to run with the very low batch
          size. The model sorts the cells by size so the ones with the most genes
          detected will be run first to encounter memory limitations earlier rather
          than later. Since you already ran many of your cells, you can start after
          the last saved cell in the data that was already saved, and you may be able
          to run larger batch sizes if the size of the cells at that point forward
          are smaller. If you still encounter the error despite the above, please
          email me your dataset so I can reproduce the error and investigate it further.
        updatedAt: '2023-07-04T06:36:19.791Z'
      numEdits: 0
      reactions: []
    id: 64a3bde30111d5ff6c42af06
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer! Please confirm that you have
    pulled the current version for both the modules and example notebooks and that
    the module is running from the correct directory and not an outdated directory
    because there was a prior tensor issue that I updated the repository to resolve
    so I want to make sure it isn't related to that. This seems like it's probably
    different though because the expected size indicates 1 in your error message,
    which may suggest that the results were trying to concatenate cell embeddings
    and gene embeddings, leading to the different sizes. One reason I am thinking
    this may be the case is because usually we run the mode of cell_states_to_model
    with "cell" as the emb_mode rather than "cell_and_gene" since that is more relevant
    to modeling cell state shifts. However, I am not sure why it is not showing up
    until you are more than 200 cells through your dataset. Can you investigate if
    there is anything unexpected about the cell the error occurs at? The model saves
    output as it goes in case there is an error so you should have at least some of
    your data saved. We expect batch sizes of 200-400 so if you are using batch sizes
    much smaller due to resource limitations, you may want to change the code to save
    more frequently since it will take longer to run. I would suggest you run the
    analysis with "cell" as the emb_mode as this is more relevant to modeling the
    change between cell states; this will also likely run faster considering your
    code seems to be taking a long time to run with the very low batch size. The model
    sorts the cells by size so the ones with the most genes detected will be run first
    to encounter memory limitations earlier rather than later. Since you already ran
    many of your cells, you can start after the last saved cell in the data that was
    already saved, and you may be able to run larger batch sizes if the size of the
    cells at that point forward are smaller. If you still encounter the error despite
    the above, please email me your dataset so I can reproduce the error and investigate
    it further.
  created_at: 2023-07-04 05:36:19+00:00
  edited: false
  hidden: false
  id: 64a3bde30111d5ff6c42af06
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-07T23:27:43.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8857446312904358
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;Renqing&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/Renqing\">@<span class=\"\
          underline\">Renqing</span></a></span>\n\n\t</span></span>  Thank you for\
          \ the discussion regarding your similar issue. Please check the open and\
          \ closed discussions before starting a new discussion so that all the information\
          \ is one place for future users who have the same question. Please post\
          \ here the last isp options you tried where the error occurred despite changing\
          \ \"genes_to_perturb\" to \"all\". Please make sure that all code is posted\
          \ as text and not a screenshot. You can use Markdown syntax to insert code\
          \ blocks into discussions. Please also see the comment above in the original\
          \ discussion. Please investigate if there is anything unexpected about the\
          \ cell where the error occurs as this may help to provide important information.\
          \ When I run the analysis using what I believe were the last isp settings\
          \ you tried, I am not encountering an error, so I need more information\
          \ to reproduce the error in order to help you troubleshoot.</p>\n<p>Also,\
          \ I would like to note that we strongly recommend tuning learning hyperparameters\
          \ for all downstream applications. I am mentioning this because I noticed\
          \ your model filename \"230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/\"\
          \ appears to indicate you used the example learning hyperparameters for\
          \ the cell annotation example to create your disease classifier. These are\
          \ not the hyperparameters we used in our manuscript (see Methods) and likely\
          \ will yield worse results than the optimized hyperparameters. I added a\
          \ note to both gene and cell classification example notebooks to emphasize\
          \ this point. Please see the example for hyperparameter optimization for\
          \ further information on how to optimize hyperparameters.</p>\n"
        raw: '@Renqing  Thank you for the discussion regarding your similar issue.
          Please check the open and closed discussions before starting a new discussion
          so that all the information is one place for future users who have the same
          question. Please post here the last isp options you tried where the error
          occurred despite changing "genes_to_perturb" to "all". Please make sure
          that all code is posted as text and not a screenshot. You can use Markdown
          syntax to insert code blocks into discussions. Please also see the comment
          above in the original discussion. Please investigate if there is anything
          unexpected about the cell where the error occurs as this may help to provide
          important information. When I run the analysis using what I believe were
          the last isp settings you tried, I am not encountering an error, so I need
          more information to reproduce the error in order to help you troubleshoot.


          Also, I would like to note that we strongly recommend tuning learning hyperparameters
          for all downstream applications. I am mentioning this because I noticed
          your model filename "230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/"
          appears to indicate you used the example learning hyperparameters for the
          cell annotation example to create your disease classifier. These are not
          the hyperparameters we used in our manuscript (see Methods) and likely will
          yield worse results than the optimized hyperparameters. I added a note to
          both gene and cell classification example notebooks to emphasize this point.
          Please see the example for hyperparameter optimization for further information
          on how to optimize hyperparameters.'
        updatedAt: '2023-07-07T23:27:43.879Z'
      numEdits: 0
      reactions: []
    id: 64a89f6f04e7b379fea6878b
    type: comment
  author: ctheodoris
  content: '@Renqing  Thank you for the discussion regarding your similar issue. Please
    check the open and closed discussions before starting a new discussion so that
    all the information is one place for future users who have the same question.
    Please post here the last isp options you tried where the error occurred despite
    changing "genes_to_perturb" to "all". Please make sure that all code is posted
    as text and not a screenshot. You can use Markdown syntax to insert code blocks
    into discussions. Please also see the comment above in the original discussion.
    Please investigate if there is anything unexpected about the cell where the error
    occurs as this may help to provide important information. When I run the analysis
    using what I believe were the last isp settings you tried, I am not encountering
    an error, so I need more information to reproduce the error in order to help you
    troubleshoot.


    Also, I would like to note that we strongly recommend tuning learning hyperparameters
    for all downstream applications. I am mentioning this because I noticed your model
    filename "230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/"
    appears to indicate you used the example learning hyperparameters for the cell
    annotation example to create your disease classifier. These are not the hyperparameters
    we used in our manuscript (see Methods) and likely will yield worse results than
    the optimized hyperparameters. I added a note to both gene and cell classification
    example notebooks to emphasize this point. Please see the example for hyperparameter
    optimization for further information on how to optimize hyperparameters.'
  created_at: 2023-07-07 22:27:43+00:00
  edited: false
  hidden: false
  id: 64a89f6f04e7b379fea6878b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
      fullname: LUYIFEI
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Akutagawaluyifei
      type: user
    createdAt: '2023-07-10T05:58:06.000Z'
    data:
      edited: false
      editors:
      - Akutagawaluyifei
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9602437019348145
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
          fullname: LUYIFEI
          isHf: false
          isPro: false
          name: Akutagawaluyifei
          type: user
        html: "<p>Sorry for the delayed reply, my account was recently created and\
          \ was limited to post any more replies in previous days.<br>Thanks for your\
          \ help! But changing emb_mode from \"cell and gene\" to \"cell\" didn't\
          \ solve this error, the error occurs at the same location. I added \"try\
          \ except\" to the code to skip cells which raise this error and and spotted\
          \ 2 cells. When I looked into these 2 cells, I was not able to identify\
          \ any curious charactistics of them. Then I finetuned the model for cell\
          \ classifier using the full dataset of my own (20000+ cells) and used the\
          \ finetuned model to run in silico perturber on the same sampled dataset\
          \ which raised this error, but in this case, the error stopped showing.<br>So\
          \ for now, I can get some results by skipping the cells or using a finetuned\
          \ model, but I am still confused about why this error occur and its possible\
          \ impact on the results. As noticed, <span data-props=\"{&quot;user&quot;:&quot;Renqing&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/Renqing\"\
          >@<span class=\"underline\">Renqing</span></a></span>\n\n\t</span></span>\
          \ and I both used rather small batch size for analysis and finetuning (geneformer_batch_size\
          \ = 4) due to resource limitations. I will e-mail you my sampled dataset\
          \ to you so you can look into it.<br>Thanks for you help and looking forward\
          \ to further support!</p>\n"
        raw: "Sorry for the delayed reply, my account was recently created and was\
          \ limited to post any more replies in previous days.\nThanks for your help!\
          \ But changing emb_mode from \"cell and gene\" to \"cell\" didn't solve\
          \ this error, the error occurs at the same location. I added \"try except\"\
          \ to the code to skip cells which raise this error and and spotted 2 cells.\
          \ When I looked into these 2 cells, I was not able to identify any curious\
          \ charactistics of them. Then I finetuned the model for cell classifier\
          \ using the full dataset of my own (20000+ cells) and used the finetuned\
          \ model to run in silico perturber on the same sampled dataset which raised\
          \ this error, but in this case, the error stopped showing. \nSo for now,\
          \ I can get some results by skipping the cells or using a finetuned model,\
          \ but I am still confused about why this error occur and its possible impact\
          \ on the results. As noticed, @Renqing and I both used rather small batch\
          \ size for analysis and finetuning (geneformer_batch_size = 4) due to resource\
          \ limitations. I will e-mail you my sampled dataset to you so you can look\
          \ into it. \nThanks for you help and looking forward to further support!"
        updatedAt: '2023-07-10T05:58:06.756Z'
      numEdits: 0
      reactions: []
    id: 64ab9deee368492ab811679b
    type: comment
  author: Akutagawaluyifei
  content: "Sorry for the delayed reply, my account was recently created and was limited\
    \ to post any more replies in previous days.\nThanks for your help! But changing\
    \ emb_mode from \"cell and gene\" to \"cell\" didn't solve this error, the error\
    \ occurs at the same location. I added \"try except\" to the code to skip cells\
    \ which raise this error and and spotted 2 cells. When I looked into these 2 cells,\
    \ I was not able to identify any curious charactistics of them. Then I finetuned\
    \ the model for cell classifier using the full dataset of my own (20000+ cells)\
    \ and used the finetuned model to run in silico perturber on the same sampled\
    \ dataset which raised this error, but in this case, the error stopped showing.\
    \ \nSo for now, I can get some results by skipping the cells or using a finetuned\
    \ model, but I am still confused about why this error occur and its possible impact\
    \ on the results. As noticed, @Renqing and I both used rather small batch size\
    \ for analysis and finetuning (geneformer_batch_size = 4) due to resource limitations.\
    \ I will e-mail you my sampled dataset to you so you can look into it. \nThanks\
    \ for you help and looking forward to further support!"
  created_at: 2023-07-10 04:58:06+00:00
  edited: false
  hidden: false
  id: 64ab9deee368492ab811679b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/58015c33c4c76a3882ea428ae3c3d399.svg
      fullname: Yuxuan Du
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: DYXDAVE
      type: user
    createdAt: '2023-07-10T07:07:09.000Z'
    data:
      edited: false
      editors:
      - DYXDAVE
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9666948318481445
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/58015c33c4c76a3882ea428ae3c3d399.svg
          fullname: Yuxuan Du
          isHf: false
          isPro: false
          name: DYXDAVE
          type: user
        html: '<p>I also faced this error. I used batch size of 14 and it will show
          the same error, hope to know the reason behind that. </p>

          '
        raw: 'I also faced this error. I used batch size of 14 and it will show the
          same error, hope to know the reason behind that. '
        updatedAt: '2023-07-10T07:07:09.114Z'
      numEdits: 0
      reactions: []
    id: 64abae1d6324705e6a69241f
    type: comment
  author: DYXDAVE
  content: 'I also faced this error. I used batch size of 14 and it will show the
    same error, hope to know the reason behind that. '
  created_at: 2023-07-10 06:07:09+00:00
  edited: false
  hidden: false
  id: 64abae1d6324705e6a69241f
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-11T01:04:00.000Z'
    data:
      edited: true
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8245672583580017
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: ''
        raw: '

          '
        updatedAt: '2023-07-11T01:13:05.430Z'
      numEdits: 9
      reactions: []
    id: 64acaa804beffa272dd2ffc5
    type: comment
  author: Renqing
  content: '

    '
  created_at: 2023-07-11 00:04:00+00:00
  edited: true
  hidden: false
  id: 64acaa804beffa272dd2ffc5
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-11T01:14:44.000Z'
    data:
      edited: true
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.3402482271194458
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: "<p>My code is: </p>\n<pre><code>isp = InSilicoPerturber(perturb_type=\"\
          delete\",\n                      perturb_rank_shift=None,\n            \
          \          genes_to_perturb='all',\n                      combos=0,\n  \
          \                    anchor_gene=None,\n                      model_type=\"\
          CellClassifier\",#Pretrained\n                      num_classes=3,\n   \
          \                   emb_mode=\"cell\",\n                      cell_emb_style=\"\
          mean_pool\",\n                      filter_data={\"cell_type\":[\"Cardiomyocyte1\"\
          ,\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\n                      cell_states_to_model={\"\
          disease\":([\"nf\"],[\"hcm\"],[\"dcm\"])},\n                      max_ncells=None,\n\
          \                      emb_layer=0,\n                      forward_batch_size=4,\n\
          \                      nproc=16,\n                      save_raw_data=False)\n\
          \nisp.perturb_data(\"/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/\"\
          ,\n               \"/Geneformer/example_input_file/cell_classification/disease_classification/Split_data/human_dcm_hcm_nf.dataset/\"\
          ,\n               \"Geneformer/example_input_file/cell_classification/test_silico_all/\"\
          ,\n               \"test\")\n</code></pre>\n"
        raw: "My code is: \n```\nisp = InSilicoPerturber(perturb_type=\"delete\",\n\
          \                      perturb_rank_shift=None,\n                      genes_to_perturb='all',\n\
          \                      combos=0,\n                      anchor_gene=None,\n\
          \                      model_type=\"CellClassifier\",#Pretrained\n     \
          \                 num_classes=3,\n                      emb_mode=\"cell\"\
          ,\n                      cell_emb_style=\"mean_pool\",\n               \
          \       filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
          ,\"Cardiomyocyte3\"]},\n                      cell_states_to_model={\"disease\"\
          :([\"nf\"],[\"hcm\"],[\"dcm\"])},\n                      max_ncells=None,\n\
          \                      emb_layer=0,\n                      forward_batch_size=4,\n\
          \                      nproc=16,\n                      save_raw_data=False)\n\
          \nisp.perturb_data(\"/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/\"\
          ,\n               \"/Geneformer/example_input_file/cell_classification/disease_classification/Split_data/human_dcm_hcm_nf.dataset/\"\
          ,\n               \"Geneformer/example_input_file/cell_classification/test_silico_all/\"\
          ,\n               \"test\")\n\n```\n"
        updatedAt: '2023-07-11T01:17:00.675Z'
      numEdits: 3
      reactions: []
    id: 64acad04b7e4b2c1ce32f14d
    type: comment
  author: Renqing
  content: "My code is: \n```\nisp = InSilicoPerturber(perturb_type=\"delete\",\n\
    \                      perturb_rank_shift=None,\n                      genes_to_perturb='all',\n\
    \                      combos=0,\n                      anchor_gene=None,\n  \
    \                    model_type=\"CellClassifier\",#Pretrained\n             \
    \         num_classes=3,\n                      emb_mode=\"cell\",\n         \
    \             cell_emb_style=\"mean_pool\",\n                      filter_data={\"\
    cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\n   \
    \                   cell_states_to_model={\"disease\":([\"nf\"],[\"hcm\"],[\"\
    dcm\"])},\n                      max_ncells=None,\n                      emb_layer=0,\n\
    \                      forward_batch_size=4,\n                      nproc=16,\n\
    \                      save_raw_data=False)\n\nisp.perturb_data(\"/cell_disease/230627_geneformer_CellClassifier_L2048_B4_LR5e-05_LSlinear_WU500_E10_Oadamw_F0/\"\
    ,\n               \"/Geneformer/example_input_file/cell_classification/disease_classification/Split_data/human_dcm_hcm_nf.dataset/\"\
    ,\n               \"Geneformer/example_input_file/cell_classification/test_silico_all/\"\
    ,\n               \"test\")\n\n```\n"
  created_at: 2023-07-11 00:14:44+00:00
  edited: true
  hidden: false
  id: 64acad04b7e4b2c1ce32f14d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
      fullname: Renqing Nie
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Renqing
      type: user
    createdAt: '2023-07-18T04:58:25.000Z'
    data:
      edited: false
      editors:
      - Renqing
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.7894428968429565
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/96dfc7cd6acde7bc305a6e3d7cfd8f81.svg
          fullname: Renqing Nie
          isHf: false
          isPro: false
          name: Renqing
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;Akutagawaluyifei&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/Akutagawaluyifei\"\
          >@<span class=\"underline\">Akutagawaluyifei</span></a></span>\n\n\t</span></span>\
          \ <span data-props=\"{&quot;user&quot;:&quot;DYXDAVE&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/DYXDAVE\">@<span class=\"\
          underline\">DYXDAVE</span></a></span>\n\n\t</span></span> Have you solved\
          \ this problem?</p>\n"
        raw: '@Akutagawaluyifei @DYXDAVE Have you solved this problem?'
        updatedAt: '2023-07-18T04:58:25.746Z'
      numEdits: 0
      reactions: []
    id: 64b61bf1c1452d75f357a03e
    type: comment
  author: Renqing
  content: '@Akutagawaluyifei @DYXDAVE Have you solved this problem?'
  created_at: 2023-07-18 03:58:25+00:00
  edited: false
  hidden: false
  id: 64b61bf1c1452d75f357a03e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
      fullname: LUYIFEI
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Akutagawaluyifei
      type: user
    createdAt: '2023-07-19T02:43:46.000Z'
    data:
      edited: false
      editors:
      - Akutagawaluyifei
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.957306444644928
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/70292de8577011b753721731d192c382.svg
          fullname: LUYIFEI
          isHf: false
          isPro: false
          name: Akutagawaluyifei
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;Renqing&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/Renqing\">@<span class=\"\
          underline\">Renqing</span></a></span>\n\n\t</span></span> Using a batch.size\
          \ of 100 doesn't raise this error for me. Maybe a larger batch.size is a\
          \ solution but still doesn't address the reason behind this error. Still\
          \ in need of help from author.</p>\n"
        raw: '@Renqing Using a batch.size of 100 doesn''t raise this error for me.
          Maybe a larger batch.size is a solution but still doesn''t address the reason
          behind this error. Still in need of help from author.'
        updatedAt: '2023-07-19T02:43:46.678Z'
      numEdits: 0
      reactions: []
    id: 64b74de2324038715940945e
    type: comment
  author: Akutagawaluyifei
  content: '@Renqing Using a batch.size of 100 doesn''t raise this error for me. Maybe
    a larger batch.size is a solution but still doesn''t address the reason behind
    this error. Still in need of help from author.'
  created_at: 2023-07-19 01:43:46+00:00
  edited: false
  hidden: false
  id: 64b74de2324038715940945e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
      fullname: Matthew Pace
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Pingiotto
      type: user
    createdAt: '2023-08-16T13:04:17.000Z'
    data:
      edited: false
      editors:
      - Pingiotto
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8881198167800903
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/2e19b0efd2e371d62a492c416f5d9ca1.svg
          fullname: Matthew Pace
          isHf: false
          isPro: false
          name: Pingiotto
          type: user
        html: '<p>I''m getting a similar error which does not get resolved by increasing
          batch size. I''m using the more recent scripts.<br><code>RuntimeError: The
          size of tensor a (1958) must match the size of tensor b (2048) at non-singleton
          dimension 3</code></p>

          '
        raw: 'I''m getting a similar error which does not get resolved by increasing
          batch size. I''m using the more recent scripts.

          `RuntimeError: The size of tensor a (1958) must match the size of tensor
          b (2048) at non-singleton dimension 3`'
        updatedAt: '2023-08-16T13:04:17.944Z'
      numEdits: 0
      reactions: []
    id: 64dcc951249785efad92069d
    type: comment
  author: Pingiotto
  content: 'I''m getting a similar error which does not get resolved by increasing
    batch size. I''m using the more recent scripts.

    `RuntimeError: The size of tensor a (1958) must match the size of tensor b (2048)
    at non-singleton dimension 3`'
  created_at: 2023-08-16 12:04:17+00:00
  edited: false
  hidden: false
  id: 64dcc951249785efad92069d
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/87affbf02e38d7088fb2b90ea634836f.svg
      fullname: Tara
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: MinieRosie
      type: user
    createdAt: '2023-09-07T01:04:17.000Z'
    data:
      edited: true
      editors:
      - MinieRosie
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6372830271720886
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/87affbf02e38d7088fb2b90ea634836f.svg
          fullname: Tara
          isHf: false
          isPro: false
          name: MinieRosie
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;ctheodoris&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/ctheodoris\">@<span class=\"\
          underline\">ctheodoris</span></a></span>\n\n\t</span></span>  <span data-props=\"\
          {&quot;user&quot;:&quot;davidjwen&quot;}\" data-target=\"UserMention\" class=\"\
          SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"inline-block\"><span\
          \ class=\"contents\"><a href=\"/davidjwen\">@<span class=\"underline\">davidjwen</span></a></span>\n\
          \n\t</span></span>  Hello I am also getting a similar error. I am trying\
          \ to recreate Figure 5b from the paper. I did not see the arrow files used\
          \ for this figure under Genecorpus-30M so I created my own by extracting\
          \ the fetal cardiomyocytes from GSE156793. </p>\n<p>Here is the code I used:\
          \ </p>\n<pre><code>isp = InSilicoPerturber(perturb_type=\"delete\",\n  \
          \                      perturb_rank_shift=None,\n                      \
          \  genes_to_perturb=[\"ENSG00000136574\"],\n                        combos=0,\n\
          \                        anchor_gene=None,\n                        model_type=\"\
          Pretrained\",\n                        num_classes=0,\n                \
          \        emb_mode=\"cell_and_gene\",\n                        cell_emb_style=\"\
          mean_pool\",\n                        cell_states_to_model=None,\n     \
          \                   max_ncells=200,\n                        emb_layer=-1,\n\
          \                        forward_batch_size=50,\n                      \
          \  nproc=16)\n                    \nisp.perturb_data(\"TOOLS/Geneformer/\"\
          ,\n                 \"/Geneformer/test_tokenizer2.dataset/\",\n        \
          \         \"/Geneformer/\",\n                 \"test_geneformer\")\n</code></pre>\n\
          <p>And the error that I get : </p>\n<pre><code>Traceback (most recent call\
          \ last):\n  File \"/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
          , line 23, in &lt;module&gt;\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 975, in perturb_dat\na\n    self.in_silico_perturb(model,\n  File\
          \ \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1053, in in_silico_\nperturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 466, in quant_cos_s\nims\n    cos_sims_stack = torch.cat(cos_sims)\n\
          RuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 2047 but got size 617 for tensor number 1 in\n the list.\n</code></pre>\n\
          <p>I also ran the same exact code using your arrow file from Genecorpus-30M/example_input_files/cell_classification/cell_type_annotation\
          \ to see if maybe I made a mistake at the tokenizing step but I get a similar\
          \ error.:</p>\n<pre><code>Traceback (most recent call last):\n  File \"\
          users/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\", line 23,\
          \ in &lt;module&gt;\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 975, in perturb_data\n    self.in_silico_perturb(model,\n  File \"\
          /anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1053, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 466, in quant_cos_sims\n    cos_sims_stack = torch.cat(cos_sims)\n\
          RuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 1354 but got size 586 for tensor number 1 in the list.\n</code></pre>\n\
          <p>Any advice you can give is greatly appreciated.</p>\n<h2 id=\"update\"\
          >UPDATE</h2>\n<p>I noticed that <span data-props=\"{&quot;user&quot;:&quot;davidjwen&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/davidjwen\"\
          >@<span class=\"underline\">davidjwen</span></a></span>\n\n\t</span></span>\
          \ made an update to this file in the past 12 hours (Fixed bugs related to\
          \ overexpressing genes <a href=\"/ctheodoris/Geneformer/discussions/229\"\
          >#229</a>). I pulled the most recent version and re-ran my code.   I get\
          \ a different error now which is identical to Discussion <a href=\"/ctheodoris/Geneformer/discussions/184\"\
          >#184</a> :</p>\n<pre><code>Map (num_proc=4): 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 50/50 [00:00&lt;00:00, 252.33 examples/s]\n\
          Map (num_proc=4):  40%|\u2588\u2588\u2588       | 15/50 [00:00&lt;00:01,\
          \ 24.59 examples/s]\nMap (num_proc=4):  94%|\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u258D| 47/50 [00:01&lt;00:00, 29.23 examples/s]\n\
          Map (num_proc=4): 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588| 50/50 [00:02&lt;00:00, 21.94 examples/s]\nTraceback (most recent\
          \ call last):\n  File \"/pusers/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
          , line 23, in &lt;mo\ndule&gt;\n    isp.perturb_data(\"/yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 981, in perturb_data\n    self.in_silico_perturb(model,\n  File\
          \ \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 1059, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 445, in quant_cos_sims\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 150\n1, in _call_impl\n    return forward_call(*args, **kwargs)\n\
          \  File \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 8\n7, in forward\n    return F.cosine_similarity(x1, x2, self.dim,\
          \ self.eps)\nRuntimeError: The size of tensor a (2047) must match the size\
          \ of tensor b (2046) at non-singleton di\nmension 1\n</code></pre>\n"
        raw: "@ctheodoris  @davidjwen  Hello I am also getting a similar error. I\
          \ am trying to recreate Figure 5b from the paper. I did not see the arrow\
          \ files used for this figure under Genecorpus-30M so I created my own by\
          \ extracting the fetal cardiomyocytes from GSE156793. \n\nHere is the code\
          \ I used: \n\n```\nisp = InSilicoPerturber(perturb_type=\"delete\",\n  \
          \                      perturb_rank_shift=None,\n                      \
          \  genes_to_perturb=[\"ENSG00000136574\"],\n                        combos=0,\n\
          \                        anchor_gene=None,\n                        model_type=\"\
          Pretrained\",\n                        num_classes=0,\n                \
          \        emb_mode=\"cell_and_gene\",\n                        cell_emb_style=\"\
          mean_pool\",\n                        cell_states_to_model=None,\n     \
          \                   max_ncells=200,\n                        emb_layer=-1,\n\
          \                        forward_batch_size=50,\n                      \
          \  nproc=16)\n                    \nisp.perturb_data(\"TOOLS/Geneformer/\"\
          ,\n                 \"/Geneformer/test_tokenizer2.dataset/\",\n        \
          \         \"/Geneformer/\",\n                 \"test_geneformer\")\n\n```\n\
          And the error that I get : \n\n```\nTraceback (most recent call last):\n\
          \  File \"/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\", line\
          \ 23, in <module>\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 975, in perturb_dat\na\n    self.in_silico_perturb(model,\n  File\
          \ \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1053, in in_silico_\nperturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 466, in quant_cos_s\nims\n    cos_sims_stack = torch.cat(cos_sims)\n\
          RuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 2047 but got size 617 for tensor number 1 in\n the list.\n```\nI\
          \ also ran the same exact code using your arrow file from Genecorpus-30M/example_input_files/cell_classification/cell_type_annotation\
          \ to see if maybe I made a mistake at the tokenizing step but I get a similar\
          \ error.:\n\n```\nTraceback (most recent call last):\n  File \"users/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
          , line 23, in <module>\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 975, in perturb_data\n    self.in_silico_perturb(model,\n  File \"\
          /anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 1053, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , line 466, in quant_cos_sims\n    cos_sims_stack = torch.cat(cos_sims)\n\
          RuntimeError: Sizes of tensors must match except in dimension 0. Expected\
          \ size 1354 but got size 586 for tensor number 1 in the list.\n```\nAny\
          \ advice you can give is greatly appreciated.\n\n\n## UPDATE\n\nI noticed\
          \ that @davidjwen made an update to this file in the past 12 hours (Fixed\
          \ bugs related to overexpressing genes #229). I pulled the most recent version\
          \ and re-ran my code.   I get a different error now which is identical to\
          \ Discussion #184 :\n\n```\nMap (num_proc=4): 100%|\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u2588\u2588\u2588| 50/50 [00:00<00:00, 252.33 examples/s]\n\
          Map (num_proc=4):  40%|\u2588\u2588\u2588       | 15/50 [00:00<00:01, 24.59\
          \ examples/s]\nMap (num_proc=4):  94%|\u2588\u2588\u2588\u2588\u2588\u2588\
          \u2588\u2588\u2588\u258D| 47/50 [00:01<00:00, 29.23 examples/s]\nMap (num_proc=4):\
          \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 50/50\
          \ [00:02<00:00, 21.94 examples/s]\nTraceback (most recent call last):\n\
          \  File \"/pusers/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
          , line 23, in <mo\ndule>\n    isp.perturb_data(\"/yanketn/TOOLS/Geneformer/\"\
          ,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 981, in perturb_data\n    self.in_silico_perturb(model,\n  File\
          \ \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 1059, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\
          \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
          , l\nine 445, in quant_cos_sims\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
          cpu\")]\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
          , line 150\n1, in _call_impl\n    return forward_call(*args, **kwargs)\n\
          \  File \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
          , line 8\n7, in forward\n    return F.cosine_similarity(x1, x2, self.dim,\
          \ self.eps)\nRuntimeError: The size of tensor a (2047) must match the size\
          \ of tensor b (2046) at non-singleton di\nmension 1\n\n```\n"
        updatedAt: '2023-09-16T22:51:24.061Z'
      numEdits: 4
      reactions: []
    id: 64f92191dcd7b028c194b3dc
    type: comment
  author: MinieRosie
  content: "@ctheodoris  @davidjwen  Hello I am also getting a similar error. I am\
    \ trying to recreate Figure 5b from the paper. I did not see the arrow files used\
    \ for this figure under Genecorpus-30M so I created my own by extracting the fetal\
    \ cardiomyocytes from GSE156793. \n\nHere is the code I used: \n\n```\nisp = InSilicoPerturber(perturb_type=\"\
    delete\",\n                        perturb_rank_shift=None,\n                \
    \        genes_to_perturb=[\"ENSG00000136574\"],\n                        combos=0,\n\
    \                        anchor_gene=None,\n                        model_type=\"\
    Pretrained\",\n                        num_classes=0,\n                      \
    \  emb_mode=\"cell_and_gene\",\n                        cell_emb_style=\"mean_pool\"\
    ,\n                        cell_states_to_model=None,\n                      \
    \  max_ncells=200,\n                        emb_layer=-1,\n                  \
    \      forward_batch_size=50,\n                        nproc=16)\n           \
    \         \nisp.perturb_data(\"TOOLS/Geneformer/\",\n                 \"/Geneformer/test_tokenizer2.dataset/\"\
    ,\n                 \"/Geneformer/\",\n                 \"test_geneformer\")\n\
    \n```\nAnd the error that I get : \n\n```\nTraceback (most recent call last):\n\
    \  File \"/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\", line 23,\
    \ in <module>\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\",\n  File \"\
    /anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 975, in perturb_dat\na\n    self.in_silico_perturb(model,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 1053, in in_silico_\nperturb\n    cos_sims_data = quant_cos_sims(model,\
    \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 466, in quant_cos_s\nims\n    cos_sims_stack = torch.cat(cos_sims)\nRuntimeError:\
    \ Sizes of tensors must match except in dimension 0. Expected size 2047 but got\
    \ size 617 for tensor number 1 in\n the list.\n```\nI also ran the same exact\
    \ code using your arrow file from Genecorpus-30M/example_input_files/cell_classification/cell_type_annotation\
    \ to see if maybe I made a mistake at the tokenizing step but I get a similar\
    \ error.:\n\n```\nTraceback (most recent call last):\n  File \"users/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
    , line 23, in <module>\n    isp.perturb_data(\"//yanketn/TOOLS/Geneformer/\",\n\
    \  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 975, in perturb_data\n    self.in_silico_perturb(model,\n  File \"/anketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 1053, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model, \n\
    \  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , line 466, in quant_cos_sims\n    cos_sims_stack = torch.cat(cos_sims)\nRuntimeError:\
    \ Sizes of tensors must match except in dimension 0. Expected size 1354 but got\
    \ size 586 for tensor number 1 in the list.\n```\nAny advice you can give is greatly\
    \ appreciated.\n\n\n## UPDATE\n\nI noticed that @davidjwen made an update to this\
    \ file in the past 12 hours (Fixed bugs related to overexpressing genes #229).\
    \ I pulled the most recent version and re-ran my code.   I get a different error\
    \ now which is identical to Discussion #184 :\n\n```\nMap (num_proc=4): 100%|\u2588\
    \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 50/50 [00:00<00:00, 252.33\
    \ examples/s]\nMap (num_proc=4):  40%|\u2588\u2588\u2588       | 15/50 [00:00<00:01,\
    \ 24.59 examples/s]\nMap (num_proc=4):  94%|\u2588\u2588\u2588\u2588\u2588\u2588\
    \u2588\u2588\u2588\u258D| 47/50 [00:01<00:00, 29.23 examples/s]\nMap (num_proc=4):\
    \ 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 50/50 [00:02<00:00,\
    \ 21.94 examples/s]\nTraceback (most recent call last):\n  File \"/pusers/yanketn/ANALYSIS/Geneformer/Geneformer_Figure5_test.py\"\
    , line 23, in <mo\ndule>\n    isp.perturb_data(\"/yanketn/TOOLS/Geneformer/\"\
    ,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , l\nine 981, in perturb_data\n    self.in_silico_perturb(model,\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , l\nine 1059, in in_silico_perturb\n    cos_sims_data = quant_cos_sims(model,\
    \ \n  File \"/yanketn/miniconda/lib/python3.10/site-packages/geneformer/in_silico_perturber.py\"\
    , l\nine 445, in quant_cos_sims\n    cos_sims += [cos(minibatch_emb, minibatch_comparison).to(\"\
    cpu\")]\n  File \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/module.py\"\
    , line 150\n1, in _call_impl\n    return forward_call(*args, **kwargs)\n  File\
    \ \"/yanketn/miniconda/lib/python3.10/site-packages/torch/nn/modules/distance.py\"\
    , line 8\n7, in forward\n    return F.cosine_similarity(x1, x2, self.dim, self.eps)\n\
    RuntimeError: The size of tensor a (2047) must match the size of tensor b (2046)\
    \ at non-singleton di\nmension 1\n\n```\n"
  created_at: 2023-09-07 00:04:17+00:00
  edited: true
  hidden: false
  id: 64f92191dcd7b028c194b3dc
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T08:58:47.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9056812524795532
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer and for your patience!
          We pushed an update that should resolve this issue. If you continue to face
          errors after pulling the updated code, please let us know by either reopening
          this discussion if it''s the same error or opening a new discussion if it''s
          a new error. Thank you!</p>

          '
        raw: Thank you for your interest in Geneformer and for your patience! We pushed
          an update that should resolve this issue. If you continue to face errors
          after pulling the updated code, please let us know by either reopening this
          discussion if it's the same error or opening a new discussion if it's a
          new error. Thank you!
        updatedAt: '2023-12-15T08:58:47.859Z'
      numEdits: 0
      reactions: []
      relatedEventId: 657c1548daab7e5f3529fe79
    id: 657c1547daab7e5f3529fe71
    type: comment
  author: ctheodoris
  content: Thank you for your interest in Geneformer and for your patience! We pushed
    an update that should resolve this issue. If you continue to face errors after
    pulling the updated code, please let us know by either reopening this discussion
    if it's the same error or opening a new discussion if it's a new error. Thank
    you!
  created_at: 2023-12-15 08:58:47+00:00
  edited: false
  hidden: false
  id: 657c1547daab7e5f3529fe71
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-12-15T08:58:48.000Z'
    data:
      status: closed
    id: 657c1548daab7e5f3529fe79
    type: status-change
  author: ctheodoris
  created_at: 2023-12-15 08:58:48+00:00
  id: 657c1548daab7e5f3529fe79
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 85
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Sizes of tensors error in in_silico_perturber
