!!python/object:huggingface_hub.community.DiscussionWithDetails
author: Ivylina
conflicting_files: null
created_at: 2023-06-22 05:00:55+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
      fullname: Ivy
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Ivylina
      type: user
    createdAt: '2023-06-22T06:00:55.000Z'
    data:
      edited: false
      editors:
      - Ivylina
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6709527969360352
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
          fullname: Ivy
          isHf: false
          isPro: false
          name: Ivylina
          type: user
        html: '<p>I only change the forward_batch_size in in_silico_perturber.py.
          Besides, I have install git lfs. When I run the insilicoperturberstats function
          it shows:<br>Traceback (most recent call last):<br>  File "", line 1, in
          <br>  File "/tool/Geneformer/geneformer/in_silico_perturber_stats.py", line
          189, in <strong>init</strong><br>    cos_sims_full_df.loc[i, "Null_avg_shift"]
          = np.mean(null_shifts)<br>_pickle.UnpicklingError: invalid load key, ''v''.</p>

          <p>I don''t know why this occurred. And how to solve it</p>

          '
        raw: "I only change the forward_batch_size in in_silico_perturber.py. Besides,\
          \ I have install git lfs. When I run the insilicoperturberstats function\
          \ it shows:\r\nTraceback (most recent call last):\r\n  File \"<stdin>\"\
          , line 1, in <module>\r\n  File \"/tool/Geneformer/geneformer/in_silico_perturber_stats.py\"\
          , line 189, in __init__\r\n    cos_sims_full_df.loc[i, \"Null_avg_shift\"\
          ] = np.mean(null_shifts)\r\n_pickle.UnpicklingError: invalid load key, 'v'.\r\
          \n\r\nI don't know why this occurred. And how to solve it"
        updatedAt: '2023-06-22T06:00:55.175Z'
      numEdits: 0
      reactions: []
    id: 6493e397b78bdd4f5d6856a0
    type: comment
  author: Ivylina
  content: "I only change the forward_batch_size in in_silico_perturber.py. Besides,\
    \ I have install git lfs. When I run the insilicoperturberstats function it shows:\r\
    \nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\
    \n  File \"/tool/Geneformer/geneformer/in_silico_perturber_stats.py\", line 189,\
    \ in __init__\r\n    cos_sims_full_df.loc[i, \"Null_avg_shift\"] = np.mean(null_shifts)\r\
    \n_pickle.UnpicklingError: invalid load key, 'v'.\r\n\r\nI don't know why this\
    \ occurred. And how to solve it"
  created_at: 2023-06-22 05:00:55+00:00
  edited: false
  hidden: false
  id: 6493e397b78bdd4f5d6856a0
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-22T06:27:12.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9483874440193176
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your question and interest in Geneformer. Installing
          git lfs is related to accessing binary files in the cloned repository but
          does not have to do with loading pickle files that you have generated locally
          with the in silico perturber. Is this the entire error message? Also, could
          you provide more information on how you are running the in silico perturber
          and in silico perturber stats so I can reproduce the error? The example
          in the repository is not for the mode comparing to a null distribution so
          I assume you changed something else in addition to the batch size and also
          assume you are providing pickle files for the null distribution so it would
          be helpful to know how those were generated too.</p>

          '
        raw: Thank you for your question and interest in Geneformer. Installing git
          lfs is related to accessing binary files in the cloned repository but does
          not have to do with loading pickle files that you have generated locally
          with the in silico perturber. Is this the entire error message? Also, could
          you provide more information on how you are running the in silico perturber
          and in silico perturber stats so I can reproduce the error? The example
          in the repository is not for the mode comparing to a null distribution so
          I assume you changed something else in addition to the batch size and also
          assume you are providing pickle files for the null distribution so it would
          be helpful to know how those were generated too.
        updatedAt: '2023-06-22T06:27:12.894Z'
      numEdits: 0
      reactions: []
    id: 6493e9c022691fc8b458dc25
    type: comment
  author: ctheodoris
  content: Thank you for your question and interest in Geneformer. Installing git
    lfs is related to accessing binary files in the cloned repository but does not
    have to do with loading pickle files that you have generated locally with the
    in silico perturber. Is this the entire error message? Also, could you provide
    more information on how you are running the in silico perturber and in silico
    perturber stats so I can reproduce the error? The example in the repository is
    not for the mode comparing to a null distribution so I assume you changed something
    else in addition to the batch size and also assume you are providing pickle files
    for the null distribution so it would be helpful to know how those were generated
    too.
  created_at: 2023-06-22 05:27:12+00:00
  edited: false
  hidden: false
  id: 6493e9c022691fc8b458dc25
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
      fullname: Ivy
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Ivylina
      type: user
    createdAt: '2023-06-22T16:09:26.000Z'
    data:
      edited: false
      editors:
      - Ivylina
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.4247289001941681
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
          fullname: Ivy
          isHf: false
          isPro: false
          name: Ivylina
          type: user
        html: "<p>The script are as follows:<br>module load cuda/11.6<br>python<br>from\
          \ geneformer import InSilicoPerturber<br>from geneformer import InSilicoPerturberStats</p>\n\
          <p>isp = InSilicoPerturber(perturb_type=\"delete\",<br>                \
          \      perturb_rank_shift=None,<br>                      genes_to_perturb=\"\
          all\",<br>                      combos=0,<br>                      anchor_gene=None,<br>\
          \                      model_type=\"CellClassifier\",<br>              \
          \        num_classes=3,<br>                      emb_mode=\"cell\",<br>\
          \                      cell_emb_style=\"mean_pool\",<br>               \
          \       filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
          ,\"Cardiomyocyte3\"]},<br>                      cell_states_to_model={\"\
          disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])},<br>                      max_ncells=2000,<br>\
          \                      emb_layer=0,<br>                      forward_batch_size=100,<br>\
          \                      nproc=16,<br>                      save_raw_data=True)</p>\n\
          <p>isp.perturb_data(\"/HOME/scz3832/run/tool/Geneformer\",<br>    \"/tool/Geneformer/examples/example_input_files/cell_classification/disease_classification/human_dcm_hcm_nf.dataset\"\
          ,<br>    \"/tool/Geneformer/test\",<br>    \"test_out\")</p>\n<p>ispstats\
          \ = InSilicoPerturberStats(mode=\"goal_state_shift\",<br>              \
          \                  combos=0,<br>                                anchor_gene=None,<br>\
          \                                cell_states_to_model={\"disease\":([\"\
          dcm\"],[\"nf\"],[\"hcm\"])})</p>\n<p>When I run InSilicoPerturberStats function:<br>and\
          \ the error message is afore mentioned.\n </p>\n"
        raw: "The script are as follows:\nmodule load cuda/11.6\npython\nfrom geneformer\
          \ import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\
          \nisp = InSilicoPerturber(perturb_type=\"delete\",\n                   \
          \   perturb_rank_shift=None,\n                      genes_to_perturb=\"\
          all\",\n                      combos=0,\n                      anchor_gene=None,\n\
          \                      model_type=\"CellClassifier\",\n                \
          \      num_classes=3,\n                      emb_mode=\"cell\",\n      \
          \                cell_emb_style=\"mean_pool\",\n                      filter_data={\"\
          cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\",\"Cardiomyocyte3\"]},\n\
          \                      cell_states_to_model={\"disease\":([\"dcm\"],[\"\
          nf\"],[\"hcm\"])},\n                      max_ncells=2000,\n           \
          \           emb_layer=0,\n                      forward_batch_size=100,\n\
          \                      nproc=16,\n                      save_raw_data=True)\n\
          \nisp.perturb_data(\"/HOME/scz3832/run/tool/Geneformer\",\n    \"/tool/Geneformer/examples/example_input_files/cell_classification/disease_classification/human_dcm_hcm_nf.dataset\"\
          ,\n    \"/tool/Geneformer/test\",\n    \"test_out\")\n\nispstats = InSilicoPerturberStats(mode=\"\
          goal_state_shift\",\n                                combos=0,\n       \
          \                         anchor_gene=None,\n                          \
          \      cell_states_to_model={\"disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\n\
          \nWhen I run InSilicoPerturberStats function:\nand the error message is\
          \ afore mentioned.\n "
        updatedAt: '2023-06-22T16:09:26.362Z'
      numEdits: 0
      reactions: []
    id: 64947236462bb86e8c1f8213
    type: comment
  author: Ivylina
  content: "The script are as follows:\nmodule load cuda/11.6\npython\nfrom geneformer\
    \ import InSilicoPerturber\nfrom geneformer import InSilicoPerturberStats\n\n\
    isp = InSilicoPerturber(perturb_type=\"delete\",\n                      perturb_rank_shift=None,\n\
    \                      genes_to_perturb=\"all\",\n                      combos=0,\n\
    \                      anchor_gene=None,\n                      model_type=\"\
    CellClassifier\",\n                      num_classes=3,\n                    \
    \  emb_mode=\"cell\",\n                      cell_emb_style=\"mean_pool\",\n \
    \                     filter_data={\"cell_type\":[\"Cardiomyocyte1\",\"Cardiomyocyte2\"\
    ,\"Cardiomyocyte3\"]},\n                      cell_states_to_model={\"disease\"\
    :([\"dcm\"],[\"nf\"],[\"hcm\"])},\n                      max_ncells=2000,\n  \
    \                    emb_layer=0,\n                      forward_batch_size=100,\n\
    \                      nproc=16,\n                      save_raw_data=True)\n\n\
    isp.perturb_data(\"/HOME/scz3832/run/tool/Geneformer\",\n    \"/tool/Geneformer/examples/example_input_files/cell_classification/disease_classification/human_dcm_hcm_nf.dataset\"\
    ,\n    \"/tool/Geneformer/test\",\n    \"test_out\")\n\nispstats = InSilicoPerturberStats(mode=\"\
    goal_state_shift\",\n                                combos=0,\n             \
    \                   anchor_gene=None,\n                                cell_states_to_model={\"\
    disease\":([\"dcm\"],[\"nf\"],[\"hcm\"])})\n\nWhen I run InSilicoPerturberStats\
    \ function:\nand the error message is afore mentioned.\n "
  created_at: 2023-06-22 15:09:26+00:00
  edited: false
  hidden: false
  id: 64947236462bb86e8c1f8213
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-22T21:34:54.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.915438175201416
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for the follow up information.</p>

          <p>Running InSilicoPerturberStats just sets up the perturber stat options.
          It should not result in this code being run that is mentioned in your error
          message:<br>cos_sims_full_df.loc[i, "Null_avg_shift"] = np.mean(null_shifts)</p>

          <p>Are you running get_stats as well? If so, please provide the options
          you are using. The line in the error message should only be run if the mode="vs_null"
          but you are listing here that you set it up as "goal_state_shift" so there
          is some discrepancy.</p>

          <p>Additionally, I noted that you are running perturb_data with a directory
          that appears as if it points to the pretrained model. (Though I cannot be
          sure what is in your directory). If that''s the case, you should set up
          the InSilicoPerturber with the model_type "pretrained". If you provide the
          pretrained model but incorrectly indicate you are providing a CellClassifier
          model, it will load the pretrained model as a classifier with a head layer
          that has not been fine-tuned (and therefore has randomly initialized weights).
          Because you are indicating the emb_layer as 0, this randomly initialized
          layer is the one the embeddings will be drawn from. If the directory you
          loaded indeed contains the pretrained model, you should have gotten a warning
          message about the weights not being trained indicating this, but just wanted
          to mention it here as well. Please disregard this comment if your directory
          contains a model you fine-tuned to distinguish the disease states you are
          modeling.</p>

          '
        raw: 'Thank you for the follow up information.


          Running InSilicoPerturberStats just sets up the perturber stat options.
          It should not result in this code being run that is mentioned in your error
          message:

          cos_sims_full_df.loc[i, "Null_avg_shift"] = np.mean(null_shifts)


          Are you running get_stats as well? If so, please provide the options you
          are using. The line in the error message should only be run if the mode="vs_null"
          but you are listing here that you set it up as "goal_state_shift" so there
          is some discrepancy.


          Additionally, I noted that you are running perturb_data with a directory
          that appears as if it points to the pretrained model. (Though I cannot be
          sure what is in your directory). If that''s the case, you should set up
          the InSilicoPerturber with the model_type "pretrained". If you provide the
          pretrained model but incorrectly indicate you are providing a CellClassifier
          model, it will load the pretrained model as a classifier with a head layer
          that has not been fine-tuned (and therefore has randomly initialized weights).
          Because you are indicating the emb_layer as 0, this randomly initialized
          layer is the one the embeddings will be drawn from. If the directory you
          loaded indeed contains the pretrained model, you should have gotten a warning
          message about the weights not being trained indicating this, but just wanted
          to mention it here as well. Please disregard this comment if your directory
          contains a model you fine-tuned to distinguish the disease states you are
          modeling.'
        updatedAt: '2023-06-22T21:34:54.669Z'
      numEdits: 0
      reactions: []
    id: 6494be7e77964f037ccd20ae
    type: comment
  author: ctheodoris
  content: 'Thank you for the follow up information.


    Running InSilicoPerturberStats just sets up the perturber stat options. It should
    not result in this code being run that is mentioned in your error message:

    cos_sims_full_df.loc[i, "Null_avg_shift"] = np.mean(null_shifts)


    Are you running get_stats as well? If so, please provide the options you are using.
    The line in the error message should only be run if the mode="vs_null" but you
    are listing here that you set it up as "goal_state_shift" so there is some discrepancy.


    Additionally, I noted that you are running perturb_data with a directory that
    appears as if it points to the pretrained model. (Though I cannot be sure what
    is in your directory). If that''s the case, you should set up the InSilicoPerturber
    with the model_type "pretrained". If you provide the pretrained model but incorrectly
    indicate you are providing a CellClassifier model, it will load the pretrained
    model as a classifier with a head layer that has not been fine-tuned (and therefore
    has randomly initialized weights). Because you are indicating the emb_layer as
    0, this randomly initialized layer is the one the embeddings will be drawn from.
    If the directory you loaded indeed contains the pretrained model, you should have
    gotten a warning message about the weights not being trained indicating this,
    but just wanted to mention it here as well. Please disregard this comment if your
    directory contains a model you fine-tuned to distinguish the disease states you
    are modeling.'
  created_at: 2023-06-22 20:34:54+00:00
  edited: false
  hidden: false
  id: 6494be7e77964f037ccd20ae
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
      fullname: Ivy
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: Ivylina
      type: user
    createdAt: '2023-06-28T05:51:55.000Z'
    data:
      edited: false
      editors:
      - Ivylina
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8795710802078247
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/54e05e56a106b00b0d6ab01203a9bf28.svg
          fullname: Ivy
          isHf: false
          isPro: false
          name: Ivylina
          type: user
        html: '<p>Thanks for your help. I updated the script, and it worked. I wonder
          whether can I run the perturbation script on pretrain model without single
          cell dataset on any disease. If yes, do you have any suggestion on the parameters?</p>

          '
        raw: 'Thanks for your help. I updated the script, and it worked. I wonder
          whether can I run the perturbation script on pretrain model without single
          cell dataset on any disease. If yes, do you have any suggestion on the parameters?

          '
        updatedAt: '2023-06-28T05:51:55.111Z'
      numEdits: 0
      reactions: []
    id: 649bca7b0165298b64291f6c
    type: comment
  author: Ivylina
  content: 'Thanks for your help. I updated the script, and it worked. I wonder whether
    can I run the perturbation script on pretrain model without single cell dataset
    on any disease. If yes, do you have any suggestion on the parameters?

    '
  created_at: 2023-06-28 04:51:55+00:00
  edited: false
  hidden: false
  id: 649bca7b0165298b64291f6c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-28T06:20:30.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9401631355285645
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: "<p>Thank you for your question. The in silico perturbation strategy\
          \ is a generalizable approach and does not need to be performed with respect\
          \ to a disease. The parameters will really depend on your scientific question.\
          \ You can access the documentation for all the options with help(module)\
          \ to read more about each one. If you still aren\u2019t sure what to choose\
          \ and you have a specific question you would like to answer with your analysis,\
          \ please email me with more specifics about your scientific question and\
          \ I\u2019m happy to help suggest an approach.</p>\n"
        raw: "Thank you for your question. The in silico perturbation strategy is\
          \ a generalizable approach and does not need to be performed with respect\
          \ to a disease. The parameters will really depend on your scientific question.\
          \ You can access the documentation for all the options with help(module)\
          \ to read more about each one. If you still aren\u2019t sure what to choose\
          \ and you have a specific question you would like to answer with your analysis,\
          \ please email me with more specifics about your scientific question and\
          \ I\u2019m happy to help suggest an approach."
        updatedAt: '2023-06-28T06:20:30.996Z'
      numEdits: 0
      reactions: []
      relatedEventId: 649bd12f5eed3f60d1793426
    id: 649bd12e5eed3f60d1793425
    type: comment
  author: ctheodoris
  content: "Thank you for your question. The in silico perturbation strategy is a\
    \ generalizable approach and does not need to be performed with respect to a disease.\
    \ The parameters will really depend on your scientific question. You can access\
    \ the documentation for all the options with help(module) to read more about each\
    \ one. If you still aren\u2019t sure what to choose and you have a specific question\
    \ you would like to answer with your analysis, please email me with more specifics\
    \ about your scientific question and I\u2019m happy to help suggest an approach."
  created_at: 2023-06-28 05:20:30+00:00
  edited: false
  hidden: false
  id: 649bd12e5eed3f60d1793425
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-06-28T06:20:31.000Z'
    data:
      status: closed
    id: 649bd12f5eed3f60d1793426
    type: status-change
  author: ctheodoris
  created_at: 2023-06-28 05:20:31+00:00
  id: 649bd12f5eed3f60d1793426
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 52
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Error in insilicoperturber_stats
