!!python/object:huggingface_hub.community.DiscussionWithDetails
author: rkjaros
conflicting_files: null
created_at: 2023-07-20 08:40:40+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/dfa03e3406308485d93c5e7812945a3b.svg
      fullname: Rachel Jaros
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: rkjaros
      type: user
    createdAt: '2023-07-20T09:40:40.000Z'
    data:
      edited: true
      editors:
      - rkjaros
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.3748767673969269
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/dfa03e3406308485d93c5e7812945a3b.svg
          fullname: Rachel Jaros
          isHf: false
          isPro: false
          name: rkjaros
          type: user
        html: "<p>Hello, thanks again for your help on my earlier post. I have encountered\
          \ another error, I'm trying to use test data <code>cell_type_train_data.dataset</code>\
          \ to run the in silico perturber code. I am getting the below error. I assumed\
          \ this training data would be tokenised, and fine for running a test..?\
          \ I've tried with other .datasets from the repo, but I'm getting the same\
          \ error. Any ideas? Appreciate your help. Thanks very much. </p>\n<pre><code>---------------------------------------------------------------------------\n\
          KeyError                                  Traceback (most recent call last)\n\
          Cell In[16], line 2\n      1 # outputs intermediate files from in silico\
          \ perturbation - example of 1 gene\n----&gt; 2 isp.perturb_data(\"/Geneformer/geneformer-12L-30M\"\
          , \n      3                  \"/Geneformer/geneformer/cell_type_train_data.dataset\"\
          , \n      4                  \"/Geneformer/test\", \n      5           \
          \       \"smarca_test\") \n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:741,\
          \ in InSilicoPerturberMps.perturb_data(self, model_directory, input_data_file,\
          \ output_directory, output_prefix)\n    737         return example[list(self.cell_states_to_model.keys())[0]]\
          \ in [start_state]\n    739     filtered_input_data = filtered_input_data.filter(filter_for_origin,\
          \ num_proc=self.nproc)\n--&gt; 741 self.in_silico_perturb(model,\n    742\
          \                       filtered_input_data,\n    743                  \
          \     layer_to_quant,\n    744                       state_embs_dict,\n\
          \    745                       output_directory,\n    746              \
          \         output_prefix)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:839,\
          \ in InSilicoPerturberMps.in_silico_perturb(self, model, filtered_input_data,\
          \ layer_to_quant, state_embs_dict, output_directory, output_prefix)\n  \
          \  836     return example\n    838 perturbation_batch = filtered_input_data.map(make_group_perturbation_batch,\
          \ num_proc=self.nproc)\n--&gt; 839 indices_to_perturb = perturbation_batch[\"\
          perturb_index\"]\n    841 cos_sims_data = quant_cos_sims(model, \n    842\
          \                                self.perturb_type,\n    843           \
          \                     perturbation_batch, \n   (...)\n    853          \
          \                      model_input_size,\n    854                      \
          \          self.nproc)\n    856 perturbed_genes = tuple(self.tokens_to_perturb)\n\
          \nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2792,\
          \ in Dataset.__getitem__(self, key)\n   2790 def __getitem__(self, key):\
          \  # noqa: F811\n   2791     \"\"\"Can be used to index columns (by string\
          \ names) or rows (by integer index or iterable of indices or bools).\"\"\
          \"\n-&gt; 2792     return self._getitem(key)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2776,\
          \ in Dataset._getitem(self, key, **kwargs)\n   2774 format_kwargs = format_kwargs\
          \ if format_kwargs is not None else {}\n   2775 formatter = get_formatter(format_type,\
          \ features=self._info.features, **format_kwargs)\n-&gt; 2776 pa_subtable\
          \ = query_table(self._data, key, indices=self._indices if self._indices\
          \ is not None else None)\n   2777 formatted_output = format_table(\n   2778\
          \     pa_subtable, key, formatter=formatter, format_columns=format_columns,\
          \ output_all_columns=output_all_columns\n   2779 )\n   2780 return formatted_output\n\
          \nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:580,\
          \ in query_table(table, key, indices)\n    578     _raise_bad_key_type(key)\n\
          \    579 if isinstance(key, str):\n--&gt; 580     _check_valid_column_key(key,\
          \ table.column_names)\n    581 else:\n    582     size = indices.num_rows\
          \ if indices is not None else table.num_rows\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:520,\
          \ in _check_valid_column_key(key, columns)\n    518 def _check_valid_column_key(key:\
          \ str, columns: List[str]) -&gt; None:\n    519     if key not in columns:\n\
          --&gt; 520         raise KeyError(f\"Column {key} not in the dataset. Current\
          \ columns in the dataset: {columns}\")\n\nKeyError: \"Column perturb_index\
          \ not in the dataset. Current columns in the dataset: ['cell_type', 'input_ids',\
          \ 'length', 'organ_major']\"\n</code></pre>\n<p>isp here</p>\n<pre><code>isp\
          \ = InSilicoPerturberMps(perturb_type = \"delete\",\n                  \
          \      perturb_rank_shift = None,\n                        genes_to_perturb\
          \ = [\"ENSG00000127616\"], \n                        combos = 0,\n     \
          \                   anchor_gene = None,\n                        model_type\
          \ = \"Pretrained\",\n                        num_classes = 0,\n        \
          \                emb_mode = \"cell_and_gene\",\n                       \
          \ cell_emb_style = \"mean_pool\",\n                        filter_data =\
          \ None,\n                        cell_states_to_model = None,\n        \
          \                max_ncells = 2000,\n                        emb_layer =\
          \ -1,\n                        forward_batch_size = 14,\n              \
          \          nproc = 2)\n</code></pre>\n"
        raw: "Hello, thanks again for your help on my earlier post. I have encountered\
          \ another error, I'm trying to use test data `cell_type_train_data.dataset`\
          \ to run the in silico perturber code. I am getting the below error. I assumed\
          \ this training data would be tokenised, and fine for running a test..?\
          \ I've tried with other .datasets from the repo, but I'm getting the same\
          \ error. Any ideas? Appreciate your help. Thanks very much. \n\n```\n---------------------------------------------------------------------------\n\
          KeyError                                  Traceback (most recent call last)\n\
          Cell In[16], line 2\n      1 # outputs intermediate files from in silico\
          \ perturbation - example of 1 gene\n----> 2 isp.perturb_data(\"/Geneformer/geneformer-12L-30M\"\
          , \n      3                  \"/Geneformer/geneformer/cell_type_train_data.dataset\"\
          , \n      4                  \"/Geneformer/test\", \n      5           \
          \       \"smarca_test\") \n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:741,\
          \ in InSilicoPerturberMps.perturb_data(self, model_directory, input_data_file,\
          \ output_directory, output_prefix)\n    737         return example[list(self.cell_states_to_model.keys())[0]]\
          \ in [start_state]\n    739     filtered_input_data = filtered_input_data.filter(filter_for_origin,\
          \ num_proc=self.nproc)\n--> 741 self.in_silico_perturb(model,\n    742 \
          \                      filtered_input_data,\n    743                   \
          \    layer_to_quant,\n    744                       state_embs_dict,\n \
          \   745                       output_directory,\n    746               \
          \        output_prefix)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:839,\
          \ in InSilicoPerturberMps.in_silico_perturb(self, model, filtered_input_data,\
          \ layer_to_quant, state_embs_dict, output_directory, output_prefix)\n  \
          \  836     return example\n    838 perturbation_batch = filtered_input_data.map(make_group_perturbation_batch,\
          \ num_proc=self.nproc)\n--> 839 indices_to_perturb = perturbation_batch[\"\
          perturb_index\"]\n    841 cos_sims_data = quant_cos_sims(model, \n    842\
          \                                self.perturb_type,\n    843           \
          \                     perturbation_batch, \n   (...)\n    853          \
          \                      model_input_size,\n    854                      \
          \          self.nproc)\n    856 perturbed_genes = tuple(self.tokens_to_perturb)\n\
          \nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2792,\
          \ in Dataset.__getitem__(self, key)\n   2790 def __getitem__(self, key):\
          \  # noqa: F811\n   2791     \"\"\"Can be used to index columns (by string\
          \ names) or rows (by integer index or iterable of indices or bools).\"\"\
          \"\n-> 2792     return self._getitem(key)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2776,\
          \ in Dataset._getitem(self, key, **kwargs)\n   2774 format_kwargs = format_kwargs\
          \ if format_kwargs is not None else {}\n   2775 formatter = get_formatter(format_type,\
          \ features=self._info.features, **format_kwargs)\n-> 2776 pa_subtable =\
          \ query_table(self._data, key, indices=self._indices if self._indices is\
          \ not None else None)\n   2777 formatted_output = format_table(\n   2778\
          \     pa_subtable, key, formatter=formatter, format_columns=format_columns,\
          \ output_all_columns=output_all_columns\n   2779 )\n   2780 return formatted_output\n\
          \nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:580,\
          \ in query_table(table, key, indices)\n    578     _raise_bad_key_type(key)\n\
          \    579 if isinstance(key, str):\n--> 580     _check_valid_column_key(key,\
          \ table.column_names)\n    581 else:\n    582     size = indices.num_rows\
          \ if indices is not None else table.num_rows\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:520,\
          \ in _check_valid_column_key(key, columns)\n    518 def _check_valid_column_key(key:\
          \ str, columns: List[str]) -> None:\n    519     if key not in columns:\n\
          --> 520         raise KeyError(f\"Column {key} not in the dataset. Current\
          \ columns in the dataset: {columns}\")\n\nKeyError: \"Column perturb_index\
          \ not in the dataset. Current columns in the dataset: ['cell_type', 'input_ids',\
          \ 'length', 'organ_major']\"\n```\n\nisp here\n```\nisp = InSilicoPerturberMps(perturb_type\
          \ = \"delete\",\n                        perturb_rank_shift = None,\n  \
          \                      genes_to_perturb = [\"ENSG00000127616\"], \n    \
          \                    combos = 0,\n                        anchor_gene =\
          \ None,\n                        model_type = \"Pretrained\",\n        \
          \                num_classes = 0,\n                        emb_mode = \"\
          cell_and_gene\",\n                        cell_emb_style = \"mean_pool\"\
          ,\n                        filter_data = None,\n                       \
          \ cell_states_to_model = None,\n                        max_ncells = 2000,\n\
          \                        emb_layer = -1,\n                        forward_batch_size\
          \ = 14,\n                        nproc = 2)\n```"
        updatedAt: '2023-07-20T09:42:23.671Z'
      numEdits: 1
      reactions: []
    id: 64b901188b53fb5dbdffb797
    type: comment
  author: rkjaros
  content: "Hello, thanks again for your help on my earlier post. I have encountered\
    \ another error, I'm trying to use test data `cell_type_train_data.dataset` to\
    \ run the in silico perturber code. I am getting the below error. I assumed this\
    \ training data would be tokenised, and fine for running a test..? I've tried\
    \ with other .datasets from the repo, but I'm getting the same error. Any ideas?\
    \ Appreciate your help. Thanks very much. \n\n```\n---------------------------------------------------------------------------\n\
    KeyError                                  Traceback (most recent call last)\n\
    Cell In[16], line 2\n      1 # outputs intermediate files from in silico perturbation\
    \ - example of 1 gene\n----> 2 isp.perturb_data(\"/Geneformer/geneformer-12L-30M\"\
    , \n      3                  \"/Geneformer/geneformer/cell_type_train_data.dataset\"\
    , \n      4                  \"/Geneformer/test\", \n      5                 \
    \ \"smarca_test\") \n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:741,\
    \ in InSilicoPerturberMps.perturb_data(self, model_directory, input_data_file,\
    \ output_directory, output_prefix)\n    737         return example[list(self.cell_states_to_model.keys())[0]]\
    \ in [start_state]\n    739     filtered_input_data = filtered_input_data.filter(filter_for_origin,\
    \ num_proc=self.nproc)\n--> 741 self.in_silico_perturb(model,\n    742       \
    \                filtered_input_data,\n    743                       layer_to_quant,\n\
    \    744                       state_embs_dict,\n    745                     \
    \  output_directory,\n    746                       output_prefix)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/geneformer/in_silico_perturber_mps.py:839,\
    \ in InSilicoPerturberMps.in_silico_perturb(self, model, filtered_input_data,\
    \ layer_to_quant, state_embs_dict, output_directory, output_prefix)\n    836 \
    \    return example\n    838 perturbation_batch = filtered_input_data.map(make_group_perturbation_batch,\
    \ num_proc=self.nproc)\n--> 839 indices_to_perturb = perturbation_batch[\"perturb_index\"\
    ]\n    841 cos_sims_data = quant_cos_sims(model, \n    842                   \
    \             self.perturb_type,\n    843                                perturbation_batch,\
    \ \n   (...)\n    853                                model_input_size,\n    854\
    \                                self.nproc)\n    856 perturbed_genes = tuple(self.tokens_to_perturb)\n\
    \nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2792,\
    \ in Dataset.__getitem__(self, key)\n   2790 def __getitem__(self, key):  # noqa:\
    \ F811\n   2791     \"\"\"Can be used to index columns (by string names) or rows\
    \ (by integer index or iterable of indices or bools).\"\"\"\n-> 2792     return\
    \ self._getitem(key)\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/arrow_dataset.py:2776,\
    \ in Dataset._getitem(self, key, **kwargs)\n   2774 format_kwargs = format_kwargs\
    \ if format_kwargs is not None else {}\n   2775 formatter = get_formatter(format_type,\
    \ features=self._info.features, **format_kwargs)\n-> 2776 pa_subtable = query_table(self._data,\
    \ key, indices=self._indices if self._indices is not None else None)\n   2777\
    \ formatted_output = format_table(\n   2778     pa_subtable, key, formatter=formatter,\
    \ format_columns=format_columns, output_all_columns=output_all_columns\n   2779\
    \ )\n   2780 return formatted_output\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:580,\
    \ in query_table(table, key, indices)\n    578     _raise_bad_key_type(key)\n\
    \    579 if isinstance(key, str):\n--> 580     _check_valid_column_key(key, table.column_names)\n\
    \    581 else:\n    582     size = indices.num_rows if indices is not None else\
    \ table.num_rows\n\nFile ~/anaconda3/envs/torch-gpu/lib/python3.8/site-packages/datasets/formatting/formatting.py:520,\
    \ in _check_valid_column_key(key, columns)\n    518 def _check_valid_column_key(key:\
    \ str, columns: List[str]) -> None:\n    519     if key not in columns:\n--> 520\
    \         raise KeyError(f\"Column {key} not in the dataset. Current columns in\
    \ the dataset: {columns}\")\n\nKeyError: \"Column perturb_index not in the dataset.\
    \ Current columns in the dataset: ['cell_type', 'input_ids', 'length', 'organ_major']\"\
    \n```\n\nisp here\n```\nisp = InSilicoPerturberMps(perturb_type = \"delete\",\n\
    \                        perturb_rank_shift = None,\n                        genes_to_perturb\
    \ = [\"ENSG00000127616\"], \n                        combos = 0,\n           \
    \             anchor_gene = None,\n                        model_type = \"Pretrained\"\
    ,\n                        num_classes = 0,\n                        emb_mode\
    \ = \"cell_and_gene\",\n                        cell_emb_style = \"mean_pool\"\
    ,\n                        filter_data = None,\n                        cell_states_to_model\
    \ = None,\n                        max_ncells = 2000,\n                      \
    \  emb_layer = -1,\n                        forward_batch_size = 14,\n       \
    \                 nproc = 2)\n```"
  created_at: 2023-07-20 08:40:40+00:00
  edited: true
  hidden: false
  id: 64b901188b53fb5dbdffb797
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-20T14:12:02.000Z'
    data:
      edited: false
      editors:
      - ctheodoris
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8742153644561768
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
          fullname: Christina Theodoris
          isHf: false
          isPro: false
          name: ctheodoris
          type: user
        html: '<p>Thank you for your interest in Geneformer! This may be related to
          a closed issue regarding the value of min_genes when filtering for cells
          containing the genes to perturb. Please pull the updated version if you
          are not in the current version. Feel free to reopen if you are still encountering
          the error. </p>

          '
        raw: 'Thank you for your interest in Geneformer! This may be related to a
          closed issue regarding the value of min_genes when filtering for cells containing
          the genes to perturb. Please pull the updated version if you are not in
          the current version. Feel free to reopen if you are still encountering the
          error. '
        updatedAt: '2023-07-20T14:12:02.833Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - rkjaros
      relatedEventId: 64b940b28c12f0008ba41b53
    id: 64b940b28c12f0008ba41b4e
    type: comment
  author: ctheodoris
  content: 'Thank you for your interest in Geneformer! This may be related to a closed
    issue regarding the value of min_genes when filtering for cells containing the
    genes to perturb. Please pull the updated version if you are not in the current
    version. Feel free to reopen if you are still encountering the error. '
  created_at: 2023-07-20 13:12:02+00:00
  edited: false
  hidden: false
  id: 64b940b28c12f0008ba41b4e
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1671502872617-622d085c8d04fd29a9ccf169.png?w=200&h=200&f=face
      fullname: Christina Theodoris
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: ctheodoris
      type: user
    createdAt: '2023-07-20T14:12:02.000Z'
    data:
      status: closed
    id: 64b940b28c12f0008ba41b53
    type: status-change
  author: ctheodoris
  created_at: 2023-07-20 13:12:02+00:00
  id: 64b940b28c12f0008ba41b53
  new_status: closed
  type: status-change
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/dfa03e3406308485d93c5e7812945a3b.svg
      fullname: Rachel Jaros
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: rkjaros
      type: user
    createdAt: '2023-07-20T23:06:06.000Z'
    data:
      edited: false
      editors:
      - rkjaros
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9783775210380554
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/dfa03e3406308485d93c5e7812945a3b.svg
          fullname: Rachel Jaros
          isHf: false
          isPro: false
          name: rkjaros
          type: user
        html: '<p>Thank you. Apologies for missing the closed issue. </p>

          '
        raw: 'Thank you. Apologies for missing the closed issue. '
        updatedAt: '2023-07-20T23:06:06.450Z'
      numEdits: 0
      reactions: []
    id: 64b9bdde356eeb0d8cc0d099
    type: comment
  author: rkjaros
  content: 'Thank you. Apologies for missing the closed issue. '
  created_at: 2023-07-20 22:06:06+00:00
  edited: false
  hidden: false
  id: 64b9bdde356eeb0d8cc0d099
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 129
repo_id: ctheodoris/Geneformer
repo_type: model
status: closed
target_branch: null
title: Error in .dataset columns for in silico perturber. 'Column perturb_index not
  in the dataset.'
