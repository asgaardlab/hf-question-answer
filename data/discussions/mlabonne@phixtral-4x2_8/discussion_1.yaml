!!python/object:huggingface_hub.community.DiscussionWithDetails
author: vince62s
conflicting_files: null
created_at: 2024-01-08 19:46:45+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-08T19:46:45.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8324870467185974
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>Hi,<br>With OpenNMT-py it''s modular, like parallel_residual=True,
          Shared_LayerNorm=True, code base does not change.<br>So if I hack my current
          converters to convert Phi to OpenNMT-py weights, running in MoE mode should
          be straight forward since I already run Mixtral.</p>

          '
        raw: "Hi,\r\nWith OpenNMT-py it's modular, like parallel_residual=True, Shared_LayerNorm=True,\
          \ code base does not change.\r\nSo if I hack my current converters to convert\
          \ Phi to OpenNMT-py weights, running in MoE mode should be straight forward\
          \ since I already run Mixtral."
        updatedAt: '2024-01-08T19:46:45.086Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - mlabonne
    id: 659c512538186a51f1065292
    type: comment
  author: vince62s
  content: "Hi,\r\nWith OpenNMT-py it's modular, like parallel_residual=True, Shared_LayerNorm=True,\
    \ code base does not change.\r\nSo if I hack my current converters to convert\
    \ Phi to OpenNMT-py weights, running in MoE mode should be straight forward since\
    \ I already run Mixtral."
  created_at: 2024-01-08 19:46:45+00:00
  edited: false
  hidden: false
  id: 659c512538186a51f1065292
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-08T19:50:24.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9280232191085815
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: '<p>Hi, I''m not familiar with OpenNMT-py but this sounds great. Happy
          to see the results if you manage to run it!</p>

          '
        raw: Hi, I'm not familiar with OpenNMT-py but this sounds great. Happy to
          see the results if you manage to run it!
        updatedAt: '2024-01-08T19:50:24.413Z'
      numEdits: 0
      reactions: []
    id: 659c52007062fcaf52d77397
    type: comment
  author: mlabonne
  content: Hi, I'm not familiar with OpenNMT-py but this sounds great. Happy to see
    the results if you manage to run it!
  created_at: 2024-01-08 19:50:24+00:00
  edited: false
  hidden: false
  id: 659c52007062fcaf52d77397
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-08T20:21:13.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.969338059425354
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>for some reason the merge renamed the ff layers from fc1/fc2 to
          w1/w2 to take the mixtral naming convention.<br>I''ll look further tomorrow
          but IMO it would be better to keep the Phi namings.</p>

          '
        raw: 'for some reason the merge renamed the ff layers from fc1/fc2 to w1/w2
          to take the mixtral naming convention.

          I''ll look further tomorrow but IMO it would be better to keep the Phi namings.'
        updatedAt: '2024-01-08T20:21:13.153Z'
      numEdits: 0
      reactions: []
    id: 659c59390819a2ee79ffd48b
    type: comment
  author: vince62s
  content: 'for some reason the merge renamed the ff layers from fc1/fc2 to w1/w2
    to take the mixtral naming convention.

    I''ll look further tomorrow but IMO it would be better to keep the Phi namings.'
  created_at: 2024-01-08 20:21:13+00:00
  edited: false
  hidden: false
  id: 659c59390819a2ee79ffd48b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-08T20:33:32.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9627568125724792
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: '<p>Oops yeah, I renamed them. Is fc1/fc2 =&gt; w1/w2 the only issue
          with the names? I can change it if it makes it easier for you.</p>

          '
        raw: Oops yeah, I renamed them. Is fc1/fc2 => w1/w2 the only issue with the
          names? I can change it if it makes it easier for you.
        updatedAt: '2024-01-08T20:33:32.077Z'
      numEdits: 0
      reactions: []
    id: 659c5c1c442979361cb9e1ea
    type: comment
  author: mlabonne
  content: Oops yeah, I renamed them. Is fc1/fc2 => w1/w2 the only issue with the
    names? I can change it if it makes it easier for you.
  created_at: 2024-01-08 20:33:32+00:00
  edited: false
  hidden: false
  id: 659c5c1c442979361cb9e1ea
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-08T21:04:06.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8991701602935791
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>ideally if you want to make it work with HF and slight changes in
          modeling_phi.py  you may also rename block_sparse_moe =&gt; moe and experts
          =&gt; mlp<br>then we just need to add a class MoE(nn.Module) in modeling_phi.py</p>

          '
        raw: 'ideally if you want to make it work with HF and slight changes in modeling_phi.py  you
          may also rename block_sparse_moe => moe and experts => mlp

          then we just need to add a class MoE(nn.Module) in modeling_phi.py'
        updatedAt: '2024-01-08T21:04:06.535Z'
      numEdits: 0
      reactions: []
    id: 659c634653812b703469521c
    type: comment
  author: vince62s
  content: 'ideally if you want to make it work with HF and slight changes in modeling_phi.py  you
    may also rename block_sparse_moe => moe and experts => mlp

    then we just need to add a class MoE(nn.Module) in modeling_phi.py'
  created_at: 2024-01-08 21:04:06+00:00
  edited: false
  hidden: false
  id: 659c634653812b703469521c
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-08T21:49:56.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.4733660817146301
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: '<p>Cool! Can you confirm that the following is correct?</p>

          <pre><code class="language-python">moe_tensor_name = tensor_name.replace(<span
          class="hljs-string">"mlp.fc1.bias"</span>, <span class="hljs-string">f"moe.mlp.<span
          class="hljs-subst">{moe_index}</span>.fc1.bias"</span>)

          moe_tensor_name = moe_tensor_name.replace(<span class="hljs-string">"mlp.fc1.weight"</span>,
          <span class="hljs-string">f"moe.mlp.<span class="hljs-subst">{moe_index}</span>.fc1.weight"</span>)

          moe_tensor_name = moe_tensor_name.replace(<span class="hljs-string">"mlp.fc2.bias"</span>,
          <span class="hljs-string">f"moe.mlp.<span class="hljs-subst">{moe_index}</span>.fc2.bias"</span>)

          moe_tensor_name = moe_tensor_name.replace(<span class="hljs-string">"mlp.fc2.weight"</span>,
          <span class="hljs-string">f"moe.mlp.<span class="hljs-subst">{moe_index}</span>.fc2.weight"</span>)

          </code></pre>

          '
        raw: 'Cool! Can you confirm that the following is correct?


          ```python

          moe_tensor_name = tensor_name.replace("mlp.fc1.bias", f"moe.mlp.{moe_index}.fc1.bias")

          moe_tensor_name = moe_tensor_name.replace("mlp.fc1.weight", f"moe.mlp.{moe_index}.fc1.weight")

          moe_tensor_name = moe_tensor_name.replace("mlp.fc2.bias", f"moe.mlp.{moe_index}.fc2.bias")

          moe_tensor_name = moe_tensor_name.replace("mlp.fc2.weight", f"moe.mlp.{moe_index}.fc2.weight")

          ```'
        updatedAt: '2024-01-08T21:49:56.768Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - vince62s
    id: 659c6e04d9a59ad53d61c4b2
    type: comment
  author: mlabonne
  content: 'Cool! Can you confirm that the following is correct?


    ```python

    moe_tensor_name = tensor_name.replace("mlp.fc1.bias", f"moe.mlp.{moe_index}.fc1.bias")

    moe_tensor_name = moe_tensor_name.replace("mlp.fc1.weight", f"moe.mlp.{moe_index}.fc1.weight")

    moe_tensor_name = moe_tensor_name.replace("mlp.fc2.bias", f"moe.mlp.{moe_index}.fc2.bias")

    moe_tensor_name = moe_tensor_name.replace("mlp.fc2.weight", f"moe.mlp.{moe_index}.fc2.weight")

    ```'
  created_at: 2024-01-08 21:49:56+00:00
  edited: false
  hidden: false
  id: 659c6e04d9a59ad53d61c4b2
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-09T08:56:09.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9488530158996582
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>I think I got it working. I patched model_phi.py with the wrong
          names so if you fix the tensors names I''ll push it with the right names.</p>

          '
        raw: 'I think I got it working. I patched model_phi.py with the wrong names
          so if you fix the tensors names I''ll push it with the right names.

          '
        updatedAt: '2024-01-09T08:56:09.122Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - mlabonne
    id: 659d0a29b0a929902c4dab79
    type: comment
  author: vince62s
  content: 'I think I got it working. I patched model_phi.py with the wrong names
    so if you fix the tensors names I''ll push it with the right names.

    '
  created_at: 2024-01-09 08:56:09+00:00
  edited: false
  hidden: false
  id: 659d0a29b0a929902c4dab79
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ae3c79f17aa7f2f91071ff94413a6b94.svg
      fullname: Aman Gokrani
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: agokrani
      type: user
    createdAt: '2024-01-13T08:53:53.000Z'
    data:
      edited: true
      editors:
      - agokrani
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9655957221984863
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ae3c79f17aa7f2f91071ff94413a6b94.svg
          fullname: Aman Gokrani
          isHf: false
          isPro: false
          name: agokrani
          type: user
        html: "<p>Hi <span data-props=\"{&quot;user&quot;:&quot;vince62s&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/vince62s\"\
          >@<span class=\"underline\">vince62s</span></a></span>\n\n\t</span></span>,</p>\n\
          <p>I assume this is not working with huggingface weights of Phi2. Is it\
          \ possible to support that? </p>\n"
        raw: "Hi @vince62s,\n\nI assume this is not working with huggingface weights\
          \ of Phi2. Is it possible to support that? \n"
        updatedAt: '2024-01-13T09:13:56.088Z'
      numEdits: 1
      reactions: []
    id: 65a24fa13522df7a2769d29f
    type: comment
  author: agokrani
  content: "Hi @vince62s,\n\nI assume this is not working with huggingface weights\
    \ of Phi2. Is it possible to support that? \n"
  created_at: 2024-01-13 08:53:53+00:00
  edited: true
  hidden: false
  id: 65a24fa13522df7a2769d29f
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-13T10:39:26.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9944772124290466
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>Not sure what your question is but I made it work with HF, look
          at  the model card.</p>

          '
        raw: Not sure what your question is but I made it work with HF, look at  the
          model card.
        updatedAt: '2024-01-13T10:39:26.938Z'
      numEdits: 0
      reactions: []
    id: 65a2685e8448f47df2ae1926
    type: comment
  author: vince62s
  content: Not sure what your question is but I made it work with HF, look at  the
    model card.
  created_at: 2024-01-13 10:39:26+00:00
  edited: false
  hidden: false
  id: 65a2685e8448f47df2ae1926
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/ae3c79f17aa7f2f91071ff94413a6b94.svg
      fullname: Aman Gokrani
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: agokrani
      type: user
    createdAt: '2024-01-13T11:32:09.000Z'
    data:
      edited: false
      editors:
      - agokrani
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9675116539001465
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/ae3c79f17aa7f2f91071ff94413a6b94.svg
          fullname: Aman Gokrani
          isHf: false
          isPro: false
          name: agokrani
          type: user
        html: '<p>So there are two implementations of phi2 one by Microsoft which
          requires trust_remote_code = True. There is another implementation which
          is actually in transformers official repo. The weights are available in
          this repo: susnato/phi-2</p>

          <p>So I was wondering if it would possible to support this as well. I think
          its more or less copying MOE class and calling it in correct places with
          correct dimensions.</p>

          '
        raw: 'So there are two implementations of phi2 one by Microsoft which requires
          trust_remote_code = True. There is another implementation which is actually
          in transformers official repo. The weights are available in this repo: susnato/phi-2


          So I was wondering if it would possible to support this as well. I think
          its more or less copying MOE class and calling it in correct places with
          correct dimensions.'
        updatedAt: '2024-01-13T11:32:09.320Z'
      numEdits: 0
      reactions: []
    id: 65a274b9c4034f4ed7662db6
    type: comment
  author: agokrani
  content: 'So there are two implementations of phi2 one by Microsoft which requires
    trust_remote_code = True. There is another implementation which is actually in
    transformers official repo. The weights are available in this repo: susnato/phi-2


    So I was wondering if it would possible to support this as well. I think its more
    or less copying MOE class and calling it in correct places with correct dimensions.'
  created_at: 2024-01-13 11:32:09+00:00
  edited: false
  hidden: false
  id: 65a274b9c4034f4ed7662db6
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-13T12:45:20.000Z'
    data:
      edited: false
      editors:
      - vince62s
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9838110208511353
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
          fullname: VincentN
          isHf: false
          isPro: false
          name: vince62s
          type: user
        html: '<p>this would require HF to accept a PR on modeling_phi.py in the official
          transformers repo, which I don''t think is possbile at the moment. so best
          is to use this repo for now.</p>

          '
        raw: this would require HF to accept a PR on modeling_phi.py in the official
          transformers repo, which I don't think is possbile at the moment. so best
          is to use this repo for now.
        updatedAt: '2024-01-13T12:45:20.566Z'
      numEdits: 0
      reactions: []
    id: 65a285e09b0ac6aafc47fd52
    type: comment
  author: vince62s
  content: this would require HF to accept a PR on modeling_phi.py in the official
    transformers repo, which I don't think is possbile at the moment. so best is to
    use this repo for now.
  created_at: 2024-01-13 12:45:20+00:00
  edited: false
  hidden: false
  id: 65a285e09b0ac6aafc47fd52
  type: comment
- !!python/object:huggingface_hub.community.DiscussionStatusChange
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6495b47a74ce69cc4eab61f0/2eg17fMXjshpfQfSq5jyP.png?w=200&h=200&f=face
      fullname: VincentN
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: vince62s
      type: user
    createdAt: '2024-01-15T18:54:36.000Z'
    data:
      status: closed
    id: 65a57f6c03ed32723498e4db
    type: status-change
  author: vince62s
  created_at: 2024-01-15 18:54:36+00:00
  id: 65a57f6c03ed32723498e4db
  new_status: closed
  type: status-change
is_pull_request: false
merge_commit_oid: null
num: 1
repo_id: mlabonne/phixtral-4x2_8
repo_type: model
status: closed
target_branch: null
title: converting Phi
