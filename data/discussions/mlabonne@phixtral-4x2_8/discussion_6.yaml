!!python/object:huggingface_hub.community.DiscussionWithDetails
author: osanseviero
conflicting_files: null
created_at: 2024-01-11 15:16:33+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6032802e1f993496bc14d9e3/w6hr-DEQot4VVkoyRIBiy.png?w=200&h=200&f=face
      fullname: Omar Sanseviero
      isHf: true
      isOrgMember: false
      isOwner: false
      isPro: false
      name: osanseviero
      type: user
    createdAt: '2024-01-11T15:16:33.000Z'
    data:
      edited: false
      editors:
      - osanseviero
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9789843559265137
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6032802e1f993496bc14d9e3/w6hr-DEQot4VVkoyRIBiy.png?w=200&h=200&f=face
          fullname: Omar Sanseviero
          isHf: true
          isPro: false
          name: osanseviero
          type: user
        html: '<p>How was the gating trained here? I don''t see <code>positive_prompts</code>
          in the model card metadata</p>

          '
        raw: How was the gating trained here? I don't see `positive_prompts` in the
          model card metadata
        updatedAt: '2024-01-11T15:16:33.188Z'
      numEdits: 0
      reactions: []
    id: 65a00651230f8846b1594c4b
    type: comment
  author: osanseviero
  content: How was the gating trained here? I don't see `positive_prompts` in the
    model card metadata
  created_at: 2024-01-11 15:16:33+00:00
  edited: false
  hidden: false
  id: 65a00651230f8846b1594c4b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-11T21:35:19.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.987549364566803
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: '<p>It hasn''t been trained (yet), unfortunately. It looks like the
          two first experts are always selected because of that.</p>

          <p>I''m working a little bit more on the 2x version before moving to fine-tuning.</p>

          '
        raw: 'It hasn''t been trained (yet), unfortunately. It looks like the two
          first experts are always selected because of that.


          I''m working a little bit more on the 2x version before moving to fine-tuning.'
        updatedAt: '2024-01-11T21:35:19.758Z'
      numEdits: 0
      reactions: []
    id: 65a05f17fbad78ab68e64fc7
    type: comment
  author: mlabonne
  content: 'It hasn''t been trained (yet), unfortunately. It looks like the two first
    experts are always selected because of that.


    I''m working a little bit more on the 2x version before moving to fine-tuning.'
  created_at: 2024-01-11 21:35:19+00:00
  edited: false
  hidden: false
  id: 65a05f17fbad78ab68e64fc7
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
      fullname: hai
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: cloudyu
      type: user
    createdAt: '2024-01-12T01:40:28.000Z'
    data:
      edited: false
      editors:
      - cloudyu
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8654754161834717
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
          fullname: hai
          isHf: false
          isPro: false
          name: cloudyu
          type: user
        html: '<p>you don''t need finetune at all.<br>just to change the value of
          num_experts_per_tok to 4.<br>here I have a quick test, <a rel="nofollow"
          href="https://www.reddit.com/r/LocalLLaMA/comments/193zr7l/the_secret_to_improve_the_performance_of_mixtral/">https://www.reddit.com/r/LocalLLaMA/comments/193zr7l/the_secret_to_improve_the_performance_of_mixtral/</a></p>

          '
        raw: 'you don''t need finetune at all.

          just to change the value of num_experts_per_tok to 4.

          here I have a quick test, https://www.reddit.com/r/LocalLLaMA/comments/193zr7l/the_secret_to_improve_the_performance_of_mixtral/'
        updatedAt: '2024-01-12T01:40:28.685Z'
      numEdits: 0
      reactions: []
    id: 65a0988cbbbb7b8dd18766fb
    type: comment
  author: cloudyu
  content: 'you don''t need finetune at all.

    just to change the value of num_experts_per_tok to 4.

    here I have a quick test, https://www.reddit.com/r/LocalLLaMA/comments/193zr7l/the_secret_to_improve_the_performance_of_mixtral/'
  created_at: 2024-01-12 01:40:28+00:00
  edited: false
  hidden: false
  id: 65a0988cbbbb7b8dd18766fb
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6032802e1f993496bc14d9e3/w6hr-DEQot4VVkoyRIBiy.png?w=200&h=200&f=face
      fullname: Omar Sanseviero
      isHf: true
      isOrgMember: false
      isOwner: false
      isPro: false
      name: osanseviero
      type: user
    createdAt: '2024-01-12T08:45:16.000Z'
    data:
      edited: false
      editors:
      - osanseviero
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9713708162307739
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/6032802e1f993496bc14d9e3/w6hr-DEQot4VVkoyRIBiy.png?w=200&h=200&f=face
          fullname: Omar Sanseviero
          isHf: true
          isPro: false
          name: osanseviero
          type: user
        html: '<p>That would activate more experts which would increase the number
          of activated parameters. Ideally we should be able to route tokens to the
          expert that will handle them the best</p>

          '
        raw: That would activate more experts which would increase the number of activated
          parameters. Ideally we should be able to route tokens to the expert that
          will handle them the best
        updatedAt: '2024-01-12T08:45:16.993Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - mlabonne
    id: 65a0fc1c43089476d820ac24
    type: comment
  author: osanseviero
  content: That would activate more experts which would increase the number of activated
    parameters. Ideally we should be able to route tokens to the expert that will
    handle them the best
  created_at: 2024-01-12 08:45:16+00:00
  edited: false
  hidden: false
  id: 65a0fc1c43089476d820ac24
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
      fullname: hai
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: cloudyu
      type: user
    createdAt: '2024-01-12T09:47:30.000Z'
    data:
      edited: false
      editors:
      - cloudyu
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9690474271774292
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
          fullname: hai
          isHf: false
          isPro: false
          name: cloudyu
          type: user
        html: '<blockquote>

          <p>That would activate more experts which would increase the number of activated
          parameters. Ideally we should be able to route tokens to the expert that
          will handle them the best</p>

          </blockquote>

          <p>maybe when training, all experts should be active</p>

          '
        raw: '> That would activate more experts which would increase the number of
          activated parameters. Ideally we should be able to route tokens to the expert
          that will handle them the best


          maybe when training, all experts should be active'
        updatedAt: '2024-01-12T09:47:30.432Z'
      numEdits: 0
      reactions: []
    id: 65a10ab244d2a6d6fbd18078
    type: comment
  author: cloudyu
  content: '> That would activate more experts which would increase the number of
    activated parameters. Ideally we should be able to route tokens to the expert
    that will handle them the best


    maybe when training, all experts should be active'
  created_at: 2024-01-12 09:47:30+00:00
  edited: false
  hidden: false
  id: 65a10ab244d2a6d6fbd18078
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
      fullname: hai
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: cloudyu
      type: user
    createdAt: '2024-01-12T09:48:00.000Z'
    data:
      edited: false
      editors:
      - cloudyu
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9809295535087585
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
          fullname: hai
          isHf: false
          isPro: false
          name: cloudyu
          type: user
        html: '<blockquote>

          <p>That would activate more experts which would increase the number of activated
          parameters. Ideally we should be able to route tokens to the expert that
          will handle them the best</p>

          </blockquote>

          <p>this is very small model, doesn''t matter</p>

          '
        raw: '> That would activate more experts which would increase the number of
          activated parameters. Ideally we should be able to route tokens to the expert
          that will handle them the best


          this is very small model, doesn''t matter'
        updatedAt: '2024-01-12T09:48:00.104Z'
      numEdits: 0
      reactions: []
    id: 65a10ad064520347aa8f9cac
    type: comment
  author: cloudyu
  content: '> That would activate more experts which would increase the number of
    activated parameters. Ideally we should be able to route tokens to the expert
    that will handle them the best


    this is very small model, doesn''t matter'
  created_at: 2024-01-12 09:48:00+00:00
  edited: false
  hidden: false
  id: 65a10ad064520347aa8f9cac
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-12T11:52:55.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8830005526542664
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;cloudyu&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/cloudyu\">@<span class=\"\
          underline\">cloudyu</span></a></span>\n\n\t</span></span> For sure but this\
          \ kind of defeats the purpose of the architecture imo. A cheap way of fixing\
          \ it is just adding noise to the gating weights (@mrclbschff on Twitter\
          \ did it). A better way is fine-tuning them, especially with a positive\
          \ prompt initialization \xE0 la mergekit.</p>\n"
        raw: "@cloudyu For sure but this kind of defeats the purpose of the architecture\
          \ imo. A cheap way of fixing it is just adding noise to the gating weights\
          \ (@mrclbschff on Twitter did it). A better way is fine-tuning them, especially\
          \ with a positive prompt initialization \xE0 la mergekit."
        updatedAt: '2024-01-12T11:52:55.714Z'
      numEdits: 0
      reactions: []
    id: 65a128179185dcca308aadad
    type: comment
  author: mlabonne
  content: "@cloudyu For sure but this kind of defeats the purpose of the architecture\
    \ imo. A cheap way of fixing it is just adding noise to the gating weights (@mrclbschff\
    \ on Twitter did it). A better way is fine-tuning them, especially with a positive\
    \ prompt initialization \xE0 la mergekit."
  created_at: 2024-01-12 11:52:55+00:00
  edited: false
  hidden: false
  id: 65a128179185dcca308aadad
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
      fullname: hai
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: cloudyu
      type: user
    createdAt: '2024-01-12T12:13:01.000Z'
    data:
      edited: false
      editors:
      - cloudyu
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9129488468170166
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
          fullname: hai
          isHf: false
          isPro: false
          name: cloudyu
          type: user
        html: "<blockquote>\n<p><span data-props=\"{&quot;user&quot;:&quot;cloudyu&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/cloudyu\"\
          >@<span class=\"underline\">cloudyu</span></a></span>\n\n\t</span></span>\
          \ For sure but this kind of defeats the purpose of the architecture, imo.\
          \ A cheap way of fixing it is just adding noise to the gating weights (@mrclbschff\
          \ on Twitter did it). A better way is fine-tuning them, especially with\
          \ a positive prompt initialization \xE0 la mergekit.</p>\n</blockquote>\n\
          <p>maybe when fine-tuning, all experts should be active that means to set\
          \  num_experts_per_tok to max. while training finished, set num_experts_per_tok\
          \ = 2.<br>this is my guess.</p>\n"
        raw: "> @cloudyu For sure but this kind of defeats the purpose of the architecture,\
          \ imo. A cheap way of fixing it is just adding noise to the gating weights\
          \ (@mrclbschff on Twitter did it). A better way is fine-tuning them, especially\
          \ with a positive prompt initialization \xE0 la mergekit.\n\nmaybe when\
          \ fine-tuning, all experts should be active that means to set  num_experts_per_tok\
          \ to max. while training finished, set num_experts_per_tok = 2.\nthis is\
          \ my guess."
        updatedAt: '2024-01-12T12:13:01.929Z'
      numEdits: 0
      reactions: []
    id: 65a12ccd19665f7549908878
    type: comment
  author: cloudyu
  content: "> @cloudyu For sure but this kind of defeats the purpose of the architecture,\
    \ imo. A cheap way of fixing it is just adding noise to the gating weights (@mrclbschff\
    \ on Twitter did it). A better way is fine-tuning them, especially with a positive\
    \ prompt initialization \xE0 la mergekit.\n\nmaybe when fine-tuning, all experts\
    \ should be active that means to set  num_experts_per_tok to max. while training\
    \ finished, set num_experts_per_tok = 2.\nthis is my guess."
  created_at: 2024-01-12 12:13:01+00:00
  edited: false
  hidden: false
  id: 65a12ccd19665f7549908878
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
      fullname: Maxime Labonne
      isHf: false
      isOrgMember: false
      isOwner: true
      isPro: false
      name: mlabonne
      type: user
    createdAt: '2024-01-12T13:37:42.000Z'
    data:
      edited: false
      editors:
      - mlabonne
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9799376130104065
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/61b8e2ba285851687028d395/4XZP5aVsMWwzGx_313cqd.jpeg?w=200&h=200&f=face
          fullname: Maxime Labonne
          isHf: false
          isPro: false
          name: mlabonne
          type: user
        html: '<p>In this case, you won''t train your gating weights to select the
          best experts (since you''re using all of them anyway). I think it''s important
          to have the same number of num_experts_per_tok for training and inference.</p>

          '
        raw: In this case, you won't train your gating weights to select the best
          experts (since you're using all of them anyway). I think it's important
          to have the same number of num_experts_per_tok for training and inference.
        updatedAt: '2024-01-12T13:37:42.958Z'
      numEdits: 0
      reactions: []
    id: 65a140a6684c018bd429626b
    type: comment
  author: mlabonne
  content: In this case, you won't train your gating weights to select the best experts
    (since you're using all of them anyway). I think it's important to have the same
    number of num_experts_per_tok for training and inference.
  created_at: 2024-01-12 13:37:42+00:00
  edited: false
  hidden: false
  id: 65a140a6684c018bd429626b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/5b227ae11e3b455f88e1a9bf7483420a.svg
      fullname: Niall Taylor
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: NTaylor
      type: user
    createdAt: '2024-01-24T17:06:41.000Z'
    data:
      edited: true
      editors:
      - NTaylor
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.88555508852005
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/5b227ae11e3b455f88e1a9bf7483420a.svg
          fullname: Niall Taylor
          isHf: false
          isPro: false
          name: NTaylor
          type: user
        html: '<p>Great work. I have a feeling the inference script may be doing something
          funny with the gate weights. Will report back when done some testing </p>

          '
        raw: 'Great work. I have a feeling the inference script may be doing something
          funny with the gate weights. Will report back when done some testing '
        updatedAt: '2024-01-24T19:44:11.799Z'
      numEdits: 1
      reactions: []
    id: 65b143a1fcead433ffdd1445
    type: comment
  author: NTaylor
  content: 'Great work. I have a feeling the inference script may be doing something
    funny with the gate weights. Will report back when done some testing '
  created_at: 2024-01-24 17:06:41+00:00
  edited: true
  hidden: false
  id: 65b143a1fcead433ffdd1445
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
      fullname: hai
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: cloudyu
      type: user
    createdAt: '2024-01-24T23:18:24.000Z'
    data:
      edited: false
      editors:
      - cloudyu
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.6366185545921326
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/64618bc5cf638aa8f856137c/zbUqrIeHjz41P3O2b3eey.jpeg?w=200&h=200&f=face
          fullname: hai
          isHf: false
          isPro: false
          name: cloudyu
          type: user
        html: '<p>update!<br> Now I trained the gating weight by DPO.<br>here is an
          example : <a href="https://huggingface.co/cloudyu/Mixtral-8x7B-Instruct-v0.1-DPO">https://huggingface.co/cloudyu/Mixtral-8x7B-Instruct-v0.1-DPO</a><br>another
          example : <a href="https://huggingface.co/cloudyu/Pluto_24B_DPO_200">https://huggingface.co/cloudyu/Pluto_24B_DPO_200</a></p>

          '
        raw: "update!\n Now I trained the gating weight by DPO.\nhere is an example\
          \ : https://huggingface.co/cloudyu/Mixtral-8x7B-Instruct-v0.1-DPO\nanother\
          \ example : https://huggingface.co/cloudyu/Pluto_24B_DPO_200"
        updatedAt: '2024-01-24T23:18:24.330Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - mlabonne
    id: 65b19ac0b4db9ac3767f732f
    type: comment
  author: cloudyu
  content: "update!\n Now I trained the gating weight by DPO.\nhere is an example\
    \ : https://huggingface.co/cloudyu/Mixtral-8x7B-Instruct-v0.1-DPO\nanother example\
    \ : https://huggingface.co/cloudyu/Pluto_24B_DPO_200"
  created_at: 2024-01-24 23:18:24+00:00
  edited: false
  hidden: false
  id: 65b19ac0b4db9ac3767f732f
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 6
repo_id: mlabonne/phixtral-4x2_8
repo_type: model
status: open
target_branch: null
title: How did you train the gating?
