!!python/object:huggingface_hub.community.DiscussionWithDetails
author: jinyolim
conflicting_files: null
created_at: 2023-09-19 16:18:22+00:00
diff: null
endpoint: https://huggingface.co
events:
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/86dae6b7521a5bae944a9d0bba61c536.svg
      fullname: JJ Lim
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: jinyolim
      type: user
    createdAt: '2023-09-19T17:18:22.000Z'
    data:
      edited: false
      editors:
      - jinyolim
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.7932596206665039
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/86dae6b7521a5bae944a9d0bba61c536.svg
          fullname: JJ Lim
          isHf: false
          isPro: false
          name: jinyolim
          type: user
        html: '<p>Got this error using the provided SageMaker SDK script. Is this
          a known bug in TGI 1.0.3?</p>

          '
        raw: Got this error using the provided SageMaker SDK script. Is this a known
          bug in TGI 1.0.3?
        updatedAt: '2023-09-19T17:18:22.804Z'
      numEdits: 0
      reactions: []
    id: 6509d7de2feb9570c52005cf
    type: comment
  author: jinyolim
  content: Got this error using the provided SageMaker SDK script. Is this a known
    bug in TGI 1.0.3?
  created_at: 2023-09-19 16:18:22+00:00
  edited: false
  hidden: false
  id: 6509d7de2feb9570c52005cf
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
      fullname: Victor Sanh
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: true
      name: VictorSanh
      type: user
    createdAt: '2023-09-20T21:57:45.000Z'
    data:
      edited: false
      editors:
      - VictorSanh
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9704620242118835
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
          fullname: Victor Sanh
          isHf: true
          isPro: true
          name: VictorSanh
          type: user
        html: '<p>will get to the bottom of this tomorrow, it does seem surprising,
          thanks for reporting!</p>

          '
        raw: will get to the bottom of this tomorrow, it does seem surprising, thanks
          for reporting!
        updatedAt: '2023-09-20T21:57:45.707Z'
      numEdits: 0
      reactions:
      - count: 1
        reaction: "\U0001F44D"
        users:
        - jinyolim
    id: 650b6ad93d41ccbfdf12663b
    type: comment
  author: VictorSanh
  content: will get to the bottom of this tomorrow, it does seem surprising, thanks
    for reporting!
  created_at: 2023-09-20 20:57:45+00:00
  edited: false
  hidden: false
  id: 650b6ad93d41ccbfdf12663b
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: /avatars/4facc7fde8bac106e80825a2e3b5b2a7.svg
      fullname: Rama Thamman
      isHf: false
      isOrgMember: false
      isOwner: false
      isPro: false
      name: rthamman
      type: user
    createdAt: '2023-09-21T19:09:02.000Z'
    data:
      edited: false
      editors:
      - rthamman
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9516638517379761
      isReport: false
      latest:
        author:
          avatarUrl: /avatars/4facc7fde8bac106e80825a2e3b5b2a7.svg
          fullname: Rama Thamman
          isHf: false
          isPro: false
          name: rthamman
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;VictorSanh&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/VictorSanh\">@<span class=\"\
          underline\">VictorSanh</span></a></span>\n\n\t</span></span> i have the\
          \ same issue. Please let me know.</p>\n"
        raw: '@VictorSanh i have the same issue. Please let me know.'
        updatedAt: '2023-09-21T19:09:02.400Z'
      numEdits: 0
      reactions: []
    id: 650c94cedceec9cd4ae9b038
    type: comment
  author: rthamman
  content: '@VictorSanh i have the same issue. Please let me know.'
  created_at: 2023-09-21 18:09:02+00:00
  edited: false
  hidden: false
  id: 650c94cedceec9cd4ae9b038
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
      fullname: Victor Sanh
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: true
      name: VictorSanh
      type: user
    createdAt: '2023-09-25T19:51:20.000Z'
    data:
      edited: false
      editors:
      - VictorSanh
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9032242298126221
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
          fullname: Victor Sanh
          isHf: true
          isPro: true
          name: VictorSanh
          type: user
        html: "<p>Ok, I understand the situation now.</p>\n<p>In TGI (file <code>idefics_vision.py</code>),\
          \ we are defining the attribute <code>position_ids</code> as <code>self.position_ids\
          \ = weights.get_tensor(f\"{prefix}.position_ids\")</code> which means that\
          \ during the initialization of the model, we'll look for a tensor called\
          \ <code>position_ids</code>.</p>\n<p>The instruct models have that weight\
          \ tensor, but not the base ones. </p>\n<p>However, in HF Transformers, we\
          \ are defining <code>position_ids</code> as a registered buffer (file <code>idefics/vision.py</code>:\
          \ <code>self.register_buffer(\"position_ids\", torch.arange(self.num_positions).expand((1,\
          \ -1)), persistent=False)</code>) which means that <code>position_ids</code>\
          \ is automatically registered at initialization.</p>\n<p>My suggestion would\
          \ be to correct the way we initialize <code>position_ids</code> in TGI (I\
          \ think that's a mistake i made to not use registering buffers). Could you\
          \ confirm it is the way course of action <span data-props=\"{&quot;user&quot;:&quot;Narsil&quot;}\"\
          \ data-target=\"UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\"\
          >\n\n<span class=\"inline-block\"><span class=\"contents\"><a href=\"/Narsil\"\
          >@<span class=\"underline\">Narsil</span></a></span>\n\n\t</span></span>?</p>\n"
        raw: "Ok, I understand the situation now.\n\nIn TGI (file `idefics_vision.py`),\
          \ we are defining the attribute `position_ids` as `self.position_ids = weights.get_tensor(f\"\
          {prefix}.position_ids\")` which means that during the initialization of\
          \ the model, we'll look for a tensor called `position_ids`.\n\nThe instruct\
          \ models have that weight tensor, but not the base ones. \n\nHowever, in\
          \ HF Transformers, we are defining `position_ids` as a registered buffer\
          \ (file `idefics/vision.py`: `self.register_buffer(\"position_ids\", torch.arange(self.num_positions).expand((1,\
          \ -1)), persistent=False)`) which means that `position_ids` is automatically\
          \ registered at initialization.\n\nMy suggestion would be to correct the\
          \ way we initialize `position_ids` in TGI (I think that's a mistake i made\
          \ to not use registering buffers). Could you confirm it is the way course\
          \ of action @Narsil?\n"
        updatedAt: '2023-09-25T19:51:20.308Z'
      numEdits: 0
      reactions: []
    id: 6511e4b860584e99b15f6728
    type: comment
  author: VictorSanh
  content: "Ok, I understand the situation now.\n\nIn TGI (file `idefics_vision.py`),\
    \ we are defining the attribute `position_ids` as `self.position_ids = weights.get_tensor(f\"\
    {prefix}.position_ids\")` which means that during the initialization of the model,\
    \ we'll look for a tensor called `position_ids`.\n\nThe instruct models have that\
    \ weight tensor, but not the base ones. \n\nHowever, in HF Transformers, we are\
    \ defining `position_ids` as a registered buffer (file `idefics/vision.py`: `self.register_buffer(\"\
    position_ids\", torch.arange(self.num_positions).expand((1, -1)), persistent=False)`)\
    \ which means that `position_ids` is automatically registered at initialization.\n\
    \nMy suggestion would be to correct the way we initialize `position_ids` in TGI\
    \ (I think that's a mistake i made to not use registering buffers). Could you\
    \ confirm it is the way course of action @Narsil?\n"
  created_at: 2023-09-25 18:51:20+00:00
  edited: false
  hidden: false
  id: 6511e4b860584e99b15f6728
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1608285816082-5e2967b819407e3277369b95.png?w=200&h=200&f=face
      fullname: Nicolas Patry
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: false
      name: Narsil
      type: user
    createdAt: '2023-09-26T06:33:52.000Z'
    data:
      edited: false
      editors:
      - Narsil
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9679039120674133
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1608285816082-5e2967b819407e3277369b95.png?w=200&h=200&f=face
          fullname: Nicolas Patry
          isHf: true
          isPro: false
          name: Narsil
          type: user
        html: '<p>This would work, however I don''t think it''s a great idea.</p>

          <p>Either we should always look for them on file, or never. We had a similar
          thing with Llama and <code>inv_freq</code>. The issue of doing it "sometimes"
          is that some models might save a different buffer than the one we generate
          automatically which makes it super hard to debug.</p>

          <p>Are those positions ids always <em>arange</em> ? If yes we should just
          use that and drop the loading part, no ? (And we could probably do the same
          in <code>transformers</code>)</p>

          '
        raw: 'This would work, however I don''t think it''s a great idea.


          Either we should always look for them on file, or never. We had a similar
          thing with Llama and `inv_freq`. The issue of doing it "sometimes" is that
          some models might save a different buffer than the one we generate automatically
          which makes it super hard to debug.


          Are those positions ids always *arange* ? If yes we should just use that
          and drop the loading part, no ? (And we could probably do the same in `transformers`)'
        updatedAt: '2023-09-26T06:33:52.718Z'
      numEdits: 0
      reactions: []
    id: 65127b50446eba391bc7c9bb
    type: comment
  author: Narsil
  content: 'This would work, however I don''t think it''s a great idea.


    Either we should always look for them on file, or never. We had a similar thing
    with Llama and `inv_freq`. The issue of doing it "sometimes" is that some models
    might save a different buffer than the one we generate automatically which makes
    it super hard to debug.


    Are those positions ids always *arange* ? If yes we should just use that and drop
    the loading part, no ? (And we could probably do the same in `transformers`)'
  created_at: 2023-09-26 05:33:52+00:00
  edited: false
  hidden: false
  id: 65127b50446eba391bc7c9bb
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
      fullname: Victor Sanh
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: true
      name: VictorSanh
      type: user
    createdAt: '2023-09-26T12:24:03.000Z'
    data:
      edited: false
      editors:
      - VictorSanh
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.8145233392715454
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
          fullname: Victor Sanh
          isHf: true
          isPro: true
          name: VictorSanh
          type: user
        html: '<p>Got it!</p>

          <p>Fixed it here: <a rel="nofollow" href="https://github.com/huggingface/text-generation-inference/pull/1064">https://github.com/huggingface/text-generation-inference/pull/1064</a></p>

          <p>It uses the same logic as in transformers</p>

          '
        raw: 'Got it!


          Fixed it here: https://github.com/huggingface/text-generation-inference/pull/1064


          It uses the same logic as in transformers'
        updatedAt: '2023-09-26T12:24:03.265Z'
      numEdits: 0
      reactions: []
    id: 6512cd63ac120f23e0e9e611
    type: comment
  author: VictorSanh
  content: 'Got it!


    Fixed it here: https://github.com/huggingface/text-generation-inference/pull/1064


    It uses the same logic as in transformers'
  created_at: 2023-09-26 11:24:03+00:00
  edited: false
  hidden: false
  id: 6512cd63ac120f23e0e9e611
  type: comment
- !!python/object:huggingface_hub.community.DiscussionComment
  _event:
    author:
      avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
      fullname: Victor Sanh
      isHf: true
      isOrgMember: true
      isOwner: false
      isPro: true
      name: VictorSanh
      type: user
    createdAt: '2023-10-04T15:50:22.000Z'
    data:
      edited: false
      editors:
      - VictorSanh
      hidden: false
      identifiedLanguage:
        language: en
        probability: 0.9007248282432556
      isReport: false
      latest:
        author:
          avatarUrl: https://aeiljuispo.cloudimg.io/v7/https://cdn-uploads.huggingface.co/production/uploads/1619623771844-5ecea265968f6028e0559fa5.jpeg?w=200&h=200&f=face
          fullname: Victor Sanh
          isHf: true
          isPro: true
          name: VictorSanh
          type: user
        html: "<p><span data-props=\"{&quot;user&quot;:&quot;jinyolim&quot;}\" data-target=\"\
          UserMention\" class=\"SVELTE_PARTIAL_HYDRATER contents\">\n\n<span class=\"\
          inline-block\"><span class=\"contents\"><a href=\"/jinyolim\">@<span class=\"\
          underline\">jinyolim</span></a></span>\n\n\t</span></span> just want to\
          \ make sure you saw this: Nicolas pushed the fix on tgi 1.1.0. could you\
          \ report back on whether you are still seeing the same bug?</p>\n"
        raw: '@jinyolim just want to make sure you saw this: Nicolas pushed the fix
          on tgi 1.1.0. could you report back on whether you are still seeing the
          same bug?'
        updatedAt: '2023-10-04T15:50:22.525Z'
      numEdits: 0
      reactions: []
    id: 651d89be4e1159ef5cd56e17
    type: comment
  author: VictorSanh
  content: '@jinyolim just want to make sure you saw this: Nicolas pushed the fix
    on tgi 1.1.0. could you report back on whether you are still seeing the same bug?'
  created_at: 2023-10-04 14:50:22+00:00
  edited: false
  hidden: false
  id: 651d89be4e1159ef5cd56e17
  type: comment
is_pull_request: false
merge_commit_oid: null
num: 9
repo_id: HuggingFaceM4/idefics-9b
repo_type: model
status: open
target_branch: null
title: 'RuntimeError: weight model.vision_model.embeddings.position_ids does not exist'
